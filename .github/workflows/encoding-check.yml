name: ç¼–ç ä¸€è‡´æ€§æ£€æŸ¥

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  encoding-check:
    runs-on: ubuntu-latest
    
    env:
      LC_ALL: zh_CN.UTF-8
      LANG: zh_CN.UTF-8
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½®ä¸­æ–‡çŽ¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y locales python3-pip
        sudo locale-gen zh_CN.UTF-8
        sudo update-locale LANG=zh_CN.UTF-8
        pip3 install chardet
        
    - name: æ£€æŸ¥æ–‡ä»¶ç¼–ç 
      run: |
        echo "ðŸ” æ£€æŸ¥æ–‡ä»¶ç¼–ç ..."

        # åˆ›å»ºç¼–ç æ£€æŸ¥è„šæœ¬
        cat > check_encoding.py << 'EOF'
        import os
        import sys
        import chardet

        def check_file_encoding(file_path):
            try:
                with open(file_path, 'rb') as f:
                    raw_data = f.read()
                    if not raw_data:
                        return True  # ç©ºæ–‡ä»¶è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„

                    # æ£€æŸ¥BOM
                    if raw_data.startswith(b'\xef\xbb\xbf'):
                        print(f"âš ï¸  æ–‡ä»¶åŒ…å«BOM: {file_path}")
                        return False

                    # å°è¯•UTF-8è§£ç 
                    try:
                        raw_data.decode('utf-8')
                        return True
                    except UnicodeDecodeError:
                        print(f"âŒ ç¼–ç å¼‚å¸¸: {file_path}")
                        return False
            except Exception as e:
                print(f"âŒ è¯»å–æ–‡ä»¶å¤±è´¥: {file_path} - {e}")
                return False

        def main():
            extensions = ['.html', '.js', '.css', '.md', '.json', '.yml', '.yaml']
            exclude_paths = ['./node_modules/', './public/', './.git/', './resources/']

            failed_files = []
            total_files = 0

            for root, dirs, files in os.walk('.'):
                # è·³è¿‡æŽ’é™¤çš„ç›®å½•
                if any(exclude in root for exclude in exclude_paths):
                    continue

                for file in files:
                    if any(file.endswith(ext) for ext in extensions):
                        file_path = os.path.join(root, file)
                        total_files += 1

                        if not check_file_encoding(file_path):
                            failed_files.append(file_path)

            print(f"ðŸ“Š æ£€æŸ¥äº† {total_files} ä¸ªæ–‡ä»¶")

            if failed_files:
                print(f"âŒ {len(failed_files)} ä¸ªæ–‡ä»¶ç¼–ç æ£€æŸ¥å¤±è´¥")
                sys.exit(1)
            else:
                print("âœ… æ‰€æœ‰æ–‡ä»¶ç¼–ç æ£€æŸ¥é€šè¿‡")

        if __name__ == "__main__":
            main()
        EOF

        python3 check_encoding.py
        
    - name: æ£€æŸ¥HTML metaæ ‡ç­¾
      run: |
        echo "ðŸ” æ£€æŸ¥HTML metaæ ‡ç­¾..."

        # æ£€æŸ¥ä¸»è¦HTMLæ–‡ä»¶çš„charsetå£°æ˜Ž
        charset_issues=0

        # æ£€æŸ¥baseof.htmlå’Œä¸»è¦å¸ƒå±€æ–‡ä»¶
        for file in layouts/_default/baseof.html layouts/index.html; do
          if [ -f "$file" ]; then
            if ! grep -q "charset.*utf-8\|charset.*UTF-8" "$file"; then
              echo "âš ï¸  ä¸»è¦å¸ƒå±€æ–‡ä»¶ç¼ºå°‘charsetå£°æ˜Ž: $file"
              charset_issues=$((charset_issues + 1))
            fi
          fi
        done

        # æ£€æŸ¥æ˜¯å¦æœ‰éžUTF-8ç¼–ç å£°æ˜Ž
        if grep -r "charset" layouts/ static/ 2>/dev/null | grep -v "utf-8\|UTF-8" | grep -v ".git"; then
          echo "âŒ å‘çŽ°éžUTF-8ç¼–ç å£°æ˜Ž"
          exit 1
        fi

        if [ $charset_issues -gt 0 ]; then
          echo "âš ï¸  å‘çŽ° $charset_issues ä¸ªcharsetå£°æ˜Žé—®é¢˜ï¼Œä½†ä¸å½±å“æž„å»º"
        fi

        echo "âœ… HTML metaæ ‡ç­¾æ£€æŸ¥å®Œæˆ"
        
    - name: æ£€æŸ¥CSSç¼–ç å£°æ˜Ž
      run: |
        echo "ðŸ” æ£€æŸ¥CSSç¼–ç å£°æ˜Ž..."

        # æ£€æŸ¥CSSæ–‡ä»¶ä¸­æ˜¯å¦æœ‰éžUTF-8ç¼–ç å£°æ˜Ž
        css_issues=0

        if [ -d "static/css/" ]; then
          find static/css/ -name "*.css" -exec grep -l "@charset" {} \; | while read file; do
            if ! grep -q "@charset.*utf-8\|@charset.*UTF-8" "$file"; then
              echo "âŒ CSSæ–‡ä»¶åŒ…å«éžUTF-8ç¼–ç å£°æ˜Ž: $file"
              css_issues=$((css_issues + 1))
            fi
          done
        fi

        # çŽ°ä»£CSSæ–‡ä»¶é€šå¸¸ä¸éœ€è¦@charsetå£°æ˜Žï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯ä¿¡æ¯æç¤º
        echo "â„¹ï¸  çŽ°ä»£CSSæ–‡ä»¶é€šå¸¸ä¸éœ€è¦@charsetå£°æ˜Žï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ä½¿ç”¨UTF-8"
        echo "âœ… CSSç¼–ç å£°æ˜Žæ£€æŸ¥å®Œæˆ"
        
    - name: æ£€æŸ¥Hugoé…ç½®
      run: |
        echo "ðŸ” æ£€æŸ¥Hugoé…ç½®..."
        
        # æ£€æŸ¥è¯­è¨€é…ç½®
        if ! grep -q "languageCode.*zh" hugo.toml; then
          echo "âŒ Hugoé…ç½®ç¼ºå°‘ä¸­æ–‡è¯­è¨€è®¾ç½®"
          exit 1
        fi
        
        # æ£€æŸ¥CJKè¯­è¨€æ”¯æŒ
        if ! grep -q "hasCJKLanguage.*true" hugo.toml; then
          echo "âŒ Hugoé…ç½®ç¼ºå°‘CJKè¯­è¨€æ”¯æŒ"
          exit 1
        fi
        
        echo "âœ… Hugoé…ç½®æ£€æŸ¥é€šè¿‡"
        
    - name: æ£€æŸ¥ä¸­æ–‡å­—ç¬¦å¤„ç†
      run: |
        echo "ðŸ” æ£€æŸ¥ä¸­æ–‡å­—ç¬¦å¤„ç†..."
        
        # åˆ›å»ºæµ‹è¯•è„šæœ¬
        cat > test_chinese.js << 'EOF'
        const fs = require('fs');
        
        // æµ‹è¯•å­—ç¬¦ä¸²
        const testString = "ç»´æ£®è§†è§‰æ£€æµ‹ä»ªå™¨ - ä¸“ä¸šçš„å·¥ä¸šå†…çª¥é•œè§£å†³æ–¹æ¡ˆ";
        
        // æµ‹è¯•ç¼–ç /è§£ç 
        try {
          const encoded = encodeURIComponent(testString);
          const decoded = decodeURIComponent(encoded);
          
          if (testString !== decoded) {
            console.error("âŒ ä¸­æ–‡å­—ç¬¦ç¼–ç /è§£ç æµ‹è¯•å¤±è´¥");
            process.exit(1);
          }
          
          // æµ‹è¯•JSONåºåˆ—åŒ–
          const jsonString = JSON.stringify({ title: testString });
          const parsed = JSON.parse(jsonString);
          
          if (parsed.title !== testString) {
            console.error("âŒ ä¸­æ–‡å­—ç¬¦JSONåºåˆ—åŒ–æµ‹è¯•å¤±è´¥");
            process.exit(1);
          }
          
          console.log("âœ… ä¸­æ–‡å­—ç¬¦å¤„ç†æµ‹è¯•é€šè¿‡");
          
        } catch (error) {
          console.error("âŒ ä¸­æ–‡å­—ç¬¦å¤„ç†æµ‹è¯•å¤±è´¥:", error.message);
          process.exit(1);
        }
        EOF
        
        node test_chinese.js
        
    - name: ç”Ÿæˆç¼–ç æ£€æŸ¥æŠ¥å‘Š
      run: |
        echo "ðŸ“Š ç”Ÿæˆç¼–ç æ£€æŸ¥æŠ¥å‘Š..."
        
        cat > encoding_report.md << 'EOF'
        # ç¼–ç ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š
        
        ## æ£€æŸ¥æ—¶é—´
        $(date '+%Y-%m-%d %H:%M:%S')
        
        ## æ£€æŸ¥é¡¹ç›®
        - [x] æ–‡ä»¶ç¼–ç æ£€æŸ¥ (HTML, JS, CSS, MD)
        - [x] HTML metaæ ‡ç­¾æ£€æŸ¥
        - [x] CSSç¼–ç å£°æ˜Žæ£€æŸ¥
        - [x] Hugoé…ç½®æ£€æŸ¥
        - [x] ä¸­æ–‡å­—ç¬¦å¤„ç†æµ‹è¯•
        
        ## æ£€æŸ¥ç»“æžœ
        âœ… æ‰€æœ‰ç¼–ç æ£€æŸ¥é¡¹ç›®é€šè¿‡
        
        ## çŽ¯å¢ƒä¿¡æ¯
        - æ“ä½œç³»ç»Ÿ: $(uname -a)
        - è¯­è¨€çŽ¯å¢ƒ: $LANG
        - å­—ç¬¦é›†: $LC_ALL
        
        ## æ–‡ä»¶ç»Ÿè®¡
        - HTMLæ–‡ä»¶: $(find . -name "*.html" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        - JavaScriptæ–‡ä»¶: $(find . -name "*.js" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        - CSSæ–‡ä»¶: $(find . -name "*.css" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        - Markdownæ–‡ä»¶: $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        EOF
        
        echo "âœ… ç¼–ç æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
        
    - name: ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: encoding-check-report
        path: encoding_report.md
        
  hugo-build-test:
    runs-on: ubuntu-latest
    needs: encoding-check
    
    env:
      LC_ALL: zh_CN.UTF-8
      LANG: zh_CN.UTF-8
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½®Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.147.1'
        extended: true
        
    - name: æž„å»ºæµ‹è¯•
      run: |
        echo "ðŸ—ï¸ æµ‹è¯•Hugoæž„å»º..."

        # å°è¯•æž„å»ºï¼Œå¦‚æžœå¤±è´¥åˆ™æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
        if ! hugo --minify --quiet; then
          echo "âŒ Hugoæž„å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š"
          hugo --minify --verbose
          exit 1
        fi

        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†publicç›®å½•
        if [ ! -d "public" ]; then
          echo "âŒ Hugoæž„å»ºæœªç”Ÿæˆpublicç›®å½•"
          exit 1
        fi

        # æ£€æŸ¥ç”Ÿæˆçš„HTMLæ–‡ä»¶æ•°é‡
        html_count=$(find public/ -name "*.html" | wc -l)
        echo "ðŸ“Š ç”Ÿæˆäº† $html_count ä¸ªHTMLæ–‡ä»¶"

        if [ $html_count -eq 0 ]; then
          echo "âŒ æœªç”Ÿæˆä»»ä½•HTMLæ–‡ä»¶"
          exit 1
        fi

        # æ£€æŸ¥ä¸»é¡µæ˜¯å¦ç”Ÿæˆ
        if [ ! -f "public/index.html" ]; then
          echo "âŒ ä¸»é¡µæ–‡ä»¶æœªç”Ÿæˆ"
          exit 1
        fi

        echo "âœ… Hugoæž„å»ºæµ‹è¯•é€šè¿‡"
