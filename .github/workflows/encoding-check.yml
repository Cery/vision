name: ç¼–ç ä¸€è‡´æ€§æ£€æŸ¥

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  encoding-check:
    runs-on: ubuntu-latest
    
    env:
      LC_ALL: zh_CN.UTF-8
      LANG: zh_CN.UTF-8
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½®ä¸­æ–‡çŽ¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y locales
        sudo locale-gen zh_CN.UTF-8
        sudo update-locale LANG=zh_CN.UTF-8
        
    - name: æ£€æŸ¥æ–‡ä»¶ç¼–ç 
      run: |
        echo "ðŸ” æ£€æŸ¥æ–‡ä»¶ç¼–ç ..."
        
        # æ£€æŸ¥HTMLæ–‡ä»¶
        echo "æ£€æŸ¥HTMLæ–‡ä»¶ç¼–ç ..."
        find . -name "*.html" -not -path "./node_modules/*" -not -path "./public/*" | while read file; do
          if ! file "$file" | grep -q "UTF-8"; then
            echo "âŒ ç¼–ç å¼‚å¸¸: $file"
            exit 1
          fi
        done
        
        # æ£€æŸ¥JavaScriptæ–‡ä»¶
        echo "æ£€æŸ¥JavaScriptæ–‡ä»¶ç¼–ç ..."
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./public/*" | while read file; do
          if ! file "$file" | grep -q "UTF-8"; then
            echo "âŒ ç¼–ç å¼‚å¸¸: $file"
            exit 1
          fi
        done
        
        # æ£€æŸ¥CSSæ–‡ä»¶
        echo "æ£€æŸ¥CSSæ–‡ä»¶ç¼–ç ..."
        find . -name "*.css" -not -path "./node_modules/*" -not -path "./public/*" | while read file; do
          if ! file "$file" | grep -q "UTF-8"; then
            echo "âŒ ç¼–ç å¼‚å¸¸: $file"
            exit 1
          fi
        done
        
        # æ£€æŸ¥Markdownæ–‡ä»¶
        echo "æ£€æŸ¥Markdownæ–‡ä»¶ç¼–ç ..."
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./public/*" | while read file; do
          if ! file "$file" | grep -q "UTF-8"; then
            echo "âŒ ç¼–ç å¼‚å¸¸: $file"
            exit 1
          fi
        done
        
        echo "âœ… æ‰€æœ‰æ–‡ä»¶ç¼–ç æ£€æŸ¥é€šè¿‡"
        
    - name: æ£€æŸ¥HTML metaæ ‡ç­¾
      run: |
        echo "ðŸ” æ£€æŸ¥HTML metaæ ‡ç­¾..."
        
        # æ£€æŸ¥charsetå£°æ˜Ž
        if grep -r "charset" layouts/ static/ | grep -v "utf-8\|UTF-8"; then
          echo "âŒ å‘çŽ°éžUTF-8ç¼–ç å£°æ˜Ž"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦ç¼ºå°‘charsetå£°æ˜Ž
        find layouts/ -name "*.html" | while read file; do
          if ! grep -q "charset.*utf-8\|charset.*UTF-8" "$file"; then
            echo "âš ï¸  æ–‡ä»¶å¯èƒ½ç¼ºå°‘charsetå£°æ˜Ž: $file"
          fi
        done
        
        echo "âœ… HTML metaæ ‡ç­¾æ£€æŸ¥å®Œæˆ"
        
    - name: æ£€æŸ¥CSSç¼–ç å£°æ˜Ž
      run: |
        echo "ðŸ” æ£€æŸ¥CSSç¼–ç å£°æ˜Ž..."
        
        find static/css/ -name "*.css" | while read file; do
          if ! head -1 "$file" | grep -q "@charset"; then
            echo "âš ï¸  CSSæ–‡ä»¶ç¼ºå°‘@charsetå£°æ˜Ž: $file"
          fi
        done
        
        echo "âœ… CSSç¼–ç å£°æ˜Žæ£€æŸ¥å®Œæˆ"
        
    - name: æ£€æŸ¥Hugoé…ç½®
      run: |
        echo "ðŸ” æ£€æŸ¥Hugoé…ç½®..."
        
        # æ£€æŸ¥è¯­è¨€é…ç½®
        if ! grep -q "languageCode.*zh" hugo.toml; then
          echo "âŒ Hugoé…ç½®ç¼ºå°‘ä¸­æ–‡è¯­è¨€è®¾ç½®"
          exit 1
        fi
        
        # æ£€æŸ¥CJKè¯­è¨€æ”¯æŒ
        if ! grep -q "hasCJKLanguage.*true" hugo.toml; then
          echo "âŒ Hugoé…ç½®ç¼ºå°‘CJKè¯­è¨€æ”¯æŒ"
          exit 1
        fi
        
        echo "âœ… Hugoé…ç½®æ£€æŸ¥é€šè¿‡"
        
    - name: æ£€æŸ¥ä¸­æ–‡å­—ç¬¦å¤„ç†
      run: |
        echo "ðŸ” æ£€æŸ¥ä¸­æ–‡å­—ç¬¦å¤„ç†..."
        
        # åˆ›å»ºæµ‹è¯•è„šæœ¬
        cat > test_chinese.js << 'EOF'
        const fs = require('fs');
        
        // æµ‹è¯•å­—ç¬¦ä¸²
        const testString = "ç»´æ£®è§†è§‰æ£€æµ‹ä»ªå™¨ - ä¸“ä¸šçš„å·¥ä¸šå†…çª¥é•œè§£å†³æ–¹æ¡ˆ";
        
        // æµ‹è¯•ç¼–ç /è§£ç 
        try {
          const encoded = encodeURIComponent(testString);
          const decoded = decodeURIComponent(encoded);
          
          if (testString !== decoded) {
            console.error("âŒ ä¸­æ–‡å­—ç¬¦ç¼–ç /è§£ç æµ‹è¯•å¤±è´¥");
            process.exit(1);
          }
          
          // æµ‹è¯•JSONåºåˆ—åŒ–
          const jsonString = JSON.stringify({ title: testString });
          const parsed = JSON.parse(jsonString);
          
          if (parsed.title !== testString) {
            console.error("âŒ ä¸­æ–‡å­—ç¬¦JSONåºåˆ—åŒ–æµ‹è¯•å¤±è´¥");
            process.exit(1);
          }
          
          console.log("âœ… ä¸­æ–‡å­—ç¬¦å¤„ç†æµ‹è¯•é€šè¿‡");
          
        } catch (error) {
          console.error("âŒ ä¸­æ–‡å­—ç¬¦å¤„ç†æµ‹è¯•å¤±è´¥:", error.message);
          process.exit(1);
        }
        EOF
        
        node test_chinese.js
        
    - name: ç”Ÿæˆç¼–ç æ£€æŸ¥æŠ¥å‘Š
      run: |
        echo "ðŸ“Š ç”Ÿæˆç¼–ç æ£€æŸ¥æŠ¥å‘Š..."
        
        cat > encoding_report.md << 'EOF'
        # ç¼–ç ä¸€è‡´æ€§æ£€æŸ¥æŠ¥å‘Š
        
        ## æ£€æŸ¥æ—¶é—´
        $(date '+%Y-%m-%d %H:%M:%S')
        
        ## æ£€æŸ¥é¡¹ç›®
        - [x] æ–‡ä»¶ç¼–ç æ£€æŸ¥ (HTML, JS, CSS, MD)
        - [x] HTML metaæ ‡ç­¾æ£€æŸ¥
        - [x] CSSç¼–ç å£°æ˜Žæ£€æŸ¥
        - [x] Hugoé…ç½®æ£€æŸ¥
        - [x] ä¸­æ–‡å­—ç¬¦å¤„ç†æµ‹è¯•
        
        ## æ£€æŸ¥ç»“æžœ
        âœ… æ‰€æœ‰ç¼–ç æ£€æŸ¥é¡¹ç›®é€šè¿‡
        
        ## çŽ¯å¢ƒä¿¡æ¯
        - æ“ä½œç³»ç»Ÿ: $(uname -a)
        - è¯­è¨€çŽ¯å¢ƒ: $LANG
        - å­—ç¬¦é›†: $LC_ALL
        
        ## æ–‡ä»¶ç»Ÿè®¡
        - HTMLæ–‡ä»¶: $(find . -name "*.html" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        - JavaScriptæ–‡ä»¶: $(find . -name "*.js" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        - CSSæ–‡ä»¶: $(find . -name "*.css" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        - Markdownæ–‡ä»¶: $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./public/*" | wc -l)
        EOF
        
        echo "âœ… ç¼–ç æ£€æŸ¥æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
        
    - name: ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: encoding-check-report
        path: encoding_report.md
        
  hugo-build-test:
    runs-on: ubuntu-latest
    needs: encoding-check
    
    env:
      LC_ALL: zh_CN.UTF-8
      LANG: zh_CN.UTF-8
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: è®¾ç½®Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.147.1'
        extended: true
        
    - name: æž„å»ºæµ‹è¯•
      run: |
        echo "ðŸ—ï¸ æµ‹è¯•Hugoæž„å»º..."
        hugo --minify --verbose
        
        # æ£€æŸ¥ç”Ÿæˆçš„HTMLæ–‡ä»¶ç¼–ç 
        echo "ðŸ” æ£€æŸ¥ç”Ÿæˆæ–‡ä»¶ç¼–ç ..."
        find public/ -name "*.html" | head -10 | while read file; do
          if ! file "$file" | grep -q "UTF-8"; then
            echo "âŒ ç”Ÿæˆæ–‡ä»¶ç¼–ç å¼‚å¸¸: $file"
            exit 1
          fi
        done
        
        echo "âœ… Hugoæž„å»ºæµ‹è¯•é€šè¿‡"
