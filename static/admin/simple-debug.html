<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•è°ƒè¯•å·¥å…· - VisNDT</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ” ç®€å•è°ƒè¯•å·¥å…·</h1>
    <p>é€æ­¥æ£€æŸ¥äº§å“åˆ—è¡¨åŠ è½½é—®é¢˜</p>

    <div id="step1" class="step">
        <h3>æ­¥éª¤1: æ£€æŸ¥JavaScriptæ–‡ä»¶åŠ è½½</h3>
        <div id="step1-result">ç­‰å¾…æ£€æŸ¥...</div>
    </div>

    <div id="step2" class="step">
        <h3>æ­¥éª¤2: æ£€æŸ¥ContentDataLoaderç±»</h3>
        <div id="step2-result">ç­‰å¾…æ£€æŸ¥...</div>
    </div>

    <div id="step3" class="step">
        <h3>æ­¥éª¤3: æµ‹è¯•æ•°æ®åŠ è½½</h3>
        <div id="step3-result">ç­‰å¾…æ£€æŸ¥...</div>
        <button class="btn-primary" onclick="testDataLoading()">å¼€å§‹æµ‹è¯•</button>
    </div>

    <div id="step4" class="step">
        <h3>æ­¥éª¤4: æµ‹è¯•äº§å“åˆ—è¡¨å‡½æ•°</h3>
        <div id="step4-result">ç­‰å¾…æ£€æŸ¥...</div>
        <button class="btn-success" onclick="testProductListFunction()">æµ‹è¯•å‡½æ•°</button>
    </div>

    <div id="step5" class="step">
        <h3>æ­¥éª¤5: æŸ¥çœ‹é”™è¯¯è¯¦æƒ…</h3>
        <div id="step5-result">ç­‰å¾…æ£€æŸ¥...</div>
        <button class="btn-danger" onclick="showDetailedErrors()">æ˜¾ç¤ºè¯¦ç»†é”™è¯¯</button>
    </div>

    <div id="console-output" class="step">
        <h3>æ§åˆ¶å°è¾“å‡º</h3>
        <pre id="console-log"></pre>
        <button onclick="clearConsole()">æ¸…ç©º</button>
    </div>

    <!-- å¼•å…¥JavaScriptæ–‡ä»¶ -->
    <script src="data-loader.js"></script>
    <script src="admin-functions.js"></script>

    <script>
        let logs = [];
        
        // é‡å†™consoleæ–¹æ³•æ¥æ•è·æ—¥å¿—
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN', args.join(' '));
        };

        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${type}: ${message}`);
            updateConsoleDisplay();
        }

        function updateConsoleDisplay() {
            document.getElementById('console-log').textContent = logs.join('\n');
        }

        function clearConsole() {
            logs = [];
            updateConsoleDisplay();
        }

        function setStepResult(stepId, content, className = 'info') {
            const element = document.getElementById(stepId + '-result');
            element.innerHTML = content;
            const stepElement = document.getElementById(stepId);
            stepElement.className = 'step ' + className;
        }

        // æ­¥éª¤1: æ£€æŸ¥JavaScriptæ–‡ä»¶åŠ è½½
        function checkJavaScriptFiles() {
            console.log('å¼€å§‹æ£€æŸ¥JavaScriptæ–‡ä»¶...');
            
            let result = '<ul>';
            let allLoaded = true;

            // æ£€æŸ¥data-loader.js
            if (typeof ContentDataLoader !== 'undefined') {
                result += '<li>âœ… data-loader.js å·²åŠ è½½ï¼ŒContentDataLoaderç±»å¯ç”¨</li>';
            } else {
                result += '<li>âŒ data-loader.js æœªåŠ è½½æˆ–ContentDataLoaderç±»æœªå®šä¹‰</li>';
                allLoaded = false;
            }

            // æ£€æŸ¥admin-functions.js
            if (typeof showProductsList !== 'undefined') {
                result += '<li>âœ… admin-functions.js å·²åŠ è½½ï¼ŒshowProductsListå‡½æ•°å¯ç”¨</li>';
            } else {
                result += '<li>âŒ admin-functions.js æœªåŠ è½½æˆ–showProductsListå‡½æ•°æœªå®šä¹‰</li>';
                allLoaded = false;
            }

            if (typeof ensureDataLoaderInitialized !== 'undefined') {
                result += '<li>âœ… ensureDataLoaderInitializedå‡½æ•°å¯ç”¨</li>';
            } else {
                result += '<li>âŒ ensureDataLoaderInitializedå‡½æ•°æœªå®šä¹‰</li>';
                allLoaded = false;
            }

            result += '</ul>';
            
            setStepResult('step1', result, allLoaded ? 'success' : 'error');
            return allLoaded;
        }

        // æ­¥éª¤2: æ£€æŸ¥ContentDataLoaderç±»
        function checkContentDataLoader() {
            console.log('å¼€å§‹æ£€æŸ¥ContentDataLoaderç±»...');
            
            if (typeof ContentDataLoader === 'undefined') {
                setStepResult('step2', 'âŒ ContentDataLoaderç±»æœªå®šä¹‰', 'error');
                return false;
            }

            try {
                const loader = new ContentDataLoader();
                let result = '<ul>';
                result += '<li>âœ… ContentDataLoaderç±»å¯ä»¥å®ä¾‹åŒ–</li>';
                result += `<li>âœ… åŸºç¡€URL: ${loader.baseUrl}</li>`;
                result += '<li>âœ… contentDataç»“æ„å·²åˆå§‹åŒ–</li>';
                
                // æ£€æŸ¥æ–¹æ³•
                if (typeof loader.loadAllData === 'function') {
                    result += '<li>âœ… loadAllDataæ–¹æ³•å­˜åœ¨</li>';
                } else {
                    result += '<li>âŒ loadAllDataæ–¹æ³•ä¸å­˜åœ¨</li>';
                }

                if (typeof loader.loadProducts === 'function') {
                    result += '<li>âœ… loadProductsæ–¹æ³•å­˜åœ¨</li>';
                } else {
                    result += '<li>âŒ loadProductsæ–¹æ³•ä¸å­˜åœ¨</li>';
                }

                result += '</ul>';
                setStepResult('step2', result, 'success');
                return true;
            } catch (error) {
                setStepResult('step2', `âŒ ContentDataLoaderå®ä¾‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        // æ­¥éª¤3: æµ‹è¯•æ•°æ®åŠ è½½
        async function testDataLoading() {
            console.log('å¼€å§‹æµ‹è¯•æ•°æ®åŠ è½½...');
            setStepResult('step3', 'ğŸ”„ æ­£åœ¨æµ‹è¯•æ•°æ®åŠ è½½...', 'warning');

            try {
                const loader = new ContentDataLoader();
                await loader.loadAllData();

                let result = '<ul>';
                result += `<li>âœ… æ•°æ®åŠ è½½å®Œæˆ</li>`;
                result += `<li>äº§å“æ•°é‡: ${loader.contentData.products?.length || 0}</li>`;
                result += `<li>èµ„è®¯æ•°é‡: ${loader.contentData.news?.length || 0}</li>`;
                result += `<li>æ¡ˆä¾‹æ•°é‡: ${loader.contentData.cases?.length || 0}</li>`;
                result += `<li>åˆ†ç±»æ•°é‡: ${loader.contentData.categories?.length || 0}</li>`;
                result += `<li>ä¾›åº”å•†æ•°é‡: ${loader.contentData.suppliers?.length || 0}</li>`;

                if (loader.contentData.products && loader.contentData.products.length > 0) {
                    result += '<li>âœ… äº§å“æ•°æ®ä¸ä¸ºç©º</li>';
                    const firstProduct = loader.contentData.products[0];
                    result += `<li>ç¬¬ä¸€ä¸ªäº§å“: ${firstProduct.title || firstProduct.id}</li>`;
                } else {
                    result += '<li>âš ï¸ äº§å“æ•°æ®ä¸ºç©º</li>';
                }

                result += '</ul>';
                setStepResult('step3', result, 'success');

                // è®¾ç½®å…¨å±€æ•°æ®åŠ è½½å™¨
                window.contentDataLoader = loader;
                console.log('å…¨å±€æ•°æ®åŠ è½½å™¨å·²è®¾ç½®');

            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                setStepResult('step3', `âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤4: æµ‹è¯•äº§å“åˆ—è¡¨å‡½æ•°
        async function testProductListFunction() {
            console.log('å¼€å§‹æµ‹è¯•äº§å“åˆ—è¡¨å‡½æ•°...');
            setStepResult('step4', 'ğŸ”„ æ­£åœ¨æµ‹è¯•äº§å“åˆ—è¡¨å‡½æ•°...', 'warning');

            try {
                if (typeof ensureDataLoaderInitialized !== 'function') {
                    throw new Error('ensureDataLoaderInitializedå‡½æ•°æœªå®šä¹‰');
                }

                await ensureDataLoaderInitialized();

                if (!window.contentDataLoader) {
                    throw new Error('å…¨å±€æ•°æ®åŠ è½½å™¨æœªåˆå§‹åŒ–');
                }

                const productCount = window.contentDataLoader.contentData?.products?.length || 0;
                
                let result = '<ul>';
                result += '<li>âœ… ensureDataLoaderInitializedå‡½æ•°æ‰§è¡ŒæˆåŠŸ</li>';
                result += '<li>âœ… å…¨å±€æ•°æ®åŠ è½½å™¨å·²åˆå§‹åŒ–</li>';
                result += `<li>äº§å“æ•°é‡: ${productCount}</li>`;

                if (typeof loadProductsList === 'function') {
                    result += '<li>âœ… loadProductsListå‡½æ•°å­˜åœ¨</li>';
                    
                    // å°è¯•è°ƒç”¨loadProductsList
                    try {
                        await loadProductsList();
                        result += '<li>âœ… loadProductsListå‡½æ•°æ‰§è¡ŒæˆåŠŸ</li>';
                    } catch (loadError) {
                        result += `<li>âŒ loadProductsListå‡½æ•°æ‰§è¡Œå¤±è´¥: ${loadError.message}</li>';
                    }
                } else {
                    result += '<li>âŒ loadProductsListå‡½æ•°ä¸å­˜åœ¨</li>';
                }

                result += '</ul>';
                setStepResult('step4', result, productCount > 0 ? 'success' : 'warning');

            } catch (error) {
                console.error('äº§å“åˆ—è¡¨å‡½æ•°æµ‹è¯•å¤±è´¥:', error);
                setStepResult('step4', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ­¥éª¤5: æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
        function showDetailedErrors() {
            console.log('æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯...');
            
            let result = '<h4>ç¯å¢ƒæ£€æŸ¥:</h4><ul>';
            result += `<li>ç”¨æˆ·ä»£ç†: ${navigator.userAgent}</li>`;
            result += `<li>å½“å‰URL: ${window.location.href}</li>`;
            result += `<li>åè®®: ${window.location.protocol}</li>`;
            result += '</ul>';

            result += '<h4>å…¨å±€å¯¹è±¡æ£€æŸ¥:</h4><ul>';
            result += `<li>window.ContentDataLoader: ${typeof window.ContentDataLoader}</li>`;
            result += `<li>window.contentDataLoader: ${typeof window.contentDataLoader}</li>`;
            result += `<li>window.showProductsList: ${typeof window.showProductsList}</li>`;
            result += `<li>window.ensureDataLoaderInitialized: ${typeof window.ensureDataLoaderInitialized}</li>`;
            result += '</ul>';

            result += '<h4>ç½‘ç»œæ£€æŸ¥:</h4>';
            result += '<button onclick="testNetworkAccess()">æµ‹è¯•ç½‘ç»œè®¿é—®</button>';
            result += '<div id="network-test-result"></div>';

            setStepResult('step5', result, 'info');
        }

        async function testNetworkAccess() {
            const resultDiv = document.getElementById('network-test-result');
            resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•ç½‘ç»œè®¿é—®...';

            try {
                // æµ‹è¯•è®¿é—®äº§å“æ–‡ä»¶
                const testUrls = [
                    '/products/WS-K08510-a/index.md',
                    '/api/products.json',
                    '/admin/data-loader.js',
                    '/admin/admin-functions.js'
                ];

                let results = '<ul>';
                for (const url of testUrls) {
                    try {
                        const response = await fetch(url);
                        results += `<li>${url}: ${response.status} ${response.statusText}</li>`;
                    } catch (error) {
                        results += `<li>${url}: âŒ ${error.message}</li>`;
                    }
                }
                results += '</ul>';
                resultDiv.innerHTML = results;

            } catch (error) {
                resultDiv.innerHTML = `âŒ ç½‘ç»œæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œå‰ä¸¤ä¸ªæ­¥éª¤
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æ£€æŸ¥...');
            
            setTimeout(() => {
                const step1Success = checkJavaScriptFiles();
                if (step1Success) {
                    setTimeout(() => {
                        checkContentDataLoader();
                    }, 500);
                }
            }, 1000);
        });
    </script>
</body>
</html>
