<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品集成验证</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-check-double"></i> VF-8500产品集成验证</h2>
        
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> 验证说明</h5>
            <p>这个页面将验证VF-8500光纤内窥镜产品是否已成功集成到系统的各个部分。</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list-check"></i> 验证项目</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">1. MD文件生成</h6>
                                    <p class="mb-1">检查content/products/VF-8500.md文件是否存在</p>
                                </div>
                                <span id="status-md" class="badge bg-secondary">待检查</span>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">2. API产品列表</h6>
                                    <p class="mb-1">检查产品是否在API产品列表中</p>
                                </div>
                                <span id="status-api" class="badge bg-secondary">待检查</span>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">3. Hugo页面访问</h6>
                                    <p class="mb-1">检查产品页面是否可以通过Hugo访问</p>
                                </div>
                                <span id="status-hugo" class="badge bg-secondary">待检查</span>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">4. 前端管理列表</h6>
                                    <p class="mb-1">检查产品是否在管理后台列表中显示</p>
                                </div>
                                <span id="status-frontend" class="badge bg-secondary">待检查</span>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">5. 搜索索引</h6>
                                    <p class="mb-1">检查产品是否在搜索索引中</p>
                                </div>
                                <span id="status-search" class="badge bg-secondary">待检查</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="runFullVerification()">
                                <i class="fas fa-play"></i> 开始完整验证
                            </button>
                            <button class="btn btn-success" onclick="fixIntegrationIssues()">
                                <i class="fas fa-wrench"></i> 修复集成问题
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> 快速操作</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="openProductPage()">
                                <i class="fas fa-external-link-alt"></i> 打开产品页面
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="openManagerPage()">
                                <i class="fas fa-cogs"></i> 打开管理页面
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="reloadProductData()">
                                <i class="fas fa-sync"></i> 重新加载数据
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="rebuildHugo()">
                                <i class="fas fa-hammer"></i> 重建Hugo
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-info"></i> 产品信息</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr><td><strong>产品ID</strong></td><td>VF-8500</td></tr>
                            <tr><td><strong>文件路径</strong></td><td>content/products/VF-8500.md</td></tr>
                            <tr><td><strong>Hugo URL</strong></td><td>/products/vf-8500/</td></tr>
                            <tr><td><strong>API端点</strong></td><td>/api/products/list</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> 验证日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="verificationLog" class="border p-3 bg-dark text-light" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;">
                            <div class="text-success">[系统] 验证系统准备就绪</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const logArea = document.getElementById('verificationLog');
            const timestamp = new Date().toLocaleTimeString();
            
            let color = 'text-info';
            let icon = 'ℹ️';
            
            switch(type) {
                case 'success':
                    color = 'text-success';
                    icon = '✅';
                    break;
                case 'error':
                    color = 'text-danger';
                    icon = '❌';
                    break;
                case 'warning':
                    color = 'text-warning';
                    icon = '⚠️';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `badge bg-${status}`;
            element.textContent = text;
        }

        async function checkMDFile() {
            log('检查MD文件是否存在...', 'info');
            try {
                const response = await fetch('/content/products/VF-8500.md');
                if (response.ok) {
                    updateStatus('status-md', 'success', '✅ 存在');
                    log('MD文件检查通过', 'success');
                    return true;
                } else {
                    updateStatus('status-md', 'danger', '❌ 不存在');
                    log('MD文件不存在', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('status-md', 'danger', '❌ 错误');
                log(`MD文件检查失败: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkAPIList() {
            log('检查API产品列表...', 'info');
            try {
                const response = await fetch('http://localhost:3002/api/products/list');
                const result = await response.json();
                
                if (result.success && result.products) {
                    const vfProduct = result.products.find(p => p.id === 'VF-8500');
                    if (vfProduct) {
                        updateStatus('status-api', 'success', '✅ 已列出');
                        log(`API列表检查通过，找到产品: ${vfProduct.title}`, 'success');
                        return true;
                    } else {
                        updateStatus('status-api', 'warning', '⚠️ 未找到');
                        log('API列表中未找到VF-8500产品', 'warning');
                        return false;
                    }
                } else {
                    updateStatus('status-api', 'danger', '❌ API错误');
                    log('API调用失败', 'error');
                    return false;
                }
            } catch (error) {
                updateStatus('status-api', 'danger', '❌ 错误');
                log(`API检查失败: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkHugoPage() {
            log('检查Hugo页面访问...', 'info');
            try {
                const response = await fetch('/products/vf-8500/');
                if (response.ok) {
                    updateStatus('status-hugo', 'success', '✅ 可访问');
                    log('Hugo页面访问正常', 'success');
                    return true;
                } else {
                    updateStatus('status-hugo', 'warning', '⚠️ 404');
                    log('Hugo页面不存在，可能需要重建', 'warning');
                    return false;
                }
            } catch (error) {
                updateStatus('status-hugo', 'danger', '❌ 错误');
                log(`Hugo页面检查失败: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkFrontendList() {
            log('检查前端管理列表...', 'info');
            // 这里需要与管理页面通信
            updateStatus('status-frontend', 'warning', '⚠️ 需手动检查');
            log('请在管理页面检查产品列表', 'warning');
            return false;
        }

        async function checkSearchIndex() {
            log('检查搜索索引...', 'info');
            try {
                const response = await fetch('/search-index.json');
                const searchData = await response.json();
                
                const vfProduct = searchData.find(item => 
                    item.uri && (item.uri.includes('vf-8500') || item.title.includes('VF-8500'))
                );
                
                if (vfProduct) {
                    updateStatus('status-search', 'success', '✅ 已索引');
                    log('搜索索引检查通过', 'success');
                    return true;
                } else {
                    updateStatus('status-search', 'warning', '⚠️ 未索引');
                    log('搜索索引中未找到产品，需要重建Hugo', 'warning');
                    return false;
                }
            } catch (error) {
                updateStatus('status-search', 'danger', '❌ 错误');
                log(`搜索索引检查失败: ${error.message}`, 'error');
                return false;
            }
        }

        async function runFullVerification() {
            log('开始完整验证...', 'info');
            
            const results = await Promise.all([
                checkMDFile(),
                checkAPIList(),
                checkHugoPage(),
                checkFrontendList(),
                checkSearchIndex()
            ]);
            
            const passedCount = results.filter(r => r).length;
            log(`验证完成: ${passedCount}/5 项通过`, passedCount === 5 ? 'success' : 'warning');
            
            if (passedCount < 5) {
                log('建议运行修复程序', 'info');
            }
        }

        async function fixIntegrationIssues() {
            log('开始修复集成问题...', 'info');
            
            // 这里可以调用管理页面的修复函数
            log('请在管理页面点击"重新加载"和"更新索引"按钮', 'info');
            log('如果Hugo页面无法访问，请重建Hugo服务器', 'warning');
        }

        function openProductPage() {
            window.open('/products/vf-8500/', '_blank');
        }

        function openManagerPage() {
            window.open('/admin/complete-content-manager.html', '_blank');
        }

        async function reloadProductData() {
            log('重新加载产品数据...', 'info');
            await checkAPIList();
        }

        function rebuildHugo() {
            log('建议重启Hugo服务器以重建索引', 'warning');
            alert('请重启Hugo服务器：\n1. 停止当前Hugo服务器\n2. 运行: hugo server --port 1313');
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('验证页面加载完成', 'success');
            log('点击"开始完整验证"进行检查', 'info');
        });
    </script>
</body>
</html>
