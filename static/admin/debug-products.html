<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品数据调试 - VisNDT管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .debug-section {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .debug-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.75rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-bug me-2"></i>产品数据调试工具
                </h2>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="debug-section">
                            <div class="debug-title">数据加载器状态</div>
                            <div id="dataLoaderStatus" class="code-block">检查中...</div>
                        </div>
                        
                        <div class="debug-section">
                            <div class="debug-title">产品数据详情</div>
                            <div id="productDetails" class="code-block">加载中...</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="debug-section">
                            <div class="debug-title">控制面板</div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="initializeDataLoader()">
                                    <i class="fas fa-play me-1"></i>初始化数据加载器
                                </button>
                                <button class="btn btn-success" onclick="loadProducts()">
                                    <i class="fas fa-download me-1"></i>加载产品数据
                                </button>
                                <button class="btn btn-info" onclick="testAdminFunctions()">
                                    <i class="fas fa-test-tube me-1"></i>测试Admin Functions
                                </button>
                                <button class="btn btn-warning" onclick="clearData()">
                                    <i class="fas fa-trash me-1"></i>清除数据
                                </button>
                                <button class="btn btn-secondary" onclick="refreshDebug()">
                                    <i class="fas fa-refresh me-1"></i>刷新调试信息
                                </button>
                            </div>
                        </div>
                        
                        <div class="debug-section">
                            <div class="debug-title">测试结果</div>
                            <div id="testResults" class="code-block">等待测试...</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="debug-section">
                            <div class="debug-title">产品列表预览</div>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>标题</th>
                                            <th>型号</th>
                                            <th>系列</th>
                                            <th>状态</th>
                                            <th>推荐</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productPreview">
                                        <tr><td colspan="6" class="text-center">暂无数据</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data-loader.js"></script>
    <script>
        let debugLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            console.log(message);
            updateDebugDisplay();
        }
        
        function updateDebugDisplay() {
            document.getElementById('testResults').textContent = debugLog.join('\n');
        }
        
        function updateDataLoaderStatus() {
            const status = document.getElementById('dataLoaderStatus');
            
            if (!window.ContentDataLoader) {
                status.textContent = '❌ ContentDataLoader 类未找到';
                return;
            }
            
            if (!window.contentDataLoader) {
                status.textContent = '⚠️ contentDataLoader 实例未创建';
                return;
            }
            
            const loader = window.contentDataLoader;
            const info = {
                '实例状态': '✅ 已创建',
                '内容数据': loader.contentData ? '✅ 已加载' : '❌ 未加载',
                '产品数据': loader.contentData?.products ? `✅ ${loader.contentData.products.length} 个产品` : '❌ 无产品数据',
                '基础URL': loader.baseUrl || '未设置'
            };
            
            status.textContent = Object.entries(info).map(([key, value]) => `${key}: ${value}`).join('\n');
        }
        
        function updateProductDetails() {
            const details = document.getElementById('productDetails');
            
            if (!window.contentDataLoader?.contentData?.products) {
                details.textContent = '无产品数据';
                return;
            }
            
            const products = window.contentDataLoader.contentData.products;
            const summary = {
                '总数': products.length,
                '已发布': products.filter(p => p.status === 'published').length,
                '草稿': products.filter(p => p.status === 'draft').length,
                '推荐': products.filter(p => p.featured).length,
                'K系列': products.filter(p => p.series === 'K系列').length,
                'P系列': products.filter(p => p.series === 'P系列').length,
                'DZ系列': products.filter(p => p.series === 'DZ系列').length
            };
            
            details.textContent = Object.entries(summary).map(([key, value]) => `${key}: ${value}`).join('\n');
        }
        
        function updateProductPreview() {
            const tbody = document.getElementById('productPreview');
            
            if (!window.contentDataLoader?.contentData?.products) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">无产品数据</td></tr>';
                return;
            }
            
            const products = window.contentDataLoader.contentData.products;
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td><code>${product.id}</code></td>
                    <td>${product.title}</td>
                    <td>${product.model}</td>
                    <td>${product.series || '-'}</td>
                    <td><span class="badge ${product.status === 'published' ? 'bg-success' : 'bg-warning'}">${product.status}</span></td>
                    <td>${product.featured ? '<i class="fas fa-star text-warning"></i>' : '-'}</td>
                </tr>
            `).join('');
        }
        
        async function initializeDataLoader() {
            try {
                log('开始初始化数据加载器...');
                
                if (!window.ContentDataLoader) {
                    throw new Error('ContentDataLoader 类未找到');
                }
                
                window.contentDataLoader = new ContentDataLoader();
                log('✅ 数据加载器实例已创建');
                
                await window.contentDataLoader.loadAllData();
                log('✅ 所有数据加载完成');
                
                refreshDebug();
                
            } catch (error) {
                log(`❌ 初始化失败: ${error.message}`);
            }
        }
        
        async function loadProducts() {
            try {
                log('开始加载产品数据...');
                
                if (!window.contentDataLoader) {
                    throw new Error('数据加载器未初始化');
                }
                
                await window.contentDataLoader.loadProducts();
                log('✅ 产品数据加载完成');
                
                refreshDebug();
                
            } catch (error) {
                log(`❌ 产品加载失败: ${error.message}`);
            }
        }
        
        function testAdminFunctions() {
            try {
                log('测试 Admin Functions 兼容性...');
                
                // 测试数据访问
                const dataLoader = window.contentDataLoader;
                if (!dataLoader) {
                    throw new Error('数据加载器未初始化');
                }
                
                if (!dataLoader.contentData) {
                    throw new Error('内容数据未加载');
                }
                
                if (!dataLoader.contentData.products) {
                    throw new Error('产品数据未加载');
                }
                
                const products = dataLoader.contentData.products;
                log(`✅ 找到 ${products.length} 个产品`);
                
                // 测试数据结构
                const firstProduct = products[0];
                const requiredFields = ['id', 'title', 'model', 'status'];
                const missingFields = requiredFields.filter(field => !firstProduct[field]);
                
                if (missingFields.length > 0) {
                    log(`⚠️ 产品数据缺少字段: ${missingFields.join(', ')}`);
                } else {
                    log('✅ 产品数据结构完整');
                }
                
                log('✅ Admin Functions 兼容性测试通过');
                
            } catch (error) {
                log(`❌ Admin Functions 测试失败: ${error.message}`);
            }
        }
        
        function clearData() {
            window.contentDataLoader = null;
            debugLog = [];
            log('🗑️ 数据已清除');
            refreshDebug();
        }
        
        function refreshDebug() {
            updateDataLoaderStatus();
            updateProductDetails();
            updateProductPreview();
        }
        
        // 页面加载时自动刷新
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 调试工具已启动');
            refreshDebug();
        });
    </script>
</body>
</html>
