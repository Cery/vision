<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整内容管理中心 - VisNDT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 2px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        .main-content {
            background: #f8f9fa;
            min-height: 100vh;
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
            transition: transform 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .stats-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .btn-action {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin: 2px;
        }
        .search-box {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        .search-box:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-published { background: #d4edda; color: #155724; }
        .status-draft { background: #fff3cd; color: #856404; }
        .status-active { background: #d1ecf1; color: #0c5460; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 50px;
        }
        .error-message {
            display: none;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .success-message {
            display: none;
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-4">
                    <h4 class="text-white mb-4">
                        <i class="fas fa-cogs me-2"></i>
                        内容管理
                    </h4>
                    <nav class="nav flex-column">
                        <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt me-2"></i>仪表板
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('products')">
                            <i class="fas fa-box me-2"></i>产品管理
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('suppliers')">
                            <i class="fas fa-truck me-2"></i>供应商管理
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('categories')">
                            <i class="fas fa-tags me-2"></i>产品分类
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('news')">
                            <i class="fas fa-newspaper me-2"></i>资讯管理
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('cases')">
                            <i class="fas fa-briefcase me-2"></i>案例管理
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('applications')">
                            <i class="fas fa-puzzle-piece me-2"></i>应用领域
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('media')">
                            <i class="fas fa-images me-2"></i>媒体库
                        </a>
                        <a class="nav-link" href="#" onclick="showSection('settings')">
                            <i class="fas fa-cog me-2"></i>系统设置
                        </a>
                    </nav>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-9 col-lg-10 main-content p-0">
                <div class="p-4">
                    <!-- 页面标题 -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 id="pageTitle">仪表板</h2>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshData()">
                                <i class="fas fa-sync-alt me-1"></i>刷新数据
                            </button>
                            <button class="btn btn-primary" onclick="showAddModal()">
                                <i class="fas fa-plus me-1"></i>添加内容
                            </button>
                        </div>
                    </div>

                    <!-- 加载状态 -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-3">正在加载数据...</p>
                    </div>

                    <!-- 错误消息 -->
                    <div class="error-message" id="errorMessage">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="errorText"></span>
                    </div>

                    <!-- 成功消息 -->
                    <div class="success-message" id="successMessage">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="successText"></span>
                    </div>

                    <!-- 仪表板 -->
                    <div id="dashboard" class="content-section active">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                            <i class="fas fa-box"></i>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="text-muted mb-1">产品总数</h6>
                                            <h4 class="mb-0" id="productCount">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                            <i class="fas fa-truck"></i>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="text-muted mb-1">供应商</h6>
                                            <h4 class="mb-0" id="supplierCount">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                                            <i class="fas fa-newspaper"></i>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="text-muted mb-1">资讯文章</h6>
                                            <h4 class="mb-0" id="newsCount">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card">
                                    <div class="d-flex align-items-center">
                                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">
                                            <i class="fas fa-briefcase"></i>
                                        </div>
                                        <div class="ms-3">
                                            <h6 class="text-muted mb-1">应用案例</h6>
                                            <h4 class="mb-0" id="caseCount">0</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 最近活动 -->
                        <div class="table-container">
                            <h5 class="mb-3">
                                <i class="fas fa-clock me-2"></i>最近活动
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>时间</th>
                                            <th>类型</th>
                                            <th>标题</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentActivities">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">暂无数据</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 产品管理 -->
                    <div id="products" class="content-section">
                        <div class="table-container">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>
                                    <i class="fas fa-box me-2"></i>产品列表
                                </h5>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control search-box" placeholder="搜索产品..." id="productSearch" onkeyup="filterProducts()">
                                    <button class="btn btn-success" onclick="addProduct()">
                                        <i class="fas fa-plus me-1"></i>添加产品
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>产品名称</th>
                                            <th>型号</th>
                                            <th>分类</th>
                                            <th>供应商</th>
                                            <th>状态</th>
                                            <th>日期</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productList">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">正在加载数据...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局数据存储
        let projectData = {
            products: [],
            suppliers: [],
            news: [],
            cases: [],
            applications: [],
            categories: []
        };

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 内容管理中心初始化...');
            loadProjectData();
        });

        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // 显示错误消息
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 显示成功消息
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // 加载项目数据
        async function loadProjectData() {
            try {
                showLoading();
                console.log('📡 开始加载项目数据...');

                // 从搜索索引读取数据
                const response = await fetch('/search-index.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const searchData = await response.json();
                console.log('📊 搜索索引数据:', searchData);

                if (searchData && Array.isArray(searchData)) {
                    // 解析产品数据
                    projectData.products = searchData.filter(page =>
                        page.type === 'products' &&
                        page.title && page.title.trim() !== ''
                    ).map(page => ({
                        id: page.uri.replace('/products/', '').replace('/', ''),
                        title: page.title,
                        uri: page.uri,
                        content: page.content || '',
                        summary: page.summary || '',
                        model: extractModelFromTitle(page.title),
                        category: extractCategoryFromContent(page.content),
                        supplier: extractSupplierFromContent(page.content),
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0]
                    }));

                    // 解析资讯数据
                    projectData.news = searchData.filter(page =>
                        page.type === 'news' &&
                        page.title && page.title.trim() !== ''
                    ).map(page => ({
                        id: page.uri.replace('/news/', '').replace('/', ''),
                        title: page.title,
                        uri: page.uri,
                        content: page.content || '',
                        summary: page.summary || '',
                        category: extractNewsCategoryFromContent(page.content),
                        author: '编辑部',
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0],
                        views: Math.floor(Math.random() * 200) + 50
                    }));

                    // 解析案例数据
                    projectData.cases = searchData.filter(page =>
                        page.type === 'cases' &&
                        page.title && page.title.trim() !== ''
                    ).map(page => ({
                        id: page.uri.replace('/cases/', '').replace('/', ''),
                        title: page.title,
                        uri: page.uri,
                        content: page.content || '',
                        summary: page.summary || '',
                        category: extractCaseCategoryFromContent(page.content),
                        industry: extractIndustryFromContent(page.content),
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0]
                    }));

                    // 解析应用领域数据
                    projectData.applications = searchData.filter(page =>
                        page.type === 'applications' &&
                        page.title && page.title.trim() !== ''
                    ).map(page => ({
                        id: page.uri.replace('/applications/', '').replace('/', ''),
                        title: page.title,
                        uri: page.uri,
                        content: page.content || '',
                        summary: page.summary || '',
                        category: '应用领域',
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0]
                    }));
                } else {
                    console.log('搜索索引数据不可用，初始化空数据');
                    projectData.products = [];
                    projectData.news = [];
                    projectData.cases = [];
                    projectData.applications = [];
                }

                // 提取供应商数据
                const supplierSet = new Set();
                projectData.products.forEach(product => {
                    if (product.supplier) {
                        supplierSet.add(product.supplier);
                    }
                });

                projectData.suppliers = Array.from(supplierSet).map((name, index) => ({
                    id: `supplier-${index + 1}`,
                    name: name,
                    type: '制造商',
                    products: projectData.products.filter(p => p.supplier === name).length,
                    status: 'active',
                    date: new Date().toISOString().split('T')[0]
                }));

                // 提取分类数据
                const categorySet = new Set();
                projectData.products.forEach(product => {
                    if (product.category) {
                        categorySet.add(product.category);
                    }
                });

                projectData.categories = Array.from(categorySet).map((name, index) => ({
                    id: `category-${index + 1}`,
                    name: name,
                    products: projectData.products.filter(p => p.category === name).length,
                    status: 'active',
                    date: new Date().toISOString().split('T')[0]
                }));

                console.log('✅ 项目数据加载完成:', {
                    products: projectData.products.length,
                    suppliers: projectData.suppliers.length,
                    news: projectData.news.length,
                    cases: projectData.cases.length,
                    applications: projectData.applications.length,
                    categories: projectData.categories.length
                });

                // 更新界面
                updateDashboard();
                updateProductList();
                hideLoading();
                showSuccess('数据加载完成！');

            } catch (error) {
                console.error('❌ 加载项目数据失败:', error);
                hideLoading();
                showError('数据加载失败: ' + error.message);

                // 返回空数据
                projectData = {
                    products: [],
                    suppliers: [],
                    news: [],
                    cases: [],
                    applications: [],
                    categories: []
                };
            }
        }

        // 数据提取辅助函数
        function extractModelFromTitle(title) {
            if (!title) return '';
            const match = title.match(/([A-Z]{1,3}-?[A-Z]?\d{4,5}[A-Z]?)/);
            return match ? match[1] : '';
        }

        function extractCategoryFromContent(content) {
            if (!content) return '其他';
            if (content.includes('电子内窥镜') || content.includes('高清') || content.includes('LED')) return '电子内窥镜';
            if (content.includes('光纤内窥镜') || content.includes('光纤传输')) return '光纤内窥镜';
            if (content.includes('便携式') || content.includes('轻量化')) return '便携式内窥镜';
            if (content.includes('管道') || content.includes('防水防尘')) return '管道内窥镜';
            if (content.includes('工业级') || content.includes('专业软件')) return '工业级系统';
            return '其他';
        }

        function extractSupplierFromContent(content) {
            if (!content) return '未知供应商';
            if (content.includes('深圳') || content.includes('微视') || content.includes('光电')) return '深圳市微视光电科技有限公司';
            if (content.includes('天津') || content.includes('维森')) return '天津维森科技有限公司';
            if (content.includes('北京') || content.includes('智博')) return '北京智博检测设备有限公司';
            return '其他供应商';
        }

        function extractNewsCategoryFromContent(content) {
            if (!content) return '其他';
            if (content.includes('汽车') || content.includes('制造业')) return '行业动态';
            if (content.includes('展会') || content.includes('展览')) return '展会信息';
            if (content.includes('产品') || content.includes('发布')) return '产品发布';
            if (content.includes('技术') || content.includes('突破')) return '技术资讯';
            return '其他';
        }

        function extractCaseCategoryFromContent(content) {
            if (!content) return '其他';
            if (content.includes('汽车') || content.includes('发动机')) return '汽车制造';
            if (content.includes('航空') || content.includes('叶片')) return '航空航天';
            if (content.includes('石油') || content.includes('管道')) return '石油化工';
            return '其他';
        }

        function extractIndustryFromContent(content) {
            if (!content) return '其他行业';
            if (content.includes('汽车')) return '汽车工业';
            if (content.includes('航空')) return '航空工业';
            if (content.includes('石油')) return '石油工业';
            return '其他行业';
        }

        // 更新仪表板
        function updateDashboard() {
            document.getElementById('productCount').textContent = projectData.products.length;
            document.getElementById('supplierCount').textContent = projectData.suppliers.length;
            document.getElementById('newsCount').textContent = projectData.news.length;
            document.getElementById('caseCount').textContent = projectData.cases.length;

            // 更新最近活动
            updateRecentActivities();
        }

        // 更新最近活动
        function updateRecentActivities() {
            const tbody = document.getElementById('recentActivities');
            const allItems = [
                ...projectData.products.map(item => ({...item, type: '产品'})),
                ...projectData.news.map(item => ({...item, type: '资讯'})),
                ...projectData.cases.map(item => ({...item, type: '案例'})),
                ...projectData.applications.map(item => ({...item, type: '应用'}))
            ];

            // 按日期排序，取最新的10条
            allItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentItems = allItems.slice(0, 10);

            if (recentItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = recentItems.map(item => `
                <tr>
                    <td>${item.date}</td>
                    <td><span class="badge bg-primary">${item.type}</span></td>
                    <td>${item.title}</td>
                    <td><span class="status-badge status-${item.status}">${item.status === 'published' ? '已发布' : '草稿'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editItem('${item.type.toLowerCase()}', '${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteItem('${item.type.toLowerCase()}', '${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 更新产品列表
        function updateProductList() {
            const tbody = document.getElementById('productList');

            if (projectData.products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无产品数据</td></tr>';
                return;
            }

            tbody.innerHTML = projectData.products.map(product => `
                <tr>
                    <td>
                        <strong>${product.title}</strong>
                        <br><small class="text-muted">${product.summary}</small>
                    </td>
                    <td><code>${product.model}</code></td>
                    <td><span class="badge bg-info">${product.category}</span></td>
                    <td>${product.supplier}</td>
                    <td><span class="status-badge status-${product.status}">${product.status === 'published' ? '已发布' : '草稿'}</span></td>
                    <td>${product.date}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" onclick="editProduct('${product.id}')" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success btn-action" onclick="viewProduct('${product.id}')" title="查看">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteProduct('${product.id}')" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 页面切换
        function showSection(sectionName) {
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // 移除所有导航链接的活跃状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 显示选中的内容区域
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // 设置对应导航链接为活跃状态
            event.target.classList.add('active');

            // 更新页面标题
            const titles = {
                'dashboard': '仪表板',
                'products': '产品管理',
                'suppliers': '供应商管理',
                'categories': '产品分类',
                'news': '资讯管理',
                'cases': '案例管理',
                'applications': '应用领域',
                'media': '媒体库',
                'settings': '系统设置'
            };

            document.getElementById('pageTitle').textContent = titles[sectionName] || '内容管理';

            // 根据不同页面加载相应数据
            switch(sectionName) {
                case 'products':
                    updateProductList();
                    break;
                case 'suppliers':
                    updateSupplierList();
                    break;
                case 'categories':
                    updateCategoryList();
                    break;
                case 'news':
                    updateNewsList();
                    break;
                case 'cases':
                    updateCaseList();
                    break;
                case 'applications':
                    updateApplicationList();
                    break;
            }
        }

        // 刷新数据
        function refreshData() {
            showSuccess('正在刷新数据...');
            loadProjectData();
        }

        // 产品搜索过滤
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#productList tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // 产品管理功能
        function addProduct() {
            showSuccess('添加产品功能开发中...');
        }

        function editProduct(id) {
            const product = projectData.products.find(p => p.id === id);
            if (product) {
                showSuccess(`编辑产品: ${product.title}`);
            }
        }

        function viewProduct(id) {
            const product = projectData.products.find(p => p.id === id);
            if (product) {
                window.open(product.uri, '_blank');
            }
        }

        function deleteProduct(id) {
            if (confirm('确定要删除这个产品吗？')) {
                showSuccess('删除产品功能开发中...');
            }
        }

        // 通用编辑和删除功能
        function editItem(type, id) {
            showSuccess(`编辑${type}: ${id}`);
        }

        function deleteItem(type, id) {
            if (confirm(`确定要删除这个${type}吗？`)) {
                showSuccess(`删除${type}功能开发中...`);
            }
        }

        // 显示添加模态框
        function showAddModal() {
            showSuccess('添加内容功能开发中...');
        }

        // 占位符函数 - 待实现
        function updateSupplierList() {
            console.log('更新供应商列表');
        }

        function updateCategoryList() {
            console.log('更新分类列表');
        }

        function updateNewsList() {
            console.log('更新资讯列表');
        }

        function updateCaseList() {
            console.log('更新案例列表');
        }

        function updateApplicationList() {
            console.log('更新应用列表');
        }
    </script>
</body>
</html>
