<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容管理器修复验证 - VisNDT管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .data-preview {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-tools me-2"></i>内容管理器修复验证
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    此页面用于验证content-manager.html的数据同步修复是否生效
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-database me-2"></i>数据加载器状态
                            </h5>
                            <div id="dataLoaderStatus">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin me-2"></i>正在检查...
                                </div>
                            </div>
                        </div>
                        
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-sync me-2"></i>数据同步测试
                            </h5>
                            <div id="dataSyncTest">
                                <div class="text-center text-muted">等待测试...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-list me-2"></i>内容列表测试
                            </h5>
                            <div id="contentListTest">
                                <button class="btn btn-primary me-2 mb-2" onclick="testProductsList()">
                                    <i class="fas fa-box me-1"></i>测试产品列表
                                </button>
                                <button class="btn btn-success me-2 mb-2" onclick="testNewsList()">
                                    <i class="fas fa-newspaper me-1"></i>测试资讯列表
                                </button>
                                <button class="btn btn-warning mb-2" onclick="testCasesList()">
                                    <i class="fas fa-briefcase me-1"></i>测试案例列表
                                </button>
                                <div id="listTestResults" class="mt-3"></div>
                            </div>
                        </div>
                        
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-chart-bar me-2"></i>统计数据测试
                            </h5>
                            <div id="statisticsTest">
                                <div class="text-center text-muted">等待测试...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-eye me-2"></i>数据预览
                            </h5>
                            <div id="dataPreview">
                                <div class="text-center text-muted">等待数据加载...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-external-link-alt me-2"></i>快速链接
                            </h5>
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="content-manager.html" class="btn btn-primary" target="_blank">
                                    <i class="fas fa-external-link-alt me-1"></i>打开内容管理器
                                </a>
                                <a href="debug-data-loading.html" class="btn btn-info" target="_blank">
                                    <i class="fas fa-bug me-1"></i>数据加载诊断
                                </a>
                                <a href="test-edit-product.html" class="btn btn-success" target="_blank">
                                    <i class="fas fa-edit me-1"></i>产品编辑测试
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data-loader.js"></script>
    <script src="admin-functions.js"></script>
    
    <script>
        let dataLoader;
        let testResults = {};

        async function runTests() {
            try {
                // 测试数据加载器
                await testDataLoader();
                
                // 测试数据同步
                await testDataSync();
                
                // 测试统计数据
                testStatistics();
                
                // 预览数据
                previewData();
                
            } catch (error) {
                console.error('测试失败:', error);
            }
        }

        async function testDataLoader() {
            const container = document.getElementById('dataLoaderStatus');
            
            try {
                if (typeof ContentDataLoader === 'undefined') {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times me-2"></i>ContentDataLoader 未定义
                        </div>
                    `;
                    return;
                }

                dataLoader = new ContentDataLoader();
                await dataLoader.loadAllData();

                const products = dataLoader.contentData?.products || [];
                const news = dataLoader.contentData?.news || [];
                const cases = dataLoader.contentData?.cases || [];

                testResults.dataLoader = {
                    success: true,
                    products: products.length,
                    news: news.length,
                    cases: cases.length
                };

                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>数据加载器工作正常
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><strong>产品:</strong> ${products.length} 个</li>
                        <li><strong>资讯:</strong> ${news.length} 个</li>
                        <li><strong>案例:</strong> ${cases.length} 个</li>
                    </ul>
                `;

                // 设置全局数据加载器
                window.contentDataLoader = dataLoader;

            } catch (error) {
                testResults.dataLoader = { success: false, error: error.message };
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times me-2"></i>数据加载失败: ${error.message}
                    </div>
                `;
            }
        }

        async function testDataSync() {
            const container = document.getElementById('dataSyncTest');
            
            if (!window.contentDataLoader) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>数据加载器未初始化
                    </div>
                `;
                return;
            }

            // 模拟content-manager.html中的数据同步逻辑
            const data = window.contentDataLoader.contentData;
            
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>数据同步测试通过
                </div>
                <div class="data-preview">
数据结构验证:
- products: ${data.products ? '✓' : '✗'} (${data.products?.length || 0} 个)
- news: ${data.news ? '✓' : '✗'} (${data.news?.length || 0} 个)  
- cases: ${data.cases ? '✓' : '✗'} (${data.cases?.length || 0} 个)
- categories: ${data.categories ? '✓' : '✗'} (${data.categories?.length || 0} 个)
- suppliers: ${data.suppliers ? '✓' : '✗'} (${data.suppliers?.length || 0} 个)
                </div>
            `;
        }

        function testStatistics() {
            const container = document.getElementById('statisticsTest');
            
            if (!window.contentDataLoader) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>数据加载器未初始化
                    </div>
                `;
                return;
            }

            const data = window.contentDataLoader.contentData;
            
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>统计数据正常
                </div>
                <div class="row text-center">
                    <div class="col-3">
                        <h4 class="text-primary">${data.products?.length || 0}</h4>
                        <small>产品</small>
                    </div>
                    <div class="col-3">
                        <h4 class="text-success">${data.news?.length || 0}</h4>
                        <small>资讯</small>
                    </div>
                    <div class="col-3">
                        <h4 class="text-warning">${data.cases?.length || 0}</h4>
                        <small>案例</small>
                    </div>
                    <div class="col-3">
                        <h4 class="text-info">${data.categories?.length || 0}</h4>
                        <small>分类</small>
                    </div>
                </div>
            `;
        }

        function previewData() {
            const container = document.getElementById('dataPreview');
            
            if (!window.contentDataLoader) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>数据加载器未初始化
                    </div>
                `;
                return;
            }

            const data = window.contentDataLoader.contentData;
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <h6>产品示例</h6>
                        <div class="data-preview">
${(data.products || []).slice(0, 3).map(p => `${p.id}: ${p.title}`).join('\n')}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>资讯示例</h6>
                        <div class="data-preview">
${(data.news || []).slice(0, 3).map(n => `${n.id}: ${n.title}`).join('\n')}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>案例示例</h6>
                        <div class="data-preview">
${(data.cases || []).slice(0, 3).map(c => `${c.id}: ${c.title}`).join('\n')}
                        </div>
                    </div>
                </div>
            `;
        }

        function testProductsList() {
            testContentList('products', '产品');
        }

        function testNewsList() {
            testContentList('news', '资讯');
        }

        function testCasesList() {
            testContentList('cases', '案例');
        }

        function testContentList(type, typeName) {
            const container = document.getElementById('listTestResults');
            
            if (!window.contentDataLoader) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>数据加载器未初始化
                    </div>
                `;
                return;
            }

            const data = window.contentDataLoader.contentData;
            const items = data[type] || [];
            
            container.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check me-2"></i>${typeName}列表测试通过
                </div>
                <div class="data-preview">
${typeName}数据 (${items.length} 个):
${items.slice(0, 5).map((item, index) => `${index + 1}. ${item.title || item.id}`).join('\n')}
${items.length > 5 ? `... 还有 ${items.length - 5} 个` : ''}
                </div>
            `;
        }

        // 页面加载时运行测试
        document.addEventListener('DOMContentLoaded', function() {
            runTests();
        });
    </script>
</body>
</html>
