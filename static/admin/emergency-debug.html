<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç´§æ€¥è°ƒè¯• - äº§å“åˆ—è¡¨é—®é¢˜</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-section { background: white; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f5fff5; }
        .warning { border-left-color: #ffc107; background: #fffbf0; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; }
    </style>
</head>
<body>
    <h1>ğŸš¨ ç´§æ€¥è°ƒè¯• - äº§å“åˆ—è¡¨åŠ è½½å¤±è´¥</h1>
    
    <div class="debug-section">
        <h3>æ­¥éª¤1: åŸºç¡€ç¯å¢ƒæ£€æŸ¥</h3>
        <button onclick="checkBasicEnvironment()">æ£€æŸ¥åŸºç¡€ç¯å¢ƒ</button>
        <div id="basic-env-result"></div>
    </div>

    <div class="debug-section">
        <h3>æ­¥éª¤2: JavaScriptæ–‡ä»¶åŠ è½½æ£€æŸ¥</h3>
        <button onclick="checkJSFiles()">æ£€æŸ¥JSæ–‡ä»¶</button>
        <div id="js-files-result"></div>
    </div>

    <div class="debug-section">
        <h3>æ­¥éª¤3: ç½‘ç»œè¯·æ±‚æ£€æŸ¥</h3>
        <button onclick="checkNetworkRequests()">æ£€æŸ¥ç½‘ç»œè¯·æ±‚</button>
        <div id="network-result"></div>
    </div>

    <div class="debug-section">
        <h3>æ­¥éª¤4: æ•°æ®åŠ è½½å™¨æµ‹è¯•</h3>
        <button onclick="testDataLoader()">æµ‹è¯•æ•°æ®åŠ è½½å™¨</button>
        <div id="data-loader-result"></div>
    </div>

    <div class="debug-section">
        <h3>æ­¥éª¤5: æ‰‹åŠ¨æ¨¡æ‹Ÿäº§å“åˆ—è¡¨</h3>
        <button onclick="simulateProductList()">æ¨¡æ‹Ÿäº§å“åˆ—è¡¨</button>
        <div id="simulate-result"></div>
    </div>

    <div class="debug-section">
        <h3>æ­¥éª¤6: ç›´æ¥æ£€æŸ¥content-manager.html</h3>
        <button onclick="checkContentManager()">æ£€æŸ¥å†…å®¹ç®¡ç†å™¨</button>
        <div id="content-manager-result"></div>
    </div>

    <div class="debug-section">
        <h3>å®æ—¶æ§åˆ¶å°æ—¥å¿—</h3>
        <button onclick="clearConsoleLog()">æ¸…ç©ºæ—¥å¿—</button>
        <pre id="console-output">ç­‰å¾…æ—¥å¿—è¾“å‡º...</pre>
    </div>

    <div class="debug-section">
        <h3>å¿«é€Ÿä¿®å¤å°è¯•</h3>
        <button class="btn-warning" onclick="quickFix1()">ä¿®å¤1: é‡æ–°åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨</button>
        <button class="btn-warning" onclick="quickFix2()">ä¿®å¤2: å¼ºåˆ¶é‡æ–°åŠ è½½äº§å“æ•°æ®</button>
        <button class="btn-danger" onclick="emergencyFix()">ç´§æ€¥ä¿®å¤: ä½¿ç”¨å¤‡ç”¨æ•°æ®</button>
        <div id="quick-fix-result"></div>
    </div>

    <script>
        let consoleMessages = [];

        // æ•è·æ‰€æœ‰æ§åˆ¶å°è¾“å‡º
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleMessage('LOG', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleMessage('ERROR', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleMessage('WARN', args.join(' '));
        };

        function addConsoleMessage(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleMessages.push(`[${timestamp}] ${type}: ${message}`);
            updateConsoleDisplay();
        }

        function updateConsoleDisplay() {
            document.getElementById('console-output').textContent = consoleMessages.join('\n');
        }

        function clearConsoleLog() {
            consoleMessages = [];
            updateConsoleDisplay();
        }

        function checkBasicEnvironment() {
            const result = document.getElementById('basic-env-result');
            console.log('å¼€å§‹åŸºç¡€ç¯å¢ƒæ£€æŸ¥...');
            
            let html = '<div class="code">';
            html += `å½“å‰URL: ${window.location.href}<br>`;
            html += `ç”¨æˆ·ä»£ç†: ${navigator.userAgent}<br>`;
            html += `åè®®: ${window.location.protocol}<br>`;
            html += `ä¸»æœº: ${window.location.host}<br>`;
            html += `è·¯å¾„: ${window.location.pathname}<br>`;
            html += '</div>';

            // æ£€æŸ¥å…¨å±€å¯¹è±¡
            html += '<h4>å…¨å±€å¯¹è±¡æ£€æŸ¥:</h4><div class="code">';
            html += `window.ContentDataLoader: ${typeof window.ContentDataLoader}<br>`;
            html += `window.contentDataLoader: ${typeof window.contentDataLoader}<br>`;
            html += `window.showProductsList: ${typeof window.showProductsList}<br>`;
            html += `window.showContentList: ${typeof window.showContentList}<br>`;
            html += `window.ensureDataLoaderInitialized: ${typeof window.ensureDataLoaderInitialized}<br>`;
            html += '</div>';

            result.innerHTML = html;
            result.className = 'debug-section success';
        }

        function checkJSFiles() {
            const result = document.getElementById('js-files-result');
            console.log('å¼€å§‹æ£€æŸ¥JavaScriptæ–‡ä»¶...');
            
            let html = '<h4>JavaScriptæ–‡ä»¶åŠ è½½çŠ¶æ€:</h4><div class="code">';
            
            // æ£€æŸ¥è„šæœ¬æ ‡ç­¾
            const scripts = document.querySelectorAll('script[src]');
            scripts.forEach(script => {
                html += `${script.src}: ${script.readyState || 'å·²åŠ è½½'}<br>`;
            });
            
            html += '</div><h4>å…³é”®å‡½æ•°æ£€æŸ¥:</h4><div class="code">';
            
            // æ£€æŸ¥å…³é”®å‡½æ•°
            const functions = [
                'ContentDataLoader',
                'showProductsList', 
                'showContentList',
                'ensureDataLoaderInitialized',
                'loadProductsList',
                'renderTableRows'
            ];
            
            functions.forEach(func => {
                const exists = typeof window[func] !== 'undefined';
                html += `${func}: ${exists ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
            });
            
            html += '</div>';
            result.innerHTML = html;
            result.className = exists ? 'debug-section success' : 'debug-section error';
        }

        async function checkNetworkRequests() {
            const result = document.getElementById('network-result');
            console.log('å¼€å§‹æ£€æŸ¥ç½‘ç»œè¯·æ±‚...');
            
            const testUrls = [
                '/admin/data-loader.js',
                '/admin/admin-functions.js',
                '/admin/content-manager.html',
                '/products/WS-K08510-a/index.md',
                '/api/products.json'
            ];

            let html = '<h4>ç½‘ç»œè¯·æ±‚æµ‹è¯•:</h4><div class="code">';
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url);
                    html += `${url}: ${response.status} ${response.statusText}<br>`;
                } catch (error) {
                    html += `${url}: âŒ ${error.message}<br>`;
                }
            }
            
            html += '</div>';
            result.innerHTML = html;
            result.className = 'debug-section warning';
        }

        async function testDataLoader() {
            const result = document.getElementById('data-loader-result');
            console.log('å¼€å§‹æµ‹è¯•æ•°æ®åŠ è½½å™¨...');
            
            try {
                // åŠ¨æ€åŠ è½½data-loader.js
                if (typeof ContentDataLoader === 'undefined') {
                    console.log('ContentDataLoaderæœªå®šä¹‰ï¼Œå°è¯•åŠ¨æ€åŠ è½½...');
                    await loadScript('/admin/data-loader.js');
                }

                if (typeof ContentDataLoader === 'undefined') {
                    throw new Error('æ— æ³•åŠ è½½ContentDataLoaderç±»');
                }

                const loader = new ContentDataLoader();
                console.log('ContentDataLoaderå®ä¾‹åˆ›å»ºæˆåŠŸ');
                
                await loader.loadAllData();
                console.log('æ•°æ®åŠ è½½å®Œæˆ');

                const products = loader.contentData?.products || [];
                const news = loader.contentData?.news || [];
                const cases = loader.contentData?.cases || [];

                let html = '<div class="code">';
                html += `âœ… ContentDataLoaderæµ‹è¯•æˆåŠŸ<br>`;
                html += `äº§å“æ•°é‡: ${products.length}<br>`;
                html += `èµ„è®¯æ•°é‡: ${news.length}<br>`;
                html += `æ¡ˆä¾‹æ•°é‡: ${cases.length}<br>`;
                
                if (products.length > 0) {
                    html += `<br>ç¬¬ä¸€ä¸ªäº§å“: ${products[0].title || products[0].id}<br>`;
                    html += `äº§å“å­—æ®µ: ${Object.keys(products[0]).join(', ')}<br>`;
                }
                
                html += '</div>';
                result.innerHTML = html;
                result.className = 'debug-section success';

                // è®¾ç½®å…¨å±€æ•°æ®åŠ è½½å™¨
                window.contentDataLoader = loader;
                console.log('å…¨å±€æ•°æ®åŠ è½½å™¨å·²è®¾ç½®');

            } catch (error) {
                console.error('æ•°æ®åŠ è½½å™¨æµ‹è¯•å¤±è´¥:', error);
                result.innerHTML = `<div class="code">âŒ æ•°æ®åŠ è½½å™¨æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function simulateProductList() {
            const result = document.getElementById('simulate-result');
            console.log('å¼€å§‹æ¨¡æ‹Ÿäº§å“åˆ—è¡¨...');
            
            try {
                // ç¡®ä¿æ•°æ®åŠ è½½å™¨å­˜åœ¨
                if (!window.contentDataLoader) {
                    await testDataLoader();
                }

                if (!window.contentDataLoader) {
                    throw new Error('æ•°æ®åŠ è½½å™¨ä¸å¯ç”¨');
                }

                const products = window.contentDataLoader.contentData?.products || [];
                
                if (products.length === 0) {
                    throw new Error('æ²¡æœ‰äº§å“æ•°æ®');
                }

                // æ¨¡æ‹Ÿæ¸²æŸ“äº§å“åˆ—è¡¨
                let html = '<h4>æ¨¡æ‹Ÿäº§å“åˆ—è¡¨:</h4>';
                html += '<table border="1" style="width:100%; border-collapse: collapse;">';
                html += '<tr><th>ID</th><th>æ ‡é¢˜</th><th>å‹å·</th><th>ç³»åˆ—</th><th>çŠ¶æ€</th></tr>';
                
                products.slice(0, 5).forEach(product => {
                    html += `<tr>
                        <td>${product.id || '-'}</td>
                        <td>${product.title || 'æœªå‘½å'}</td>
                        <td>${product.model || '-'}</td>
                        <td>${product.series || '-'}</td>
                        <td>${product.status || 'published'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                html += `<p>æ˜¾ç¤ºå‰5ä¸ªäº§å“ï¼Œæ€»å…±${products.length}ä¸ªäº§å“</p>`;
                
                result.innerHTML = html;
                result.className = 'debug-section success';

            } catch (error) {
                console.error('æ¨¡æ‹Ÿäº§å“åˆ—è¡¨å¤±è´¥:', error);
                result.innerHTML = `<div class="code">âŒ æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        async function checkContentManager() {
            const result = document.getElementById('content-manager-result');
            console.log('å¼€å§‹æ£€æŸ¥å†…å®¹ç®¡ç†å™¨...');
            
            try {
                // æ£€æŸ¥content-manager.htmlæ˜¯å¦å¯è®¿é—®
                const response = await fetch('/admin/content-manager.html');
                if (!response.ok) {
                    throw new Error(`æ— æ³•è®¿é—®content-manager.html: ${response.status}`);
                }

                const html = await response.text();
                
                // æ£€æŸ¥å…³é”®å‡½æ•°æ˜¯å¦åœ¨HTMLä¸­å®šä¹‰
                const hasShowContentList = html.includes('function showContentList');
                const hasRenderTableRows = html.includes('function renderTableRows');
                const hasEnsureDataSync = html.includes('function ensureDataSync');

                let resultHtml = '<div class="code">';
                resultHtml += `âœ… content-manager.htmlå¯è®¿é—®<br>`;
                resultHtml += `showContentListå‡½æ•°: ${hasShowContentList ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
                resultHtml += `renderTableRowså‡½æ•°: ${hasRenderTableRows ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
                resultHtml += `ensureDataSyncå‡½æ•°: ${hasEnsureDataSync ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}<br>`;
                resultHtml += `æ–‡ä»¶å¤§å°: ${(html.length / 1024).toFixed(2)} KB<br>`;
                resultHtml += '</div>';

                result.innerHTML = resultHtml;
                result.className = 'debug-section success';

            } catch (error) {
                console.error('æ£€æŸ¥å†…å®¹ç®¡ç†å™¨å¤±è´¥:', error);
                result.innerHTML = `<div class="code">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        async function quickFix1() {
            const result = document.getElementById('quick-fix-result');
            console.log('å°è¯•ä¿®å¤1: é‡æ–°åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨...');
            
            try {
                // å¼ºåˆ¶é‡æ–°åŠ è½½data-loader.js
                await loadScript('/admin/data-loader.js?t=' + Date.now());
                
                // é‡æ–°åˆ›å»ºæ•°æ®åŠ è½½å™¨
                window.contentDataLoader = new ContentDataLoader();
                await window.contentDataLoader.loadAllData();
                
                result.innerHTML = '<div class="code">âœ… ä¿®å¤1æˆåŠŸ: æ•°æ®åŠ è½½å™¨å·²é‡æ–°åˆå§‹åŒ–</div>';
                result.className = 'debug-section success';
                
            } catch (error) {
                result.innerHTML = `<div class="code">âŒ ä¿®å¤1å¤±è´¥: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        async function quickFix2() {
            const result = document.getElementById('quick-fix-result');
            console.log('å°è¯•ä¿®å¤2: å¼ºåˆ¶é‡æ–°åŠ è½½äº§å“æ•°æ®...');
            
            try {
                if (!window.contentDataLoader) {
                    window.contentDataLoader = new ContentDataLoader();
                }
                
                // å¼ºåˆ¶é‡æ–°åŠ è½½äº§å“æ•°æ®
                await window.contentDataLoader.loadProducts();
                
                const productCount = window.contentDataLoader.contentData?.products?.length || 0;
                result.innerHTML = `<div class="code">âœ… ä¿®å¤2æˆåŠŸ: å·²é‡æ–°åŠ è½½${productCount}ä¸ªäº§å“</div>`;
                result.className = 'debug-section success';
                
            } catch (error) {
                result.innerHTML = `<div class="code">âŒ ä¿®å¤2å¤±è´¥: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        function emergencyFix() {
            const result = document.getElementById('quick-fix-result');
            console.log('æ‰§è¡Œç´§æ€¥ä¿®å¤: ä½¿ç”¨å¤‡ç”¨æ•°æ®...');
            
            // åˆ›å»ºå¤‡ç”¨äº§å“æ•°æ®
            const emergencyProducts = [
                {
                    id: 'emergency-product-1',
                    title: 'ç´§æ€¥å¤‡ç”¨äº§å“1',
                    model: 'EMERGENCY-001',
                    series: 'å¤‡ç”¨ç³»åˆ—',
                    status: 'published',
                    primary_category: 'ç”µå­å†…çª¥é•œ',
                    thumbnail: '/images/placeholder.jpg'
                },
                {
                    id: 'emergency-product-2', 
                    title: 'ç´§æ€¥å¤‡ç”¨äº§å“2',
                    model: 'EMERGENCY-002',
                    series: 'å¤‡ç”¨ç³»åˆ—',
                    status: 'published',
                    primary_category: 'ç”µå­å†…çª¥é•œ',
                    thumbnail: '/images/placeholder.jpg'
                }
            ];

            // åˆ›å»ºç´§æ€¥æ•°æ®åŠ è½½å™¨
            window.contentDataLoader = {
                contentData: {
                    products: emergencyProducts,
                    news: [],
                    cases: [],
                    categories: [],
                    suppliers: []
                }
            };

            result.innerHTML = `<div class="code">âš ï¸ ç´§æ€¥ä¿®å¤å®Œæˆ: å·²è®¾ç½®${emergencyProducts.length}ä¸ªå¤‡ç”¨äº§å“</div>`;
            result.className = 'debug-section warning';
            
            // å°è¯•æ‰“å¼€å†…å®¹ç®¡ç†å™¨
            setTimeout(() => {
                window.open('/admin/content-manager.html', '_blank');
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç´§æ€¥è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
            setTimeout(checkBasicEnvironment, 500);
        });
    </script>
</body>
</html>
