<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆä¿®å¤æµ‹è¯• - VisNDT</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-card { background: white; margin: 15px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        .info { border-left: 4px solid #17a2b8; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .status { font-weight: bold; padding: 5px 10px; border-radius: 3px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ æœ€ç»ˆä¿®å¤æµ‹è¯•</h1>
        <p>æµ‹è¯•äº§å“åˆ—è¡¨åŠ è½½çš„æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ</p>

        <div class="test-card info">
            <h3>æµ‹è¯•çŠ¶æ€</h3>
            <div id="test-status">
                <span class="status status-warning">ç­‰å¾…æµ‹è¯•</span>
            </div>
        </div>

        <div class="test-card">
            <h3>å¿«é€Ÿæµ‹è¯•</h3>
            <button class="btn-primary" onclick="runQuickTest()">è¿è¡Œå¿«é€Ÿæµ‹è¯•</button>
            <button class="btn-success" onclick="openContentManager()">æ‰“å¼€å†…å®¹ç®¡ç†å™¨</button>
            <button class="btn-warning" onclick="openEmergencyDebug()">æ‰“å¼€ç´§æ€¥è°ƒè¯•</button>
            <button class="btn-danger" onclick="forceReset()">å¼ºåˆ¶é‡ç½®</button>
        </div>

        <div class="test-card">
            <h3>è¯¦ç»†æµ‹è¯•ç»“æœ</h3>
            <div id="test-results">
                <p>ç‚¹å‡»"è¿è¡Œå¿«é€Ÿæµ‹è¯•"å¼€å§‹æµ‹è¯•...</p>
            </div>
        </div>

        <div class="test-card">
            <h3>æµ‹è¯•æ—¥å¿—</h3>
            <div id="test-log" class="log">
                ç­‰å¾…æµ‹è¯•å¼€å§‹...
            </div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-card">
            <h3>æ‰‹åŠ¨éªŒè¯æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡»"è¿è¡Œå¿«é€Ÿæµ‹è¯•"æŒ‰é’®</li>
                <li>æ£€æŸ¥æµ‹è¯•ç»“æœæ˜¯å¦æ˜¾ç¤ºæˆåŠŸ</li>
                <li>ç‚¹å‡»"æ‰“å¼€å†…å®¹ç®¡ç†å™¨"</li>
                <li>åœ¨å†…å®¹ç®¡ç†å™¨ä¸­ç‚¹å‡»"äº§å“åˆ—è¡¨"</li>
                <li>éªŒè¯äº§å“åˆ—è¡¨æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
            </ol>
        </div>
    </div>

    <script>
        let testLog = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            testLog.push(logEntry);
            updateLogDisplay();
            console.log(logEntry);
        }

        function updateLogDisplay() {
            document.getElementById('test-log').textContent = testLog.join('\n');
        }

        function clearLog() {
            testLog = [];
            updateLogDisplay();
        }

        function updateTestStatus(status, message) {
            const statusElement = document.getElementById('test-status');
            const className = status === 'success' ? 'status-success' : 
                             status === 'error' ? 'status-error' : 'status-warning';
            statusElement.innerHTML = `<span class="status ${className}">${message}</span>`;
        }

        async function runQuickTest() {
            addLog('å¼€å§‹è¿è¡Œå¿«é€Ÿæµ‹è¯•');
            updateTestStatus('warning', 'æµ‹è¯•ä¸­...');
            
            const results = document.getElementById('test-results');
            results.innerHTML = '<p>ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...</p>';

            try {
                let testResults = [];
                let passedTests = 0;
                let totalTests = 0;

                // æµ‹è¯•1: æ£€æŸ¥åŸºç¡€ç¯å¢ƒ
                totalTests++;
                addLog('æµ‹è¯•1: æ£€æŸ¥åŸºç¡€ç¯å¢ƒ');
                try {
                    const hasWindow = typeof window !== 'undefined';
                    const hasDocument = typeof document !== 'undefined';
                    const hasConsole = typeof console !== 'undefined';
                    
                    if (hasWindow && hasDocument && hasConsole) {
                        testResults.push('âœ… åŸºç¡€ç¯å¢ƒæ£€æŸ¥é€šè¿‡');
                        passedTests++;
                        addLog('åŸºç¡€ç¯å¢ƒæ£€æŸ¥é€šè¿‡');
                    } else {
                        testResults.push('âŒ åŸºç¡€ç¯å¢ƒæ£€æŸ¥å¤±è´¥');
                        addLog('åŸºç¡€ç¯å¢ƒæ£€æŸ¥å¤±è´¥', 'error');
                    }
                } catch (error) {
                    testResults.push('âŒ åŸºç¡€ç¯å¢ƒæ£€æŸ¥å¼‚å¸¸: ' + error.message);
                    addLog('åŸºç¡€ç¯å¢ƒæ£€æŸ¥å¼‚å¸¸: ' + error.message, 'error');
                }

                // æµ‹è¯•2: æ£€æŸ¥ç½‘ç»œè¿æ¥
                totalTests++;
                addLog('æµ‹è¯•2: æ£€æŸ¥ç½‘ç»œè¿æ¥');
                try {
                    const response = await fetch('/admin/content-manager.html', { method: 'HEAD' });
                    if (response.ok) {
                        testResults.push('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸');
                        passedTests++;
                        addLog('ç½‘ç»œè¿æ¥æ­£å¸¸');
                    } else {
                        testResults.push('âŒ ç½‘ç»œè¿æ¥å¼‚å¸¸: ' + response.status);
                        addLog('ç½‘ç»œè¿æ¥å¼‚å¸¸: ' + response.status, 'error');
                    }
                } catch (error) {
                    testResults.push('âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ' + error.message);
                    addLog('ç½‘ç»œè¿æ¥å¤±è´¥: ' + error.message, 'error');
                }

                // æµ‹è¯•3: æ£€æŸ¥JavaScriptæ–‡ä»¶
                totalTests++;
                addLog('æµ‹è¯•3: æ£€æŸ¥JavaScriptæ–‡ä»¶');
                try {
                    const dataLoaderResponse = await fetch('/admin/data-loader.js', { method: 'HEAD' });
                    const adminFunctionsResponse = await fetch('/admin/admin-functions.js', { method: 'HEAD' });
                    
                    if (dataLoaderResponse.ok && adminFunctionsResponse.ok) {
                        testResults.push('âœ… JavaScriptæ–‡ä»¶å¯è®¿é—®');
                        passedTests++;
                        addLog('JavaScriptæ–‡ä»¶å¯è®¿é—®');
                    } else {
                        testResults.push('âŒ JavaScriptæ–‡ä»¶è®¿é—®å¤±è´¥');
                        addLog('JavaScriptæ–‡ä»¶è®¿é—®å¤±è´¥', 'error');
                    }
                } catch (error) {
                    testResults.push('âŒ JavaScriptæ–‡ä»¶æ£€æŸ¥å¼‚å¸¸: ' + error.message);
                    addLog('JavaScriptæ–‡ä»¶æ£€æŸ¥å¼‚å¸¸: ' + error.message, 'error');
                }

                // æµ‹è¯•4: åŠ¨æ€åŠ è½½æ•°æ®åŠ è½½å™¨
                totalTests++;
                addLog('æµ‹è¯•4: åŠ¨æ€åŠ è½½æ•°æ®åŠ è½½å™¨');
                try {
                    // åŠ¨æ€åŠ è½½data-loader.js
                    await loadScript('/admin/data-loader.js');
                    
                    if (typeof ContentDataLoader !== 'undefined') {
                        const loader = new ContentDataLoader();
                        await loader.loadAllData();
                        
                        const productCount = loader.contentData?.products?.length || 0;
                        testResults.push(`âœ… æ•°æ®åŠ è½½å™¨æµ‹è¯•é€šè¿‡ (${productCount}ä¸ªäº§å“)`);
                        passedTests++;
                        addLog(`æ•°æ®åŠ è½½å™¨æµ‹è¯•é€šè¿‡ï¼ŒåŠ è½½äº†${productCount}ä¸ªäº§å“`);
                        
                        // è®¾ç½®å…¨å±€æ•°æ®åŠ è½½å™¨
                        window.contentDataLoader = loader;
                        
                    } else {
                        testResults.push('âŒ ContentDataLoaderç±»æœªå®šä¹‰');
                        addLog('ContentDataLoaderç±»æœªå®šä¹‰', 'error');
                    }
                } catch (error) {
                    testResults.push('âŒ æ•°æ®åŠ è½½å™¨æµ‹è¯•å¤±è´¥: ' + error.message);
                    addLog('æ•°æ®åŠ è½½å™¨æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                }

                // æµ‹è¯•5: æ¨¡æ‹Ÿäº§å“åˆ—è¡¨æ˜¾ç¤º
                totalTests++;
                addLog('æµ‹è¯•5: æ¨¡æ‹Ÿäº§å“åˆ—è¡¨æ˜¾ç¤º');
                try {
                    if (window.contentDataLoader && window.contentDataLoader.contentData) {
                        const products = window.contentDataLoader.contentData.products || [];
                        
                        if (products.length > 0) {
                            // æ¨¡æ‹Ÿæ¸²æŸ“ç¬¬ä¸€ä¸ªäº§å“
                            const firstProduct = products[0];
                            const mockHtml = `
                                <tr>
                                    <td>${firstProduct.title || 'æœªå‘½åäº§å“'}</td>
                                    <td>${firstProduct.model || '-'}</td>
                                    <td>${firstProduct.series || '-'}</td>
                                    <td>${firstProduct.status || 'published'}</td>
                                </tr>
                            `;
                            
                            testResults.push(`âœ… äº§å“åˆ—è¡¨æ¨¡æ‹ŸæˆåŠŸ (é¦–ä¸ªäº§å“: ${firstProduct.title})`);
                            passedTests++;
                            addLog(`äº§å“åˆ—è¡¨æ¨¡æ‹ŸæˆåŠŸï¼Œé¦–ä¸ªäº§å“: ${firstProduct.title}`);
                        } else {
                            testResults.push('âš ï¸ äº§å“æ•°æ®ä¸ºç©º');
                            addLog('äº§å“æ•°æ®ä¸ºç©º', 'warning');
                        }
                    } else {
                        testResults.push('âŒ æ•°æ®åŠ è½½å™¨ä¸å¯ç”¨');
                        addLog('æ•°æ®åŠ è½½å™¨ä¸å¯ç”¨', 'error');
                    }
                } catch (error) {
                    testResults.push('âŒ äº§å“åˆ—è¡¨æ¨¡æ‹Ÿå¤±è´¥: ' + error.message);
                    addLog('äº§å“åˆ—è¡¨æ¨¡æ‹Ÿå¤±è´¥: ' + error.message, 'error');
                }

                // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                const successRate = Math.round((passedTests / totalTests) * 100);
                const overallStatus = passedTests === totalTests ? 'success' : 
                                    passedTests > totalTests / 2 ? 'warning' : 'error';

                results.innerHTML = `
                    <h4>æµ‹è¯•ç»“æœæ€»è§ˆ</h4>
                    <p><strong>é€šè¿‡ç‡: ${successRate}% (${passedTests}/${totalTests})</strong></p>
                    <ul>
                        ${testResults.map(result => `<li>${result}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 20px;">
                        <h5>å»ºè®®æ“ä½œ:</h5>
                        ${successRate >= 80 ? 
                            '<p style="color: green;">âœ… æµ‹è¯•åŸºæœ¬é€šè¿‡ï¼Œå¯ä»¥å°è¯•æ‰“å¼€å†…å®¹ç®¡ç†å™¨æµ‹è¯•äº§å“åˆ—è¡¨åŠŸèƒ½ã€‚</p>' :
                            '<p style="color: red;">âŒ æµ‹è¯•æœªå®Œå…¨é€šè¿‡ï¼Œå»ºè®®ä½¿ç”¨ç´§æ€¥è°ƒè¯•å·¥å…·è¿›ä¸€æ­¥æ’æŸ¥é—®é¢˜ã€‚</p>'
                        }
                    </div>
                `;

                updateTestStatus(overallStatus, 
                    overallStatus === 'success' ? 'æµ‹è¯•é€šè¿‡' : 
                    overallStatus === 'warning' ? 'éƒ¨åˆ†é€šè¿‡' : 'æµ‹è¯•å¤±è´¥'
                );

                addLog(`æµ‹è¯•å®Œæˆï¼Œé€šè¿‡ç‡: ${successRate}%`);

            } catch (error) {
                addLog('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ' + error.message, 'error');
                results.innerHTML = `<p style="color: red;">âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ${error.message}</p>`;
                updateTestStatus('error', 'æµ‹è¯•å¼‚å¸¸');
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = src + '?t=' + Date.now(); // æ·»åŠ æ—¶é—´æˆ³é¿å…ç¼“å­˜
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function openContentManager() {
            addLog('æ‰“å¼€å†…å®¹ç®¡ç†å™¨');
            window.open('/admin/content-manager.html', '_blank');
        }

        function openEmergencyDebug() {
            addLog('æ‰“å¼€ç´§æ€¥è°ƒè¯•å·¥å…·');
            window.open('/admin/emergency-debug.html', '_blank');
        }

        function forceReset() {
            addLog('æ‰§è¡Œå¼ºåˆ¶é‡ç½®');
            
            // æ¸…é™¤æ‰€æœ‰å…¨å±€å˜é‡
            if (window.contentDataLoader) {
                delete window.contentDataLoader;
            }
            if (window.ContentDataLoader) {
                delete window.ContentDataLoader;
            }
            
            // ç§»é™¤åŠ¨æ€åŠ è½½çš„è„šæœ¬
            const scripts = document.querySelectorAll('script[src*="data-loader"], script[src*="admin-functions"]');
            scripts.forEach(script => script.remove());
            
            // é‡ç½®æµ‹è¯•çŠ¶æ€
            updateTestStatus('warning', 'å·²é‡ç½®');
            document.getElementById('test-results').innerHTML = '<p>å·²æ‰§è¡Œå¼ºåˆ¶é‡ç½®ï¼Œè¯·é‡æ–°è¿è¡Œæµ‹è¯•ã€‚</p>';
            
            addLog('å¼ºåˆ¶é‡ç½®å®Œæˆ');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            addLog('å‡†å¤‡è¿è¡Œæµ‹è¯•ï¼Œè¯·ç‚¹å‡»"è¿è¡Œå¿«é€Ÿæµ‹è¯•"æŒ‰é’®');
        });
    </script>
</body>
</html>
