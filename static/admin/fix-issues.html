<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问题修复中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-tools"></i> 问题修复中心</h2>
        
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle"></i> 当前问题</h5>
            <ol>
                <li><strong>产品保存后后台列表显示一瞬间就消失</strong></li>
                <li><strong>图片显示异常（主图无法加载，编辑器显示路径）</strong></li>
                <li><strong>编辑器工具栏重复增加</strong></li>
            </ol>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-circle"></i> 问题1：列表显示</h5>
                    </div>
                    <div class="card-body">
                        <h6>症状：</h6>
                        <ul>
                            <li>产品保存后列表显示一瞬间就消失</li>
                            <li>MD文件正常但后台列表为空</li>
                        </ul>

                        <h6>原因：</h6>
                        <ul>
                            <li>延迟重新加载数据导致列表被清空</li>
                            <li>数据同步逻辑问题</li>
                        </ul>

                        <h6>解决方案：</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="fixBackendList()">
                                <i class="fas fa-sync"></i> 修复列表显示
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-image"></i> 问题2：图片显示</h5>
                    </div>
                    <div class="card-body">
                        <h6>症状：</h6>
                        <ul>
                            <li>产品主图无法加载（上传本地图片）</li>
                            <li>编辑器中图片显示为路径文本</li>
                            <li>图片预览异常</li>
                        </ul>

                        <h6>原因：</h6>
                        <ul>
                            <li>图片路径处理逻辑错误</li>
                            <li>base64数据和文件路径混淆</li>
                        </ul>

                        <h6>解决方案：</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="fixImageIssues()">
                                <i class="fas fa-image"></i> 修复图片显示
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-edit"></i> 问题3：编辑器工具栏</h5>
                    </div>
                    <div class="card-body">
                        <h6>症状：</h6>
                        <ul>
                            <li>每次打开产品表单工具栏增加</li>
                            <li>编辑器区域显示多个工具栏</li>
                            <li>影响用户体验</li>
                        </ul>
                        
                        <h6>原因：</h6>
                        <ul>
                            <li>编辑器清理机制不完善</li>
                            <li>重复初始化没有销毁旧实例</li>
                        </ul>
                        
                        <h6>解决方案：</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-info" onclick="testEditorCleanup()">
                                <i class="fas fa-broom"></i> 测试编辑器清理
                            </button>
                            <button class="btn btn-secondary" onclick="openManagerToTest()">
                                <i class="fas fa-external-link-alt"></i> 打开管理页面测试
                            </button>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>已修复：</strong>改进了编辑器清理机制，现在会正确销毁旧实例并清空容器。
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-check"></i> 修复状态</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div id="status-backend" class="badge bg-secondary fs-6 p-2 mb-2">未检查</div>
                                    <div>后台列表</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div id="status-images" class="badge bg-secondary fs-6 p-2 mb-2">未检查</div>
                                    <div>图片显示</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div id="status-editor" class="badge bg-success fs-6 p-2 mb-2">已修复</div>
                                    <div>编辑器工具栏</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div id="status-frontend" class="badge bg-secondary fs-6 p-2 mb-2">未检查</div>
                                    <div>前台页面</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <div id="status-overall" class="badge bg-warning fs-6 p-2 mb-2">进行中</div>
                                    <div>整体状态</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> 修复日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="fixLog" class="border p-3 bg-dark text-light" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;">
                            <div class="text-success">[系统] 问题修复中心准备就绪</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let managerWindow = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('fixLog');
            const timestamp = new Date().toLocaleTimeString();
            
            let color = 'text-info';
            let icon = 'ℹ️';
            
            switch(type) {
                case 'success':
                    color = 'text-success';
                    icon = '✅';
                    break;
                case 'error':
                    color = 'text-danger';
                    icon = '❌';
                    break;
                case 'warning':
                    color = 'text-warning';
                    icon = '⚠️';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `badge bg-${status} fs-6 p-2 mb-2`;
            element.textContent = text;
        }

        async function fixBackendList() {
            log('开始修复后台列表显示问题...', 'info');
            updateStatus('status-backend', 'warning', '修复中');
            
            try {
                // 检查API连接
                const response = await fetch('http://localhost:3002/api/products/list');
                const result = await response.json();
                
                if (result.success && result.products) {
                    log(`从API获取到 ${result.products.length} 个产品`, 'success');
                    updateStatus('status-backend', 'success', '已修复');
                    
                    // 打开管理页面并触发修复
                    if (!managerWindow || managerWindow.closed) {
                        managerWindow = window.open('/admin/complete-content-manager.html', 'manager');
                    }
                    
                    setTimeout(() => {
                        if (managerWindow && managerWindow.fixDisplayIssues) {
                            managerWindow.fixDisplayIssues();
                            log('已触发管理页面的显示修复功能', 'success');
                        }
                    }, 2000);
                    
                } else {
                    log('API返回数据异常', 'error');
                    updateStatus('status-backend', 'danger', '失败');
                }
                
            } catch (error) {
                log(`修复后台列表失败: ${error.message}`, 'error');
                updateStatus('status-backend', 'danger', '失败');
            }
        }

        function fixFrontendPages() {
            log('开始修复前台页面显示问题...', 'info');
            updateStatus('status-frontend', 'warning', '修复中');
            
            log('前台页面需要重新启动Hugo服务器', 'warning');
            
            const instructions = `
重启Hugo服务器步骤：

1. 停止当前Hugo服务器
   - 在终端按 Ctrl+C

2. 重新启动Hugo服务器
   - 运行命令: hugo server --port 1313

3. 等待重建完成
   - 看到 "Web Server is available at..." 消息

4. 验证修复结果
   - 访问前台产品中心页面
   - 检查新产品是否显示

重启后新产品将在前台页面显示。
            `;
            
            alert(instructions);
            log('已显示Hugo重启指导', 'info');
            updateStatus('status-frontend', 'warning', '需重启Hugo');
        }

        async function fixImageIssues() {
            log('开始修复图片显示问题...', 'info');
            updateStatus('status-images', 'warning', '修复中');

            try {
                if (!managerWindow || managerWindow.closed) {
                    managerWindow = window.open('/admin/complete-content-manager.html', 'manager');
                    log('已打开管理页面', 'info');

                    // 等待页面加载
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }

                if (managerWindow && managerWindow.fixImageIssues) {
                    managerWindow.fixImageIssues();
                    log('已触发图片修复功能', 'success');
                    updateStatus('status-images', 'success', '已修复');
                } else {
                    log('无法访问管理页面的修复功能', 'error');
                    updateStatus('status-images', 'danger', '失败');
                }

            } catch (error) {
                log(`修复图片问题失败: ${error.message}`, 'error');
                updateStatus('status-images', 'danger', '失败');
            }
        }

        async function fixBothIssues() {
            log('开始一键修复所有问题...', 'info');
            updateStatus('status-overall', 'warning', '修复中');

            // 先修复后台列表
            await fixBackendList();

            // 等待一下
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 修复图片问题
            await fixImageIssues();

            // 等待一下
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 然后处理前台页面
            fixFrontendPages();

            log('所有修复操作已完成', 'success');
            updateStatus('status-overall', 'success', '已完成');
        }

        function testEditorCleanup() {
            log('测试编辑器清理功能...', 'info');
            
            if (!managerWindow || managerWindow.closed) {
                managerWindow = window.open('/admin/complete-content-manager.html', 'manager');
                log('已打开管理页面', 'info');
            }
            
            log('请在管理页面多次点击"添加产品"按钮测试编辑器清理', 'info');
            log('如果工具栏不再重复，说明问题已修复', 'success');
        }

        function openManagerToTest() {
            managerWindow = window.open('/admin/complete-content-manager.html', 'manager');
            log('已打开管理页面，请测试编辑器功能', 'info');
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('问题修复中心加载完成', 'success');
            log('请根据需要选择修复方案', 'info');
        });
    </script>
</body>
</html>
