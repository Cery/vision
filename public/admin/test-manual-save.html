<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手动保存测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-hand-paper"></i> 手动保存测试指南</h2>
        
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle"></i> 问题描述</h5>
            <p>手动添加产品时，列表没有更新，项目文件也没有生成。</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list-ol"></i> 测试步骤</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item">
                                <h6 class="mb-1">步骤1: 打开管理页面</h6>
                                <p class="mb-1">在新窗口打开产品管理页面</p>
                                <button class="btn btn-sm btn-primary" onclick="openManager()">
                                    <i class="fas fa-external-link-alt"></i> 打开管理页面
                                </button>
                            </div>
                            
                            <div class="list-group-item">
                                <h6 class="mb-1">步骤2: 点击添加产品</h6>
                                <p class="mb-1">在管理页面点击"添加产品"按钮</p>
                                <button class="btn btn-sm btn-success" onclick="triggerAddProduct()">
                                    <i class="fas fa-plus"></i> 触发添加产品
                                </button>
                            </div>
                            
                            <div class="list-group-item">
                                <h6 class="mb-1">步骤3: 填写测试产品信息</h6>
                                <p class="mb-1">填写以下测试产品信息：</p>
                                <ul class="small">
                                    <li><strong>产品名称：</strong>测试光纤内窥镜</li>
                                    <li><strong>产品型号：</strong>TEST-001</li>
                                    <li><strong>主要分类：</strong>光纤内窥镜</li>
                                    <li><strong>次要分类：</strong>柔性光纤内窥镜</li>
                                    <li><strong>简要描述：</strong>这是一个测试产品</li>
                                </ul>
                                <button class="btn btn-sm btn-info" onclick="fillTestData()">
                                    <i class="fas fa-edit"></i> 自动填写测试数据
                                </button>
                            </div>
                            
                            <div class="list-group-item">
                                <h6 class="mb-1">步骤4: 使用调试保存</h6>
                                <p class="mb-1">点击"手动保存调试"按钮进行详细调试</p>
                                <button class="btn btn-sm btn-warning" onclick="triggerDebugSave()">
                                    <i class="fas fa-bug"></i> 触发调试保存
                                </button>
                            </div>
                            
                            <div class="list-group-item">
                                <h6 class="mb-1">步骤5: 验证结果</h6>
                                <p class="mb-1">检查保存结果和列表更新</p>
                                <button class="btn btn-sm btn-secondary" onclick="verifyResults()">
                                    <i class="fas fa-check"></i> 验证结果
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info"></i> 测试产品信息</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr><td><strong>名称</strong></td><td>测试光纤内窥镜</td></tr>
                            <tr><td><strong>型号</strong></td><td>TEST-001</td></tr>
                            <tr><td><strong>分类</strong></td><td>光纤内窥镜 → 柔性光纤内窥镜</td></tr>
                            <tr><td><strong>描述</strong></td><td>这是一个测试产品</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-check"></i> 检查清单</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check1">
                            <label class="form-check-label" for="check1">
                                管理页面已打开
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check2">
                            <label class="form-check-label" for="check2">
                                产品表单已填写
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check3">
                            <label class="form-check-label" for="check3">
                                调试保存已执行
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check4">
                            <label class="form-check-label" for="check4">
                                控制台无错误
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="check5">
                            <label class="form-check-label" for="check5">
                                产品列表已更新
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> 测试日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="testLog" class="border p-3 bg-dark text-light" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;">
                            <div class="text-success">[系统] 手动保存测试准备就绪</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let managerWindow = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            
            let color = 'text-info';
            let icon = 'ℹ️';
            
            switch(type) {
                case 'success':
                    color = 'text-success';
                    icon = '✅';
                    break;
                case 'error':
                    color = 'text-danger';
                    icon = '❌';
                    break;
                case 'warning':
                    color = 'text-warning';
                    icon = '⚠️';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function openManager() {
            log('打开产品管理页面...', 'info');
            managerWindow = window.open('/admin/complete-content-manager.html', 'manager', 'width=1400,height=900');
            if (managerWindow) {
                log('管理页面已在新窗口打开', 'success');
                document.getElementById('check1').checked = true;
            } else {
                log('无法打开管理页面，请检查弹窗拦截设置', 'error');
            }
        }

        function triggerAddProduct() {
            if (!managerWindow || managerWindow.closed) {
                log('请先打开管理页面', 'warning');
                return;
            }
            
            log('触发添加产品...', 'info');
            try {
                if (managerWindow.addProduct) {
                    managerWindow.addProduct();
                    log('产品添加表单已打开', 'success');
                } else {
                    log('管理页面未完全加载，请稍后重试', 'warning');
                }
            } catch (error) {
                log(`触发添加产品失败: ${error.message}`, 'error');
            }
        }

        function fillTestData() {
            if (!managerWindow || managerWindow.closed) {
                log('请先打开管理页面', 'warning');
                return;
            }
            
            log('自动填写测试数据...', 'info');
            try {
                const doc = managerWindow.document;
                
                // 填写基本信息
                const titleInput = doc.getElementById('productTitle');
                const modelInput = doc.getElementById('productModel');
                const summaryInput = doc.getElementById('productSummary');
                const primaryCategorySelect = doc.getElementById('productPrimaryCategory');
                const secondaryCategorySelect = doc.getElementById('productSecondaryCategory');
                
                if (titleInput) titleInput.value = '测试光纤内窥镜';
                if (modelInput) modelInput.value = 'TEST-001';
                if (summaryInput) summaryInput.value = '这是一个测试产品';
                if (primaryCategorySelect) primaryCategorySelect.value = '光纤内窥镜';
                
                // 触发次要分类更新
                if (managerWindow.updateSecondaryCategories) {
                    managerWindow.updateSecondaryCategories();
                    setTimeout(() => {
                        if (secondaryCategorySelect) {
                            secondaryCategorySelect.value = '柔性光纤内窥镜';
                        }
                    }, 500);
                }
                
                log('测试数据填写完成', 'success');
                document.getElementById('check2').checked = true;
                
            } catch (error) {
                log(`填写测试数据失败: ${error.message}`, 'error');
            }
        }

        function triggerDebugSave() {
            if (!managerWindow || managerWindow.closed) {
                log('请先打开管理页面', 'warning');
                return;
            }
            
            log('触发调试保存...', 'info');
            try {
                if (managerWindow.debugManualSave) {
                    managerWindow.debugManualSave();
                    log('调试保存已启动，请查看管理页面控制台', 'success');
                    document.getElementById('check3').checked = true;
                } else {
                    log('调试保存函数未找到，请确保管理页面已完全加载', 'warning');
                }
            } catch (error) {
                log(`触发调试保存失败: ${error.message}`, 'error');
            }
        }

        async function verifyResults() {
            log('验证保存结果...', 'info');
            
            try {
                // 检查API产品列表
                const response = await fetch('http://localhost:3002/api/products/list');
                const result = await response.json();
                
                if (result.success && result.products) {
                    const testProduct = result.products.find(p => p.id === 'TEST-001');
                    if (testProduct) {
                        log('✅ 在API列表中找到测试产品', 'success');
                        document.getElementById('check5').checked = true;
                    } else {
                        log('⚠️ API列表中未找到测试产品', 'warning');
                    }
                    log(`API列表包含 ${result.products.length} 个产品`, 'info');
                } else {
                    log('❌ 获取API产品列表失败', 'error');
                }
                
                // 检查文件是否存在
                try {
                    const fileResponse = await fetch('/content/products/TEST-001.md');
                    if (fileResponse.ok) {
                        log('✅ 测试产品MD文件已生成', 'success');
                    } else {
                        log('⚠️ 测试产品MD文件未找到', 'warning');
                    }
                } catch (fileError) {
                    log('❌ 检查MD文件失败', 'error');
                }
                
            } catch (error) {
                log(`验证结果失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('手动保存测试页面加载完成', 'success');
            log('请按步骤进行测试', 'info');
        });
    </script>
</body>
</html>
