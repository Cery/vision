<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整测试流程</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2><i class="fas fa-vial"></i> 光纤内窥镜产品完整测试流程</h2>
        
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> 测试说明</h5>
            <p>这个页面将引导您完成光纤内窥镜产品的完整测试流程，包括表单填写、保存和验证。</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list-ol"></i> 测试步骤</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">步骤1: API连接测试</h6>
                                    <p class="mb-1">验证服务器连接和API端点</p>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="testAPI()">
                                    <i class="fas fa-play"></i> 执行
                                </button>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">步骤2: 打开管理页面</h6>
                                    <p class="mb-1">在新窗口打开产品管理页面</p>
                                </div>
                                <button class="btn btn-sm btn-success" onclick="openManager()">
                                    <i class="fas fa-external-link-alt"></i> 打开
                                </button>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">步骤3: 快速填写表单</h6>
                                    <p class="mb-1">自动填写光纤内窥镜产品信息</p>
                                </div>
                                <button class="btn btn-sm btn-info" onclick="runQuickTest()">
                                    <i class="fas fa-bolt"></i> 快速填写
                                </button>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">步骤4: 调试保存功能</h6>
                                    <p class="mb-1">测试产品保存和MD文件生成</p>
                                </div>
                                <button class="btn btn-sm btn-warning" onclick="debugSave()">
                                    <i class="fas fa-bug"></i> 调试保存
                                </button>
                            </div>
                            
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">步骤5: 验证结果</h6>
                                    <p class="mb-1">检查生成的MD文件和数据</p>
                                </div>
                                <button class="btn btn-sm btn-secondary" onclick="verifyResults()">
                                    <i class="fas fa-check"></i> 验证
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info"></i> 测试产品</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr><td><strong>名称</strong></td><td>VF-8.5mm柔性光纤内窥镜</td></tr>
                            <tr><td><strong>型号</strong></td><td>VF-8500</td></tr>
                            <tr><td><strong>分类</strong></td><td>光纤内窥镜 → 柔性光纤内窥镜</td></tr>
                            <tr><td><strong>供应商</strong></td><td>VisNDT</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-link"></i> 快速链接</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/admin/complete-content-manager.html" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-cogs"></i> 管理页面
                            </a>
                            <a href="/admin/test-api.html" target="_blank" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-plug"></i> API测试
                            </a>
                            <a href="/content/products/" target="_blank" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-folder"></i> 产品目录
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> 测试日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="testLog" class="border p-3 bg-dark text-light" style="height: 300px; overflow-y: auto; font-family: 'Courier New', monospace;">
                            <div class="text-success">[系统] 测试环境准备就绪</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let managerWindow = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            
            let color = 'text-info';
            let icon = 'ℹ️';
            
            switch(type) {
                case 'success':
                    color = 'text-success';
                    icon = '✅';
                    break;
                case 'error':
                    color = 'text-danger';
                    icon = '❌';
                    break;
                case 'warning':
                    color = 'text-warning';
                    icon = '⚠️';
                    break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = color;
            logEntry.textContent = `[${timestamp}] ${icon} ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function testAPI() {
            log('开始API连接测试...', 'info');
            try {
                const response = await fetch('http://localhost:3002/api/products/status');
                const result = await response.json();
                log('API连接测试成功', 'success');
                log(`服务器状态: ${JSON.stringify(result)}`, 'info');
            } catch (error) {
                log(`API连接测试失败: ${error.message}`, 'error');
            }
        }

        function openManager() {
            log('打开产品管理页面...', 'info');
            managerWindow = window.open('/admin/complete-content-manager.html', 'manager', 'width=1200,height=800');
            if (managerWindow) {
                log('管理页面已在新窗口打开', 'success');
            } else {
                log('无法打开管理页面，请检查弹窗拦截设置', 'error');
            }
        }

        function runQuickTest() {
            if (!managerWindow || managerWindow.closed) {
                log('请先打开管理页面', 'warning');
                return;
            }
            
            log('执行快速表单填写测试...', 'info');
            try {
                if (managerWindow.quickTestProduct) {
                    managerWindow.quickTestProduct();
                    log('快速测试已启动', 'success');
                } else {
                    log('管理页面未完全加载，请稍后重试', 'warning');
                }
            } catch (error) {
                log(`快速测试失败: ${error.message}`, 'error');
            }
        }

        function debugSave() {
            if (!managerWindow || managerWindow.closed) {
                log('请先打开管理页面', 'warning');
                return;
            }
            
            log('执行保存功能调试...', 'info');
            try {
                if (managerWindow.debugSaveProduct) {
                    managerWindow.debugSaveProduct();
                    log('保存调试已启动', 'success');
                } else {
                    log('管理页面未完全加载，请稍后重试', 'warning');
                }
            } catch (error) {
                log(`保存调试失败: ${error.message}`, 'error');
            }
        }

        async function verifyResults() {
            log('验证测试结果...', 'info');
            try {
                // 检查产品列表
                const response = await fetch('http://localhost:3002/api/products/list');
                const result = await response.json();
                
                if (result.success && result.products) {
                    const vfProduct = result.products.find(p => p.model === 'VF-8500');
                    if (vfProduct) {
                        log('✅ 找到VF-8500产品，保存成功！', 'success');
                        log(`产品信息: ${vfProduct.title}`, 'info');
                    } else {
                        log('未找到VF-8500产品', 'warning');
                    }
                    log(`总共找到 ${result.products.length} 个产品`, 'info');
                } else {
                    log('获取产品列表失败', 'error');
                }
            } catch (error) {
                log(`验证失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('测试页面加载完成', 'success');
            log('请按顺序执行测试步骤', 'info');
        });
    </script>
</body>
</html>
