<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索索引测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 400px; }
        button { margin: 5px; padding: 8px 16px; }
        .stats { display: flex; gap: 20px; margin: 10px 0; }
        .stat-item { padding: 10px; background: #f8f9fa; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
    <h1>搜索索引数据测试</h1>
    
    <div class="test-section">
        <h3>搜索索引统计</h3>
        <button onclick="loadSearchIndex()">加载搜索索引</button>
        <div class="stats" id="stats"></div>
        <div id="searchIndexResult"></div>
    </div>
    
    <div class="test-section">
        <h3>产品数据详情</h3>
        <button onclick="showProductDetails()">显示产品详情</button>
        <button onclick="testProductFiltering()">测试产品过滤</button>
        <div id="productDetails"></div>
    </div>

    <div class="test-section">
        <h3>分类数据测试</h3>
        <button onclick="showCategoryDetails()">显示分类详情</button>
        <div id="categoryDetails"></div>
    </div>

    <script>
        let searchData = [];

        async function loadSearchIndex() {
            const resultDiv = document.getElementById('searchIndexResult');
            const statsDiv = document.getElementById('stats');
            
            try {
                const response = await fetch('/search-index.json');
                searchData = await response.json();
                
                // 统计各类型数据
                const stats = {
                    total: searchData.length,
                    products: searchData.filter(item => item.type === 'products').length,
                    suppliers: searchData.filter(item => item.type === 'suppliers').length,
                    news: searchData.filter(item => item.type === 'news').length,
                    cases: searchData.filter(item => item.type === 'cases').length,
                    applications: searchData.filter(item => item.type === 'applications').length,
                    categories: searchData.filter(item => item.type === 'categories').length
                };
                
                statsDiv.innerHTML = `
                    <div class="stat-item">
                        <strong>${stats.total}</strong><br>总记录
                    </div>
                    <div class="stat-item">
                        <strong>${stats.products}</strong><br>产品
                    </div>
                    <div class="stat-item">
                        <strong>${stats.suppliers}</strong><br>供应商
                    </div>
                    <div class="stat-item">
                        <strong>${stats.news}</strong><br>资讯
                    </div>
                    <div class="stat-item">
                        <strong>${stats.cases}</strong><br>案例
                    </div>
                    <div class="stat-item">
                        <strong>${stats.applications}</strong><br>应用领域
                    </div>
                `;
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <p>✅ 搜索索引加载成功！</p>
                        <h4>数据类型分布:</h4>
                        <pre>${JSON.stringify(stats, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <p>❌ 搜索索引加载失败: ${error.message}</p>
                    </div>
                `;
            }
        }

        function showProductDetails() {
            const resultDiv = document.getElementById('productDetails');
            
            if (searchData.length === 0) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <p>请先加载搜索索引</p>
                    </div>
                `;
                return;
            }
            
            const products = searchData.filter(item => 
                item.type === 'products' && 
                item.title && 
                item.title.trim() !== '' &&
                !item.uri.includes('_index') &&
                !item.uri.includes('model.md')
            );
            
            if (products.length === 0) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <p>❌ 未找到有效的产品数据</p>
                        <h4>所有products类型的记录:</h4>
                        <pre>${JSON.stringify(searchData.filter(item => item.type === 'products'), null, 2)}</pre>
                    </div>
                `;
                return;
            }
            
            resultDiv.innerHTML = `
                <div class="success">
                    <p>✅ 找到 ${products.length} 个有效产品</p>
                    <h4>产品列表:</h4>
                    <pre>${JSON.stringify(products.map(p => ({
                        title: p.title,
                        model: p.params?.model,
                        supplier: p.params?.supplier,
                        uri: p.uri,
                        type: p.type
                    })), null, 2)}</pre>

                    <h4>第一个产品的完整数据:</h4>
                    <pre>${JSON.stringify(products[0], null, 2)}</pre>
                </div>
            `;
        }

        function testProductFiltering() {
            const resultDiv = document.getElementById('productDetails');

            if (searchData.length === 0) {
                resultDiv.innerHTML = `<div class="error"><p>请先加载搜索索引</p></div>`;
                return;
            }

            // 测试产品过滤逻辑（模拟内容管理系统的逻辑）
            const allProductPages = searchData.filter(page => page.type === 'products');
            const validProductPages = allProductPages.filter(page =>
                page.title && page.title.trim() !== '' &&
                !page.uri.includes('_index') &&
                !page.uri.includes('model.md')
            );

            resultDiv.innerHTML = `
                <div class="success">
                    <h4>产品过滤测试结果:</h4>
                    <p>所有products类型页面: ${allProductPages.length} 个</p>
                    <p>过滤后有效页面: ${validProductPages.length} 个</p>

                    <h5>所有products类型页面:</h5>
                    <pre>${JSON.stringify(allProductPages.map(p => ({
                        title: p.title,
                        uri: p.uri,
                        hasTitle: !!p.title,
                        titleTrimmed: p.title ? p.title.trim() : '',
                        isIndex: p.uri.includes('_index'),
                        isModel: p.uri.includes('model.md')
                    })), null, 2)}</pre>
                </div>
            `;
        }

        function showCategoryDetails() {
            const resultDiv = document.getElementById('categoryDetails');

            if (searchData.length === 0) {
                resultDiv.innerHTML = `<div class="error"><p>请先加载搜索索引</p></div>`;
                return;
            }

            // 从产品数据中提取分类（模拟内容管理系统的逻辑）
            const products = searchData.filter(page =>
                page.type === 'products' &&
                page.title && page.title.trim() !== '' &&
                !page.uri.includes('_index') &&
                !page.uri.includes('model.md')
            );

            const categorySet = new Set();
            products.forEach(product => {
                if (product.params?.primary_category) {
                    categorySet.add(product.params.primary_category);
                }
                if (product.params?.secondary_category) {
                    categorySet.add(product.params.secondary_category);
                }
            });

            const categories = Array.from(categorySet).map((name, index) => ({
                id: `category-${index + 1}`,
                name: name,
                product_count: products.filter(p =>
                    p.params?.primary_category === name || p.params?.secondary_category === name
                ).length
            }));

            resultDiv.innerHTML = `
                <div class="success">
                    <p>✅ 从 ${products.length} 个产品中提取到 ${categories.length} 个分类</p>
                    <h4>分类列表:</h4>
                    <pre>${JSON.stringify(categories, null, 2)}</pre>
                </div>
            `;
        }
    </script>
</body>
</html>
