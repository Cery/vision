<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品列表修复验证 - VisNDT管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .log-output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .product-preview {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-tools me-2"></i>产品列表修复验证
                </h2>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    此页面用于验证产品列表加载修复是否生效
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-database me-2"></i>数据加载器测试
                            </h5>
                            <div id="dataLoaderTest">
                                <div class="text-center">
                                    <i class="fas fa-spinner fa-spin me-2"></i>正在测试...
                                </div>
                            </div>
                        </div>
                        
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-list me-2"></i>产品列表加载测试
                            </h5>
                            <div id="productListTest">
                                <button class="btn btn-primary" onclick="testProductListLoading()">
                                    <i class="fas fa-play me-2"></i>开始测试
                                </button>
                                <div id="productListResults" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-eye me-2"></i>产品数据预览
                            </h5>
                            <div id="productPreview">
                                <div class="text-center text-muted">等待数据加载...</div>
                            </div>
                        </div>
                        
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-chart-bar me-2"></i>统计信息
                            </h5>
                            <div id="statisticsInfo">
                                <div class="text-center text-muted">等待数据加载...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-terminal me-2"></i>控制台日志
                            </h5>
                            <div id="consoleLog" class="log-output">
                                等待日志输出...
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-secondary" onclick="clearLog()">
                                    <i class="fas fa-trash me-1"></i>清空日志
                                </button>
                                <button class="btn btn-sm btn-info" onclick="exportLog()">
                                    <i class="fas fa-download me-1"></i>导出日志
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="test-card">
                            <h5>
                                <i class="fas fa-external-link-alt me-2"></i>快速链接
                            </h5>
                            <div class="d-flex gap-2 flex-wrap">
                                <a href="content-manager.html" class="btn btn-primary" target="_blank">
                                    <i class="fas fa-external-link-alt me-1"></i>打开内容管理器
                                </a>
                                <a href="debug-data-loading.html" class="btn btn-info" target="_blank">
                                    <i class="fas fa-bug me-1"></i>数据加载诊断
                                </a>
                                <button class="btn btn-success" onclick="testDirectProductAccess()">
                                    <i class="fas fa-direct-hit me-1"></i>直接测试产品访问
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data-loader.js"></script>
    <script src="admin-functions.js"></script>
    
    <script>
        let logMessages = [];

        // 重写console.log来捕获日志
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogMessage('LOG', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLogMessage('ERROR', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogMessage('WARN', args.join(' '));
        };

        function addLogMessage(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            logMessages.push(`[${timestamp}] ${type}: ${message}`);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logElement = document.getElementById('consoleLog');
            logElement.textContent = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            logMessages = [];
            updateLogDisplay();
        }

        function exportLog() {
            const logContent = logMessages.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product-list-test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function runInitialTests() {
            try {
                await testDataLoader();
                await testProductListLoading();
            } catch (error) {
                console.error('初始测试失败:', error);
            }
        }

        async function testDataLoader() {
            const container = document.getElementById('dataLoaderTest');
            
            try {
                container.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>测试数据加载器...
                    </div>
                `;

                if (typeof ContentDataLoader === 'undefined') {
                    throw new Error('ContentDataLoader 类未定义');
                }

                const dataLoader = new ContentDataLoader();
                await dataLoader.loadAllData();

                const products = dataLoader.contentData?.products || [];
                const news = dataLoader.contentData?.news || [];
                const cases = dataLoader.contentData?.cases || [];

                container.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check me-2"></i>数据加载器测试通过
                    </div>
                    <ul class="list-unstyled mb-0">
                        <li><strong>产品:</strong> ${products.length} 个</li>
                        <li><strong>资讯:</strong> ${news.length} 个</li>
                        <li><strong>案例:</strong> ${cases.length} 个</li>
                    </ul>
                `;

                // 更新产品预览
                updateProductPreview(products);
                updateStatistics(products, news, cases);

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times me-2"></i>数据加载器测试失败
                        <div class="mt-2"><small>${error.message}</small></div>
                    </div>
                `;
            }
        }

        async function testProductListLoading() {
            const container = document.getElementById('productListResults');
            
            try {
                container.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>测试产品列表加载...
                    </div>
                `;

                // 测试ensureDataLoaderInitialized函数
                if (typeof ensureDataLoaderInitialized === 'function') {
                    await ensureDataLoaderInitialized();
                    
                    const dataLoader = window.contentDataLoader;
                    if (dataLoader && dataLoader.contentData && dataLoader.contentData.products) {
                        const productCount = dataLoader.contentData.products.length;
                        
                        container.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check me-2"></i>产品列表加载测试通过
                            </div>
                            <div class="mt-2">
                                <strong>产品数量:</strong> ${productCount} 个<br>
                                <strong>数据加载器状态:</strong> 正常<br>
                                <strong>产品数据结构:</strong> 完整
                            </div>
                        `;
                    } else {
                        throw new Error('数据加载器中没有产品数据');
                    }
                } else {
                    throw new Error('ensureDataLoaderInitialized 函数未定义');
                }

            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times me-2"></i>产品列表加载测试失败
                        <div class="mt-2"><small>${error.message}</small></div>
                    </div>
                `;
            }
        }

        function updateProductPreview(products) {
            const container = document.getElementById('productPreview');
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>没有产品数据
                    </div>
                `;
                return;
            }

            const previewProducts = products.slice(0, 5);
            container.innerHTML = `
                <div class="product-preview">
                    ${previewProducts.map((product, index) => `
                        <div class="d-flex align-items-center mb-2 p-2 border rounded">
                            <div class="me-3">
                                <strong>${index + 1}.</strong>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">${product.title || '未命名'}</div>
                                <small class="text-muted">${product.model || ''} | ${product.series || ''}</small>
                            </div>
                            <div>
                                <span class="badge ${product.status === 'published' ? 'bg-success' : 'bg-warning'}">${product.statusName || product.status}</span>
                            </div>
                        </div>
                    `).join('')}
                    ${products.length > 5 ? `<div class="text-muted text-center">... 还有 ${products.length - 5} 个产品</div>` : ''}
                </div>
            `;
        }

        function updateStatistics(products, news, cases) {
            const container = document.getElementById('statisticsInfo');
            
            const publishedProducts = products.filter(p => p.status === 'published').length;
            const featuredProducts = products.filter(p => p.featured).length;
            
            container.innerHTML = `
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-primary">${products.length}</h4>
                        <small>总产品数</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-success">${publishedProducts}</h4>
                        <small>已发布</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">${featuredProducts}</h4>
                        <small>推荐产品</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">${news.length}</h4>
                        <small>资讯数量</small>
                    </div>
                </div>
            `;
        }

        async function testDirectProductAccess() {
            try {
                console.log('开始直接产品访问测试...');
                
                // 测试直接调用showProductsList函数
                if (typeof showProductsList === 'function') {
                    console.log('调用showProductsList函数...');
                    await showProductsList();
                    console.log('showProductsList函数调用成功');
                    
                    // 打开新窗口显示结果
                    window.open('content-manager.html', '_blank');
                } else {
                    throw new Error('showProductsList 函数未定义');
                }
                
            } catch (error) {
                console.error('直接产品访问测试失败:', error);
                alert(`直接产品访问测试失败: ${error.message}`);
            }
        }

        // 页面加载时运行测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始运行测试...');
            runInitialTests();
        });
    </script>
</body>
</html>
