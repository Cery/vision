<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紧急调试 - 产品列表问题</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .debug-section { background: white; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #fff5f5; }
        .success { border-left-color: #28a745; background: #f5fff5; }
        .warning { border-left-color: #ffc107; background: #fffbf0; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 3px; font-family: monospace; margin: 10px 0; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; background: #007bff; color: white; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: black; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 300px; }
    </style>
</head>
<body>
    <h1>🚨 紧急调试 - 产品列表加载失败</h1>
    
    <div class="debug-section">
        <h3>步骤1: 基础环境检查</h3>
        <button onclick="checkBasicEnvironment()">检查基础环境</button>
        <div id="basic-env-result"></div>
    </div>

    <div class="debug-section">
        <h3>步骤2: JavaScript文件加载检查</h3>
        <button onclick="checkJSFiles()">检查JS文件</button>
        <div id="js-files-result"></div>
    </div>

    <div class="debug-section">
        <h3>步骤3: 网络请求检查</h3>
        <button onclick="checkNetworkRequests()">检查网络请求</button>
        <div id="network-result"></div>
    </div>

    <div class="debug-section">
        <h3>步骤4: 数据加载器测试</h3>
        <button onclick="testDataLoader()">测试数据加载器</button>
        <div id="data-loader-result"></div>
    </div>

    <div class="debug-section">
        <h3>步骤5: 手动模拟产品列表</h3>
        <button onclick="simulateProductList()">模拟产品列表</button>
        <div id="simulate-result"></div>
    </div>

    <div class="debug-section">
        <h3>步骤6: 直接检查content-manager.html</h3>
        <button onclick="checkContentManager()">检查内容管理器</button>
        <div id="content-manager-result"></div>
    </div>

    <div class="debug-section">
        <h3>实时控制台日志</h3>
        <button onclick="clearConsoleLog()">清空日志</button>
        <pre id="console-output">等待日志输出...</pre>
    </div>

    <div class="debug-section">
        <h3>快速修复尝试</h3>
        <button class="btn-warning" onclick="quickFix1()">修复1: 重新初始化数据加载器</button>
        <button class="btn-warning" onclick="quickFix2()">修复2: 强制重新加载产品数据</button>
        <button class="btn-danger" onclick="emergencyFix()">紧急修复: 使用备用数据</button>
        <div id="quick-fix-result"></div>
    </div>

    <script>
        let consoleMessages = [];

        // 捕获所有控制台输出
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleMessage('LOG', args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleMessage('ERROR', args.join(' '));
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleMessage('WARN', args.join(' '));
        };

        function addConsoleMessage(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleMessages.push(`[${timestamp}] ${type}: ${message}`);
            updateConsoleDisplay();
        }

        function updateConsoleDisplay() {
            document.getElementById('console-output').textContent = consoleMessages.join('\n');
        }

        function clearConsoleLog() {
            consoleMessages = [];
            updateConsoleDisplay();
        }

        function checkBasicEnvironment() {
            const result = document.getElementById('basic-env-result');
            console.log('开始基础环境检查...');
            
            let html = '<div class="code">';
            html += `当前URL: ${window.location.href}<br>`;
            html += `用户代理: ${navigator.userAgent}<br>`;
            html += `协议: ${window.location.protocol}<br>`;
            html += `主机: ${window.location.host}<br>`;
            html += `路径: ${window.location.pathname}<br>`;
            html += '</div>';

            // 检查全局对象
            html += '<h4>全局对象检查:</h4><div class="code">';
            html += `window.ContentDataLoader: ${typeof window.ContentDataLoader}<br>`;
            html += `window.contentDataLoader: ${typeof window.contentDataLoader}<br>`;
            html += `window.showProductsList: ${typeof window.showProductsList}<br>`;
            html += `window.showContentList: ${typeof window.showContentList}<br>`;
            html += `window.ensureDataLoaderInitialized: ${typeof window.ensureDataLoaderInitialized}<br>`;
            html += '</div>';

            result.innerHTML = html;
            result.className = 'debug-section success';
        }

        function checkJSFiles() {
            const result = document.getElementById('js-files-result');
            console.log('开始检查JavaScript文件...');
            
            let html = '<h4>JavaScript文件加载状态:</h4><div class="code">';
            
            // 检查脚本标签
            const scripts = document.querySelectorAll('script[src]');
            scripts.forEach(script => {
                html += `${script.src}: ${script.readyState || '已加载'}<br>`;
            });
            
            html += '</div><h4>关键函数检查:</h4><div class="code">';
            
            // 检查关键函数
            const functions = [
                'ContentDataLoader',
                'showProductsList', 
                'showContentList',
                'ensureDataLoaderInitialized',
                'loadProductsList',
                'renderTableRows'
            ];
            
            functions.forEach(func => {
                const exists = typeof window[func] !== 'undefined';
                html += `${func}: ${exists ? '✅ 存在' : '❌ 不存在'}<br>`;
            });
            
            html += '</div>';
            result.innerHTML = html;
            result.className = exists ? 'debug-section success' : 'debug-section error';
        }

        async function checkNetworkRequests() {
            const result = document.getElementById('network-result');
            console.log('开始检查网络请求...');
            
            const testUrls = [
                '/admin/data-loader.js',
                '/admin/admin-functions.js',
                '/admin/content-manager.html',
                '/products/WS-K08510-a/index.md',
                '/api/products.json'
            ];

            let html = '<h4>网络请求测试:</h4><div class="code">';
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url);
                    html += `${url}: ${response.status} ${response.statusText}<br>`;
                } catch (error) {
                    html += `${url}: ❌ ${error.message}<br>`;
                }
            }
            
            html += '</div>';
            result.innerHTML = html;
            result.className = 'debug-section warning';
        }

        async function testDataLoader() {
            const result = document.getElementById('data-loader-result');
            console.log('开始测试数据加载器...');
            
            try {
                // 动态加载data-loader.js
                if (typeof ContentDataLoader === 'undefined') {
                    console.log('ContentDataLoader未定义，尝试动态加载...');
                    await loadScript('/admin/data-loader.js');
                }

                if (typeof ContentDataLoader === 'undefined') {
                    throw new Error('无法加载ContentDataLoader类');
                }

                const loader = new ContentDataLoader();
                console.log('ContentDataLoader实例创建成功');
                
                await loader.loadAllData();
                console.log('数据加载完成');

                const products = loader.contentData?.products || [];
                const news = loader.contentData?.news || [];
                const cases = loader.contentData?.cases || [];

                let html = '<div class="code">';
                html += `✅ ContentDataLoader测试成功<br>`;
                html += `产品数量: ${products.length}<br>`;
                html += `资讯数量: ${news.length}<br>`;
                html += `案例数量: ${cases.length}<br>`;
                
                if (products.length > 0) {
                    html += `<br>第一个产品: ${products[0].title || products[0].id}<br>`;
                    html += `产品字段: ${Object.keys(products[0]).join(', ')}<br>`;
                }
                
                html += '</div>';
                result.innerHTML = html;
                result.className = 'debug-section success';

                // 设置全局数据加载器
                window.contentDataLoader = loader;
                console.log('全局数据加载器已设置');

            } catch (error) {
                console.error('数据加载器测试失败:', error);
                result.innerHTML = `<div class="code">❌ 数据加载器测试失败: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function simulateProductList() {
            const result = document.getElementById('simulate-result');
            console.log('开始模拟产品列表...');
            
            try {
                // 确保数据加载器存在
                if (!window.contentDataLoader) {
                    await testDataLoader();
                }

                if (!window.contentDataLoader) {
                    throw new Error('数据加载器不可用');
                }

                const products = window.contentDataLoader.contentData?.products || [];
                
                if (products.length === 0) {
                    throw new Error('没有产品数据');
                }

                // 模拟渲染产品列表
                let html = '<h4>模拟产品列表:</h4>';
                html += '<table border="1" style="width:100%; border-collapse: collapse;">';
                html += '<tr><th>ID</th><th>标题</th><th>型号</th><th>系列</th><th>状态</th></tr>';
                
                products.slice(0, 5).forEach(product => {
                    html += `<tr>
                        <td>${product.id || '-'}</td>
                        <td>${product.title || '未命名'}</td>
                        <td>${product.model || '-'}</td>
                        <td>${product.series || '-'}</td>
                        <td>${product.status || 'published'}</td>
                    </tr>`;
                });
                
                html += '</table>';
                html += `<p>显示前5个产品，总共${products.length}个产品</p>`;
                
                result.innerHTML = html;
                result.className = 'debug-section success';

            } catch (error) {
                console.error('模拟产品列表失败:', error);
                result.innerHTML = `<div class="code">❌ 模拟失败: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        async function checkContentManager() {
            const result = document.getElementById('content-manager-result');
            console.log('开始检查内容管理器...');
            
            try {
                // 检查content-manager.html是否可访问
                const response = await fetch('/admin/content-manager.html');
                if (!response.ok) {
                    throw new Error(`无法访问content-manager.html: ${response.status}`);
                }

                const html = await response.text();
                
                // 检查关键函数是否在HTML中定义
                const hasShowContentList = html.includes('function showContentList');
                const hasRenderTableRows = html.includes('function renderTableRows');
                const hasEnsureDataSync = html.includes('function ensureDataSync');

                let resultHtml = '<div class="code">';
                resultHtml += `✅ content-manager.html可访问<br>`;
                resultHtml += `showContentList函数: ${hasShowContentList ? '✅ 存在' : '❌ 不存在'}<br>`;
                resultHtml += `renderTableRows函数: ${hasRenderTableRows ? '✅ 存在' : '❌ 不存在'}<br>`;
                resultHtml += `ensureDataSync函数: ${hasEnsureDataSync ? '✅ 存在' : '❌ 不存在'}<br>`;
                resultHtml += `文件大小: ${(html.length / 1024).toFixed(2)} KB<br>`;
                resultHtml += '</div>';

                result.innerHTML = resultHtml;
                result.className = 'debug-section success';

            } catch (error) {
                console.error('检查内容管理器失败:', error);
                result.innerHTML = `<div class="code">❌ 检查失败: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        async function quickFix1() {
            const result = document.getElementById('quick-fix-result');
            console.log('尝试修复1: 重新初始化数据加载器...');
            
            try {
                // 强制重新加载data-loader.js
                await loadScript('/admin/data-loader.js?t=' + Date.now());
                
                // 重新创建数据加载器
                window.contentDataLoader = new ContentDataLoader();
                await window.contentDataLoader.loadAllData();
                
                result.innerHTML = '<div class="code">✅ 修复1成功: 数据加载器已重新初始化</div>';
                result.className = 'debug-section success';
                
            } catch (error) {
                result.innerHTML = `<div class="code">❌ 修复1失败: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        async function quickFix2() {
            const result = document.getElementById('quick-fix-result');
            console.log('尝试修复2: 强制重新加载产品数据...');
            
            try {
                if (!window.contentDataLoader) {
                    window.contentDataLoader = new ContentDataLoader();
                }
                
                // 强制重新加载产品数据
                await window.contentDataLoader.loadProducts();
                
                const productCount = window.contentDataLoader.contentData?.products?.length || 0;
                result.innerHTML = `<div class="code">✅ 修复2成功: 已重新加载${productCount}个产品</div>`;
                result.className = 'debug-section success';
                
            } catch (error) {
                result.innerHTML = `<div class="code">❌ 修复2失败: ${error.message}</div>`;
                result.className = 'debug-section error';
            }
        }

        function emergencyFix() {
            const result = document.getElementById('quick-fix-result');
            console.log('执行紧急修复: 使用备用数据...');
            
            // 创建备用产品数据
            const emergencyProducts = [
                {
                    id: 'emergency-product-1',
                    title: '紧急备用产品1',
                    model: 'EMERGENCY-001',
                    series: '备用系列',
                    status: 'published',
                    primary_category: '电子内窥镜',
                    thumbnail: '/images/placeholder.jpg'
                },
                {
                    id: 'emergency-product-2', 
                    title: '紧急备用产品2',
                    model: 'EMERGENCY-002',
                    series: '备用系列',
                    status: 'published',
                    primary_category: '电子内窥镜',
                    thumbnail: '/images/placeholder.jpg'
                }
            ];

            // 创建紧急数据加载器
            window.contentDataLoader = {
                contentData: {
                    products: emergencyProducts,
                    news: [],
                    cases: [],
                    categories: [],
                    suppliers: []
                }
            };

            result.innerHTML = `<div class="code">⚠️ 紧急修复完成: 已设置${emergencyProducts.length}个备用产品</div>`;
            result.className = 'debug-section warning';
            
            // 尝试打开内容管理器
            setTimeout(() => {
                window.open('/admin/content-manager.html', '_blank');
            }, 1000);
        }

        // 页面加载时自动运行基础检查
        document.addEventListener('DOMContentLoaded', function() {
            console.log('紧急调试页面加载完成');
            setTimeout(checkBasicEnvironment, 500);
        });
    </script>
</body>
</html>
