<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容统计仪表板 - VisNDT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --sidebar-width: 280px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: all 0.3s ease;
            border-radius: 0;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .content-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .section-header h2 {
            color: var(--primary-color);
            margin: 0;
            font-weight: 600;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .content-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .list-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .list-item {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }
        
        .list-item:hover {
            background-color: #f8f9fa;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .item-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .badge {
            border-radius: 20px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-chart-bar me-2"></i>内容统计仪表板</h4>
            </div>
            <div class="nav flex-column">
                <button class="nav-link active" onclick="showSection('overview')">
                    <i class="fas fa-tachometer-alt"></i>总览
                </button>
                <button class="nav-link" onclick="showSection('products')">
                    <i class="fas fa-box"></i>产品统计
                </button>
                <button class="nav-link" onclick="showSection('news')">
                    <i class="fas fa-newspaper"></i>资讯统计
                </button>
                <button class="nav-link" onclick="showSection('cases')">
                    <i class="fas fa-briefcase"></i>案例统计
                </button>
                <button class="nav-link" onclick="showSection('suppliers')">
                    <i class="fas fa-truck"></i>供应商统计
                </button>
            </div>
        </nav>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 同步状态提示 -->
            <div id="syncStatus" class="sync-status"></div>

            <!-- 数据源状态 -->
            <div id="dataSourceStatus" class="sync-status" style="top: 80px;">
                <div class="alert alert-info" style="margin: 0;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="dataSourceText">正在检测数据源...</span>
                </div>
            </div>

            <!-- 总览 -->
            <section id="overview" class="content-section active">
                <div class="section-header">
                    <h2><i class="fas fa-tachometer-alt me-2"></i>内容总览</h2>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">产品总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalNews">0</div>
                        <div class="stat-label">资讯总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCases">0</div>
                        <div class="stat-label">案例总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalSuppliers">0</div>
                        <div class="stat-label">供应商数量</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="content-list">
                            <div class="list-header">
                                <i class="fas fa-clock me-2"></i>最近更新
                            </div>
                            <div id="recentUpdates">
                                <!-- 最近更新内容 -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="content-list">
                            <div class="list-header">
                                <i class="fas fa-chart-pie me-2"></i>内容分布
                            </div>
                            <div id="contentDistribution">
                                <!-- 内容分布统计 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 产品统计 -->
            <section id="products" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-box me-2"></i>产品统计</h2>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="publishedProducts">0</div>
                        <div class="stat-label">已发布产品</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="draftProducts">0</div>
                        <div class="stat-label">草稿产品</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="productCategories">0</div>
                        <div class="stat-label">产品分类</div>
                    </div>
                </div>

                <div class="content-list">
                    <div class="list-header">
                        <i class="fas fa-list me-2"></i>产品列表
                    </div>
                    <div id="productsList">
                        <!-- 产品列表 -->
                    </div>
                </div>
            </section>

            <!-- 其他统计部分 -->
            <section id="news" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-newspaper me-2"></i>资讯统计</h2>
                </div>
                <div id="newsStats">
                    <!-- 资讯统计内容 -->
                </div>
            </section>

            <section id="cases" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-briefcase me-2"></i>案例统计</h2>
                </div>
                <div id="casesStats">
                    <!-- 案例统计内容 -->
                </div>
            </section>

            <section id="suppliers" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-truck me-2"></i>供应商统计</h2>
                </div>
                <div id="suppliersStats">
                    <!-- 供应商统计内容 -->
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局数据
        let dashboardData = {
            products: [],
            news: [],
            cases: [],
            suppliers: []
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        function initializeDashboard() {
            console.log('初始化内容统计仪表板...');
            loadAllData();
        }

        // 导航功能
        function showSection(sectionId) {
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // 移除所有导航链接的活动状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 显示选中的内容区域
            document.getElementById(sectionId).classList.add('active');

            // 设置对应导航链接为活动状态
            event.target.classList.add('active');

            // 根据不同部分加载相应数据
            switch(sectionId) {
                case 'overview':
                    updateOverview();
                    break;
                case 'products':
                    updateProductsStats();
                    break;
                case 'news':
                    updateNewsStats();
                    break;
                case 'cases':
                    updateCasesStats();
                    break;
                case 'suppliers':
                    updateSuppliersStats();
                    break;
            }
        }

        // 数据加载
        async function loadAllData() {
            try {
                showSyncStatus('正在加载数据...', 'info');
                updateDataSourceStatus('正在检测数据源...', 'info');

                // 检测数据源
                const dataSources = await detectDataSources();

                await Promise.all([
                    loadProducts(),
                    loadNews(),
                    loadCases(),
                    loadSuppliers()
                ]);

                updateOverview();
                showSyncStatus('数据加载完成', 'success');
                updateDataSourceStatus(generateDataSourceMessage(dataSources), 'success');

                setTimeout(() => {
                    hideSyncStatus();
                    hideDataSourceStatus();
                }, 5000);

            } catch (error) {
                console.error('数据加载失败:', error);
                showSyncStatus('数据加载失败: ' + error.message, 'error');
                updateDataSourceStatus('数据源检测失败', 'error');
            }
        }

        // 检测可用的数据源
        async function detectDataSources() {
            const sources = {
                productServer: false,
                searchIndex: false,
                hugoIndex: false,
                newsServer: false,
                casesServer: false
            };

            // 检测产品服务器
            try {
                const response = await fetch('http://localhost:3002/api/products/list');
                sources.productServer = response.ok;
            } catch (error) {
                sources.productServer = false;
            }

            // 检测搜索索引
            try {
                const response = await fetch('/search-index.json');
                sources.searchIndex = response.ok;
            } catch (error) {
                sources.searchIndex = false;
            }

            // 检测Hugo索引
            try {
                const response = await fetch('/index.json');
                sources.hugoIndex = response.ok;
            } catch (error) {
                sources.hugoIndex = false;
            }

            // 检测新闻服务器
            try {
                const response = await fetch('http://localhost:3002/api/news/list');
                sources.newsServer = response.ok;
            } catch (error) {
                sources.newsServer = false;
            }

            // 检测案例服务器
            try {
                const response = await fetch('http://localhost:3002/api/cases/list');
                sources.casesServer = response.ok;
            } catch (error) {
                sources.casesServer = false;
            }

            return sources;
        }

        // 生成数据源状态消息
        function generateDataSourceMessage(sources) {
            const available = [];
            const unavailable = [];

            if (sources.productServer) available.push('产品服务器');
            else unavailable.push('产品服务器');

            if (sources.newsServer) available.push('新闻服务器');
            else unavailable.push('新闻服务器');

            if (sources.casesServer) available.push('案例服务器');
            else unavailable.push('案例服务器');

            if (sources.searchIndex) available.push('搜索索引');
            else unavailable.push('搜索索引');

            if (sources.hugoIndex) available.push('Hugo索引');
            else unavailable.push('Hugo索引');

            let message = '';
            if (available.length > 0) {
                message += `✅ 可用: ${available.join(', ')}`;
            }
            if (unavailable.length > 0) {
                if (message) message += ' | ';
                message += `❌ 不可用: ${unavailable.join(', ')}`;
            }

            return message || '无可用数据源';
        }

        // 更新数据源状态
        function updateDataSourceStatus(message, type = 'info') {
            const statusDiv = document.getElementById('dataSourceStatus');
            const alertClass = type === 'error' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' : 'alert-info';

            statusDiv.innerHTML = `
                <div class="alert ${alertClass}" style="margin: 0;">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' :
                                      type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                </div>
            `;
            statusDiv.style.display = 'block';
        }

        // 隐藏数据源状态
        function hideDataSourceStatus() {
            document.getElementById('dataSourceStatus').style.display = 'none';
        }

        async function loadProducts() {
            try {
                // 方法1: 尝试从产品服务器API加载
                try {
                    const response = await fetch('http://localhost:3002/api/products/list');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.products) {
                            dashboardData.products = result.products.map(product => ({
                                id: product.id,
                                title: product.title,
                                model: product.id,
                                category: extractCategoryFromContent(product.content || ''),
                                status: 'published',
                                date: product.lastModified ? product.lastModified.split('T')[0] : new Date().toISOString().split('T')[0],
                                size: product.size,
                                fileName: product.fileName
                            }));
                            console.log('✅ 从产品服务器加载了', dashboardData.products.length, '个产品');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('产品服务器不可用，尝试其他方法');
                }

                // 方法2: 尝试从搜索索引加载
                try {
                    const response = await fetch('/search-index.json');
                    if (response.ok) {
                        const searchData = await response.json();

                        // 过滤产品数据 - 更宽松的条件
                        const products = searchData.filter(page => {
                            // 检查是否是产品页面
                            const isProduct = page.type === 'products' ||
                                            page.section === 'products' ||
                                            (page.uri && page.uri.includes('/products/'));

                            // 检查是否有标题
                            const hasTitle = page.title && page.title.trim() !== '';

                            return isProduct && hasTitle;
                        });

                        if (products.length > 0) {
                            dashboardData.products = products.map(product => {
                                // 从URI提取产品ID
                                let productId = product.uri;
                                if (productId.includes('/products/')) {
                                    productId = productId.replace('/products/', '').replace('/', '');
                                }

                                // 提取分类信息
                                let category = '未分类';
                                if (product.params && product.params.primary_category) {
                                    category = product.params.primary_category;
                                } else if (product.content) {
                                    category = extractCategoryFromContent(product.content);
                                }

                                return {
                                    id: productId,
                                    title: product.title,
                                    model: extractModelFromTitle(product.title),
                                    category: category,
                                    status: 'published',
                                    date: product.date || product.params?.date || new Date().toISOString().split('T')[0],
                                    uri: product.uri,
                                    summary: product.summary || '',
                                    content: product.content || ''
                                };
                            });
                            console.log('✅ 从搜索索引加载了', dashboardData.products.length, '个产品');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('搜索索引不可用，尝试其他方法');
                }

                // 方法3: 尝试从Hugo生成的index.json加载
                try {
                    const response = await fetch('/index.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data && Array.isArray(data)) {
                            const products = data.filter(item =>
                                item.section === 'products' ||
                                item.type === 'products' ||
                                (item.permalink && item.permalink.includes('/products/'))
                            );

                            if (products.length > 0) {
                                dashboardData.products = products.map(product => ({
                                    id: product.permalink ? product.permalink.replace('/products/', '').replace('/', '') : product.title,
                                    title: product.title,
                                    model: extractModelFromTitle(product.title),
                                    category: product.categories ? product.categories[0] : '未分类',
                                    status: 'published',
                                    date: product.date || new Date().toISOString().split('T')[0],
                                    permalink: product.permalink
                                }));
                                console.log('✅ 从index.json加载了', dashboardData.products.length, '个产品');
                                return;
                            }
                        }
                    }
                } catch (error) {
                    console.log('index.json不可用');
                }

                // 如果所有方法都失败，显示提示信息
                console.log('⚠️ 无法加载实际产品数据，请检查数据源');
                dashboardData.products = [];

                // 显示数据源状态提示
                updateDataSourceStatus('❌ 无可用数据源 - 请启动产品服务器(port 3002)或检查搜索索引文件', 'error');

            } catch (error) {
                console.error('加载产品数据时发生错误:', error);
                dashboardData.products = [];
            }
        }

        // 辅助函数：从标题提取型号
        function extractModelFromTitle(title) {
            const modelMatch = title.match(/([A-Z]{2,}-[A-Z0-9]+)/);
            return modelMatch ? modelMatch[1] : title.split(' ')[0];
        }

        // 辅助函数：从内容提取分类
        function extractCategoryFromContent(content) {
            const categoryMatch = content.match(/primary_category:\s*"?([^"\n]+)"?/);
            if (categoryMatch) return categoryMatch[1];

            const altCategoryMatch = content.match(/category:\s*"?([^"\n]+)"?/);
            if (altCategoryMatch) return altCategoryMatch[1];

            return '未分类';
        }

        async function loadNews() {
            try {
                // 方法1: 尝试从新闻服务器API加载
                try {
                    const response = await fetch('http://localhost:3002/api/news/list');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.news) {
                            dashboardData.news = result.news.map(news => ({
                                id: news.id,
                                title: news.title,
                                date: news.date || news.lastModified?.split('T')[0] || new Date().toISOString().split('T')[0],
                                status: news.status || 'published',
                                fileName: news.fileName
                            }));
                            console.log('✅ 从新闻服务器加载了', dashboardData.news.length, '条新闻');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('新闻服务器不可用，尝试其他方法');
                }

                // 方法2: 尝试从搜索索引加载
                try {
                    const response = await fetch('/search-index.json');
                    if (response.ok) {
                        const searchData = await response.json();

                        // 过滤新闻数据
                        const news = searchData.filter(page => {
                            const isNews = page.type === 'news' ||
                                          page.section === 'news' ||
                                          (page.uri && page.uri.includes('/news/'));
                            const hasTitle = page.title && page.title.trim() !== '';
                            return isNews && hasTitle;
                        });

                        if (news.length > 0) {
                            dashboardData.news = news.map(item => {
                                let newsId = item.uri;
                                if (newsId.includes('/news/')) {
                                    newsId = newsId.replace('/news/', '').replace('/', '');
                                }

                                return {
                                    id: newsId,
                                    title: item.title,
                                    date: item.date || item.params?.date || new Date().toISOString().split('T')[0],
                                    status: 'published',
                                    uri: item.uri,
                                    summary: item.summary || ''
                                };
                            });
                            console.log('✅ 从搜索索引加载了', dashboardData.news.length, '条新闻');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('搜索索引中无新闻数据');
                }

                // 如果无法加载实际数据
                console.log('⚠️ 无法加载实际新闻数据');
                dashboardData.news = [];

            } catch (error) {
                console.error('加载新闻数据时发生错误:', error);
                dashboardData.news = [];
            }
        }

        async function loadCases() {
            try {
                // 方法1: 尝试从案例服务器API加载
                try {
                    const response = await fetch('http://localhost:3002/api/cases/list');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.cases) {
                            dashboardData.cases = result.cases.map(caseItem => ({
                                id: caseItem.id,
                                title: caseItem.title,
                                date: caseItem.date || caseItem.lastModified?.split('T')[0] || new Date().toISOString().split('T')[0],
                                status: caseItem.status || 'published',
                                fileName: caseItem.fileName
                            }));
                            console.log('✅ 从案例服务器加载了', dashboardData.cases.length, '个案例');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('案例服务器不可用，尝试其他方法');
                }

                // 方法2: 尝试从搜索索引加载
                try {
                    const response = await fetch('/search-index.json');
                    if (response.ok) {
                        const searchData = await response.json();

                        // 过滤案例数据
                        const cases = searchData.filter(page => {
                            const isCase = page.type === 'cases' ||
                                          page.section === 'cases' ||
                                          (page.uri && page.uri.includes('/cases/'));
                            const hasTitle = page.title && page.title.trim() !== '';
                            return isCase && hasTitle;
                        });

                        if (cases.length > 0) {
                            dashboardData.cases = cases.map(item => {
                                let caseId = item.uri;
                                if (caseId.includes('/cases/')) {
                                    caseId = caseId.replace('/cases/', '').replace('/', '');
                                }

                                return {
                                    id: caseId,
                                    title: item.title,
                                    date: item.date || item.params?.date || new Date().toISOString().split('T')[0],
                                    status: 'published',
                                    uri: item.uri,
                                    summary: item.summary || ''
                                };
                            });
                            console.log('✅ 从搜索索引加载了', dashboardData.cases.length, '个案例');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('搜索索引中无案例数据');
                }

                // 如果无法加载实际数据
                console.log('⚠️ 无法加载实际案例数据');
                dashboardData.cases = [];

            } catch (error) {
                console.error('加载案例数据时发生错误:', error);
                dashboardData.cases = [];
            }
        }

        async function loadSuppliers() {
            try {
                // 方法1: 尝试从数据文件加载供应商信息
                try {
                    const response = await fetch('/data/suppliers.json');
                    if (response.ok) {
                        const suppliers = await response.json();
                        if (suppliers && Array.isArray(suppliers)) {
                            dashboardData.suppliers = suppliers.map(supplier => ({
                                name: supplier.name,
                                products: supplier.products || 0,
                                status: supplier.status || 'active',
                                description: supplier.description,
                                website: supplier.website,
                                contact: supplier.contact
                            }));
                            console.log('✅ 从数据文件加载了', dashboardData.suppliers.length, '个供应商');
                            return;
                        }
                    }
                } catch (error) {
                    console.log('供应商数据文件不可用');
                }

                // 方法2: 从搜索索引中提取供应商信息
                try {
                    const response = await fetch('/search-index.json');
                    if (response.ok) {
                        const searchData = await response.json();
                        const supplierMap = new Map();

                        // 从产品数据中提取供应商信息
                        searchData.forEach(item => {
                            if ((item.type === 'products' || item.section === 'products') && item.title) {
                                const supplier = extractSupplierFromSearchItem(item);
                                if (supplier) {
                                    if (supplierMap.has(supplier.name)) {
                                        supplierMap.get(supplier.name).products++;
                                        // 合并产品类型
                                        const existingTypes = supplierMap.get(supplier.name).productTypes || new Set();
                                        if (supplier.category) {
                                            existingTypes.add(supplier.category);
                                        }
                                        supplierMap.get(supplier.name).productTypes = existingTypes;
                                    } else {
                                        supplierMap.set(supplier.name, {
                                            name: supplier.name,
                                            products: 1,
                                            status: 'active',
                                            description: supplier.description || `专业的${supplier.category || '工业检测'}设备供应商`,
                                            productTypes: new Set(supplier.category ? [supplier.category] : []),
                                            website: supplier.website || '',
                                            contact: supplier.contact || ''
                                        });
                                    }
                                }
                            }
                        });

                        // 转换为数组并处理产品类型
                        dashboardData.suppliers = Array.from(supplierMap.values()).map(supplier => ({
                            ...supplier,
                            productTypes: Array.from(supplier.productTypes || []).join(', '),
                            mainCategory: Array.from(supplier.productTypes || [])[0] || '工业检测设备'
                        }));

                        console.log('✅ 从搜索索引提取了', dashboardData.suppliers.length, '个供应商');
                        return;
                    }
                } catch (error) {
                    console.log('从搜索索引提取供应商信息失败');
                }

                // 方法3: 从产品数据中提取供应商信息
                if (dashboardData.products && dashboardData.products.length > 0) {
                    const supplierMap = new Map();

                    dashboardData.products.forEach(product => {
                        const supplier = extractSupplierFromProduct(product);
                        if (supplier) {
                            if (supplierMap.has(supplier)) {
                                supplierMap.get(supplier).products++;
                                // 收集产品分类
                                if (product.category && product.category !== '未分类') {
                                    const types = supplierMap.get(supplier).productTypes || new Set();
                                    types.add(product.category);
                                    supplierMap.get(supplier).productTypes = types;
                                }
                            } else {
                                supplierMap.set(supplier, {
                                    name: supplier,
                                    products: 1,
                                    status: 'active',
                                    description: `专业的${product.category || '工业检测'}设备供应商`,
                                    productTypes: new Set(product.category && product.category !== '未分类' ? [product.category] : []),
                                    website: getSupplierWebsite(supplier),
                                    contact: getSupplierContact(supplier)
                                });
                            }
                        }
                    });

                    // 转换为数组
                    dashboardData.suppliers = Array.from(supplierMap.values()).map(supplier => ({
                        ...supplier,
                        productTypes: Array.from(supplier.productTypes || []).join(', '),
                        mainCategory: Array.from(supplier.productTypes || [])[0] || '工业检测设备'
                    }));

                    console.log('✅ 从产品数据提取了', dashboardData.suppliers.length, '个供应商');
                    return;
                }

                // 默认供应商数据
                dashboardData.suppliers = [
                    {
                        name: 'VisNDT',
                        products: dashboardData.products ? dashboardData.products.length : 0,
                        status: 'active',
                        description: '专业的无损检测设备供应商，提供工业内窥镜、超声波检测等设备',
                        productTypes: '电子内窥镜, 光纤内窥镜, 光学内窥镜',
                        mainCategory: '工业内窥镜',
                        website: 'https://www.visndt.com',
                        contact: 'info@visndt.com'
                    }
                ];
                console.log('⚠️ 使用默认供应商数据');

            } catch (error) {
                console.error('加载供应商数据时发生错误:', error);
                dashboardData.suppliers = [];
            }
        }

        // 辅助函数：从产品中提取供应商
        function extractSupplierFromProduct(product) {
            // 从产品内容中提取供应商信息
            if (product.supplier) return product.supplier;

            // 从产品标题或型号推断供应商
            if (product.model && product.model.startsWith('WS-')) {
                return 'VisNDT';
            }

            return 'VisNDT'; // 默认供应商
        }

        // 从搜索项中提取供应商信息
        function extractSupplierFromSearchItem(item) {
            let supplierName = 'VisNDT'; // 默认供应商
            let category = '工业检测设备';
            let description = '';

            // 从内容中提取供应商信息
            if (item.content) {
                const supplierMatch = item.content.match(/supplier:\s*"?([^"\n]+)"?/i);
                if (supplierMatch) {
                    supplierName = supplierMatch[1].trim();
                }

                const categoryMatch = item.content.match(/(?:primary_category|category):\s*"?([^"\n]+)"?/i);
                if (categoryMatch) {
                    category = categoryMatch[1].trim();
                }
            }

            // 从参数中提取
            if (item.params) {
                if (item.params.supplier) supplierName = item.params.supplier;
                if (item.params.primary_category) category = item.params.primary_category;
                if (item.params.category) category = item.params.category;
            }

            // 从标题推断供应商
            if (item.title && item.title.includes('WS-')) {
                supplierName = 'VisNDT';
            }

            return {
                name: supplierName,
                category: category,
                description: description,
                website: getSupplierWebsite(supplierName),
                contact: getSupplierContact(supplierName)
            };
        }

        // 获取供应商网站
        function getSupplierWebsite(supplierName) {
            const websites = {
                'VisNDT': 'https://www.visndt.com',
                'VISNDT': 'https://www.visndt.com'
            };
            return websites[supplierName] || '';
        }

        // 获取供应商联系方式
        function getSupplierContact(supplierName) {
            const contacts = {
                'VisNDT': 'info@visndt.com',
                'VISNDT': 'info@visndt.com'
            };
            return contacts[supplierName] || '';
        }

        // 更新总览
        function updateOverview() {
            document.getElementById('totalProducts').textContent = dashboardData.products.length;
            document.getElementById('totalNews').textContent = dashboardData.news.length;
            document.getElementById('totalCases').textContent = dashboardData.cases.length;
            document.getElementById('totalSuppliers').textContent = dashboardData.suppliers.length;

            // 更新最近更新
            updateRecentUpdates();
            updateContentDistribution();
        }

        function updateRecentUpdates() {
            const recentItems = [
                ...dashboardData.products.map(p => ({...p, type: '产品'})),
                ...dashboardData.news.map(n => ({...n, type: '资讯'})),
                ...dashboardData.cases.map(c => ({...c, type: '案例'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            const html = recentItems.map(item => `
                <div class="list-item">
                    <div class="item-title">${item.title}</div>
                    <div class="item-meta">
                        <span class="badge bg-primary">${item.type}</span>
                        <span class="ms-2">${item.date}</span>
                    </div>
                </div>
            `).join('');

            document.getElementById('recentUpdates').innerHTML = html;
        }

        function updateContentDistribution() {
            const total = dashboardData.products.length + dashboardData.news.length + dashboardData.cases.length;
            
            const distribution = [
                { type: '产品', count: dashboardData.products.length, percentage: Math.round((dashboardData.products.length / total) * 100) },
                { type: '资讯', count: dashboardData.news.length, percentage: Math.round((dashboardData.news.length / total) * 100) },
                { type: '案例', count: dashboardData.cases.length, percentage: Math.round((dashboardData.cases.length / total) * 100) }
            ];

            const html = distribution.map(item => `
                <div class="list-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>${item.type}</span>
                        <span>
                            <strong>${item.count}</strong> 
                            <small class="text-muted">(${item.percentage}%)</small>
                        </span>
                    </div>
                </div>
            `).join('');

            document.getElementById('contentDistribution').innerHTML = html;
        }

        // 更新产品统计
        function updateProductsStats() {
            const products = dashboardData.products || [];
            const published = products.filter(p => p.status === 'published' || !p.status).length;
            const draft = products.filter(p => p.status === 'draft').length;
            const categories = [...new Set(products.map(p => p.category).filter(c => c && c !== '未分类'))].length;

            document.getElementById('publishedProducts').textContent = published;
            document.getElementById('draftProducts').textContent = draft;
            document.getElementById('productCategories').textContent = categories;

            // 更新产品列表
            if (products.length === 0) {
                document.getElementById('productsList').innerHTML = `
                    <div class="list-item">
                        <div class="item-title text-muted">暂无产品数据</div>
                        <div class="item-meta">
                            <small>请检查产品服务器是否运行，或确保content/products目录中有产品文件</small>
                        </div>
                    </div>
                `;
                return;
            }

            const html = products.map(product => `
                <div class="list-item">
                    <div class="item-title">${product.title || '未命名产品'}</div>
                    <div class="item-meta">
                        <span class="badge ${(product.status === 'published' || !product.status) ? 'bg-success' : 'bg-warning'}">
                            ${(product.status === 'published' || !product.status) ? '已发布' : '草稿'}
                        </span>
                        ${product.model ? `<span class="ms-2">型号: ${product.model}</span>` : ''}
                        ${product.category ? `<span class="ms-2">分类: ${product.category}</span>` : ''}
                        <span class="ms-2">${product.date || '未知日期'}</span>
                        ${product.size ? `<span class="ms-2">${formatFileSize(product.size)}</span>` : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('productsList').innerHTML = html;
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 其他统计更新函数
        function updateNewsStats() {
            const news = dashboardData.news || [];
            const published = news.filter(n => n.status === 'published' || !n.status).length;
            const draft = news.filter(n => n.status === 'draft').length;

            const statsHtml = `
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number">${published}</div>
                        <div class="stat-label">已发布资讯</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${draft}</div>
                        <div class="stat-label">草稿资讯</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${news.length}</div>
                        <div class="stat-label">资讯总数</div>
                    </div>
                </div>

                <div class="content-list">
                    <div class="list-header">
                        <i class="fas fa-list me-2"></i>资讯列表
                    </div>
                    ${news.length === 0 ?
                        '<div class="list-item"><div class="item-title text-muted">暂无资讯数据</div></div>' :
                        news.map(item => `
                            <div class="list-item">
                                <div class="item-title">${item.title || '未命名资讯'}</div>
                                <div class="item-meta">
                                    <span class="badge ${(item.status === 'published' || !item.status) ? 'bg-success' : 'bg-warning'}">
                                        ${(item.status === 'published' || !item.status) ? '已发布' : '草稿'}
                                    </span>
                                    <span class="ms-2">${item.date || '未知日期'}</span>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            `;

            document.getElementById('newsStats').innerHTML = statsHtml;
        }

        function updateCasesStats() {
            const cases = dashboardData.cases || [];
            const published = cases.filter(c => c.status === 'published' || !c.status).length;
            const draft = cases.filter(c => c.status === 'draft').length;

            const statsHtml = `
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number">${published}</div>
                        <div class="stat-label">已发布案例</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${draft}</div>
                        <div class="stat-label">草稿案例</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${cases.length}</div>
                        <div class="stat-label">案例总数</div>
                    </div>
                </div>

                <div class="content-list">
                    <div class="list-header">
                        <i class="fas fa-list me-2"></i>案例列表
                    </div>
                    ${cases.length === 0 ?
                        '<div class="list-item"><div class="item-title text-muted">暂无案例数据</div></div>' :
                        cases.map(item => `
                            <div class="list-item">
                                <div class="item-title">${item.title || '未命名案例'}</div>
                                <div class="item-meta">
                                    <span class="badge ${(item.status === 'published' || !item.status) ? 'bg-success' : 'bg-warning'}">
                                        ${(item.status === 'published' || !item.status) ? '已发布' : '草稿'}
                                    </span>
                                    <span class="ms-2">${item.date || '未知日期'}</span>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            `;

            document.getElementById('casesStats').innerHTML = statsHtml;
        }

        function updateSuppliersStats() {
            const suppliers = dashboardData.suppliers || [];
            const active = suppliers.filter(s => s.status === 'active' || !s.status).length;
            const totalProducts = suppliers.reduce((sum, s) => sum + (s.products || 0), 0);
            const categories = [...new Set(suppliers.map(s => s.mainCategory).filter(c => c))].length;

            const statsHtml = `
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number">${active}</div>
                        <div class="stat-label">活跃供应商</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${suppliers.length}</div>
                        <div class="stat-label">供应商总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalProducts}</div>
                        <div class="stat-label">关联产品数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${categories}</div>
                        <div class="stat-label">产品类别</div>
                    </div>
                </div>

                <div class="content-list">
                    <div class="list-header">
                        <i class="fas fa-list me-2"></i>供应商详细信息
                    </div>
                    ${suppliers.length === 0 ?
                        '<div class="list-item"><div class="item-title text-muted">暂无供应商数据</div></div>' :
                        suppliers.map(supplier => `
                            <div class="list-item">
                                <div class="item-title">
                                    ${supplier.name || '未命名供应商'}
                                    <span class="badge ${(supplier.status === 'active' || !supplier.status) ? 'bg-success' : 'bg-secondary'} ms-2">
                                        ${(supplier.status === 'active' || !supplier.status) ? '活跃' : '非活跃'}
                                    </span>
                                </div>
                                <div class="item-meta" style="margin-top: 8px;">
                                    <div><strong>产品数量:</strong> ${supplier.products || 0} 个</div>
                                    ${supplier.mainCategory ? `<div><strong>主要类别:</strong> ${supplier.mainCategory}</div>` : ''}
                                    ${supplier.productTypes ? `<div><strong>产品类型:</strong> ${supplier.productTypes}</div>` : ''}
                                    ${supplier.description ? `<div><strong>描述:</strong> ${supplier.description}</div>` : ''}
                                    ${supplier.website ? `<div><strong>网站:</strong> <a href="${supplier.website}" target="_blank" style="color: #007bff;">${supplier.website}</a></div>` : ''}
                                    ${supplier.contact ? `<div><strong>联系:</strong> <a href="mailto:${supplier.contact}" style="color: #007bff;">${supplier.contact}</a></div>` : ''}
                                </div>
                            </div>
                        `).join('')
                    }
                </div>

                ${suppliers.length > 0 ? `
                    <div class="content-list" style="margin-top: 20px;">
                        <div class="list-header">
                            <i class="fas fa-chart-pie me-2"></i>供应商产品分布
                        </div>
                        ${suppliers.map(supplier => `
                            <div class="list-item">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><strong>${supplier.name}</strong></span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span>${supplier.products || 0} 个产品</span>
                                        <div style="width: 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${Math.min(100, (supplier.products || 0) / Math.max(1, totalProducts) * 100)}%; height: 100%; background: #007bff;"></div>
                                        </div>
                                        <span style="font-size: 12px; color: #6c757d;">${Math.round((supplier.products || 0) / Math.max(1, totalProducts) * 100)}%</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            document.getElementById('suppliersStats').innerHTML = statsHtml;
        }

        // 状态提示
        function showSyncStatus(message, type = 'info') {
            const statusDiv = document.getElementById('syncStatus');
            const alertClass = type === 'error' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' : 'alert-info';

            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' :
                                      type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').innerHTML = '';
        }

        // 定期刷新数据
        setInterval(loadAllData, 300000); // 每5分钟刷新一次
    </script>
</body>
</html>
