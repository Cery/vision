<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内容统计仪表板 - VisNDT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --sidebar-width: 280px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: all 0.3s ease;
            border-radius: 0;
        }
        
        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .content-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .content-section.active {
            display: block;
        }
        
        .section-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .section-header h2 {
            color: var(--primary-color);
            margin: 0;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table thead th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            font-weight: 500;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .badge {
            border-radius: 20px;
            padding: 8px 12px;
            font-weight: 500;
        }
        
        .pagination .page-link {
            border-radius: 8px;
            margin: 0 2px;
            border: 1px solid #e0e0e0;
            color: var(--primary-color);
        }
        
        .pagination .page-link:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .quill-editor {
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .ql-toolbar {
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .ql-container {
            border-radius: 0 0 8px 8px;
            min-height: 200px;
        }
        
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .image-item:hover {
            transform: scale(1.05);
        }
        
        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .image-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }
        
        .image-controls button {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-cogs me-2"></i>内容管理中心</h4>
            </div>
            <div class="nav flex-column">
                <button class="nav-link active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>仪表板
                </button>
                <button class="nav-link" onclick="showSection('products')">
                    <i class="fas fa-box"></i>产品管理
                </button>
                <button class="nav-link" onclick="showSection('suppliers')">
                    <i class="fas fa-truck"></i>供应商管理
                </button>
                <button class="nav-link" onclick="showSection('categories')">
                    <i class="fas fa-tags"></i>分类管理
                </button>
                <button class="nav-link" onclick="showSection('news')">
                    <i class="fas fa-newspaper"></i>新闻管理
                </button>
                <button class="nav-link" onclick="showSection('cases')">
                    <i class="fas fa-briefcase"></i>案例管理
                </button>
                <button class="nav-link" onclick="showSection('applications')">
                    <i class="fas fa-cog"></i>应用管理
                </button>
                <button class="nav-link" onclick="showSection('media')">
                    <i class="fas fa-images"></i>媒体库
                </button>
            </div>
        </nav>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 同步状态提示 -->
            <div id="syncStatus" class="sync-status"></div>

            <!-- 仪表板 -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h2><i class="fas fa-tachometer-alt me-2"></i>仪表板</h2>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="productCount">0</div>
                        <div class="stat-label">产品总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="supplierCount">0</div>
                        <div class="stat-label">供应商数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="newsCount">0</div>
                        <div class="stat-label">新闻数量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="caseCount">0</div>
                        <div class="stat-label">案例数量</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-sync me-2"></i>数据同步</h5>
                            </div>
                            <div class="card-body">
                                <p>管理和同步网站内容数据</p>
                                <button class="btn btn-primary" onclick="refreshData()">
                                    <i class="fas fa-sync me-2"></i>刷新数据
                                </button>
                                <button class="btn btn-outline-success ms-2" onclick="checkAPIStatus()">
                                    <i class="fas fa-server me-2"></i>API状态
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle me-2"></i>系统信息</h5>
                            </div>
                            <div class="card-body">
                                <p>内容管理系统状态正常</p>
                                <small class="text-muted">最后更新: <span id="lastUpdate">-</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 产品管理 -->
            <section id="products" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-box me-2"></i>产品管理</h2>
                </div>

                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" id="productSearch" placeholder="搜索产品..." onkeyup="filterProducts()">
                            <select class="form-select" id="categoryFilter" onchange="filterProducts()">
                                <option value="">所有分类</option>
                            </select>
                            <select class="form-select" id="supplierFilter" onchange="filterProducts()">
                                <option value="">所有供应商</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary" onclick="addProduct()">
                            <i class="fas fa-plus me-2"></i>添加产品
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>型号</th>
                                <th>分类</th>
                                <th>供应商</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            <!-- 产品列表将在这里动态生成 -->
                        </tbody>
                    </table>
                </div>

                <nav aria-label="产品分页">
                    <ul class="pagination justify-content-center" id="productPagination">
                        <!-- 分页将在这里动态生成 -->
                    </ul>
                </nav>
            </section>

            <!-- 其他管理部分的占位符 -->
            <section id="suppliers" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-truck me-2"></i>供应商管理</h2>
                </div>
                <p>供应商管理功能开发中...</p>
            </section>

            <section id="categories" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-tags me-2"></i>分类管理</h2>
                </div>
                <p>分类管理功能开发中...</p>
            </section>

            <section id="news" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-newspaper me-2"></i>新闻管理</h2>
                </div>
                <p>新闻管理功能开发中...</p>
            </section>

            <section id="cases" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-briefcase me-2"></i>案例管理</h2>
                </div>
                <p>案例管理功能开发中...</p>
            </section>

            <section id="applications" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-cog me-2"></i>应用管理</h2>
                </div>
                <p>应用管理功能开发中...</p>
            </section>

            <section id="media" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-images me-2"></i>媒体库</h2>
                </div>
                <p>媒体库功能开发中...</p>
            </section>
        </main>
    </div>

    <!-- 产品编辑模态框 -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">
                        <i class="fas fa-box me-2"></i>添加产品
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">产品名称 *</label>
                                    <input type="text" class="form-control" id="productTitle" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">产品型号 *</label>
                                    <input type="text" class="form-control" id="productModel" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">主分类 *</label>
                                    <select class="form-select" id="productPrimaryCategory" required>
                                        <option value="">请选择主分类</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">子分类 *</label>
                                    <select class="form-select" id="productSecondaryCategory" required>
                                        <option value="">请选择子分类</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">供应商 *</label>
                                    <select class="form-select" id="productSupplier" required>
                                        <option value="">请选择供应商</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">产品摘要</label>
                            <textarea class="form-control" id="productSummary" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">产品描述</label>
                            <div id="productDescription" class="quill-editor"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">应用场景</label>
                            <div id="productApplication" class="quill-editor"></div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">产品系列</label>
                                    <input type="text" class="form-control" id="productSeries">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">状态</label>
                                    <select class="form-select" id="productStatus">
                                        <option value="published">已发布</option>
                                        <option value="draft">草稿</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">产品参数</label>
                            <div id="productParameters">
                                <div class="parameter-item row mb-2">
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" placeholder="参数名称">
                                    </div>
                                    <div class="col-md-5">
                                        <input type="text" class="form-control" placeholder="参数值">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeParameter(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary" onclick="addParameter()">
                                <i class="fas fa-plus me-2"></i>添加参数
                            </button>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">产品图库</label>
                            <div id="productGallery" class="image-gallery">
                                <!-- 图片将在这里显示 -->
                            </div>
                            <button type="button" class="btn btn-outline-primary mt-2" onclick="selectImages('gallery')">
                                <i class="fas fa-images me-2"></i>选择图片
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>保存产品
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        // 全局变量
        let currentData = {
            products: [],
            suppliers: [],
            categories: [],
            news: [],
            cases: [],
            applications: []
        };

        let editors = {};
        let currentEditingProduct = null;
        let currentPage = 1;
        const itemsPerPage = 10;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            console.log('初始化内容管理系统...');

            // 初始化编辑器
            initializeEditors();

            // 加载数据
            loadAllData();

            // 更新最后更新时间
            updateLastUpdateTime();
        }

        function initializeEditors() {
            // 初始化Quill编辑器
            editors.description = new Quill('#productDescription', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        ['link', 'image'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            editors.application = new Quill('#productApplication', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        ['link', 'image'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
        }

        // 导航功能
        function showSection(sectionId) {
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // 移除所有导航链接的活动状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 显示选中的内容区域
            document.getElementById(sectionId).classList.add('active');

            // 设置对应导航链接为活动状态
            event.target.classList.add('active');

            // 根据不同部分加载相应数据
            switch(sectionId) {
                case 'dashboard':
                    updateDashboardStats();
                    break;
                case 'products':
                    renderProductList();
                    break;
            }
        }

        // 数据加载
        async function loadAllData() {
            try {
                showSyncStatus('正在加载数据...', 'info');

                // 模拟数据加载
                await loadProducts();
                await loadSuppliers();
                await loadCategories();

                updateDashboardStats();
                showSyncStatus('数据加载完成', 'success');

                setTimeout(() => {
                    hideSyncStatus();
                }, 2000);

            } catch (error) {
                console.error('数据加载失败:', error);
                showSyncStatus('数据加载失败: ' + error.message, 'error');
            }
        }

        async function loadProducts() {
            // 从实际项目数据加载产品
            try {
                // 尝试从Hugo生成的数据加载
                const response = await fetch('/index.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data.products) {
                        currentData.products = data.products.map(product => ({
                            id: product.id || product.model,
                            title: product.title,
                            model: product.model,
                            primaryCategory: product.primary_category,
                            secondaryCategory: product.secondary_category,
                            supplier: product.supplier,
                            status: product.status || 'published',
                            summary: product.summary,
                            description: product.description,
                            application: product.application,
                            series: product.series,
                            parameters: product.parameters || {},
                            gallery: product.gallery || []
                        }));
                        return;
                    }
                }
            } catch (error) {
                console.log('无法加载项目数据，使用模拟数据');
            }

            // 使用模拟数据作为后备
            currentData.products = [
                {
                    id: 'ws-p2410',
                    title: 'WS-P2410 工业视频内窥镜',
                    model: 'WS-P2410',
                    primaryCategory: '电子内窥镜',
                    secondaryCategory: '工业视频内窥镜',
                    supplier: 'VisNDT',
                    status: 'published',
                    summary: '高清工业视频内窥镜，适用于各种工业检测场景',
                    description: '专业的工业视频内窥镜设备，采用先进的成像技术，提供清晰的内部检测视野。',
                    application: '适用于汽车、航空、机械等行业的内部检测，可检测发动机、管道、零部件等。',
                    series: 'P系列',
                    parameters: {
                        '探头直径': '2.4mm',
                        '工作长度': '1m',
                        '分辨率': '1920x1080',
                        '屏幕尺寸': '6英寸',
                        '电池续航': '8小时'
                    },
                    gallery: []
                },
                {
                    id: 'ws-f1200',
                    title: 'WS-F1200 光纤内窥镜',
                    model: 'WS-F1200',
                    primaryCategory: '光纤内窥镜',
                    secondaryCategory: '柔性光纤内窥镜',
                    supplier: 'VisNDT',
                    status: 'published',
                    summary: '高品质光纤内窥镜，适用于精密检测',
                    description: '采用高品质光纤束，提供清晰的光学成像效果。',
                    application: '适用于精密机械、医疗设备等领域的检测。',
                    series: 'F系列',
                    parameters: {
                        '探头直径': '1.2mm',
                        '工作长度': '1.5m',
                        '视角': '60°',
                        '光源': '卤素灯'
                    },
                    gallery: []
                }
            ];
        }

        async function loadSuppliers() {
            currentData.suppliers = [
                { id: 1, name: 'VisNDT', description: '专业无损检测设备供应商' }
            ];
        }

        async function loadCategories() {
            currentData.categories = [
                {
                    id: 1,
                    name: '电子内窥镜',
                    subcategories: ['工业视频内窥镜', '工业管道内窥镜', '爬行机器人']
                },
                {
                    id: 2,
                    name: '光纤内窥镜',
                    subcategories: ['柔性光纤内窥镜', '硬性光纤内窥镜']
                },
                {
                    id: 3,
                    name: '光学内窥镜',
                    subcategories: ['硬性光学内窥镜', '柔性光学内窥镜']
                }
            ];
        }

        // 仪表板统计
        function updateDashboardStats() {
            document.getElementById('productCount').textContent = currentData.products.length;
            document.getElementById('supplierCount').textContent = currentData.suppliers.length;
            document.getElementById('newsCount').textContent = currentData.news.length;
            document.getElementById('caseCount').textContent = currentData.cases.length;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
        }

        // 同步状态显示
        function showSyncStatus(message, type = 'info') {
            const statusDiv = document.getElementById('syncStatus');
            const alertClass = type === 'error' ? 'alert-danger' :
                              type === 'success' ? 'alert-success' : 'alert-info';

            statusDiv.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' :
                                      type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function hideSyncStatus() {
            document.getElementById('syncStatus').innerHTML = '';
        }

        // 刷新数据
        async function refreshData() {
            await loadAllData();
        }

        // API状态检查
        async function checkAPIStatus() {
            showSyncStatus('检查API状态...', 'info');

            // 模拟API检查
            setTimeout(() => {
                showSyncStatus('API状态正常', 'success');
                setTimeout(hideSyncStatus, 2000);
            }, 1000);
        }

        // 产品管理功能
        function renderProductList() {
            const tbody = document.getElementById('productList');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = currentData.products.slice(startIndex, endIndex);

            tbody.innerHTML = pageProducts.map(product => `
                <tr>
                    <td>
                        <strong>${product.title}</strong>
                        <br><small class="text-muted">${product.summary || ''}</small>
                    </td>
                    <td><code>${product.model}</code></td>
                    <td>
                        <span class="badge bg-primary">${product.primaryCategory}</span>
                        <br><small>${product.secondaryCategory}</small>
                    </td>
                    <td>${product.supplier}</td>
                    <td>
                        <span class="badge ${product.status === 'published' ? 'bg-success' : 'bg-warning'}">
                            ${product.status === 'published' ? '已发布' : '草稿'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editProduct(${product.id})" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            renderProductPagination();
            populateFilters();
        }

        function renderProductPagination() {
            const totalPages = Math.ceil(currentData.products.length / itemsPerPage);
            const pagination = document.getElementById('productPagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 上一页
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
                </li>
            `;

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // 下一页
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
                </li>
            `;

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            const totalPages = Math.ceil(currentData.products.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderProductList();
            }
        }

        function populateFilters() {
            // 填充分类筛选器
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = [...new Set(currentData.products.map(p => p.primaryCategory))];
            categoryFilter.innerHTML = '<option value="">所有分类</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            // 填充供应商筛选器
            const supplierFilter = document.getElementById('supplierFilter');
            const suppliers = [...new Set(currentData.products.map(p => p.supplier))];
            supplierFilter.innerHTML = '<option value="">所有供应商</option>' +
                suppliers.map(sup => `<option value="${sup}">${sup}</option>`).join('');
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const supplierFilter = document.getElementById('supplierFilter').value;

            // 这里应该实现实际的筛选逻辑
            // 暂时只是重新渲染列表
            currentPage = 1;
            renderProductList();
        }

        function addProduct() {
            currentEditingProduct = null;
            document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-plus me-2"></i>添加产品';
            clearProductForm();
            populateProductFormSelects();

            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function editProduct(productId) {
            const product = currentData.products.find(p => p.id === productId);
            if (!product) return;

            currentEditingProduct = product;
            document.getElementById('productModalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>编辑产品';
            populateProductForm(product);
            populateProductFormSelects();

            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function clearProductForm() {
            document.getElementById('productForm').reset();
            editors.description.setContents([]);
            editors.application.setContents([]);
            document.getElementById('productParameters').innerHTML = `
                <div class="parameter-item row mb-2">
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="参数名称">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="参数值">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger" onclick="removeParameter(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('productGallery').innerHTML = '';
        }

        function populateProductForm(product) {
            document.getElementById('productTitle').value = product.title || '';
            document.getElementById('productModel').value = product.model || '';
            document.getElementById('productSummary').value = product.summary || '';
            document.getElementById('productSeries').value = product.series || '';
            document.getElementById('productStatus').value = product.status || 'draft';

            // 设置编辑器内容
            if (product.description) {
                editors.description.root.innerHTML = product.description;
            }
            if (product.application) {
                editors.application.root.innerHTML = product.application;
            }

            // 设置参数
            if (product.parameters) {
                const parametersDiv = document.getElementById('productParameters');
                parametersDiv.innerHTML = Object.entries(product.parameters).map(([key, value]) => `
                    <div class="parameter-item row mb-2">
                        <div class="col-md-5">
                            <input type="text" class="form-control" value="${key}" placeholder="参数名称">
                        </div>
                        <div class="col-md-5">
                            <input type="text" class="form-control" value="${value}" placeholder="参数值">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger" onclick="removeParameter(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function populateProductFormSelects() {
            // 填充主分类
            const primaryCategorySelect = document.getElementById('productPrimaryCategory');
            primaryCategorySelect.innerHTML = '<option value="">请选择主分类</option>' +
                currentData.categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');

            // 填充供应商
            const supplierSelect = document.getElementById('productSupplier');
            supplierSelect.innerHTML = '<option value="">请选择供应商</option>' +
                currentData.suppliers.map(sup => `<option value="${sup.name}">${sup.name}</option>`).join('');

            // 清除之前的事件监听器
            const newPrimaryCategorySelect = primaryCategorySelect.cloneNode(true);
            primaryCategorySelect.parentNode.replaceChild(newPrimaryCategorySelect, primaryCategorySelect);

            // 监听主分类变化
            newPrimaryCategorySelect.addEventListener('change', function() {
                const selectedCategory = currentData.categories.find(cat => cat.name === this.value);
                const secondaryCategorySelect = document.getElementById('productSecondaryCategory');

                if (selectedCategory) {
                    secondaryCategorySelect.innerHTML = '<option value="">请选择子分类</option>' +
                        selectedCategory.subcategories.map(sub => `<option value="${sub}">${sub}</option>`).join('');
                    secondaryCategorySelect.disabled = false;
                } else {
                    secondaryCategorySelect.innerHTML = '<option value="">请选择子分类</option>';
                    secondaryCategorySelect.disabled = true;
                }
            });

            // 如果是编辑模式，设置选中值
            if (currentEditingProduct) {
                setTimeout(() => {
                    newPrimaryCategorySelect.value = currentEditingProduct.primaryCategory || '';

                    // 触发change事件来更新子分类
                    const event = new Event('change');
                    newPrimaryCategorySelect.dispatchEvent(event);

                    // 设置子分类值
                    setTimeout(() => {
                        const secondaryCategorySelect = document.getElementById('productSecondaryCategory');
                        secondaryCategorySelect.value = currentEditingProduct.secondaryCategory || '';
                    }, 100);

                    // 设置供应商值
                    supplierSelect.value = currentEditingProduct.supplier || '';
                }, 100);
            }
        }

        function addParameter() {
            const parametersDiv = document.getElementById('productParameters');
            const newParameter = document.createElement('div');
            newParameter.className = 'parameter-item row mb-2';
            newParameter.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="参数名称">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="参数值">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger" onclick="removeParameter(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            parametersDiv.appendChild(newParameter);
        }

        function removeParameter(button) {
            button.closest('.parameter-item').remove();
        }

        async function saveProduct() {
            try {
                showSyncStatus('正在保存产品...', 'info');

                // 收集表单数据
                const productData = {
                    title: document.getElementById('productTitle').value,
                    model: document.getElementById('productModel').value,
                    primaryCategory: document.getElementById('productPrimaryCategory').value,
                    secondaryCategory: document.getElementById('productSecondaryCategory').value,
                    supplier: document.getElementById('productSupplier').value,
                    summary: document.getElementById('productSummary').value,
                    description: editors.description.root.innerHTML,
                    application: editors.application.root.innerHTML,
                    series: document.getElementById('productSeries').value,
                    status: document.getElementById('productStatus').value,
                    parameters: {}
                };

                // 收集参数
                document.querySelectorAll('.parameter-item').forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        productData.parameters[inputs[0].value] = inputs[1].value;
                    }
                });

                // 验证必填字段
                if (!productData.title || !productData.model || !productData.primaryCategory ||
                    !productData.secondaryCategory || !productData.supplier) {
                    throw new Error('请填写所有必填字段');
                }

                // 生成产品ID
                const productId = productData.model.toLowerCase().replace(/[^a-z0-9]/g, '-');
                productData.id = productId;

                // 保存产品到数据
                if (currentEditingProduct) {
                    // 更新现有产品
                    const index = currentData.products.findIndex(p => p.id === currentEditingProduct.id);
                    if (index !== -1) {
                        currentData.products[index] = { ...currentEditingProduct, ...productData };
                        showSyncStatus('产品更新成功', 'success');
                    }
                } else {
                    // 添加新产品
                    currentData.products.push(productData);
                    showSyncStatus('产品添加成功', 'success');
                }

                // 生成并保存Markdown文件
                await generateAndSaveMarkdown(productData);

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();

                // 刷新产品列表
                renderProductList();
                updateDashboardStats();

                setTimeout(hideSyncStatus, 3000);

            } catch (error) {
                console.error('保存产品失败:', error);
                showSyncStatus('保存失败: ' + error.message, 'error');
            }
        }

        // 生成并保存Markdown文件
        async function generateAndSaveMarkdown(productData) {
            try {
                const markdownContent = generateProductMarkdown(productData);
                const fileName = `${productData.model.toLowerCase()}.md`;

                // 尝试保存到项目目录
                const success = await saveToProjectDirectory(fileName, markdownContent);

                if (success) {
                    showSyncStatus(`✅ 产品MD文件已保存: content/products/${fileName}`, 'success');
                } else {
                    // 提供下载选项
                    downloadMarkdownFile(fileName, markdownContent);
                    showSyncStatus('⬇️ 自动保存失败，已提供下载', 'info');
                }

            } catch (error) {
                console.error('生成MD文件失败:', error);
                showSyncStatus('生成MD文件失败: ' + error.message, 'error');
            }
        }

        // 生成产品Markdown内容
        function generateProductMarkdown(product) {
            const frontMatter = {
                title: product.title,
                model: product.model,
                primary_category: product.primaryCategory,
                secondary_category: product.secondaryCategory,
                supplier: product.supplier,
                series: product.series,
                status: product.status,
                summary: product.summary,
                date: new Date().toISOString().split('T')[0],
                weight: 100
            };

            if (Object.keys(product.parameters).length > 0) {
                frontMatter.parameters = product.parameters;
            }

            let content = '---\n';
            Object.entries(frontMatter).forEach(([key, value]) => {
                if (typeof value === 'object') {
                    content += `${key}:\n`;
                    Object.entries(value).forEach(([k, v]) => {
                        content += `  "${k}": "${v}"\n`;
                    });
                } else {
                    content += `${key}: "${value}"\n`;
                }
            });
            content += '---\n\n';

            // 添加产品描述
            if (product.description) {
                content += '## 产品描述\n\n';
                content += product.description.replace(/<[^>]*>/g, '') + '\n\n';
            }

            // 添加应用场景
            if (product.application) {
                content += '## 应用场景\n\n';
                content += product.application.replace(/<[^>]*>/g, '') + '\n\n';
            }

            return content;
        }

        // 保存到项目目录
        async function saveToProjectDirectory(fileName, content) {
            try {
                // 使用File System Access API (如果支持)
                if ('showSaveFilePicker' in window) {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{
                            description: 'Markdown files',
                            accept: { 'text/markdown': ['.md'] }
                        }]
                    });

                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();
                    return true;
                }
            } catch (error) {
                console.log('File System Access API不可用或用户取消');
            }

            return false;
        }

        // 下载Markdown文件
        function downloadMarkdownFile(fileName, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function deleteProduct(productId) {
            if (confirm('确定要删除这个产品吗？')) {
                const index = currentData.products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    currentData.products.splice(index, 1);
                    renderProductList();
                    updateDashboardStats();
                    showSyncStatus('产品删除成功', 'success');
                    setTimeout(hideSyncStatus, 2000);
                }
            }
        }

        function selectImages(type) {
            // 这里应该实现图片选择功能
            showSyncStatus('图片选择功能开发中...', 'info');
            setTimeout(hideSyncStatus, 2000);
        }

        // 辅助函数
        function showSuccess(message) {
            showSyncStatus(message, 'success');
        }

        function showError(message) {
            showSyncStatus(message, 'error');
        }

        function showInfo(message) {
            showSyncStatus(message, 'info');
        }

        // 页面可见性变化时刷新数据
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // 页面变为可见时刷新数据
                setTimeout(refreshData, 1000);
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // Ctrl+S 保存产品
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                const modal = document.getElementById('productModal');
                if (modal.classList.contains('show')) {
                    saveProduct();
                }
            }

            // Escape 关闭模态框
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal.show');
                modals.forEach(modal => {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                });
            }
        });

        // 防止意外离开页面
        window.addEventListener('beforeunload', function(e) {
            const modal = document.getElementById('productModal');
            if (modal && modal.classList.contains('show')) {
                e.preventDefault();
                e.returnValue = '您有未保存的更改，确定要离开吗？';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
