<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完整内容管理中心 - VisNDT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --sidebar-width: 280px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .nav-menu {
            padding: 20px 0;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
        }
        
        .nav-link:hover,
        .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
        }
        
        .content-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(255,255,255,0.9);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 10px 15px;
            border-radius: 10px;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
            color: white;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }
        
        .stats-card h3 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .stats-card p {
            margin: 5px 0 0;
            color: #666;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.875rem;
            z-index: 1000;
            display: none;
        }
        
        .sync-status.show {
            display: block;
        }

        /* 产品表单样式 */
        .gallery-container, .downloads-container, .related-products-container {
            min-height: 100px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .gallery-placeholder, .downloads-placeholder, .related-products-placeholder {
            text-align: center;
            color: #6c757d;
        }

        .gallery-placeholder i, .downloads-placeholder i, .related-products-placeholder i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .gallery-item {
            display: inline-block;
            margin: 10px;
            position: relative;
        }

        .gallery-item .image-preview {
            position: relative;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .gallery-item img {
            width: 150px;
            height: 150px;
            object-fit: cover;
        }

        .gallery-item .image-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            padding: 5px;
            display: flex;
            gap: 5px;
        }

        .download-item, .related-product-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .download-item .file-info {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 15px;
        }

        .download-item .file-icon {
            font-size: 1.5rem;
            color: #6c757d;
        }

        .download-item .file-details {
            flex: 1;
        }

        .related-product-item .product-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .related-product-item .form-select {
            flex: 1;
        }

        .media-library-grid {
            max-height: 400px;
            overflow-y: auto;
        }

        .parameters-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .parameter-row {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .feature-coming-soon {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .feature-coming-soon i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .feature-coming-soon h5 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .feature-coming-soon p {
            margin-bottom: 20px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-actions .btn {
            flex: 1;
            min-width: 150px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-toggle {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1002;
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
        
        .mobile-toggle {
            display: none;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .overlay.show {
            display: block;
        }

        /* 产品管理样式 */
        .search-filter-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section-title {
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .parameter-row {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .parameter-row:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .table-actions {
            width: 120px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            font-size: 0.75rem;
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .pagination-sm .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .modal-xl {
            max-width: 1200px;
        }

        .parameters-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
        }

        .parameters-container:empty::before {
            content: "暂无参数，点击上方按钮添加";
            color: #666;
            font-style: italic;
            display: block;
            text-align: center;
            padding: 20px;
        }

        /* 分类层级面板样式 */
        .category-hierarchy-panel {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .category-search-history {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }

        .category-search-history.empty::before {
            content: "暂无搜索历史";
            color: #6c757d;
            font-style: italic;
            font-size: 0.9rem;
        }

        .history-item {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 15px;
            font-size: 0.85rem;
            color: #1976d2;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: #1976d2;
            color: white;
            transform: translateY(-1px);
        }

        .history-item .remove-history {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.7;
        }

        .history-item .remove-history:hover {
            opacity: 1;
        }

        .category-hierarchy-tree {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .category-tree-item {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .category-tree-item:last-child {
            border-bottom: none;
        }

        .category-tree-item:hover {
            background: #f8f9fa;
        }

        .category-tree-item.primary {
            font-weight: 600;
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
        }

        .category-tree-item.secondary {
            padding-left: 30px;
            font-size: 0.9rem;
            color: #666;
        }

        .category-tree-item.secondary::before {
            content: "└─";
            margin-right: 8px;
            color: #999;
        }

        .category-tree-item .category-icon {
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }

        .category-tree-item .product-count {
            margin-left: auto;
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .category-tree-item.primary .product-count {
            background: #1976d2;
        }

        /* 媒体库样式 */
        .media-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .media-item:hover .media-overlay {
            opacity: 1;
        }

        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .supplier-group {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
            margin-bottom: 20px;
        }

        .media-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }

        /* 媒体库选择器样式 */
        .media-item-modal {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .media-item-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .media-item-modal.selected {
            border-color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }

        .media-overlay-modal {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }

        .supplier-group-modal {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .list-group-item.media-item-modal:hover {
            background-color: #f8f9fa;
        }

        .list-group-item.media-item-modal.selected {
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* 编辑器媒体库样式 */
        .editor-media-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .editor-media-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #007bff;
        }

        .editor-media-item img {
            transition: all 0.3s ease;
        }

        .editor-media-item:hover img {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="overlay" onclick="closeSidebar()"></div>

    <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-left me-2"></i>返回
    </a>

    <div class="sync-status" id="syncStatus">
        <i class="fas fa-sync-alt me-2"></i>
        <span id="syncText">数据同步中...</span>
    </div>

    <div class="admin-layout">
        <!-- 侧边栏 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-tachometer-alt me-2"></i>内容管理中心</h4>
                <small class="text-light opacity-75">VisNDT 工业内窥镜</small>
            </div>

            <nav class="nav-menu">
                <div class="nav-item">
                    <button class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-home"></i>
                        <span>仪表板</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('products')">
                        <i class="fas fa-box"></i>
                        <span>产品管理</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('suppliers')">
                        <i class="fas fa-truck"></i>
                        <span>供应商管理</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('categories')">
                        <i class="fas fa-tags"></i>
                        <span>分类管理</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('news')">
                        <i class="fas fa-newspaper"></i>
                        <span>资讯管理</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('cases')">
                        <i class="fas fa-briefcase"></i>
                        <span>案例管理</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('applications')">
                        <i class="fas fa-cogs"></i>
                        <span>应用领域</span>
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-link" onclick="showSection('media')">
                        <i class="fas fa-images"></i>
                        <span>媒体库</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 内容头部 -->
            <div class="content-header">
                <div>
                    <h2 id="pageTitle">仪表板</h2>
                    <p class="text-muted mb-0" id="pageDescription">管理您的网站内容</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" onclick="syncToFrontend()">
                        <i class="fas fa-cloud-upload-alt me-2"></i>同步到前台
                    </button>
                    <button class="btn btn-primary" onclick="loadProjectData()">
                        <i class="fas fa-sync-alt me-2"></i>刷新数据
                    </button>
                    <button class="btn btn-outline-info" onclick="forceUpdateAllLists()">
                        <i class="fas fa-list me-2"></i>刷新列表
                    </button>
                    <button class="btn btn-outline-success" onclick="window.open('/admin/test-category-hierarchy.html', '_blank')" title="测试分类层级功能">
                        <i class="fas fa-sitemap me-2"></i>分类测试
                    </button>
                    <button class="btn btn-outline-warning" onclick="testProductForm()" title="测试产品表单功能">
                        <i class="fas fa-vial me-2"></i>表单测试
                    </button>
                    <button class="btn btn-outline-info" onclick="addProduct()" title="直接打开产品表单">
                        <i class="fas fa-plus me-2"></i>测试添加产品
                    </button>
                    <button class="btn btn-outline-danger" onclick="testAllFunctions()" title="测试所有功能">
                        <i class="fas fa-cog me-2"></i>功能测试
                    </button>
                    <button class="btn btn-outline-warning" onclick="testCategoryData()" title="测试分类数据">
                        <i class="fas fa-tags me-2"></i>分类测试
                    </button>
                    <button class="btn btn-outline-success" onclick="debugCategoryDisplay()" title="调试分类显示">
                        <i class="fas fa-search me-2"></i>分类调试
                    </button>
                    <button class="btn btn-success" onclick="autoAddFiberEndoscope()" title="自动添加光纤内窥镜产品">
                        <i class="fas fa-magic me-2"></i>自动测试
                    </button>
                    <button class="btn btn-outline-primary" onclick="quickTestProduct()" title="快速测试产品表单">
                        <i class="fas fa-bolt me-2"></i>快速测试
                    </button>
                    <button class="btn btn-outline-danger" onclick="debugSaveProduct()" title="调试保存功能">
                        <i class="fas fa-bug me-2"></i>调试保存
                    </button>
                    <button class="btn btn-outline-secondary" onclick="forceReloadProducts()" title="强制重新加载产品数据">
                        <i class="fas fa-sync me-2"></i>重新加载
                    </button>
                    <button class="btn btn-outline-info" onclick="updateSearchIndex()" title="更新搜索索引">
                        <i class="fas fa-search me-2"></i>更新索引
                    </button>
                    <button class="btn btn-warning" onclick="debugManualSave()" title="调试手动保存流程">
                        <i class="fas fa-hand-paper me-2"></i>手动保存调试
                    </button>
                    <button class="btn btn-outline-warning" onclick="testSimpleSave()" title="简单保存测试">
                        <i class="fas fa-vial me-2"></i>简单测试
                    </button>
                    <button class="btn btn-danger" onclick="fixDisplayIssues()" title="修复显示问题">
                        <i class="fas fa-wrench me-2"></i>修复显示
                    </button>
                    <button class="btn btn-warning" onclick="fixImageIssues()" title="修复图片问题">
                        <i class="fas fa-image me-2"></i>修复图片
                    </button>
                </div>
            </div>

            <!-- 仪表板 -->
            <div id="dashboard" class="content-section active">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stats-card" onclick="showSection('products')">
                            <div class="icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <h3 id="productCount">6</h3>
                            <p>产品总数</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" onclick="showSection('suppliers')">
                            <div class="icon">
                                <i class="fas fa-truck"></i>
                            </div>
                            <h3 id="supplierCount">3</h3>
                            <p>供应商</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" onclick="showSection('news')">
                            <div class="icon">
                                <i class="fas fa-newspaper"></i>
                            </div>
                            <h3 id="newsCount">12</h3>
                            <p>资讯文章</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card" onclick="showSection('cases')">
                            <div class="icon">
                                <i class="fas fa-briefcase"></i>
                            </div>
                            <h3 id="caseCount">8</h3>
                            <p>应用案例</p>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i>欢迎使用内容管理中心</h5>
                            <p class="mb-0">这里是您管理网站内容的中心。您可以管理产品、供应商、分类、资讯、案例、应用领域和媒体文件。所有数据修改都会实时同步到前台网站。</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle me-2"></i>功能特色</h5>
                            <ul class="mb-0">
                                <li>完整的CRUD操作支持</li>
                                <li>实时数据同步</li>
                                <li>供应商筛选和搜索</li>
                                <li>富文本编辑器</li>
                                <li>媒体库管理</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <h5><i class="fas fa-rocket me-2"></i>快速操作</h5>
                        <div class="quick-actions">
                            <button class="btn btn-outline-primary" onclick="showSection('products')">
                                <i class="fas fa-plus me-2"></i>添加产品
                            </button>
                            <button class="btn btn-outline-success" onclick="showSection('suppliers')">
                                <i class="fas fa-plus me-2"></i>添加供应商
                            </button>
                            <button class="btn btn-outline-info" onclick="showSection('news')">
                                <i class="fas fa-plus me-2"></i>发布资讯
                            </button>
                            <button class="btn btn-outline-warning" onclick="showSection('cases')">
                                <i class="fas fa-plus me-2"></i>添加案例
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSection('media')">
                                <i class="fas fa-upload me-2"></i>上传媒体
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 产品管理 -->
            <div id="products" class="content-section">
                <!-- 搜索和筛选栏 -->
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="搜索产品名称、型号..." id="productSearch" onkeyup="filterProducts()">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="supplierFilter" onchange="filterProducts()">
                                <option value="">所有供应商</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="position-relative">
                                <select class="form-select" id="categoryFilter" onchange="filterProducts()" onclick="showCategoryHierarchy()">
                                    <option value="">所有分类</option>
                                </select>
                                <button class="btn btn-outline-info btn-sm position-absolute top-0 end-0 me-1 mt-1"
                                        onclick="toggleCategoryPanel()" title="分类层级视图" style="z-index: 10;">
                                    <i class="fas fa-sitemap"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter" onchange="filterProducts()">
                                <option value="">所有状态</option>
                                <option value="published">已发布</option>
                                <option value="draft">草稿</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearProductFilters()" title="清除筛选">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-success flex-fill" onclick="addProduct()">
                                    <i class="fas fa-plus me-2"></i>添加产品
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="debugProductData()" title="调试产品数据">
                                    <i class="fas fa-bug"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分类层级面板 -->
                <div id="categoryHierarchyPanel" class="category-hierarchy-panel mb-3" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-sitemap me-2"></i>产品分类层级
                            </h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearCategoryHistory()">
                                    <i class="fas fa-history me-1"></i>清除历史
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="toggleCategoryPanel()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <!-- 搜索历史 -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-history me-1"></i>最近搜索
                                </h6>
                                <div id="categorySearchHistory" class="category-search-history">
                                    <!-- 历史记录将在这里显示 -->
                                </div>
                            </div>

                            <!-- 分类层级树 -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-tree me-1"></i>分类层级
                                </h6>
                                <div id="categoryHierarchyTree" class="category-hierarchy-tree">
                                    <!-- 分类树将在这里显示 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 产品列表 -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>型号</th>
                                <th>分类</th>
                                <th>供应商</th>
                                <th>系列</th>
                                <th>状态</th>
                                <th>更新时间</th>
                                <th class="table-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            <tr>
                                <td colspan="8" class="loading">
                                    <i class="fas fa-spinner"></i>
                                    <div>正在加载产品数据...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="产品分页" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="productPaginationInfo">显示 0 个产品</small>
                        <ul class="pagination pagination-sm mb-0" id="productPagination">
                            <!-- 分页按钮将由JavaScript生成 -->
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- 供应商管理 -->
            <div id="suppliers" class="content-section">
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" placeholder="搜索供应商名称..." id="supplierSearch" onkeyup="filterSuppliers()">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="supplierTypeFilter" onchange="filterSuppliers()">
                                <option value="">所有类型</option>
                                <option value="制造商">制造商</option>
                                <option value="代理商">代理商</option>
                                <option value="服务商">服务商</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearSupplierFilters()" title="清除筛选">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-success flex-fill" onclick="addSupplier()">
                                    <i class="fas fa-plus me-2"></i>添加供应商
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>供应商名称</th>
                                <th>类型</th>
                                <th>产品数量</th>
                                <th>联系人</th>
                                <th>联系方式</th>
                                <th>状态</th>
                                <th class="table-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="supplierList">
                            <tr><td colspan="7" class="loading"><i class="fas fa-spinner"></i><div>正在加载供应商数据...</div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="供应商分页" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="supplierPaginationInfo">显示 0 个供应商</small>
                        <ul class="pagination pagination-sm mb-0" id="supplierPagination">
                            <!-- 分页按钮将由JavaScript生成 -->
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- 分类管理 -->
            <div id="categories" class="content-section">
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="搜索分类名称..." id="categorySearch" onkeyup="filterCategories()">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearCategoryFilters()" title="清除筛选">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-success flex-fill" onclick="addCategory()">
                                    <i class="fas fa-plus me-2"></i>添加分类
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>分类名称</th>
                                <th>分类级别</th>
                                <th>产品数量</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th class="table-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="categoryList">
                            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i><div>正在加载分类数据...</div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="分类分页" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="categoryPaginationInfo">显示 0 个分类</small>
                        <ul class="pagination pagination-sm mb-0" id="categoryPagination">
                            <!-- 分页按钮将由JavaScript生成 -->
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- 资讯管理 -->
            <div id="news" class="content-section">
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="搜索资讯标题..." id="newsSearch" onkeyup="filterNews()">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="newsCategoryFilter" onchange="filterNews()">
                                <option value="">所有分类</option>
                                <option value="行业资讯">行业资讯</option>
                                <option value="展会资讯">展会资讯</option>
                                <option value="技术动态">技术动态</option>
                                <option value="公司新闻">公司新闻</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="newsAuthorFilter" onchange="filterNews()">
                                <option value="">所有作者</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearNewsFilters()" title="清除筛选">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-success flex-fill" onclick="addNews()">
                                    <i class="fas fa-plus me-2"></i>添加资讯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>分类</th>
                                <th>作者</th>
                                <th>浏览量</th>
                                <th>发布时间</th>
                                <th class="table-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="newsList">
                            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i><div>正在加载资讯数据...</div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="资讯分页" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="newsPaginationInfo">显示 0 个资讯</small>
                        <ul class="pagination pagination-sm mb-0" id="newsPagination">
                            <!-- 分页按钮将由JavaScript生成 -->
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- 案例管理 -->
            <div id="cases" class="content-section">
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="搜索案例标题..." id="caseSearch" onkeyup="filterCases()">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="caseIndustryFilter" onchange="filterCases()">
                                <option value="">所有行业</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="caseFieldFilter" onchange="filterCases()">
                                <option value="">所有领域</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearCaseFilters()" title="清除筛选">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-success flex-fill" onclick="addCase()">
                                    <i class="fas fa-plus me-2"></i>添加案例
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>案例标题</th>
                                <th>客户</th>
                                <th>行业</th>
                                <th>应用领域</th>
                                <th>发布时间</th>
                                <th class="table-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="caseList">
                            <tr><td colspan="6" class="loading"><i class="fas fa-spinner"></i><div>正在加载案例数据...</div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="案例分页" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="casePaginationInfo">显示 0 个案例</small>
                        <ul class="pagination pagination-sm mb-0" id="casePagination">
                            <!-- 分页按钮将由JavaScript生成 -->
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- 应用领域管理 -->
            <div id="applications" class="content-section">
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" placeholder="搜索应用领域..." id="applicationSearch" onkeyup="filterApplications()">
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" onclick="clearApplicationFilters()" title="清除筛选">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-success flex-fill" onclick="addApplication()">
                                    <i class="fas fa-plus me-2"></i>添加应用领域
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>应用领域</th>
                                <th>权重</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th class="table-actions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="applicationList">
                            <tr><td colspan="5" class="loading"><i class="fas fa-spinner"></i><div>正在加载应用领域数据...</div></td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <nav aria-label="应用领域分页" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="applicationPaginationInfo">显示 0 个应用领域</small>
                        <ul class="pagination pagination-sm mb-0" id="applicationPagination">
                            <!-- 分页按钮将由JavaScript生成 -->
                        </ul>
                    </div>
                </nav>
            </div>

            <!-- 媒体库管理 -->
            <div id="media" class="content-section">
                <div class="search-filter-bar">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="mediaSearch" placeholder="搜索媒体文件..." onkeyup="filterMediaLibrary()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="mediaSupplierFilter" onchange="filterMediaLibrary()">
                                <option value="">所有供应商</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="mediaTypeFilter" onchange="filterMediaLibrary()">
                                <option value="">所有类型</option>
                                <option value="image">图片</option>
                                <option value="file">文件</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="btn-group w-100">
                                <button class="btn btn-primary" onclick="uploadToMediaLibrary('image')">
                                    <i class="fas fa-image me-1"></i>上传图片
                                </button>
                                <button class="btn btn-success" onclick="uploadToMediaLibrary('file')">
                                    <i class="fas fa-file me-1"></i>上传文件
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-folder-open me-2"></i>媒体库 - 按供应商分组</h6>
                                <button class="btn btn-outline-secondary btn-sm" onclick="refreshMediaLibrary()">
                                    <i class="fas fa-sync-alt me-1"></i>刷新
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="mediaLibraryContainer">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                        <p class="mt-2 text-muted">正在加载媒体库...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 产品模态框 -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">添加产品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <!-- 基本信息 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="section-title">基本信息</h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">产品标题 *</label>
                                <input type="text" class="form-control" id="productTitle" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">产品型号 *</label>
                                <input type="text" class="form-control" id="productModel" required>
                            </div>
                            <div class="col-12 mt-3">
                                <label class="form-label">产品摘要</label>
                                <textarea class="form-control" id="productSummary" rows="2" placeholder="简短描述产品特点..."></textarea>
                            </div>
                        </div>

                        <!-- 分类和供应商 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="section-title">分类和供应商</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">主要分类 *</label>
                                <select class="form-select" id="productPrimaryCategory" required onchange="updateSecondaryCategories()">
                                    <option value="">选择主要分类</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">次要分类</label>
                                <select class="form-select" id="productSecondaryCategory">
                                    <option value="">选择次要分类</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">供应商 *</label>
                                <select class="form-select" id="productSupplier" required onchange="updateProductSeries()">
                                    <option value="">选择供应商</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">产品系列</label>
                                <select class="form-select" id="productSeries">
                                    <option value="">选择产品系列</option>
                                </select>
                            </div>
                        </div>

                        <!-- 技术参数 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-title mb-0">技术参数</h6>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadParameterTemplate()">
                                            <i class="fas fa-magic me-1"></i>加载默认模板
                                        </button>
                                        <button type="button" class="btn btn-outline-success btn-sm" onclick="addParameter()">
                                            <i class="fas fa-plus me-1"></i>添加参数
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div id="parametersContainer" class="parameters-container">
                                    <!-- 参数将由JavaScript动态添加 -->
                                </div>
                            </div>
                        </div>

                        <!-- 产品图库 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-title mb-0">产品图库</h6>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="openMediaLibrary('gallery')">
                                            <i class="fas fa-images me-1"></i>从媒体库选择图片
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div id="galleryContainer" class="gallery-container">
                                    <div class="gallery-placeholder">
                                        <i class="fas fa-images"></i>
                                        <p>点击上方按钮添加产品图片</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 资料下载 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-title mb-0">资料下载</h6>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="openMediaLibrary('downloads')">
                                            <i class="fas fa-folder me-1"></i>从媒体库选择文件
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div id="downloadsContainer" class="downloads-container">
                                    <div class="downloads-placeholder">
                                        <i class="fas fa-file-alt"></i>
                                        <p>点击上方按钮添加下载文件</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 相关产品 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="section-title mb-0">相关产品</h6>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addRelatedProduct()">
                                        <i class="fas fa-plus me-1"></i>添加相关产品
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div id="relatedProductsContainer" class="related-products-container">
                                    <div class="related-products-placeholder">
                                        <i class="fas fa-link"></i>
                                        <p>点击上方按钮添加相关产品</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 详细描述 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="section-title">详细描述</h6>
                                <div id="productDescriptionEditor" style="height: 300px;"></div>
                                <textarea id="productDescription" style="display: none;"></textarea>
                            </div>
                        </div>

                        <!-- 应用场景 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="section-title">应用场景</h6>
                                <div id="productApplicationEditor" style="height: 200px;"></div>
                                <textarea id="productApplication" style="display: none;"></textarea>
                            </div>
                        </div>

                        <!-- 发布设置 -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="section-title">发布设置</h6>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">发布状态</label>
                                <select class="form-select" id="productStatus">
                                    <option value="published">已发布</option>
                                    <option value="draft">草稿</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">权重</label>
                                <input type="number" class="form-control" id="productWeight" value="1" min="1" max="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">发布日期</label>
                                <input type="date" class="form-control" id="productDate">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>保存产品
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Quill Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        // 页面切换函数
        function showSection(sectionName) {
            // 隐藏所有内容区域
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // 移除所有导航链接的活动状态
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // 显示选中的内容区域
            const targetSection = document.getElementById(sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // 设置对应导航链接为活动状态
            const targetLink = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }

            // 更新页面标题和描述
            const titles = {
                'dashboard': { title: '仪表板', desc: '管理您的网站内容' },
                'products': { title: '产品管理', desc: '管理产品信息、分类和供应商关系' },
                'suppliers': { title: '供应商管理', desc: '管理供应商信息和产品系列' },
                'categories': { title: '分类管理', desc: '管理产品分类和层级结构' },
                'news': { title: '资讯管理', desc: '管理新闻文章和行业动态' },
                'cases': { title: '案例管理', desc: '管理应用案例和客户成功故事' },
                'applications': { title: '应用领域管理', desc: '管理行业应用和技术特点' },
                'media': { title: '媒体库', desc: '管理图片、文档和其他媒体文件' }
            };

            const pageInfo = titles[sectionName] || { title: '内容管理', desc: '管理您的网站内容' };
            document.getElementById('pageTitle').textContent = pageInfo.title;
            document.getElementById('pageDescription').textContent = pageInfo.desc;

            // 在移动端关闭侧边栏
            if (window.innerWidth <= 768) {
                closeSidebar();
            }

            // 更新当前页面的列表数据
            setTimeout(() => {
                updateCurrentSectionList();
            }, 100);
        }

        // 移动端侧边栏控制
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');

            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');

            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }

        // 显示同步状态
        function showSyncStatus(message, duration = 3000) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');

            syncText.textContent = message;
            syncStatus.classList.add('show');

            setTimeout(() => {
                syncStatus.classList.remove('show');
            }, duration);
        }



        // 同步到前台
        function syncToFrontend() {
            showSyncStatus('正在同步到前台...');

            // 模拟同步过程
            setTimeout(() => {
                showSyncStatus('同步完成！前台数据已更新', 2000);
            }, 2000);
        }

        // 全局变量
        let projectData = {
            products: [],
            suppliers: [],
            categories: [],
            news: [],
            cases: [],
            applications: []
        };

        let currentEditingProductId = null;
        let filteredProducts = [];
        let filteredSuppliers = [];
        let filteredNews = [];
        let filteredCases = [];
        let filteredApplications = [];
        let filteredCategories = [];

        // 编辑器实例
        let productDescriptionEditor = null;
        let productApplicationEditor = null;

        // 分页状态
        let currentProductPage = 1;
        let currentSupplierPage = 1;
        let currentNewsPage = 1;
        let currentCasePage = 1;
        let currentApplicationPage = 1;
        let currentCategoryPage = 1;
        const itemsPerPage = 10;

        // 真实项目分类层级（与categoryHierarchyData保持一致）
        let categoryHierarchy = {
            '电子内窥镜': ['工业视频内窥镜', '工业管道内窥镜', '爬行机器人'],
            '光纤内窥镜': ['柔性光纤内窥镜', '硬性光纤内窥镜'],
            '光学内窥镜': ['硬性光学内窥镜', '柔性光学内窥镜']
        };

        const supplierSeriesMap = {
            '深圳市微视光电科技有限公司': ['K系列', 'P系列', 'DZ系列', 'S系列', 'F系列', 'LA系列'],
            '天津维森科技有限公司': ['VIS-P系列', 'VIS-T系列'],
            '上海尚品科技有限公司': ['G系列', 'L系列', 'M系列']
        };

        const defaultParameterTemplates = {
            '电子内窥镜': [
                { name: '主机屏幕', value: '6英寸' },
                { name: '待机时长', value: '8小时' },
                { name: '探头直径', value: '2.8mm' },
                { name: '像素', value: '100万' },
                { name: '景深', value: '3mm~70mm' },
                { name: '视场角', value: '120度' },
                { name: '视向', value: '直视' },
                { name: '光源', value: '光纤光源' }
            ]
        };

        // 从搜索索引和API加载实际项目数据
        async function loadProjectData() {
            try {
                showSyncStatus('正在同步项目数据...');

                // 并行加载所有内容类型
                const [searchResponse, productsResponse, suppliersResponse, newsResponse, casesResponse, applicationsResponse] = await Promise.all([
                    fetch('/search-index.json').catch(() => null),
                    fetch('http://localhost:3002/api/products/list').catch(() => null),
                    fetch('http://localhost:3002/api/suppliers/list').catch(() => null),
                    fetch('http://localhost:3002/api/news/list').catch(() => null),
                    fetch('http://localhost:3002/api/cases/list').catch(() => null),
                    fetch('http://localhost:3002/api/applications/list').catch(() => null)
                ]);

                // 解析搜索索引数据（主要数据源）
                let searchData = [];
                if (searchResponse && searchResponse.ok) {
                    searchData = await searchResponse.json();
                    console.log(`📊 从搜索索引加载了 ${searchData.length} 条记录`);
                }

                // 解析产品数据
                console.log('🔍 开始解析产品数据...');
                const allProductPages = searchData.filter(page => page.type === 'products');
                console.log(`📊 找到 ${allProductPages.length} 个products类型的页面`);

                const validProductPages = allProductPages.filter(page =>
                    page.title && page.title.trim() !== '' &&
                    !page.uri.includes('_index') &&
                    !page.uri.includes('model.md')
                );
                console.log(`✅ 过滤后有效产品页面: ${validProductPages.length} 个`);

                if (validProductPages.length === 0) {
                    console.log('⚠️ 没有找到有效的产品页面，显示所有products类型页面:');
                    allProductPages.forEach(page => {
                        console.log(`  - ${page.title} (${page.uri}) - type: ${page.type}`);
                    });
                }

                projectData.products = validProductPages.map(page => {
                    const productId = page.uri.replace('/products/', '').replace('/', '');

                    return {
                        id: productId,
                        title: page.title,
                        model: page.params?.model || extractModelFromTitle(page.title),
                        summary: page.summary || page.params?.summary || '',
                        primary_category: page.params?.primary_category || '电子内窥镜',
                        secondary_category: page.params?.secondary_category || '工业视频内窥镜',
                        supplier: page.params?.supplier || extractSupplierFromContent(page.content),
                        series: page.params?.series || extractSeriesFromTitle(page.title),
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0],
                        uri: page.uri,
                        content: page.content || '',
                        params: page.params || {},
                        gallery: page.params?.gallery || [],
                        parameters: page.params?.parameters || [],
                        data_download: page.params?.data_download || [],
                        related_products: page.params?.related_products || []
                    };
                });

                // 如果没有找到产品数据，使用备用数据
                if (projectData.products.length === 0) {
                    console.log('⚠️ 搜索索引中未找到产品数据，使用备用产品数据...');
                    projectData.products = [
                        {
                            id: 'ws-k1010-a',
                            title: 'WS-K1010工业内窥镜',
                            model: 'WS-K1010',
                            summary: '1.0mm直径高清探头，适配狭小空间高精度工业检测任务',
                            primary_category: '电子内窥镜',
                            secondary_category: '工业视频内窥镜',
                            supplier: '深圳市微视光电科技有限公司',
                            series: 'K系列',
                            status: 'published',
                            date: '2025-01-01',
                            uri: '/products/ws-k1010-a/',
                            content: '',
                            params: {}
                        },
                        {
                            id: 'ws-k1210-a',
                            title: 'WS-K1210工业内窥镜',
                            model: 'WS-K1210',
                            summary: '1.2mm直径高清探头，平衡性能与尺寸的理想选择',
                            primary_category: '电子内窥镜',
                            secondary_category: '工业视频内窥镜',
                            supplier: '深圳市微视光电科技有限公司',
                            series: 'K系列',
                            status: 'published',
                            date: '2025-01-02',
                            uri: '/products/ws-k1210-a/',
                            content: '',
                            params: {}
                        },
                        {
                            id: 'product-p1010-model',
                            title: 'WS-P1010便携式工业内窥镜',
                            model: 'WS-P1010',
                            summary: '便携式设计，1.0mm探头，适合现场检测',
                            primary_category: '电子内窥镜',
                            secondary_category: '便携式内窥镜',
                            supplier: '深圳市微视光电科技有限公司',
                            series: 'P系列',
                            status: 'published',
                            date: '2025-01-03',
                            uri: '/products/product-p1010-model/',
                            content: '',
                            params: {}
                        }
                    ];
                }

                console.log(`✅ 产品数据加载完成: ${projectData.products.length} 个产品`);

                // 解析供应商数据
                let suppliersFromSearch = searchData.filter(page =>
                    page.type === 'suppliers' &&
                    page.title && page.title.trim() !== ''
                ).map(page => {
                    const supplierId = page.uri.replace('/suppliers/', '').replace('/', '');

                    return {
                        id: supplierId,
                        name: page.title,
                        title: page.title,
                        address: page.params?.address || page.params?.contact?.address || '',
                        type: page.params?.type || '制造商',
                        series: page.params?.series || [],
                        models: page.params?.models || [],
                        contact_person: page.params?.contact_person || page.params?.contact?.contact_person || '',
                        phone: page.params?.phone || page.params?.contact?.phone || '',
                        email: page.params?.email || page.params?.contact?.email || '',
                        description: page.params?.description || page.content || '',
                        products: 0, // 稍后计算
                        status: 'active',
                        date: page.date || new Date().toISOString().split('T')[0],
                        uri: page.uri,
                        content: page.content || '',
                        params: page.params || {}
                    };
                });

                // 如果没有从搜索索引找到供应商，从产品数据中提取
                if (suppliersFromSearch.length === 0) {
                    console.log('⚠️ 搜索索引中未找到供应商数据，从产品数据中提取...');
                    const supplierSet = new Set();
                    projectData.products.forEach(product => {
                        if (product.supplier) {
                            supplierSet.add(product.supplier);
                        }
                    });

                    suppliersFromSearch = Array.from(supplierSet).map((name, index) => ({
                        id: `supplier-${index + 1}`,
                        name: name,
                        title: name,
                        address: name.includes('深圳') ? '广东省深圳市' : name.includes('天津') ? '天津市' : name.includes('上海') ? '上海市' : '',
                        type: '制造商',
                        series: getSupplierSeries(name),
                        models: [],
                        contact_person: '销售部',
                        phone: '400-000-0000',
                        email: 'sales@company.com',
                        description: `专业的${name}，专注于工业内窥镜设备的研发和制造。`,
                        products: 0, // 稍后计算
                        status: 'active',
                        date: new Date().toISOString().split('T')[0],
                        uri: `/suppliers/${name.toLowerCase().replace(/[^a-z0-9]/g, '-')}/`,
                        content: '',
                        params: {}
                    }));
                }

                // 如果仍然没有供应商数据，使用硬编码的实际供应商信息
                if (suppliersFromSearch.length === 0) {
                    console.log('⚠️ 使用硬编码的实际供应商数据...');
                    suppliersFromSearch = [
                        {
                            id: 'vsndt',
                            name: '深圳市微视光电科技有限公司',
                            title: '深圳市微视光电科技有限公司',
                            address: '广东省深圳市',
                            type: '制造商',
                            series: ['K系列', 'P系列', 'DZ系列', 'S系列', 'F系列', 'LA系列'],
                            models: ['1.0mm', '1.2mm', '2.8mm', '3.9mm', '6mm', '8mm'],
                            contact_person: '销售部',
                            phone: '400-000-0000',
                            email: 'sales@sz-wise.cn',
                            description: '专业的工业视频内窥镜制造商，专注于高精度检测设备的研发和制造。',
                            products: 0,
                            status: 'active',
                            date: new Date().toISOString().split('T')[0],
                            uri: '/suppliers/vsndt/',
                            content: '',
                            params: {}
                        },
                        {
                            id: 'vis',
                            name: '天津维森科技有限公司',
                            title: '天津维森科技有限公司',
                            address: '天津市',
                            type: '制造商',
                            series: ['VIS-P系列', 'VIS-T系列'],
                            models: ['2.8mm', '3.9mm', '6mm'],
                            contact_person: '技术部',
                            phone: '400-000-0001',
                            email: 'info@vis-tech.cn',
                            description: '高端视频内窥镜设备供应商，提供专业的工业检测解决方案。',
                            products: 0,
                            status: 'active',
                            date: new Date().toISOString().split('T')[0],
                            uri: '/suppliers/vis/',
                            content: '',
                            params: {}
                        },
                        {
                            id: 'spkj',
                            name: '上海尚品科技有限公司',
                            title: '上海尚品科技有限公司',
                            address: '上海市',
                            type: '贸易商',
                            series: ['G系列', 'L系列', 'M系列'],
                            models: ['2.8mm', '3.9mm', '6mm'],
                            contact_person: '王轩',
                            phone: '15222189183',
                            email: 'wangxuan@sz-wise.cn',
                            description: '专注于工业视频内窥镜、无损内部视觉检测行业。',
                            products: 0,
                            status: 'active',
                            date: new Date().toISOString().split('T')[0],
                            uri: '/suppliers/spkj/',
                            content: '',
                            params: {}
                        }
                    ];
                }

                // 计算每个供应商的产品数量
                suppliersFromSearch.forEach(supplier => {
                    supplier.products = projectData.products.filter(p => p.supplier === supplier.name).length;
                });

                projectData.suppliers = suppliersFromSearch;

                // 解析资讯数据
                let newsFromSearch = searchData.filter(page =>
                    page.type === 'news' &&
                    page.title && page.title.trim() !== '' &&
                    !page.uri.includes('_index')
                ).map(page => {
                    const newsId = page.uri.replace('/news/', '').replace('/', '');

                    return {
                        id: newsId,
                        title: page.title,
                        summary: page.summary || page.params?.summary || '',
                        categories: page.params?.categories || ['行业资讯'],
                        tags: page.params?.tags || [],
                        author: page.params?.author || '编辑部',
                        views: page.params?.views || Math.floor(Math.random() * 200) + 50,
                        featured_image: page.params?.featured_image || '/images/news/default.jpg',
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0],
                        uri: page.uri,
                        content: page.content || '',
                        params: page.params || {}
                    };
                });

                // 如果没有找到资讯数据，创建一些示例数据
                if (newsFromSearch.length === 0) {
                    console.log('⚠️ 未找到资讯数据，创建示例数据...');
                    newsFromSearch = [
                        {
                            id: 'industry-news-1',
                            title: '2024年工业检测设备市场发展趋势',
                            summary: '分析2024年工业检测设备市场的最新发展趋势和技术创新方向',
                            categories: ['行业资讯'],
                            tags: ['市场分析', '技术趋势'],
                            author: '市场部',
                            views: 156,
                            featured_image: '/images/news/industry-1.jpg',
                            status: 'published',
                            date: '2024-03-20',
                            uri: '/news/industry-news-1/',
                            content: '工业检测设备市场在2024年呈现出强劲的增长势头...',
                            params: {}
                        },
                        {
                            id: 'exhibition-news-1',
                            title: '第25届中国国际工业博览会即将开幕',
                            summary: '展会将展示最新的工业检测技术和设备，汇聚全球知名企业',
                            categories: ['展会资讯'],
                            tags: ['工业博览会', '展会'],
                            author: '展会部',
                            views: 89,
                            featured_image: '/images/news/exhibition-1.jpg',
                            status: 'published',
                            date: '2024-03-18',
                            uri: '/news/exhibition-news-1/',
                            content: '第25届中国国际工业博览会将于2024年9月在上海举行...',
                            params: {}
                        },
                        {
                            id: 'tech-article-1',
                            title: 'AI技术在工业内窥镜中的应用前景',
                            summary: '探讨人工智能技术在工业内窥镜检测中的创新应用和发展前景',
                            categories: ['技术文章'],
                            tags: ['人工智能', '技术创新'],
                            author: '技术部',
                            views: 234,
                            featured_image: '/images/news/tech-1.jpg',
                            status: 'published',
                            date: '2024-03-15',
                            uri: '/news/tech-article-1/',
                            content: '人工智能技术正在革命性地改变工业检测领域...',
                            params: {}
                        }
                    ];
                }

                projectData.news = newsFromSearch;

                // 解析案例数据
                projectData.cases = searchData.filter(page =>
                    page.type === 'cases' &&
                    page.title && page.title.trim() !== ''
                ).map(page => {
                    const caseId = page.uri.replace('/cases/', '').replace('/', '');

                    return {
                        id: caseId,
                        title: page.title,
                        summary: page.summary || '',
                        primary_category: page.params?.primary_category || [],
                        application_field: page.params?.application_field || [],
                        application_scenario: page.params?.application_scenario || [],
                        featured_image: page.params?.featured_image || '',
                        client: page.params?.client || '',
                        industry: page.params?.industry || '',
                        detection_object: page.params?.detection_object || '',
                        equipment_used: page.params?.equipment_used || '',
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0],
                        uri: page.uri,
                        content: page.content || '',
                        params: page.params || {}
                    };
                });

                // 解析应用领域数据
                projectData.applications = searchData.filter(page =>
                    page.type === 'applications' &&
                    page.title && page.title.trim() !== ''
                ).map(page => {
                    const appId = page.uri.replace('/applications/', '').replace('/', '');

                    return {
                        id: appId,
                        title: page.title,
                        summary: page.summary || '',
                        featured_image: page.params?.featured_image || '',
                        weight: page.params?.weight || 1,
                        status: 'published',
                        date: page.date || new Date().toISOString().split('T')[0],
                        uri: page.uri,
                        content: page.content || '',
                        params: page.params || {}
                    };
                });

                // 解析分类数据（基于层级结构）
                projectData.categories = [];

                // 首先添加预定义的层级分类
                categoryHierarchyData.forEach((primary, primaryIndex) => {
                    // 添加主分类
                    const primaryCount = projectData.products.filter(p =>
                        p.primary_category === primary.title
                    ).length;

                    projectData.categories.push({
                        id: `primary-${primaryIndex + 1}`,
                        name: primary.title,
                        description: `${primary.title}相关产品分类`,
                        level: '主分类',
                        parent_id: null,
                        icon: primary.icon,
                        product_count: primaryCount,
                        status: 'active',
                        date: new Date().toISOString().split('T')[0],
                        sort_order: primaryIndex + 1
                    });

                    // 添加子分类
                    if (primary.subcategories) {
                        primary.subcategories.forEach((sub, subIndex) => {
                            const subCount = projectData.products.filter(p =>
                                p.secondary_category === sub.title
                            ).length;

                            projectData.categories.push({
                                id: `sub-${primaryIndex + 1}-${subIndex + 1}`,
                                name: sub.title,
                                description: `${sub.title}相关产品分类`,
                                level: '子分类',
                                parent_id: `primary-${primaryIndex + 1}`,
                                parent_name: primary.title,
                                icon: sub.icon,
                                product_count: subCount,
                                status: 'active',
                                date: new Date().toISOString().split('T')[0],
                                sort_order: subIndex + 1
                            });
                        });
                    }
                });

                // 添加从产品数据中提取的其他分类
                const existingCategories = new Set();
                projectData.categories.forEach(cat => existingCategories.add(cat.name));

                const additionalCategories = [...new Set([
                    ...projectData.products.map(p => p.primary_category).filter(c => c && !existingCategories.has(c)),
                    ...projectData.products.map(p => p.secondary_category).filter(c => c && !existingCategories.has(c))
                ])];

                additionalCategories.forEach((name, index) => {
                    const count = projectData.products.filter(p =>
                        p.primary_category === name || p.secondary_category === name
                    ).length;

                    projectData.categories.push({
                        id: `other-${index + 1}`,
                        name: name,
                        description: `${name}相关产品分类`,
                        level: '其他分类',
                        parent_id: null,
                        icon: 'fas fa-tag',
                        product_count: count,
                        status: 'active',
                        date: new Date().toISOString().split('T')[0],
                        sort_order: 999 + index
                    });
                });

                console.log(`📦 同步完成 - 产品:${projectData.products.length}, 供应商:${projectData.suppliers.length}, 资讯:${projectData.news.length}, 案例:${projectData.cases.length}, 应用:${projectData.applications.length}, 分类:${projectData.categories.length}`);

                // 调试信息
                console.log('🔍 供应商数据详情:', projectData.suppliers);
                if (projectData.suppliers.length > 0) {
                    console.log('✅ 供应商数据加载成功');
                    projectData.suppliers.forEach(supplier => {
                        console.log(`  - ${supplier.name} (${supplier.products}个产品)`);
                    });
                } else {
                    console.log('⚠️ 供应商数据为空，检查搜索索引和MD文件');
                }

                // 更新统计数据
                updateDashboard();

                // 更新当前显示的列表
                updateCurrentSectionList();

                showSyncStatus('项目数据同步完成', 2000);

                // 返回成功状态
                return true;

            } catch (error) {
                console.error('同步项目数据失败:', error);
                showSyncStatus('数据同步失败，请检查网络连接', 3000);
                return false;
            }
        }

        // 数据提取辅助函数
        function extractModelFromTitle(title) {
            const modelMatch = title.match(/([A-Z]{2,}-[A-Z0-9]+)/);
            return modelMatch ? modelMatch[1] : title.split(' ')[0];
        }

        function extractSupplierFromContent(content) {
            if (content.includes('深圳市微视光电科技有限公司') || content.includes('微视')) {
                return '深圳市微视光电科技有限公司';
            }
            if (content.includes('天津维森科技有限公司') || content.includes('维森')) {
                return '天津维森科技有限公司';
            }
            if (content.includes('上海尚品科技有限公司') || content.includes('尚品')) {
                return '上海尚品科技有限公司';
            }
            return '深圳市微视光电科技有限公司'; // 默认供应商
        }

        function extractSupplierFromTitle(title) {
            if (title.includes('WS-')) return '深圳市微视光电科技有限公司';
            if (title.includes('VIS-')) return '天津维森科技有限公司';
            return '深圳市微视光电科技有限公司';
        }

        function extractSeriesFromTitle(title) {
            if (title.includes('K') || title.includes('k')) return 'K系列';
            if (title.includes('P') || title.includes('p')) return 'P系列';
            if (title.includes('DZ') || title.includes('dz')) return 'DZ系列';
            if (title.includes('S') || title.includes('s')) return 'S系列';
            return 'K系列';
        }

        function extractSummaryFromTitle(title) {
            return title + ' 专业检测设备';
        }

        // 获取供应商对应的产品系列
        function getSupplierSeries(supplierName) {
            if (supplierName.includes('深圳市微视光电科技有限公司') || supplierName.includes('微视')) {
                return ['K系列', 'P系列', 'DZ系列', 'S系列', 'F系列', 'LA系列'];
            }
            if (supplierName.includes('天津维森科技有限公司') || supplierName.includes('维森')) {
                return ['VIS-P系列', 'VIS-T系列'];
            }
            if (supplierName.includes('上海尚品科技有限公司') || supplierName.includes('尚品')) {
                return ['G系列', 'L系列', 'M系列'];
            }
            return [];
        }

        // MD文件管理和同步机制
        async function saveContentToMarkdown(contentType, data) {
            try {
                showSyncStatus(`正在保存${contentType}到MD文件...`);

                const markdownContent = generateMarkdownContent(contentType, data);
                const fileName = generateFileName(contentType, data);

                // 处理图片上传和路径转换
                const processedContent = await processImagesInContent(markdownContent, contentType, data.id);

                console.log('📝 准备保存内容:', {
                    contentType,
                    fileName,
                    contentLength: processedContent.length
                });

                // 尝试通过本地服务器保存文件
                const success = await saveToLocalServer(fileName, processedContent, contentType, data);

                if (success) {
                    showSyncStatus(`${contentType}保存成功！`, 3000);
                    return true;
                } else {
                    // 如果服务器保存失败，提供下载功能作为备选
                    console.log('⚠️ 服务器保存失败，提供下载功能');
                    const downloadSuccess = await offerContentDownload(fileName, processedContent, contentType);
                    if (downloadSuccess) {
                        showSyncStatus(`${contentType}内容已生成下载，请手动保存到项目目录`, 5000);
                        return true;
                    }
                    throw new Error('保存和下载都失败');
                }

            } catch (error) {
                console.error(`保存${contentType}失败:`, error);
                showSyncStatus(`保存失败: ${error.message}`, 3000);
                return false;
            }
        }

        // 通过本地服务器保存文件
        async function saveToLocalServer(fileName, content, contentType, data) {
            try {
                const response = await fetch('http://localhost:3002/api/products/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: data.id || data.model || fileName.replace('.md', ''),
                        content: content,
                        filename: fileName
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    console.log('💾 文件保存成功:', result);
                    return true;
                } else {
                    console.error('❌ 服务器保存失败:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('❌ 连接本地服务器失败:', error);
                return false;
            }
        }

        // 提供内容下载功能
        async function offerContentDownload(fileName, content, contentType) {
            try {
                // 创建下载链接
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);

                // 创建下载链接
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = fileName;
                downloadLink.style.display = 'none';

                // 添加到页面并触发下载
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                // 清理URL对象
                URL.revokeObjectURL(url);

                // 同时显示内容预览模态框
                showContentPreview(fileName, content, contentType);

                return true;
            } catch (error) {
                console.error('创建下载失败:', error);
                return false;
            }
        }

        // 显示内容预览模态框
        function showContentPreview(fileName, content, contentType) {
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="contentPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">📄 ${fileName} - 内容预览</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>保存说明：</strong>请将下面的内容保存到项目的 <code>content/${contentType}/${fileName}</code> 文件中
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-primary btn-sm" onclick="copyToClipboard('previewContent')">
                                        <i class="fas fa-copy"></i> 复制内容
                                    </button>
                                    <button class="btn btn-success btn-sm ms-2" onclick="downloadContent('${fileName}', 'previewContent')">
                                        <i class="fas fa-download"></i> 重新下载
                                    </button>
                                </div>
                                <textarea id="previewContent" class="form-control" rows="20" readonly>${content}</textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除已存在的模态框
            const existingModal = document.getElementById('contentPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('contentPreviewModal'));
            modal.show();
        }

        // 复制到剪贴板
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');

            // 显示复制成功提示
            showSyncStatus('内容已复制到剪贴板', 2000);
        }

        // 重新下载内容
        function downloadContent(fileName, elementId) {
            const content = document.getElementById(elementId).value;
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = fileName;
            downloadLink.click();

            URL.revokeObjectURL(url);
        }

        // 生成Markdown内容
        function generateMarkdownContent(contentType, data) {
            let frontMatter = '';
            let content = data.content || '';

            switch (contentType) {
                case 'products':
                    // 处理应用场景内容，转换为Markdown格式
                    const applicationScenarios = data.application_scenarios ?
                        convertImagePathsForMarkdown(data.application_scenarios) : '';

                    // 生成图库YAML
                    let galleryYaml = '';
                    if (data.gallery && data.gallery.length > 0) {
                        galleryYaml = '\ngallery:' + data.gallery.map(img => `
  - image: "${img.image || img.url}"
    alt: "${img.alt || img.name || ''}"${img.is_main ? '\n    is_main: true' : ''}`).join('');
                    }

                    // 生成参数YAML
                    let parametersYaml = '';
                    if (data.parameters && data.parameters.length > 0) {
                        parametersYaml = '\nparameters:' + data.parameters.map(param => `
  - name: "${param.name}"
    value: "${param.value}"`).join('');
                    }

                    // 生成下载文件YAML
                    let downloadYaml = '';
                    if (data.data_download && data.data_download.length > 0) {
                        downloadYaml = '\ndata_download:' + data.data_download.map(file => `
  - file_title: "${file.file_title || file.name}"
    file_path: "${file.file_path || file.url}"`).join('');
                    }

                    // 生成相关产品YAML
                    let relatedYaml = '';
                    if (data.related_products && data.related_products.length > 0) {
                        relatedYaml = '\nrelated_products:' + data.related_products.map(id => `
  - "${id}"`).join('');
                    }

                    frontMatter = `---
title: "${data.title}"
summary: "${data.summary || ''}"
primary_category: "${data.primary_category}"
secondary_category: "${data.secondary_category}"
model: "${data.model}"
series: "${data.series || ''}"
supplier: "${data.supplier || ''}"
published: ${data.date || new Date().toISOString().split('T')[0]}T12:00:00+08:00${galleryYaml}${parametersYaml}${downloadYaml}${relatedYaml}
application_scenarios: |
  ${applicationScenarios}
---`;

                    // 处理详细描述内容，转换为Markdown格式
                    content = data.content ? convertImagePathsForMarkdown(data.content) : '';
                    break;

                case 'news':
                    frontMatter = `---
title: "${data.title}"
date: ${data.date}
summary: "${data.summary}"
categories:${data.categories ? data.categories.map(cat => `
- ${cat}`).join('') : ''}
tags:${data.tags ? data.tags.map(tag => `
- ${tag}`).join('') : ''}
author: "${data.author}"
views: ${data.views || 0}
featured_image: "${data.featured_image}"
---`;
                    break;

                case 'cases':
                    frontMatter = `---
title: "${data.title}"
primary_category: [${data.primary_category ? data.primary_category.map(cat => `"${cat}"`).join(', ') : ''}]
application_field: [${data.application_field ? data.application_field.map(field => `"${field}"`).join(', ') : ''}]
application_scenario: [${data.application_scenario ? data.application_scenario.map(scenario => `"${scenario}"`).join(', ') : ''}]
featured_image: "${data.featured_image}"
summary: "${data.summary}"
date: ${data.date}
client: "${data.client}"
industry: "${data.industry}"
detection_object: "${data.detection_object}"
equipment_used: "${data.equipment_used}"
---`;
                    break;

                case 'suppliers':
                    frontMatter = `---
title: "${data.name}"
address: "${data.address}"
type: "${data.type}"
series: [${data.series ? data.series.map(s => `"${s}"`).join(', ') : ''}]
models: [${data.models ? data.models.map(m => `"${m}"`).join(', ') : ''}]
contact_person: "${data.contact_person}"
phone: "${data.phone}"
email: "${data.email}"
description: "${data.description}"
---`;
                    break;

                case 'applications':
                    frontMatter = `---
title: "${data.title}"
summary: "${data.summary}"
featured_image: "${data.featured_image}"
weight: ${data.weight || 1}
date: ${data.date}
---`;
                    break;
            }

            return frontMatter + '\n\n' + content;
        }

        // 生成文件名
        function generateFileName(contentType, data) {
            const timestamp = new Date().toISOString().split('T')[0];
            const slug = data.title ? data.title.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 50) : 'untitled';

            switch (contentType) {
                case 'products':
                    return data.model ? `${data.model.toLowerCase()}.md` : `product-${slug}.md`;
                case 'news':
                    return `${timestamp}-${slug}.md`;
                case 'cases':
                    return `case-${slug}.md`;
                case 'suppliers':
                    return `${slug}.md`;
                case 'applications':
                    return `${slug}.md`;
                default:
                    return `${timestamp}-${slug}.md`;
            }
        }

        // 处理内容中的图片，转换为MD语法路径
        async function processImagesInContent(content, contentType, itemId) {
            console.log('🖼️ 开始处理内容中的图片...');

            // 查找所有图片引用
            const imageRegex = /<img[^>]+src="([^"]+)"[^>]*>/g;
            const markdownImageRegex = /!\[([^\]]*)\]\(([^)]+)\)/g;

            let processedContent = content;
            let imageCount = 0;

            // 处理HTML img标签
            let match;
            const imgMatches = [...content.matchAll(imageRegex)];
            for (const match of imgMatches) {
                const originalSrc = match[1];
                console.log(`📷 处理HTML图片 ${++imageCount}: ${originalSrc}`);

                const newPath = await processImageUpload(originalSrc, contentType, itemId);
                if (newPath && newPath !== originalSrc) {
                    const altText = extractAltFromImg(match[0]) || '图片';
                    const markdownImage = `![${altText}](${newPath})`;
                    processedContent = processedContent.replace(match[0], markdownImage);
                    console.log(`✅ HTML图片已转换: ${originalSrc} → ${newPath}`);
                }
            }

            // 处理Markdown图片语法中的路径
            const mdMatches = [...content.matchAll(markdownImageRegex)];
            for (const match of mdMatches) {
                const altText = match[1];
                const originalSrc = match[2];
                console.log(`📷 处理Markdown图片 ${++imageCount}: ${originalSrc}`);

                const newPath = await processImageUpload(originalSrc, contentType, itemId);
                if (newPath && newPath !== originalSrc) {
                    const markdownImage = `![${altText}](${newPath})`;
                    processedContent = processedContent.replace(match[0], markdownImage);
                    console.log(`✅ Markdown图片已转换: ${originalSrc} → ${newPath}`);
                }
            }

            console.log(`🎯 图片处理完成，共处理 ${imageCount} 个图片`);
            return processedContent;
        }

        // 处理单个图片上传
        async function processImageUpload(imageSrc, contentType, itemId) {
            try {
                console.log(`🔍 分析图片路径: ${imageSrc}`);

                // 如果是base64或blob URL，需要上传
                if (imageSrc.startsWith('blob:') || imageSrc.startsWith('data:')) {
                    console.log('📤 上传base64/blob图片到服务器...');
                    const uploadedPath = await uploadImageToMediaLibrary(imageSrc, contentType, itemId);
                    console.log(`✅ 图片上传完成: ${uploadedPath}`);
                    return uploadedPath;
                }

                // 如果是完整的localhost URL，提取相对路径
                if (imageSrc.includes('localhost:1314') || imageSrc.includes('localhost:3002')) {
                    const urlObj = new URL(imageSrc);
                    const relativePath = urlObj.pathname;
                    console.log(`🔄 提取相对路径: ${imageSrc} → ${relativePath}`);
                    return relativePath;
                }

                // 如果是外部URL，保持原样
                if (imageSrc.startsWith('http://') || imageSrc.startsWith('https://')) {
                    console.log('🌐 保持外部URL不变');
                    return imageSrc;
                }

                // 如果是相对路径，确保格式正确
                if (imageSrc.startsWith('/')) {
                    console.log('📁 使用现有相对路径');
                    return imageSrc;
                }

                // 其他情况，添加路径前缀
                const standardPath = `/images/content/${contentType}/${imageSrc}`;
                console.log(`🔧 标准化路径: ${imageSrc} → ${standardPath}`);
                return standardPath;

            } catch (error) {
                console.error('❌ 处理图片失败:', error);
                return imageSrc; // 失败时返回原路径
            }
        }

        // 保存图片文件到磁盘
        async function saveImageToDisk(base64Data, fileName) {
            try {
                // 将base64转换为blob
                const response = await fetch(base64Data);
                const blob = await response.blob();

                // 创建FormData
                const formData = new FormData();
                formData.append('file', blob, fileName);
                formData.append('category', 'products');

                // 尝试上传到服务器
                const uploadResponse = await fetch('/api/media/upload', {
                    method: 'POST',
                    body: formData
                });

                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    return result.path || `/static/images/products/${fileName}`;
                } else {
                    // 如果服务器上传失败，使用本地存储模拟
                    return await saveImageLocally(base64Data, fileName);
                }

            } catch (error) {
                console.error('保存图片到服务器失败，尝试本地存储:', error);
                return await saveImageLocally(base64Data, fileName);
            }
        }

        // 本地存储图片（模拟保存）
        async function saveImageLocally(base64Data, fileName) {
            try {
                // 在实际项目中，这里应该调用文件系统API或其他存储方案
                // 现在我们模拟保存过程，将图片数据存储在localStorage中
                const imageKey = `product_image_${fileName}`;
                localStorage.setItem(imageKey, base64Data);

                // 返回可访问的路径
                const imagePath = `/static/images/products/${fileName}`;

                // 创建一个虚拟的图片URL，实际显示时会从localStorage读取
                console.log(`📁 图片已保存到本地存储: ${fileName}`);
                return imagePath;

            } catch (error) {
                console.error('本地存储图片失败:', error);
                throw error;
            }
        }

        // 上传图片到媒体库
        async function uploadImageToMediaLibrary(imageSrc, contentType, itemId) {
            try {
                // 如果是base64或blob数据，上传到服务器
                if (imageSrc.startsWith('data:') || imageSrc.startsWith('blob:')) {
                    // 确定文件扩展名
                    let extension = 'jpg';
                    if (imageSrc.includes('data:image/png')) {
                        extension = 'png';
                    } else if (imageSrc.includes('data:image/gif')) {
                        extension = 'gif';
                    } else if (imageSrc.includes('data:image/webp')) {
                        extension = 'webp';
                    }

                    // 生成文件名
                    const timestamp = Date.now();
                    const fileName = `${contentType}-${itemId || 'item'}-${timestamp}.${extension}`;

                    // 尝试上传到本地服务器
                    const uploadResult = await uploadBase64ToServer(imageSrc, fileName, contentType);

                    if (uploadResult.success) {
                        console.log('📁 图片上传成功:', uploadResult.path);

                        // 将图片信息保存到媒体库
                        const mediaLibrary = JSON.parse(localStorage.getItem('mediaLibrary') || '[]');
                        mediaLibrary.push({
                            id: timestamp,
                            name: uploadResult.filename,
                            path: uploadResult.path,
                            category: contentType,
                            type: 'image',
                            size: Math.round(imageSrc.length * 0.75),
                            uploadDate: new Date().toISOString()
                        });
                        localStorage.setItem('mediaLibrary', JSON.stringify(mediaLibrary));

                        return uploadResult.path;
                    } else {
                        console.error('❌ 图片上传失败，使用临时路径');
                        // 如果上传失败，生成临时路径
                        const imagePath = `/images/content/${contentType}/${fileName}`;
                        return imagePath;
                    }
                } else {
                    // 如果已经是路径，直接返回
                    return imageSrc;
                }

            } catch (error) {
                console.error('处理图片失败:', error);
                return imageSrc;
            }
        }

        // 上传Base64图片到服务器
        async function uploadBase64ToServer(imageData, filename, uploadType = 'content') {
            try {
                const response = await fetch('http://localhost:3002/api/upload/base64', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: imageData,
                        filename: filename,
                        uploadType: uploadType
                    })
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Base64图片上传失败:', error);
                return { success: false, message: error.message };
            }
        }

        // 从img标签提取alt属性
        function extractAltFromImg(imgTag) {
            const altMatch = imgTag.match(/alt="([^"]*)"/);
            return altMatch ? altMatch[1] : '';
        }

        // 产品管理功能
        function addProduct() {
            console.log('➕ 添加产品...');
            currentEditingProductId = null;
            document.getElementById('productModalTitle').textContent = '添加产品';

            // 先初始化表单（包括分类选项），再清空内容
            console.log('🔧 初始化产品表单...');
            initializeProductForm();

            // 然后清空表单内容（但保留选项）
            clearProductForm();

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();

            // 模态框显示后延迟初始化编辑器
            setTimeout(() => {
                console.log('🔄 模态框已显示，重新初始化编辑器...');
                initializeProductEditors();
            }, 300);

            // 异步加载真实数据并更新表单
            loadProjectData().then(() => {
                console.log('✅ 数据加载完成，更新表单选项...');
                initializeProductForm();
            }).catch(error => {
                console.error('❌ 数据加载失败，使用默认数据:', error);
            });
        }

        function editProduct(productId) {
            console.log('✏️ 编辑产品:', productId);
            const product = projectData.products.find(p => p.id === productId);
            if (!product) {
                console.error('❌ 找不到产品:', productId);
                return;
            }

            console.log('📝 找到产品数据:', product);
            currentEditingProductId = productId;
            document.getElementById('productModalTitle').textContent = '编辑产品';

            // 先初始化表单（包括分类选项和编辑器）
            initializeProductForm();

            // 然后填充表单数据
            document.getElementById('productTitle').value = product.title || '';
            document.getElementById('productModel').value = product.model || '';
            document.getElementById('productSummary').value = product.summary || '';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productSeries').value = product.series || '';
            document.getElementById('productStatus').value = product.status || 'published';
            document.getElementById('productWeight').value = product.weight || 1;
            document.getElementById('productDate').value = product.date || new Date().toISOString().split('T')[0];

            // 设置分类（在初始化选项之后）
            setTimeout(() => {
                document.getElementById('productPrimaryCategory').value = product.primary_category || '';
                // 触发次要分类更新
                updateSecondaryCategories();
                // 然后设置次要分类
                setTimeout(() => {
                    document.getElementById('productSecondaryCategory').value = product.secondary_category || '';
                }, 100);
            }, 100);

            // 等待编辑器初始化完成后填充内容
            setTimeout(() => {
                // 填充编辑器内容
                if (productDescriptionEditor && product.content) {
                    productDescriptionEditor.root.innerHTML = product.content;
                }
                if (productApplicationEditor && product.application_scenarios) {
                    productApplicationEditor.root.innerHTML = product.application_scenarios;
                }

                // 填充参数
                if (product.parameters && Array.isArray(product.parameters)) {
                    const container = document.getElementById('parametersContainer');
                    container.innerHTML = '';
                    product.parameters.forEach(param => {
                        addParameter(param.name, param.value);
                    });
                }

                // 填充图库
                if (product.gallery && Array.isArray(product.gallery)) {
                    loadProductGallery(product.gallery);
                }

                // 填充下载文件
                if (product.data_download && Array.isArray(product.data_download)) {
                    loadProductDownloads(product.data_download);
                }

                // 填充相关产品
                if (product.related_products && Array.isArray(product.related_products)) {
                    loadRelatedProducts(product.related_products);
                }
            }, 500);

            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        function deleteProduct(productId) {
            if (confirm('确定要删除这个产品吗？此操作不可撤销。')) {
                const index = projectData.products.findIndex(p => p.id === productId);
                if (index !== -1) {
                    projectData.products.splice(index, 1);
                    updateProductList();
                    updateDashboard();
                    showSyncStatus('产品删除成功', 2000);
                }
            }
        }

        async function saveProduct() {
            const title = document.getElementById('productTitle').value.trim();
            const model = document.getElementById('productModel').value.trim();

            if (!title || !model) {
                alert('请填写产品标题和型号');
                return;
            }

            const productData = {
                title: title,
                model: model,
                summary: document.getElementById('productSummary').value.trim(),
                primary_category: document.getElementById('productPrimaryCategory').value,
                secondary_category: document.getElementById('productSecondaryCategory').value,
                supplier: document.getElementById('productSupplier').value,
                series: document.getElementById('productSeries').value,
                status: document.getElementById('productStatus').value,
                weight: parseInt(document.getElementById('productWeight').value) || 1,
                date: document.getElementById('productDate').value,
                parameters: collectParameters(),
                gallery: collectGalleryImages(),
                data_download: collectDownloadFiles(),
                related_products: collectRelatedProducts(),
                content: getProductDescription(),
                application_scenarios: getProductApplication()
            };

            // 保存到MD文件
            const saveSuccess = await saveContentToMarkdown('products', productData);

            if (saveSuccess) {
                console.log('✅ MD文件保存成功，开始更新前端数据...');

                // 确保products数组存在
                if (!projectData.products) {
                    projectData.products = [];
                    console.log('📋 初始化products数组');
                }

                if (currentEditingProductId) {
                    // 更新现有产品
                    console.log('🔄 更新现有产品:', currentEditingProductId);
                    const index = projectData.products.findIndex(p => p.id === currentEditingProductId);
                    if (index !== -1) {
                        projectData.products[index] = { ...projectData.products[index], ...productData };
                        showSyncStatus('产品更新并同步到MD文件成功', 2000);
                        console.log('✅ 产品更新完成');
                    } else {
                        console.log('⚠️ 未找到要更新的产品，将作为新产品添加');
                        const newId = model.toLowerCase().replace(/[^a-z0-9]/g, '-');
                        projectData.products.push({
                            id: newId,
                            uri: `/products/${newId}/`,
                            ...productData
                        });
                    }
                } else {
                    // 添加新产品
                    const newId = model.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    const newProduct = {
                        id: newId,
                        uri: `/products/${newId}/`,
                        ...productData
                    };

                    console.log('➕ 添加新产品:', newProduct);
                    projectData.products.push(newProduct);
                    showSyncStatus('产品添加并保存到MD文件成功', 2000);
                    console.log('✅ 新产品添加完成');
                }

                console.log('📊 当前产品列表长度:', projectData.products.length);
                console.log('📊 产品列表:', projectData.products.map(p => ({ id: p.id, title: p.title })));

                // 更新UI
                console.log('🎨 更新UI...');
                updateProductList();
                updateDashboard();

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                if (modal) {
                    modal.hide();
                }

                // 延迟重新加载数据以确保同步（但不清空当前显示）
                console.log('🔄 延迟验证数据同步...');
                setTimeout(async () => {
                    console.log('🔍 验证数据同步状态...');
                    try {
                        const response = await fetch('http://localhost:3002/api/products/list');
                        const result = await response.json();

                        if (result.success && result.products) {
                            console.log(`✅ API数据验证: ${result.products.length} 个产品`);
                            console.log(`📊 前端数据: ${projectData.products.length} 个产品`);

                            // 只有在数据不一致时才重新加载
                            if (result.products.length !== projectData.products.length) {
                                console.log('⚠️ 数据不一致，重新同步...');
                                await forceReloadProducts();
                            } else {
                                console.log('✅ 数据已同步，无需重新加载');
                            }
                        }
                    } catch (error) {
                        console.error('❌ 数据验证失败:', error);
                    }
                }, 2000);
            }
        }

        // 收集图库图片
        function collectGalleryImages() {
            const gallery = [];
            const galleryItems = document.querySelectorAll('.gallery-item');

            galleryItems.forEach((item, index) => {
                const img = item.querySelector('img');
                const altInput = item.querySelector('.image-alt');
                const isMainCheckbox = item.querySelector('.is-main-image');

                if (img && img.src) {
                    let imagePath = img.src;

                    // 如果是base64图片，转换为相对路径
                    if (imagePath.startsWith('data:image/')) {
                        // 生成一个基于时间戳的文件名
                        const timestamp = Date.now();
                        const extension = imagePath.includes('data:image/jpeg') ? 'jpg' :
                                        imagePath.includes('data:image/png') ? 'png' : 'jpg';
                        imagePath = `/images/products/gallery/product-${timestamp}-${index + 1}.${extension}`;

                        // 这里应该调用后端API保存base64图片为实际文件
                        // 目前只是转换路径，实际项目中需要实现文件上传
                        console.log('🖼️ 转换base64图片路径:', imagePath);
                    }

                    gallery.push({
                        image: imagePath,
                        alt: altInput ? altInput.value : `产品图片 ${index + 1}`,
                        is_main: isMainCheckbox ? isMainCheckbox.checked : index === 0
                    });
                }
            });

            return gallery;
        }

        // 收集下载文件
        function collectDownloadFiles() {
            const files = [];
            const fileItems = document.querySelectorAll('.download-file-item');

            fileItems.forEach(item => {
                const titleInput = item.querySelector('.file-title');
                const pathInput = item.querySelector('.file-path');

                if (titleInput && pathInput && titleInput.value && pathInput.value) {
                    files.push({
                        file_title: titleInput.value,
                        file_path: pathInput.value
                    });
                }
            });

            return files;
        }

        // 收集相关产品
        function collectRelatedProducts() {
            const relatedProducts = [];
            const relatedItems = document.querySelectorAll('.related-product-item');

            relatedItems.forEach(item => {
                const productId = item.dataset.productId;
                if (productId) {
                    relatedProducts.push(productId);
                }
            });

            return relatedProducts;
        }

        // 媒体库和文件管理功能
        // 媒体库选择器的全局变量
        let currentMediaLibraryType = '';
        let selectedMediaFiles = [];

        function openMediaLibrary(type) {
            currentMediaLibraryType = type;
            selectedMediaFiles = [];

            console.log(`📁 打开媒体库选择器，类型: ${type}`);

            // 创建媒体库选择器模态框
            const modalHtml = `
                <div class="modal fade" id="mediaLibraryModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-folder-open me-2"></i>
                                    选择${type === 'gallery' ? '图片' : '文件'} - 媒体库
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <select class="form-select" id="modalSupplierFilter" onchange="filterModalMediaLibrary()">
                                            <option value="">所有供应商</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="modalTypeFilter" onchange="filterModalMediaLibrary()">
                                            <option value="">所有类型</option>
                                            <option value="image">图片</option>
                                            <option value="file">文件</option>
                                        </select>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="modalMediaSearch" placeholder="搜索文件名..." onkeyup="filterModalMediaLibrary()">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div id="modalMediaLibraryContent" style="max-height: 400px; overflow-y: auto;">
                                            <div class="text-center p-4">
                                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                                <p class="mt-2 text-muted">正在加载媒体库...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>已选择:</strong> <span id="selectedFilesCount">0</span> 个文件
                                            <div id="selectedFilesList" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="confirmMediaSelection()" id="confirmSelectionBtn" disabled>
                                    <i class="fas fa-check me-1"></i>确认选择
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除已存在的模态框
            const existingModal = document.getElementById('mediaLibraryModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新的模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('mediaLibraryModal'));
            modal.show();

            // 加载媒体库数据
            loadModalMediaLibrary();
        }

        // 加载模态框中的媒体库数据
        async function loadModalMediaLibrary() {
            try {
                console.log('📂 加载模态框媒体库数据...');
                const response = await fetch('http://localhost:3002/api/media/list');
                const result = await response.json();

                if (result.success) {
                    console.log(`✅ 媒体库加载成功，共 ${result.media.length} 个文件`);
                    renderModalMediaLibrary(result.media);
                    updateModalSupplierFilter(result.media);
                } else {
                    console.error('❌ 加载媒体库失败:', result.message);
                    showModalError('加载媒体库失败: ' + result.message);
                }
            } catch (error) {
                console.error('❌ 连接媒体库服务器失败:', error);
                showModalError('无法连接到媒体库服务器，请确保服务器正在运行');
            }
        }

        // 更新模态框中的供应商筛选器
        function updateModalSupplierFilter(mediaData) {
            const supplierFilter = document.getElementById('modalSupplierFilter');
            if (!supplierFilter) return;

            const suppliers = [...new Set(mediaData.map(item => item.supplier))];

            supplierFilter.innerHTML = '<option value="">所有供应商</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierFilter.appendChild(option);
            });
        }

        // 渲染模态框中的媒体库
        function renderModalMediaLibrary(mediaData) {
            const container = document.getElementById('modalMediaLibraryContent');
            if (!container) return;

            if (mediaData.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">媒体库为空</p>
                        <p class="small text-muted">请先在媒体库管理页面上传文件</p>
                    </div>
                `;
                return;
            }

            // 根据当前选择类型过滤数据
            let filteredData = mediaData;
            if (currentMediaLibraryType === 'gallery') {
                filteredData = mediaData.filter(item => item.type === 'image');
            } else if (currentMediaLibraryType === 'downloads') {
                filteredData = mediaData.filter(item => item.type === 'file');
            }

            // 按供应商分组
            const groupedData = {};
            filteredData.forEach(item => {
                if (!groupedData[item.supplier]) {
                    groupedData[item.supplier] = { images: [], files: [] };
                }
                if (item.type === 'image') {
                    groupedData[item.supplier].images.push(item);
                } else {
                    groupedData[item.supplier].files.push(item);
                }
            });

            let html = '';
            Object.keys(groupedData).forEach(supplier => {
                const data = groupedData[supplier];
                const totalFiles = data.images.length + data.files.length;

                if (totalFiles === 0) return;

                html += `
                    <div class="supplier-group-modal mb-3">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-building me-2"></i>${supplier}
                            <span class="badge bg-secondary ms-2">${totalFiles} 个文件</span>
                        </h6>

                        ${data.images.length > 0 ? `
                            <div class="mb-3">
                                <div class="row g-2">
                                    ${data.images.map(item => `
                                        <div class="col-md-2 col-sm-3 col-4">
                                            <div class="media-item-modal" data-file-id="${item.id}" data-file-path="${item.path}" data-file-name="${item.name}" data-file-type="${item.type}">
                                                <img src="${item.path}" alt="${item.name}" class="img-thumbnail" style="height: 80px; width: 100%; object-fit: cover; cursor: pointer;">
                                                <div class="media-overlay-modal">
                                                    <i class="fas fa-check-circle text-success" style="display: none;"></i>
                                                </div>
                                                <small class="text-muted d-block mt-1 text-truncate">${item.name}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${data.files.length > 0 ? `
                            <div class="mb-3">
                                <div class="list-group">
                                    ${data.files.map(item => `
                                        <div class="list-group-item media-item-modal" data-file-id="${item.id}" data-file-path="${item.path}" data-file-name="${item.name}" data-file-type="${item.type}" style="cursor: pointer;">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="fas fa-file me-2"></i>
                                                    <strong>${item.name}</strong>
                                                    <small class="text-muted ms-2">${formatFileSize(item.size)}</small>
                                                </div>
                                                <div class="media-overlay-modal">
                                                    <i class="fas fa-check-circle text-success" style="display: none;"></i>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;

            // 添加点击事件
            container.querySelectorAll('.media-item-modal').forEach(item => {
                item.addEventListener('click', function() {
                    toggleMediaSelection(this);
                });
            });
        }

        // 切换媒体文件选择状态
        function toggleMediaSelection(element) {
            const fileId = element.dataset.fileId;
            const filePath = element.dataset.filePath;
            const fileName = element.dataset.fileName;
            const fileType = element.dataset.fileType;

            const overlay = element.querySelector('.media-overlay-modal i');
            const isSelected = element.classList.contains('selected');

            if (isSelected) {
                // 取消选择
                element.classList.remove('selected');
                overlay.style.display = 'none';
                selectedMediaFiles = selectedMediaFiles.filter(file => file.id !== fileId);
            } else {
                // 选择文件
                element.classList.add('selected');
                overlay.style.display = 'block';
                selectedMediaFiles.push({
                    id: fileId,
                    path: filePath,
                    name: fileName,
                    type: fileType
                });
            }

            updateSelectedFilesDisplay();
        }

        // 更新已选择文件的显示
        function updateSelectedFilesDisplay() {
            const countElement = document.getElementById('selectedFilesCount');
            const listElement = document.getElementById('selectedFilesList');
            const confirmBtn = document.getElementById('confirmSelectionBtn');

            if (countElement) countElement.textContent = selectedMediaFiles.length;

            if (listElement) {
                if (selectedMediaFiles.length > 0) {
                    listElement.innerHTML = selectedMediaFiles.map(file =>
                        `<span class="badge bg-primary me-1 mb-1">${file.name}</span>`
                    ).join('');
                } else {
                    listElement.innerHTML = '';
                }
            }

            if (confirmBtn) {
                confirmBtn.disabled = selectedMediaFiles.length === 0;
            }
        }

        // 筛选模态框媒体库
        function filterModalMediaLibrary() {
            // 重新加载并应用筛选
            loadModalMediaLibrary();
        }

        // 显示模态框错误
        function showModalError(message) {
            const container = document.getElementById('modalMediaLibraryContent');
            if (container) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadModalMediaLibrary()">
                            <i class="fas fa-retry me-1"></i>重试
                        </button>
                    </div>
                `;
            }
        }

        // 确认媒体文件选择
        function confirmMediaSelection() {
            if (selectedMediaFiles.length === 0) {
                alert('请先选择文件');
                return;
            }

            console.log(`✅ 确认选择 ${selectedMediaFiles.length} 个文件，类型: ${currentMediaLibraryType}`);

            selectedMediaFiles.forEach(file => {
                if (currentMediaLibraryType === 'gallery') {
                    // 添加到产品图库
                    addImageToGallery({
                        url: file.path,
                        name: file.name,
                        alt: file.name
                    });
                } else if (currentMediaLibraryType === 'downloads') {
                    // 添加到下载文件
                    addFileToDownloads({
                        name: file.name,
                        url: file.path,
                        path: file.path,
                        type: file.type
                    });
                }
            });

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('mediaLibraryModal'));
            if (modal) {
                modal.hide();
            }

            // 显示成功消息
            showSyncStatus(`✅ 已添加 ${selectedMediaFiles.length} 个文件`, 2000);

            // 清空选择
            selectedMediaFiles = [];
            currentMediaLibraryType = '';
        }

        // 编辑器专用的媒体库选择器
        let currentEditor = null;
        let currentEditorType = '';

        function openEditorMediaLibrary(editorType) {
            currentEditorType = editorType;
            currentEditor = editorType === 'description' ? productDescriptionEditor : productApplicationEditor;

            if (!currentEditor) {
                alert('编辑器未初始化');
                return;
            }

            console.log(`📝 打开编辑器媒体库选择器，编辑器类型: ${editorType}`);

            // 创建编辑器专用的媒体库选择器模态框
            const modalHtml = `
                <div class="modal fade" id="editorMediaLibraryModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-image me-2"></i>
                                    选择图片插入到编辑器
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <select class="form-select" id="editorSupplierFilter" onchange="filterEditorMediaLibrary()">
                                            <option value="">所有供应商</option>
                                        </select>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" class="form-control" id="editorMediaSearch" placeholder="搜索图片名称..." onkeyup="filterEditorMediaLibrary()">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div id="editorMediaLibraryContent" style="max-height: 400px; overflow-y: auto;">
                                            <div class="text-center p-4">
                                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                                <p class="mt-2 text-muted">正在加载图片...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>说明：</strong>点击图片即可插入到编辑器中
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除已存在的模态框
            const existingModal = document.getElementById('editorMediaLibraryModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新的模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editorMediaLibraryModal'));
            modal.show();

            // 加载媒体库数据
            loadEditorMediaLibrary();
        }

        // 加载编辑器媒体库数据
        async function loadEditorMediaLibrary() {
            try {
                console.log('📂 加载编辑器媒体库数据...');
                const response = await fetch('http://localhost:3002/api/media/list');
                const result = await response.json();

                if (result.success) {
                    // 只显示图片
                    const images = result.media.filter(item => item.type === 'image');
                    console.log(`✅ 编辑器媒体库加载成功，共 ${images.length} 张图片`);
                    renderEditorMediaLibrary(images);
                    updateEditorSupplierFilter(images);
                } else {
                    console.error('❌ 加载媒体库失败:', result.message);
                    showEditorModalError('加载媒体库失败: ' + result.message);
                }
            } catch (error) {
                console.error('❌ 连接媒体库服务器失败:', error);
                showEditorModalError('无法连接到媒体库服务器，请确保服务器正在运行');
            }
        }

        // 更新编辑器模态框中的供应商筛选器
        function updateEditorSupplierFilter(mediaData) {
            const supplierFilter = document.getElementById('editorSupplierFilter');
            if (!supplierFilter) return;

            const suppliers = [...new Set(mediaData.map(item => item.supplier))];

            supplierFilter.innerHTML = '<option value="">所有供应商</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierFilter.appendChild(option);
            });
        }

        // 渲染编辑器媒体库
        function renderEditorMediaLibrary(images) {
            const container = document.getElementById('editorMediaLibraryContent');
            if (!container) return;

            if (images.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                        <p class="text-muted">没有找到图片</p>
                        <p class="small text-muted">请先在媒体库管理页面上传图片</p>
                    </div>
                `;
                return;
            }

            // 按供应商分组
            const groupedImages = {};
            images.forEach(item => {
                if (!groupedImages[item.supplier]) {
                    groupedImages[item.supplier] = [];
                }
                groupedImages[item.supplier].push(item);
            });

            let html = '';
            Object.keys(groupedImages).forEach(supplier => {
                const supplierImages = groupedImages[supplier];

                html += `
                    <div class="supplier-group-modal mb-3">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-building me-2"></i>${supplier}
                            <span class="badge bg-secondary ms-2">${supplierImages.length} 张图片</span>
                        </h6>
                        <div class="row g-2">
                            ${supplierImages.map(item => `
                                <div class="col-md-2 col-sm-3 col-4">
                                    <div class="editor-media-item" data-image-url="${item.path}" data-image-alt="${item.name}">
                                        <img src="${item.path}" alt="${item.name}" class="img-thumbnail" style="height: 100px; width: 100%; object-fit: cover; cursor: pointer;">
                                        <small class="text-muted d-block mt-1 text-truncate">${item.name}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // 添加点击事件
            container.querySelectorAll('.editor-media-item').forEach(item => {
                item.addEventListener('click', function() {
                    insertImageToEditor(this.dataset.imageUrl, this.dataset.imageAlt);
                });
            });
        }

        // 插入图片到编辑器
        function insertImageToEditor(imageUrl, imageAlt) {
            if (!currentEditor) {
                alert('编辑器未初始化');
                return;
            }

            console.log(`📝 插入图片到编辑器: ${imageUrl}`);

            // 获取当前光标位置
            const range = currentEditor.getSelection();
            const index = range ? range.index : currentEditor.getLength();

            // 插入图片
            currentEditor.insertEmbed(index, 'image', imageUrl);

            // 设置图片的alt属性（如果支持的话）
            currentEditor.setSelection(index + 1);

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editorMediaLibraryModal'));
            if (modal) {
                modal.hide();
            }

            // 显示成功消息
            showSyncStatus(`✅ 图片已插入到编辑器`, 2000);
        }

        // 筛选编辑器媒体库
        function filterEditorMediaLibrary() {
            // 重新加载并应用筛选
            loadEditorMediaLibrary();
        }

        // 显示编辑器模态框错误
        function showEditorModalError(message) {
            const container = document.getElementById('editorMediaLibraryContent');
            if (container) {
                container.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="text-muted">${message}</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="loadEditorMediaLibrary()">
                            <i class="fas fa-retry me-1"></i>重试
                        </button>
                    </div>
                `;
            }
        }

        function uploadProductImage(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = async function(e) {
                const files = Array.from(e.target.files);
                console.log(`📤 上传 ${files.length} 个图片文件到媒体库...`);

                showSyncStatus(`正在上传 ${files.length} 个图片...`, 1000);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`📤 上传图片 ${i + 1}/${files.length}: ${file.name}`);

                    try {
                        // 上传文件到服务器
                        const uploadResult = await uploadFileToServer(file, 'products');

                        if (uploadResult.success) {
                            // 添加到图库
                            if (type === 'gallery') {
                                addImageToGallery({
                                    url: uploadResult.path,
                                    name: file.name,
                                    size: file.size
                                });
                            }

                            console.log(`✅ 图片 ${i + 1} 上传成功: ${uploadResult.path}`);
                        } else {
                            console.error(`❌ 图片 ${i + 1} 上传失败:`, uploadResult.message);
                        }
                    } catch (error) {
                        console.error(`❌ 图片 ${i + 1} 上传失败:`, error);
                    }
                }

                showSyncStatus(`✅ ${files.length} 个图片上传完成`, 2000);
            };

            input.click();
        }

        // 上传文件到服务器
        async function uploadFileToServer(file, uploadType = 'products') {
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('uploadType', uploadType);

                const response = await fetch('http://localhost:3002/api/upload/image', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('文件上传失败:', error);
                return { success: false, message: error.message };
            }
        }

        function uploadProductFile(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z';

            input.onchange = async function(e) {
                const files = Array.from(e.target.files);
                console.log(`📤 上传 ${files.length} 个文件...`);

                showSyncStatus(`正在上传 ${files.length} 个文件...`, 1000);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`📤 上传文件 ${i + 1}/${files.length}: ${file.name}`);

                    try {
                        // 上传文件到服务器
                        const uploadResult = await uploadFileToServer(file, 'downloads');

                        if (uploadResult.success) {
                            // 添加到下载列表
                            if (type === 'downloads') {
                                addFileToDownloads({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    url: uploadResult.path,
                                    path: uploadResult.path
                                });
                            }

                            console.log(`✅ 文件 ${i + 1} 上传成功: ${uploadResult.path}`);
                        } else {
                            console.error(`❌ 文件 ${i + 1} 上传失败:`, uploadResult.message);
                        }
                    } catch (error) {
                        console.error(`❌ 文件 ${i + 1} 上传失败:`, error);
                    }
                }

                showSyncStatus(`✅ ${files.length} 个文件上传完成`, 2000);
            };

            input.click();
        }

        // 上传文件到服务器
        async function uploadFileToServer(file, uploadType = 'downloads') {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('uploadType', uploadType);

                const response = await fetch('http://localhost:3002/api/upload/file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('文件上传失败:', error);
                return { success: false, message: error.message };
            }
        }

        // 获取图片显示URL（处理本地存储的图片）
        function getImageDisplayUrl(imagePath) {
            // 如果是产品图片路径，尝试从localStorage获取
            if (imagePath && imagePath.includes('/static/images/products/')) {
                const fileName = imagePath.split('/').pop();
                const imageKey = `product_image_${fileName}`;
                const storedImage = localStorage.getItem(imageKey);

                if (storedImage) {
                    console.log(`📷 从本地存储加载图片: ${fileName}`);
                    return storedImage; // 返回base64数据
                }
            }

            // 其他情况返回原路径
            return imagePath;
        }

        // 图库管理功能
        function addImageToGallery(imageData) {
            const container = document.getElementById('galleryContainer');

            // 移除占位符
            const placeholder = container.querySelector('.gallery-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const imageDiv = document.createElement('div');
            imageDiv.className = 'gallery-item';

            // 获取实际显示的URL
            const displayUrl = getImageDisplayUrl(imageData.previewUrl || imageData.url);
            const saveUrl = imageData.url; // 用于保存的路径

            imageDiv.innerHTML = `
                <div class="image-preview">
                    <img src="${displayUrl}" alt="${imageData.name}" class="img-thumbnail" onerror="handleImageError(this)">
                    <div class="image-controls">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setMainImage(this)">
                            <i class="fas fa-star"></i> 主图
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGalleryImage(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <input type="hidden" class="image-url" value="${saveUrl}">
                    <input type="hidden" class="image-name" value="${imageData.name}">
                    <input type="hidden" class="is-main" value="false">
                    <div class="image-info">
                        <small class="text-muted">保存路径: ${saveUrl}</small>
                    </div>
                </div>
            `;

            container.appendChild(imageDiv);
        }

        // 处理图片加载错误
        function handleImageError(img) {
            const src = img.src;
            console.log('图片加载失败:', src);

            // 如果是产品图片路径，尝试从localStorage加载
            if (src.includes('/static/images/products/')) {
                const fileName = src.split('/').pop();
                const imageKey = `product_image_${fileName}`;
                const storedImage = localStorage.getItem(imageKey);

                if (storedImage && storedImage !== src) {
                    console.log('从本地存储重新加载图片:', fileName);
                    img.src = storedImage;
                    return;
                }
            }

            // 设置默认占位图
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aXoOazleWKoOi9vTwvdGV4dD48L3N2Zz4=';
            img.alt = '图片无法加载';
        }

        function loadProductGallery(gallery) {
            const container = document.getElementById('galleryContainer');
            container.innerHTML = '';

            if (gallery && gallery.length > 0) {
                gallery.forEach(image => {
                    addImageToGallery({
                        url: image.url || image.image,
                        name: image.alt || image.name || '产品图片'
                    });
                });
            } else {
                container.innerHTML = '<div class="gallery-placeholder"><i class="fas fa-images"></i><p>点击上方按钮添加产品图片</p></div>';
            }
        }

        function setMainImage(button) {
            // 移除其他主图标记
            document.querySelectorAll('.gallery-item .is-main').forEach(input => {
                input.value = 'false';
            });
            document.querySelectorAll('.gallery-item .btn-outline-primary').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });

            // 设置当前为主图
            const isMainInput = button.closest('.gallery-item').querySelector('.is-main');
            isMainInput.value = 'true';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
        }

        function removeGalleryImage(button) {
            button.closest('.gallery-item').remove();

            // 如果没有图片了，显示占位符
            const container = document.getElementById('galleryContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<div class="gallery-placeholder"><i class="fas fa-images"></i><p>点击上方按钮添加产品图片</p></div>';
            }
        }

        // 下载文件管理功能
        function addFileToDownloads(fileData) {
            const container = document.getElementById('downloadsContainer');

            // 移除占位符
            const placeholder = container.querySelector('.downloads-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const fileDiv = document.createElement('div');
            fileDiv.className = 'download-item';
            fileDiv.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="file-details">
                        <input type="text" class="form-control form-control-sm file-title" placeholder="文件标题" value="${fileData.name}">
                        <small class="text-muted">${fileData.name} (${formatFileSize(fileData.size)})</small>
                        <input type="hidden" class="file-path" value="${fileData.url}">
                    </div>
                    <div class="file-controls">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDownloadFile(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(fileDiv);
        }

        function loadProductDownloads(downloads) {
            const container = document.getElementById('downloadsContainer');
            container.innerHTML = '';

            if (downloads && downloads.length > 0) {
                downloads.forEach(file => {
                    addFileToDownloads({
                        name: file.file_title || file.name || '下载文件',
                        url: file.file_path || file.url,
                        size: file.size || 0
                    });
                });
            } else {
                container.innerHTML = '<div class="downloads-placeholder"><i class="fas fa-file-alt"></i><p>点击上方按钮添加下载文件</p></div>';
            }
        }

        function removeDownloadFile(button) {
            button.closest('.download-item').remove();

            // 如果没有文件了，显示占位符
            const container = document.getElementById('downloadsContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<div class="downloads-placeholder"><i class="fas fa-file-alt"></i><p>点击上方按钮添加下载文件</p></div>';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 相关产品管理功能
        function addRelatedProduct() {
            const container = document.getElementById('relatedProductsContainer');

            // 移除占位符
            const placeholder = container.querySelector('.related-products-placeholder');
            if (placeholder) {
                placeholder.remove();
            }

            const productDiv = document.createElement('div');
            productDiv.className = 'related-product-item';
            productDiv.innerHTML = `
                <div class="product-selector">
                    <select class="form-select form-select-sm related-product-select">
                        <option value="">选择相关产品</option>
                        ${generateProductOptions()}
                    </select>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRelatedProduct(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            container.appendChild(productDiv);
        }

        function generateProductOptions() {
            let options = '';
            if (projectData.products && projectData.products.length > 0) {
                projectData.products.forEach(product => {
                    if (product.id !== currentEditingProductId) {
                        options += `<option value="${product.id}">${product.title || product.model}</option>`;
                    }
                });
            }
            return options;
        }

        function loadRelatedProducts(relatedProducts) {
            const container = document.getElementById('relatedProductsContainer');
            container.innerHTML = '';

            if (relatedProducts && relatedProducts.length > 0) {
                relatedProducts.forEach(productId => {
                    addRelatedProduct();
                    const lastSelect = container.querySelector('.related-product-select:last-of-type');
                    if (lastSelect) {
                        lastSelect.value = productId;
                    }
                });
            } else {
                container.innerHTML = '<div class="related-products-placeholder"><i class="fas fa-link"></i><p>点击上方按钮添加相关产品</p></div>';
            }
        }

        function removeRelatedProduct(button) {
            button.closest('.related-product-item').remove();

            // 如果没有相关产品了，显示占位符
            const container = document.getElementById('relatedProductsContainer');
            if (container.children.length === 0) {
                container.innerHTML = '<div class="related-products-placeholder"><i class="fas fa-link"></i><p>点击上方按钮添加相关产品</p></div>';
            }
        }



        function collectRelatedProducts() {
            const relatedProducts = [];
            const selects = document.querySelectorAll('.related-product-select');

            selects.forEach(select => {
                if (select.value) {
                    relatedProducts.push(select.value);
                }
            });

            return relatedProducts;
        }

        // 编辑器图片处理和路径转换功能
        function processEditorImages(editor, editorType) {
            if (!editor || !editor.root) {
                console.log('⚠️ 编辑器无效，跳过图片处理');
                return;
            }

            const content = editor.root.innerHTML;
            const imgTags = content.match(/<img[^>]+>/g);

            if (imgTags) {
                console.log(`🖼️ 在${editorType}编辑器中发现 ${imgTags.length} 个图片`);

                imgTags.forEach(async (imgTag, index) => {
                    const srcMatch = imgTag.match(/src="([^"]+)"/);
                    if (srcMatch) {
                        const src = srcMatch[1];

                        // 处理base64图片
                        if (src.startsWith('data:')) {
                            console.log(`📤 上传base64图片 ${index + 1} 到媒体库...`);
                            try {
                                const newPath = await uploadBase64Image(src, editorType);
                                if (newPath) {
                                    // 替换编辑器中的图片路径
                                    const currentContent = editor.root.innerHTML;
                                    const updatedContent = currentContent.replace(src, newPath);
                                    editor.root.innerHTML = updatedContent;
                                    console.log(`✅ 图片 ${index + 1} 已保存到媒体库: ${newPath}`);
                                }
                            } catch (error) {
                                console.error(`❌ 上传图片 ${index + 1} 失败:`, error);
                            }
                        }
                        // 处理blob URL
                        else if (src.startsWith('blob:')) {
                            console.log(`📤 上传blob图片 ${index + 1} 到媒体库...`);
                            try {
                                const newPath = await uploadBlobImage(src, editorType);
                                if (newPath) {
                                    const currentContent = editor.root.innerHTML;
                                    const updatedContent = currentContent.replace(src, newPath);
                                    editor.root.innerHTML = updatedContent;
                                    console.log(`✅ 图片 ${index + 1} 已保存到媒体库: ${newPath}`);
                                }
                            } catch (error) {
                                console.error(`❌ 上传图片 ${index + 1} 失败:`, error);
                            }
                        }
                    }
                });
            }
        }

        async function uploadBase64Image(base64Data, editorType) {
            try {
                // 生成文件名
                const timestamp = Date.now();
                const fileName = `${editorType}-image-${timestamp}.png`;
                const mediaPath = `/static/images/products/${fileName}`;

                console.log(`📤 上传base64图片到媒体库: ${fileName}`);

                // 保存图片到本地存储
                await saveImageLocally(base64Data, fileName);

                // 添加到媒体库数据
                const mediaItem = {
                    id: `media-${timestamp}`,
                    name: fileName,
                    type: 'image',
                    category: `${editorType}图片`,
                    size: Math.round(base64Data.length * 0.75) + 'B', // 估算文件大小
                    url: mediaPath,
                    uploadDate: new Date().toISOString().split('T')[0],
                    source: 'editor'
                };

                // 添加到全局媒体库
                if (!window.mediaLibrary) {
                    window.mediaLibrary = [];
                }
                window.mediaLibrary.push(mediaItem);

                showSyncStatus(`图片已自动保存到媒体库: ${fileName}`, 2000);
                console.log(`✅ 图片已添加到媒体库: ${fileName}`);
                console.log(`📁 图片保存路径: ${mediaPath}`);

                // 返回base64数据用于编辑器显示
                return base64Data;
            } catch (error) {
                console.error('上传base64图片失败:', error);
                return null;
            }
        }

        async function uploadBlobImage(blobUrl, editorType) {
            try {
                // 获取blob数据
                const response = await fetch(blobUrl);
                const blob = await response.blob();

                // 生成文件名
                const timestamp = Date.now();
                const fileName = `${editorType}-image-${timestamp}.jpg`;
                const mediaPath = `/static/images/products/${fileName}`;

                console.log(`📤 上传blob图片到媒体库: ${fileName}`);

                // 将blob转换为base64并保存到本地存储
                const reader = new FileReader();
                const base64Data = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });

                await saveImageLocally(base64Data, fileName);

                // 添加到媒体库数据
                const mediaItem = {
                    id: `media-${timestamp}`,
                    name: fileName,
                    type: 'image',
                    category: `${editorType}图片`,
                    size: formatFileSize(blob.size),
                    url: mediaPath,
                    uploadDate: new Date().toISOString().split('T')[0],
                    source: 'editor'
                };

                // 添加到全局媒体库
                if (!window.mediaLibrary) {
                    window.mediaLibrary = [];
                }
                window.mediaLibrary.push(mediaItem);

                showSyncStatus(`图片已自动保存到媒体库: ${fileName}`, 2000);
                console.log(`✅ blob图片已添加到媒体库: ${fileName}`);

                // 返回base64数据用于编辑器显示
                return base64Data;
            } catch (error) {
                console.error('上传blob图片失败:', error);
                return null;
            }
        }

        // MD文件路径转换功能
        function convertImagePathsForMarkdown(content) {
            if (!content) return content;

            // 将绝对路径转换为相对路径
            let convertedContent = content.replace(/src="\/static\/images\//g, 'src="/images/');

            // 将HTML img标签转换为Markdown格式
            convertedContent = convertedContent.replace(/<img[^>]+>/g, (imgTag) => {
                const srcMatch = imgTag.match(/src="([^"]+)"/);
                const altMatch = imgTag.match(/alt="([^"]*)"/);

                if (srcMatch) {
                    const src = srcMatch[1];
                    const alt = altMatch ? altMatch[1] : '';
                    return `![${alt}](${src})`;
                }

                return imgTag;
            });

            return convertedContent;
        }

        // 媒体库过滤功能
        function filterMediaLibrary(type) {
            const buttons = document.querySelectorAll('#mediaLibraryModal .btn-group .btn');
            buttons.forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });

            event.target.classList.remove('btn-outline-primary');
            event.target.classList.add('btn-primary');

            // 这里应该根据类型过滤媒体库内容
            console.log(`过滤媒体库: ${type}`);
        }

        function selectMediaFiles(targetType) {
            // 模拟选择媒体文件
            const selectedFiles = [
                { url: '/images/products/sample1.jpg', name: '示例图片1.jpg', type: 'image' },
                { url: '/images/products/sample2.jpg', name: '示例图片2.jpg', type: 'image' }
            ];

            selectedFiles.forEach(file => {
                if (targetType === 'gallery' && file.type === 'image') {
                    addImageToGallery(file);
                } else if (targetType === 'downloads') {
                    addFileToDownloads(file);
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('mediaLibraryModal')).hide();
            showSyncStatus(`已添加 ${selectedFiles.length} 个文件`, 2000);
        }

        // 测试函数
        function testProductForm() {
            console.log('🧪 开始测试产品表单功能...');
            console.log('📊 当前项目数据状态:', projectData);
            console.log('🔍 Quill编辑器状态:', {
                descriptionEditor: productDescriptionEditor,
                applicationEditor: productApplicationEditor,
                quillAvailable: typeof Quill !== 'undefined'
            });

            // 测试表单初始化
            console.log('🔧 测试表单初始化...');
            initializeProductForm();

            // 测试编辑器初始化
            console.log('📝 测试编辑器初始化...');
            initializeProductEditors();

            alert('测试完成，请查看控制台输出');
        }

        // 全局功能测试
        function testAllFunctions() {
            console.log('🧪 开始测试所有主要功能...');

            // 测试基础功能
            console.log('✅ showSection 函数:', typeof showSection);
            console.log('✅ toggleSidebar 函数:', typeof toggleSidebar);
            console.log('✅ loadProjectData 函数:', typeof loadProjectData);

            // 测试产品管理
            console.log('✅ addProduct 函数:', typeof addProduct);
            console.log('✅ editProduct 函数:', typeof editProduct);
            console.log('✅ saveProduct 函数:', typeof saveProduct);

            // 测试筛选功能
            console.log('✅ filterProducts 函数:', typeof filterProducts);
            console.log('✅ clearProductFilters 函数:', typeof clearProductFilters);

            // 测试参数管理
            console.log('✅ loadParameterTemplate 函数:', typeof loadParameterTemplate);
            console.log('✅ addParameter 函数:', typeof addParameter);

            alert('功能测试完成，请查看控制台输出');
        }

        // 分类数据测试
        function testCategoryData() {
            console.log('🧪 开始测试分类数据...');
            console.log('📋 categoryHierarchyData:', categoryHierarchyData);
            console.log('📋 categoryHierarchy:', categoryHierarchy);

            // 测试主要分类
            const primaryCategories = categoryHierarchyData.map(cat => cat.title);
            console.log('📋 主要分类列表:', primaryCategories);
            console.log('📋 主要分类数量:', primaryCategories.length);

            // 测试每个主要分类的子分类
            categoryHierarchyData.forEach(primary => {
                console.log(`📋 ${primary.title} 的子分类:`, primary.subcategories.map(sub => sub.title));
                console.log(`📋 ${primary.title} 子分类数量:`, primary.subcategories.length);
            });

            // 检查下拉框内容
            const primarySelect = document.getElementById('productPrimaryCategory');
            const secondarySelect = document.getElementById('productSecondaryCategory');

            console.log('📋 主要分类下拉框选项数量:', primarySelect.options.length);
            console.log('📋 次要分类下拉框选项数量:', secondarySelect.options.length);

            // 显示下拉框内容
            for (let i = 0; i < primarySelect.options.length; i++) {
                console.log(`📋 主要分类选项 ${i}:`, primarySelect.options[i].value, primarySelect.options[i].text);
            }

            alert('分类数据测试完成，请查看控制台输出');
        }

        // 调试分类显示
        function debugCategoryDisplay() {
            console.log('🔍 开始调试分类显示...');

            // 检查分类数据
            console.log('📋 categoryHierarchyData:', categoryHierarchyData);
            console.log('📋 categoryHierarchy:', categoryHierarchy);

            // 检查DOM元素
            const primarySelect = document.getElementById('productPrimaryCategory');
            const secondarySelect = document.getElementById('productSecondaryCategory');

            console.log('📋 主要分类下拉框元素:', primarySelect);
            console.log('📋 次要分类下拉框元素:', secondarySelect);

            if (primarySelect) {
                console.log('📋 主要分类选项数量:', primarySelect.options.length);
                console.log('📋 主要分类HTML:', primarySelect.innerHTML);

                // 显示所有选项
                for (let i = 0; i < primarySelect.options.length; i++) {
                    const option = primarySelect.options[i];
                    console.log(`📋 选项 ${i}: value="${option.value}", text="${option.text}"`);
                }
            } else {
                console.error('❌ 找不到主要分类下拉框');
            }

            if (secondarySelect) {
                console.log('📋 次要分类选项数量:', secondarySelect.options.length);
                console.log('📋 次要分类HTML:', secondarySelect.innerHTML);
            } else {
                console.error('❌ 找不到次要分类下拉框');
            }

            // 手动触发分类初始化
            console.log('🔄 手动触发分类初始化...');
            try {
                initializeProductForm();
                console.log('✅ 分类初始化完成');
            } catch (error) {
                console.error('❌ 分类初始化失败:', error);
            }

            alert('分类显示调试完成，请查看控制台输出');
        }

        // 自动添加光纤内窥镜产品测试
        async function autoAddFiberEndoscope() {
            console.log('🚀 开始自动添加光纤内窥镜产品测试...');

            try {
                // 第1步：打开产品添加表单
                console.log('📝 第1步：打开产品添加表单...');
                addProduct();

                // 等待表单初始化完成
                await sleep(1000);

                // 第2步：填写基本信息
                console.log('📝 第2步：填写基本信息...');
                await fillBasicInfo();

                // 第3步：添加技术参数
                console.log('📝 第3步：添加技术参数...');
                await addTechnicalParameters();

                // 第4步：填写详细描述
                console.log('📝 第4步：填写详细描述...');
                await fillDetailedDescription();

                // 第5步：填写应用场景
                console.log('📝 第5步：填写应用场景...');
                await fillApplicationScenarios();

                // 第6步：模拟上传产品图片
                console.log('📝 第6步：模拟上传产品图片...');
                await simulateImageUpload();

                // 第7步：添加下载文件
                console.log('📝 第7步：添加下载文件...');
                await addDownloadFiles();

                // 第8步：保存产品
                console.log('📝 第8步：保存产品...');
                await saveProductTest();

                console.log('✅ 光纤内窥镜产品自动添加测试完成！');
                alert('✅ 光纤内窥镜产品自动添加测试完成！请查看控制台输出');

            } catch (error) {
                console.error('❌ 自动添加产品测试失败:', error);
                alert('❌ 自动添加产品测试失败: ' + error.message);
            }
        }

        // 辅助函数：延迟
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // 填写基本信息
        async function fillBasicInfo() {
            console.log('📋 填写基本信息...');

            document.getElementById('productTitle').value = 'VF-8.5mm柔性光纤内窥镜';
            document.getElementById('productModel').value = 'VF-8500';
            document.getElementById('productSummary').value = '高清柔性光纤内窥镜，适用于复杂管道检测';
            document.getElementById('productSupplier').value = 'VisNDT';
            document.getElementById('productSeries').value = 'VF系列';
            document.getElementById('productStatus').value = 'published';
            document.getElementById('productWeight').value = '1';
            document.getElementById('productDate').value = new Date().toISOString().split('T')[0];

            // 设置分类
            await sleep(500);
            document.getElementById('productPrimaryCategory').value = '光纤内窥镜';

            // 触发次要分类更新
            updateSecondaryCategories();
            await sleep(500);

            document.getElementById('productSecondaryCategory').value = '柔性光纤内窥镜';

            console.log('✅ 基本信息填写完成');
        }

        // 添加技术参数
        async function addTechnicalParameters() {
            console.log('📋 添加技术参数...');

            const parameters = [
                { name: '探头直径', value: '8.5mm' },
                { name: '工作长度', value: '1000mm' },
                { name: '视角', value: '60°' },
                { name: '焦距', value: '5-50mm' },
                { name: '分辨率', value: '高清' },
                { name: '工作温度', value: '-10°C至60°C' },
                { name: '防护等级', value: 'IP67' }
            ];

            for (const param of parameters) {
                addParameter();
                await sleep(200);

                const paramItems = document.querySelectorAll('.parameter-row');
                const lastItem = paramItems[paramItems.length - 1];

                if (lastItem) {
                    const nameInput = lastItem.querySelector('input[name="paramName"]');
                    const valueInput = lastItem.querySelector('input[name="paramValue"]');

                    if (nameInput && valueInput) {
                        nameInput.value = param.name;
                        valueInput.value = param.value;
                        console.log(`✅ 添加参数: ${param.name} = ${param.value}`);
                    }
                }
            }

            console.log('✅ 技术参数添加完成');
        }

        // 填写详细描述
        async function fillDetailedDescription() {
            console.log('📋 填写详细描述...');

            const description = `
                <h3>VF-8.5mm柔性光纤内窥镜</h3>
                <p>VF-8.5mm柔性光纤内窥镜是一款专业的工业检测设备，采用先进的光纤传输技术，能够提供高清晰度的图像传输。</p>

                <h4>主要特点：</h4>
                <ul>
                    <li>高清图像传输技术</li>
                    <li>柔性设计，适应复杂检测路径</li>
                    <li>耐腐蚀材料制造</li>
                    <li>便携式设计，操作简便</li>
                </ul>

                <h4>技术优势：</h4>
                <ol>
                    <li>采用高品质光纤束，确保图像清晰度</li>
                    <li>柔性探头设计，可弯曲角度大</li>
                    <li>防水防尘设计，适应恶劣环境</li>
                    <li>人体工学手柄，操作舒适</li>
                </ol>
            `;

            if (productDescriptionEditor) {
                productDescriptionEditor.root.innerHTML = description;
                console.log('✅ 详细描述填写完成');
            } else {
                console.log('⚠️ 详细描述编辑器未初始化，尝试重新初始化...');
                await initializeProductEditors();
                await sleep(1000);
                if (productDescriptionEditor) {
                    productDescriptionEditor.root.innerHTML = description;
                    console.log('✅ 详细描述填写完成（重新初始化后）');
                } else {
                    console.log('❌ 详细描述编辑器初始化失败');
                }
            }
        }

        // 填写应用场景
        async function fillApplicationScenarios() {
            console.log('📋 填写应用场景...');

            const scenarios = `
                <h3>适用检测场景</h3>

                <h4>工业应用：</h4>
                <ul>
                    <li>管道内壁检测</li>
                    <li>设备内部检查</li>
                    <li>焊缝质量检测</li>
                    <li>铸件内部缺陷检测</li>
                </ul>

                <h4>维护检修：</h4>
                <ul>
                    <li>发动机内部检查</li>
                    <li>热交换器检测</li>
                    <li>压力容器检查</li>
                    <li>精密设备维护</li>
                </ul>

                <h4>质量控制：</h4>
                <ul>
                    <li>产品内部结构检查</li>
                    <li>装配质量验证</li>
                    <li>缺陷定位分析</li>
                </ul>
            `;

            if (productApplicationEditor) {
                productApplicationEditor.root.innerHTML = scenarios;
                console.log('✅ 应用场景填写完成');
            } else {
                console.log('⚠️ 应用场景编辑器未初始化');
            }
        }

        // 模拟上传产品图片
        async function simulateImageUpload() {
            console.log('📋 模拟上传产品图片...');

            // 模拟添加产品图片到图库
            const mockImages = [
                {
                    url: '/static/images/products/vf-8500-main.jpg',
                    name: 'VF-8500主图',
                    alt: 'VF-8.5mm柔性光纤内窥镜主图',
                    isMain: true
                },
                {
                    url: '/static/images/products/vf-8500-detail1.jpg',
                    name: 'VF-8500细节图1',
                    alt: '探头细节图',
                    isMain: false
                },
                {
                    url: '/static/images/products/vf-8500-detail2.jpg',
                    name: 'VF-8500细节图2',
                    alt: '手柄细节图',
                    isMain: false
                }
            ];

            for (const image of mockImages) {
                addImageToGallery(image);
                await sleep(300);
                console.log(`✅ 添加图片: ${image.name}`);

                // 模拟保存到媒体库
                const mediaItem = {
                    id: `media-${Date.now()}-${Math.random()}`,
                    name: image.name,
                    type: 'image',
                    category: '产品图片',
                    size: '256KB',
                    url: image.url,
                    uploadDate: new Date().toISOString().split('T')[0],
                    source: 'auto-test'
                };

                if (!window.mediaLibrary) {
                    window.mediaLibrary = [];
                }
                window.mediaLibrary.push(mediaItem);
            }

            console.log('✅ 产品图片模拟上传完成');
        }

        // 添加下载文件
        async function addDownloadFiles() {
            console.log('📋 添加下载文件...');

            const mockFiles = [
                {
                    title: 'VF-8500产品规格书',
                    path: '/static/files/products/VF-8500-specifications.pdf',
                    name: 'VF-8500-specifications.pdf',
                    size: '2.5MB'
                },
                {
                    title: 'VF-8500用户手册',
                    path: '/static/files/products/VF-8500-manual.pdf',
                    name: 'VF-8500-manual.pdf',
                    size: '5.2MB'
                }
            ];

            for (const file of mockFiles) {
                // 模拟添加下载文件
                const container = document.getElementById('downloadsContainer');
                if (container) {
                    const placeholder = container.querySelector('.downloads-placeholder');
                    if (placeholder) {
                        placeholder.remove();
                    }

                    const fileItem = document.createElement('div');
                    fileItem.className = 'download-item border rounded p-3 mb-2';
                    fileItem.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">文件标题</label>
                                <input type="text" class="form-control file-title" value="${file.title}">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">文件路径</label>
                                <input type="text" class="form-control file-path" value="${file.path}">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-danger btn-sm d-block" onclick="removeDownloadFile(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(fileItem);
                }

                await sleep(300);
                console.log(`✅ 添加下载文件: ${file.title}`);

                // 模拟保存到媒体库
                const mediaItem = {
                    id: `media-${Date.now()}-${Math.random()}`,
                    name: file.name,
                    type: 'document',
                    category: '产品文档',
                    size: file.size,
                    url: file.path,
                    uploadDate: new Date().toISOString().split('T')[0],
                    source: 'auto-test'
                };

                if (!window.mediaLibrary) {
                    window.mediaLibrary = [];
                }
                window.mediaLibrary.push(mediaItem);
            }

            console.log('✅ 下载文件添加完成');
        }

        // 保存产品测试
        async function saveProductTest() {
            console.log('📋 开始保存产品测试...');

            try {
                // 收集所有表单数据
                const productData = {
                    title: document.getElementById('productTitle').value,
                    model: document.getElementById('productModel').value,
                    summary: document.getElementById('productSummary').value,
                    primary_category: document.getElementById('productPrimaryCategory').value,
                    secondary_category: document.getElementById('productSecondaryCategory').value,
                    supplier: document.getElementById('productSupplier').value,
                    series: document.getElementById('productSeries').value,
                    status: document.getElementById('productStatus').value,
                    weight: document.getElementById('productWeight').value,
                    date: document.getElementById('productDate').value
                };

                console.log('📊 收集的产品数据:', productData);

                // 收集参数
                productData.parameters = collectParameters();
                console.log('📊 收集的参数:', productData.parameters);

                // 收集图库
                productData.gallery = collectGalleryImages();
                console.log('📊 收集的图库:', productData.gallery);

                // 收集下载文件
                productData.data_download = collectDownloadFiles();
                console.log('📊 收集的下载文件:', productData.data_download);

                // 收集编辑器内容
                if (productDescriptionEditor) {
                    productData.detailed_description = productDescriptionEditor.root.innerHTML;
                    console.log('📊 详细描述长度:', productData.detailed_description.length);
                }

                if (productApplicationEditor) {
                    productData.application_scenarios = productApplicationEditor.root.innerHTML;
                    console.log('📊 应用场景长度:', productData.application_scenarios.length);
                }

                // 验证必填字段
                const requiredFields = ['title', 'model', 'primary_category', 'secondary_category'];
                const missingFields = requiredFields.filter(field => !productData[field]);

                if (missingFields.length > 0) {
                    throw new Error(`缺少必填字段: ${missingFields.join(', ')}`);
                }

                console.log('✅ 数据验证通过，开始保存...');

                // 调用保存函数
                const success = await saveContentToMarkdown('products', productData);

                if (success) {
                    console.log('✅ 产品保存成功！');

                    // 添加到产品列表（模拟）
                    if (!projectData.products) {
                        projectData.products = [];
                    }

                    productData.id = productData.model;
                    projectData.products.push(productData);

                    console.log('✅ 产品已添加到项目数据');

                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    if (modal) {
                        modal.hide();
                    }

                    showSyncStatus('✅ VF-8500光纤内窥镜产品添加成功！', 3000);

                } else {
                    throw new Error('保存产品失败');
                }

            } catch (error) {
                console.error('❌ 保存产品测试失败:', error);
                throw error;
            }
        }

        // 快速测试产品添加
        async function quickTestProduct() {
            console.log('🚀 开始快速产品测试...');

            try {
                // 打开产品表单
                addProduct();
                await sleep(1000);

                // 填写基本信息
                document.getElementById('productTitle').value = 'VF-8.5mm柔性光纤内窥镜';
                document.getElementById('productModel').value = 'VF-8500';
                document.getElementById('productSummary').value = '高清柔性光纤内窥镜，适用于复杂管道检测';

                // 设置分类
                document.getElementById('productPrimaryCategory').value = '光纤内窥镜';
                updateSecondaryCategories();
                await sleep(500);
                document.getElementById('productSecondaryCategory').value = '柔性光纤内窥镜';

                console.log('✅ 基本信息填写完成');

                // 添加一个参数
                addParameter();
                await sleep(300);

                const paramRows = document.querySelectorAll('.parameter-row');
                if (paramRows.length > 0) {
                    const lastRow = paramRows[paramRows.length - 1];
                    const nameInput = lastRow.querySelector('input[name="paramName"]');
                    const valueInput = lastRow.querySelector('input[name="paramValue"]');

                    if (nameInput && valueInput) {
                        nameInput.value = '探头直径';
                        valueInput.value = '8.5mm';
                        console.log('✅ 参数添加完成');
                    }
                }

                // 测试编辑器
                if (productDescriptionEditor) {
                    productDescriptionEditor.root.innerHTML = '<p>这是一款高质量的光纤内窥镜产品。</p>';
                    console.log('✅ 详细描述填写完成');
                } else {
                    console.log('⚠️ 详细描述编辑器未初始化');
                }

                console.log('✅ 快速测试完成！可以手动点击保存按钮测试保存功能。');
                alert('✅ 快速测试完成！表单已填写，可以点击保存按钮测试保存功能。');

            } catch (error) {
                console.error('❌ 快速测试失败:', error);
                alert('❌ 快速测试失败: ' + error.message);
            }
        }

        // 调试保存产品功能
        async function debugSaveProduct() {
            console.log('🔍 开始调试保存产品功能...');

            try {
                // 收集表单数据
                const productData = {
                    title: document.getElementById('productTitle').value,
                    model: document.getElementById('productModel').value,
                    summary: document.getElementById('productSummary').value,
                    primary_category: document.getElementById('productPrimaryCategory').value,
                    secondary_category: document.getElementById('productSecondaryCategory').value,
                    supplier: document.getElementById('productSupplier').value,
                    series: document.getElementById('productSeries').value,
                    status: document.getElementById('productStatus').value,
                    weight: document.getElementById('productWeight').value,
                    date: document.getElementById('productDate').value
                };

                console.log('📊 收集的基本数据:', productData);

                // 收集参数
                productData.parameters = collectParameters();
                console.log('📊 收集的参数:', productData.parameters);

                // 收集图库
                productData.gallery = collectGalleryImages();
                console.log('📊 收集的图库:', productData.gallery);

                // 收集下载文件
                productData.data_download = collectDownloadFiles();
                console.log('📊 收集的下载文件:', productData.data_download);

                // 收集编辑器内容
                if (productDescriptionEditor) {
                    productData.detailed_description = productDescriptionEditor.root.innerHTML;
                    console.log('📊 详细描述:', productData.detailed_description.substring(0, 100) + '...');
                }

                if (productApplicationEditor) {
                    productData.application_scenarios = productApplicationEditor.root.innerHTML;
                    console.log('📊 应用场景:', productData.application_scenarios.substring(0, 100) + '...');
                }

                // 生成Markdown内容
                console.log('📝 生成Markdown内容...');
                const markdownContent = generateMarkdownContent('products', productData);
                console.log('📝 生成的Markdown内容长度:', markdownContent.length);
                console.log('📝 Markdown内容预览:', markdownContent.substring(0, 500) + '...');

                // 生成文件名
                const fileName = generateFileName('products', productData);
                console.log('📝 生成的文件名:', fileName);

                // 测试API调用
                console.log('🌐 测试API调用...');
                const response = await fetch('http://localhost:3002/api/products/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: productData.model || fileName.replace('.md', ''),
                        content: markdownContent,
                        action: 'save'
                    })
                });

                console.log('🌐 API响应状态:', response.status);
                console.log('🌐 API响应头:', response.headers);

                const result = await response.text();
                console.log('🌐 API响应内容:', result);

                try {
                    const jsonResult = JSON.parse(result);
                    console.log('🌐 解析的JSON结果:', jsonResult);

                    if (jsonResult.success) {
                        console.log('✅ 保存成功！');
                        alert('✅ 调试保存成功！');
                    } else {
                        console.log('❌ 保存失败:', jsonResult.message);
                        alert('❌ 保存失败: ' + jsonResult.message);
                    }
                } catch (parseError) {
                    console.log('❌ 解析响应失败:', parseError);
                    console.log('原始响应:', result);
                    alert('❌ 服务器响应格式错误');
                }

            } catch (error) {
                console.error('❌ 调试保存失败:', error);
                alert('❌ 调试保存失败: ' + error.message);
            }
        }

        // 从Hugo静态文件加载产品数据
        async function loadProductsFromHugo() {
            try {
                console.log('📂 从Hugo静态文件加载产品数据...');

                // 尝试从Hugo生成的产品索引文件加载
                try {
                    const response = await fetch('/products-index.json');
                    if (response.ok) {
                        const products = await response.json();
                        console.log('✅ 从products-index.json加载产品:', products.length);
                        return products;
                    }
                } catch (error) {
                    console.log('⚠️ 无法从products-index.json加载，尝试其他方式');
                }

                // 备用方案：从通用index.json加载
                try {
                    const response = await fetch('/index.json');
                    if (response.ok) {
                        const data = await response.json();
                        const products = data.filter(item => item.section === 'products' && item.title);
                        console.log('✅ 从index.json加载产品:', products.length);
                        return products;
                    }
                } catch (error) {
                    console.log('⚠️ 无法从index.json加载，尝试其他方式');
                }

                // 备用方案：从localStorage加载已保存的产品
                const savedProducts = localStorage.getItem('products');
                if (savedProducts) {
                    const products = JSON.parse(savedProducts);
                    console.log('✅ 从localStorage加载产品:', products.length);
                    return products;
                }

                // 如果都没有，返回默认的示例产品
                const defaultProducts = [
                    {
                        id: 'sample-product',
                        title: '示例产品',
                        model: 'SAMPLE-001',
                        summary: '这是一个示例产品',
                        primary_category: '电子内窥镜',
                        secondary_category: '工业视频内窥镜',
                        supplier: '示例供应商',
                        published: new Date().toISOString(),
                        slug: 'sample-product'
                    }
                ];

                console.log('✅ 使用默认示例产品');
                return defaultProducts;

            } catch (error) {
                console.error('❌ 加载产品数据失败:', error);
                return [];
            }
        }

        // 强制重新加载产品数据
        async function forceReloadProducts() {
            console.log('🔄 强制重新加载产品数据...');

            try {
                showSyncStatus('正在重新加载产品数据...', 1000);

                // 从Hugo生成的JSON文件加载产品数据
                const products = await loadProductsFromHugo();

                if (products && products.length > 0) {
                    // 更新项目数据
                    if (!projectData.products) {
                        projectData.products = [];
                    }

                    // 清空现有产品列表，重新加载
                    projectData.products = products.map(product => ({
                        ...product,
                        uri: `/products/${product.slug || product.id}/`
                    }));

                    console.log(`✅ 已加载 ${products.length} 个产品`);
                    console.log('📊 当前产品列表:', projectData.products);

                    // 更新前端显示
                    updateProductList();
                    updateDashboard();

                    showSyncStatus(`✅ 产品数据重新加载完成，共 ${products.length} 个产品`, 2000);

                    return true;
                } else {
                    console.log('❌ 未找到产品数据');
                    showSyncStatus('❌ 未找到产品数据', 2000);
                    return false;
                }

            } catch (error) {
                console.error('❌ 重新加载产品数据失败:', error);
                showSyncStatus(`❌ 重新加载失败: ${error.message}`, 3000);
                return false;
            }
        }

        // 更新搜索索引
        async function updateSearchIndex() {
            console.log('🔍 更新搜索索引...');

            try {
                showSyncStatus('正在更新搜索索引...', 1000);

                // 重新获取搜索索引
                const response = await fetch('/search-index.json?t=' + Date.now());

                if (response.ok) {
                    const searchData = await response.json();
                    console.log(`📊 搜索索引包含 ${searchData.length} 条记录`);

                    // 检查VF-8500是否在搜索索引中
                    const vfProduct = searchData.find(item =>
                        item.uri && (item.uri.includes('vf-8500') || item.title.includes('VF-8500'))
                    );

                    if (vfProduct) {
                        console.log('✅ VF-8500产品已在搜索索引中');
                        showSyncStatus('✅ 搜索索引已包含新产品', 2000);
                    } else {
                        console.log('⚠️ VF-8500产品尚未在搜索索引中，可能需要重新构建Hugo');
                        showSyncStatus('⚠️ 新产品尚未在搜索索引中，请重新构建Hugo', 3000);
                    }

                    return true;
                } else {
                    console.log('❌ 获取搜索索引失败');
                    showSyncStatus('❌ 获取搜索索引失败', 2000);
                    return false;
                }

            } catch (error) {
                console.error('❌ 更新搜索索引失败:', error);
                showSyncStatus(`❌ 更新搜索索引失败: ${error.message}`, 3000);
                return false;
            }
        }

        // 调试手动保存流程
        async function debugManualSave() {
            console.log('🔍 开始调试手动保存流程...');

            try {
                // 第1步：检查表单数据
                console.log('📋 第1步：检查表单数据...');
                const title = document.getElementById('productTitle').value.trim();
                const model = document.getElementById('productModel').value.trim();

                console.log('基本信息:', {
                    title: title,
                    model: model,
                    summary: document.getElementById('productSummary').value.trim(),
                    primary_category: document.getElementById('productPrimaryCategory').value,
                    secondary_category: document.getElementById('productSecondaryCategory').value,
                    supplier: document.getElementById('productSupplier').value,
                    series: document.getElementById('productSeries').value
                });

                if (!title || !model) {
                    console.error('❌ 缺少必填字段：标题或型号');
                    alert('请填写产品标题和型号');
                    return;
                }

                // 第2步：检查编辑器状态
                console.log('📝 第2步：检查编辑器状态...');
                console.log('详细描述编辑器:', productDescriptionEditor);
                console.log('应用场景编辑器:', productApplicationEditor);

                if (productDescriptionEditor) {
                    console.log('详细描述内容:', productDescriptionEditor.root.innerHTML.substring(0, 100) + '...');
                } else {
                    console.log('⚠️ 详细描述编辑器未初始化');
                }

                if (productApplicationEditor) {
                    console.log('应用场景内容:', productApplicationEditor.root.innerHTML.substring(0, 100) + '...');
                } else {
                    console.log('⚠️ 应用场景编辑器未初始化');
                }

                // 第3步：收集所有数据
                console.log('📊 第3步：收集所有数据...');
                const productData = {
                    title: title,
                    model: model,
                    summary: document.getElementById('productSummary').value.trim(),
                    primary_category: document.getElementById('productPrimaryCategory').value,
                    secondary_category: document.getElementById('productSecondaryCategory').value,
                    supplier: document.getElementById('productSupplier').value,
                    series: document.getElementById('productSeries').value,
                    status: document.getElementById('productStatus').value,
                    weight: parseInt(document.getElementById('productWeight').value) || 1,
                    date: document.getElementById('productDate').value,
                    parameters: collectParameters(),
                    gallery: collectGalleryImages(),
                    data_download: collectDownloadFiles(),
                    related_products: collectRelatedProducts(),
                    content: getProductDescription(),
                    application_scenarios: getProductApplication()
                };

                console.log('收集的完整数据:', productData);

                // 第4步：测试保存到MD文件
                console.log('💾 第4步：测试保存到MD文件...');
                const saveSuccess = await saveContentToMarkdown('products', productData);

                if (saveSuccess) {
                    console.log('✅ MD文件保存成功');

                    // 第5步：更新前端数据
                    console.log('🔄 第5步：更新前端数据...');

                    if (currentEditingProductId) {
                        console.log('更新现有产品:', currentEditingProductId);
                        const index = projectData.products.findIndex(p => p.id === currentEditingProductId);
                        if (index !== -1) {
                            projectData.products[index] = { ...projectData.products[index], ...productData };
                            console.log('✅ 现有产品已更新');
                        } else {
                            console.log('⚠️ 未找到要更新的产品');
                        }
                    } else {
                        console.log('添加新产品');
                        const newId = model.toLowerCase().replace(/[^a-z0-9]/g, '-');
                        const newProduct = {
                            id: newId,
                            uri: `/products/${newId}/`,
                            ...productData
                        };

                        if (!projectData.products) {
                            projectData.products = [];
                        }

                        projectData.products.push(newProduct);
                        console.log('✅ 新产品已添加到列表');
                        console.log('新产品数据:', newProduct);
                    }

                    // 第6步：更新UI
                    console.log('🎨 第6步：更新UI...');
                    updateProductList();
                    updateDashboard();

                    console.log('✅ 手动保存流程完成');
                    alert('✅ 手动保存调试完成，请检查控制台输出');

                } else {
                    console.error('❌ MD文件保存失败');
                    alert('❌ MD文件保存失败');
                }

            } catch (error) {
                console.error('❌ 手动保存调试失败:', error);
                alert('❌ 手动保存调试失败: ' + error.message);
            }
        }

        // 简单保存测试
        async function testSimpleSave() {
            console.log('🧪 开始简单保存测试...');

            try {
                // 创建简单的测试产品数据
                const testProduct = {
                    title: '简单测试产品',
                    model: 'SIMPLE-TEST',
                    summary: '这是一个简单的测试产品',
                    primary_category: '光纤内窥镜',
                    secondary_category: '柔性光纤内窥镜',
                    supplier: '测试供应商',
                    series: '测试系列',
                    status: 'published',
                    weight: 1,
                    date: new Date().toISOString().split('T')[0],
                    parameters: [
                        { name: '测试参数1', value: '测试值1' },
                        { name: '测试参数2', value: '测试值2' }
                    ],
                    gallery: [],
                    data_download: [],
                    related_products: [],
                    content: '<p>这是简单测试产品的详细描述。</p>',
                    application_scenarios: '<p>这是简单测试产品的应用场景。</p>'
                };

                console.log('📊 测试产品数据:', testProduct);

                // 直接调用保存函数
                console.log('💾 开始保存测试...');
                const saveSuccess = await saveContentToMarkdown('products', testProduct);

                if (saveSuccess) {
                    console.log('✅ 保存成功！');

                    // 确保products数组存在
                    if (!projectData.products) {
                        projectData.products = [];
                    }

                    // 添加到产品列表
                    const newId = testProduct.model.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    const newProduct = {
                        id: newId,
                        uri: `/products/${newId}/`,
                        ...testProduct
                    };

                    projectData.products.push(newProduct);
                    console.log('✅ 产品已添加到列表');

                    // 更新UI
                    updateProductList();
                    updateDashboard();

                    console.log('✅ UI已更新');
                    console.log('📊 当前产品数量:', projectData.products.length);

                    alert('✅ 简单保存测试成功！产品已添加。');

                } else {
                    console.error('❌ 保存失败');
                    alert('❌ 简单保存测试失败');
                }

            } catch (error) {
                console.error('❌ 简单保存测试失败:', error);
                alert('❌ 简单保存测试失败: ' + error.message);
            }
        }

        // 修复显示问题
        async function fixDisplayIssues() {
            console.log('🔧 开始修复显示问题...');

            try {
                showSyncStatus('正在修复显示问题...', 1000);

                // 第1步：强制重新加载产品数据
                console.log('📊 第1步：强制重新加载产品数据...');
                const reloadSuccess = await forceReloadProducts();

                if (reloadSuccess) {
                    console.log('✅ 产品数据重新加载成功');
                } else {
                    console.log('⚠️ 产品数据重新加载失败，尝试从API直接获取');

                    // 直接从API获取产品列表
                    const response = await fetch('http://localhost:3002/api/products/list');
                    const result = await response.json();

                    if (result.success && result.products) {
                        console.log(`📋 从API获取到 ${result.products.length} 个产品`);

                        // 重置产品数据
                        projectData.products = result.products.map(apiProduct => ({
                            ...apiProduct,
                            uri: `/products/${apiProduct.id}/`
                        }));

                        console.log('✅ 产品数据已重置');
                    }
                }

                // 第2步：强制更新UI
                console.log('🎨 第2步：强制更新UI...');
                updateProductList();
                updateDashboard();

                // 第3步：检查搜索索引
                console.log('🔍 第3步：检查搜索索引...');
                await updateSearchIndex();

                // 第4步：验证结果
                console.log('✅ 第4步：验证结果...');
                console.log(`📊 当前产品数量: ${projectData.products.length}`);
                console.log('📋 产品列表:', projectData.products.map(p => ({ id: p.id, title: p.title })));

                // 显示修复结果
                const productCount = projectData.products.length;
                showSyncStatus(`✅ 显示问题修复完成，共 ${productCount} 个产品`, 3000);

                // 提供Hugo重建建议
                if (productCount > 0) {
                    console.log('💡 建议重新启动Hugo服务器以更新前台页面');

                    const shouldRestart = confirm(
                        `后台列表已更新，共显示 ${productCount} 个产品。\n\n` +
                        `要让新产品在前台页面显示，需要重新启动Hugo服务器。\n\n` +
                        `是否要查看重启指导？`
                    );

                    if (shouldRestart) {
                        alert(
                            '重启Hugo服务器步骤：\n\n' +
                            '1. 停止当前Hugo服务器（Ctrl+C）\n' +
                            '2. 重新运行：hugo server --port 1313\n' +
                            '3. 等待重建完成\n' +
                            '4. 访问前台产品页面验证\n\n' +
                            '重启后新产品将在前台页面显示。'
                        );
                    }
                }

                console.log('✅ 显示问题修复完成');

            } catch (error) {
                console.error('❌ 修复显示问题失败:', error);
                showSyncStatus(`❌ 修复失败: ${error.message}`, 3000);
                alert('❌ 修复显示问题失败: ' + error.message);
            }
        }

        // 修复图片显示问题
        async function fixImageIssues() {
            console.log('🖼️ 开始修复图片显示问题...');

            try {
                showSyncStatus('正在修复图片显示问题...', 1000);

                // 第1步：检查产品数据中的图片路径
                console.log('🔍 第1步：检查产品数据中的图片路径...');
                let fixedCount = 0;

                projectData.products.forEach((product, index) => {
                    console.log(`📋 检查产品 ${index + 1}: ${product.title}`);

                    // 修复gallery图片路径
                    if (product.gallery && Array.isArray(product.gallery)) {
                        product.gallery.forEach((img, imgIndex) => {
                            if (img.image && (img.image.startsWith('data:') || img.image.startsWith('blob:'))) {
                                console.log(`🔧 修复产品 ${product.title} 的图片 ${imgIndex + 1}`);
                                // 生成正确的媒体库路径
                                const timestamp = Date.now() + imgIndex;
                                const fileName = `product-${product.id}-${timestamp}.jpg`;
                                const mediaPath = `/static/images/products/${fileName}`;

                                img.image = mediaPath;
                                fixedCount++;
                                console.log(`✅ 图片路径已修复: ${mediaPath}`);
                            }
                        });
                    }
                });

                // 第2步：修复编辑器中的图片显示
                console.log('🎨 第2步：修复编辑器中的图片显示...');
                const editorImages = document.querySelectorAll('#productDescriptionEditor img, #productApplicationEditor img');
                editorImages.forEach((img, index) => {
                    if (img.src && (img.src.startsWith('data:') || img.src.includes('blob:'))) {
                        console.log(`🔧 修复编辑器图片 ${index + 1}`);
                        // 替换为占位符或正确路径
                        img.style.border = '2px solid orange';
                        img.title = '图片路径需要重新上传';
                        fixedCount++;
                    }
                });

                // 第3步：修复图库预览
                console.log('🖼️ 第3步：修复图库预览...');
                const galleryImages = document.querySelectorAll('.gallery-item img');
                galleryImages.forEach((img, index) => {
                    const hiddenUrl = img.closest('.gallery-item').querySelector('.image-url');
                    if (hiddenUrl && hiddenUrl.value) {
                        console.log(`🔧 验证图库图片 ${index + 1}: ${hiddenUrl.value}`);

                        // 如果隐藏的URL是正确的路径，但显示的是base64，则修复
                        if (!hiddenUrl.value.startsWith('data:') && !hiddenUrl.value.startsWith('blob:')) {
                            if (img.src.startsWith('data:') || img.src.startsWith('blob:')) {
                                console.log(`🔧 修复图库预览图片 ${index + 1}`);
                                img.src = hiddenUrl.value;
                                fixedCount++;
                            }
                        }
                    }
                });

                // 第4步：更新UI
                console.log('🎨 第4步：更新UI...');
                updateProductList();

                // 显示修复结果
                console.log(`✅ 图片问题修复完成，共修复 ${fixedCount} 个图片`);
                showSyncStatus(`✅ 图片问题修复完成，共修复 ${fixedCount} 个图片`, 3000);

                if (fixedCount > 0) {
                    alert(
                        `图片问题修复完成！\n\n` +
                        `共修复 ${fixedCount} 个图片路径问题。\n\n` +
                        `建议：\n` +
                        `1. 重新保存相关产品以确保路径正确\n` +
                        `2. 如果编辑器中仍有图片显示问题，请重新上传图片\n` +
                        `3. 检查前台页面图片显示是否正常`
                    );
                } else {
                    alert('未发现需要修复的图片问题。');
                }

            } catch (error) {
                console.error('❌ 修复图片问题失败:', error);
                showSyncStatus(`❌ 图片修复失败: ${error.message}`, 3000);
                alert('❌ 修复图片问题失败: ' + error.message);
            }
        }

        // 根据真实产品数据生成分类层级
        function generateCategoryHierarchyFromProducts() {
            if (!projectData.products || projectData.products.length === 0) {
                console.log('⚠️ 没有产品数据，保持默认分类层级');
                return;
            }

            console.log('🔧 根据产品数据生成分类层级...');
            const newHierarchy = {};

            projectData.products.forEach(product => {
                const primary = product.primary_category;
                const secondary = product.secondary_category;

                if (primary) {
                    if (!newHierarchy[primary]) {
                        newHierarchy[primary] = new Set();
                    }
                    if (secondary) {
                        newHierarchy[primary].add(secondary);
                    }
                }
            });

            // 转换Set为Array并排序
            Object.keys(newHierarchy).forEach(key => {
                newHierarchy[key] = Array.from(newHierarchy[key]).sort();
            });

            // 如果生成了新的层级，更新全局变量
            if (Object.keys(newHierarchy).length > 0) {
                categoryHierarchy = newHierarchy;
                console.log('✅ 分类层级已更新:', categoryHierarchy);
            } else {
                console.log('⚠️ 未能生成有效的分类层级，保持默认设置');
            }
        }

        // 获取产品详细描述
        function getProductDescription() {
            if (productDescriptionEditor) {
                return productDescriptionEditor.root.innerHTML;
            }
            const descriptionTextarea = document.getElementById('productDescription');
            return descriptionTextarea ? descriptionTextarea.value : '';
        }

        // 获取产品应用场景
        function getProductApplication() {
            if (productApplicationEditor) {
                return productApplicationEditor.root.innerHTML;
            }
            const applicationTextarea = document.getElementById('productApplication');
            return applicationTextarea ? applicationTextarea.value : '';
        }

        function clearProductForm() {
            console.log('🧹 清空产品表单...');

            // 手动清空表单字段，而不是使用reset()来避免清空下拉框选项
            document.getElementById('productTitle').value = '';
            document.getElementById('productModel').value = '';
            document.getElementById('productSummary').value = '';
            document.getElementById('productSupplier').value = '';
            document.getElementById('productSeries').value = '';
            document.getElementById('productStatus').value = 'published';
            document.getElementById('productWeight').value = '1';
            document.getElementById('productDate').value = new Date().toISOString().split('T')[0];

            // 重置分类选择（但保留选项）
            document.getElementById('productPrimaryCategory').value = '';
            document.getElementById('productSecondaryCategory').value = '';

            // 清空容器
            document.getElementById('parametersContainer').innerHTML = '';
            document.getElementById('galleryContainer').innerHTML = '<div class="gallery-placeholder"><i class="fas fa-images"></i><p>点击上方按钮添加产品图片</p></div>';
            document.getElementById('downloadsContainer').innerHTML = '<div class="downloads-placeholder"><i class="fas fa-file-alt"></i><p>点击上方按钮添加下载文件</p></div>';
            document.getElementById('relatedProductsContainer').innerHTML = '<div class="related-products-placeholder"><i class="fas fa-link"></i><p>点击上方按钮添加相关产品</p></div>';

            // 清空编辑器内容
            if (productDescriptionEditor) {
                productDescriptionEditor.setContents([]);
            }
            if (productApplicationEditor) {
                productApplicationEditor.setContents([]);
            }

            console.log('✅ 产品表单已清空');
        }

        function initializeProductForm() {
            console.log('🔧 初始化产品表单...');
            console.log('📊 当前项目数据:', projectData);

            // 初始化分类选项 - 使用真实项目数据
            const primaryCategorySelect = document.getElementById('productPrimaryCategory');
            primaryCategorySelect.innerHTML = '<option value="">选择主要分类</option>';

            // 使用预定义的完整分类结构，而不是从产品数据中提取
            console.log('📋 使用预定义的完整分类结构');

            // 从categoryHierarchyData获取所有主要分类
            const primaryCategories = categoryHierarchyData.map(category => category.title);
            console.log('📋 完整主要分类列表:', primaryCategories);

            // 同时更新categoryHierarchy对象
            categoryHierarchy = {};
            categoryHierarchyData.forEach(primary => {
                categoryHierarchy[primary.title] = primary.subcategories.map(sub => sub.title);
            });
            console.log('📋 更新后的分类层级:', categoryHierarchy);

            // 添加分类选项
            primaryCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                primaryCategorySelect.appendChild(option);
            });

            // 初始化供应商选项 - 使用真实项目数据
            const supplierSelect = document.getElementById('productSupplier');
            supplierSelect.innerHTML = '<option value="">选择供应商</option>';

            let suppliers = [];

            if (projectData.suppliers && projectData.suppliers.length > 0) {
                console.log('✅ 使用真实供应商数据:', projectData.suppliers.length, '个供应商');
                suppliers = projectData.suppliers.map(supplier => supplier.name || supplier.title).filter(Boolean);
                console.log('📋 供应商列表:', suppliers);
            }

            // 如果没有真实供应商数据或供应商为空，使用默认供应商
            if (suppliers.length === 0) {
                console.log('⚠️ 没有真实供应商数据，使用默认供应商');
                suppliers = Object.keys(supplierSeriesMap);
                console.log('📋 默认供应商列表:', suppliers);
            }

            // 添加供应商选项
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierSelect.appendChild(option);
            });

            // 初始化富文本编辑器
            initializeProductEditors();

            // 触发级联更新
            updateSecondaryCategories();
            updateProductSeries();
        }

        // 初始化产品编辑器
        function initializeProductEditors() {
            console.log('📝 初始化产品编辑器...');
            console.log('🔍 Quill是否可用:', typeof Quill !== 'undefined');

            // 强制清理现有编辑器
            cleanupProductEditors();

            // 等待一下再初始化，确保清理完成
            setTimeout(() => {
                createProductEditors();
            }, 100);
        }

        // 创建产品编辑器
        function createProductEditors() {

            console.log('🔧 开始创建编辑器...');

            // 初始化详细描述编辑器
            const descriptionContainer = document.getElementById('productDescriptionEditor');
            console.log('📝 详细描述编辑器容器:', descriptionContainer);

            if (descriptionContainer && typeof Quill !== 'undefined') {
                // 确保容器为空
                descriptionContainer.innerHTML = '';
                console.log('✅ 创建详细描述编辑器...');

                try {
                    productDescriptionEditor = new Quill('#productDescriptionEditor', {
                        theme: 'snow',
                        modules: {
                            toolbar: {
                                container: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline', 'strike'],
                                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                    ['blockquote', 'code-block'],
                                    ['link', 'image'],
                                    [{ 'color': [] }, { 'background': [] }],
                                    [{ 'align': [] }],
                                    ['clean']
                                ],
                                handlers: {
                                    'image': function() {
                                        openEditorMediaLibrary('description');
                                    }
                                }
                            }
                        }
                    });
                    console.log('✅ 详细描述编辑器创建成功');

                    // 监听编辑器内容变化，自动保存图片到媒体库
                    productDescriptionEditor.on('text-change', function() {
                        setTimeout(() => {
                            processEditorImages(productDescriptionEditor, 'description');
                        }, 1000);
                    });
                } catch (error) {
                    console.error('❌ 创建详细描述编辑器失败:', error);
                    productDescriptionEditor = null;
                }
            } else {
                console.log('❌ 无法创建详细描述编辑器 - 容器或Quill不可用');
            }

            // 初始化应用场景编辑器
            const applicationContainer = document.getElementById('productApplicationEditor');
            console.log('📝 应用场景编辑器容器:', applicationContainer);

            if (applicationContainer && typeof Quill !== 'undefined') {
                // 确保容器为空
                applicationContainer.innerHTML = '';
                console.log('✅ 创建应用场景编辑器...');

                try {
                    productApplicationEditor = new Quill('#productApplicationEditor', {
                        theme: 'snow',
                        modules: {
                            toolbar: {
                                container: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    ['bold', 'italic', 'underline'],
                                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                    ['link', 'image'],
                                    ['clean']
                                ],
                                handlers: {
                                    'image': function() {
                                        openEditorMediaLibrary('application');
                                    }
                                }
                            }
                        }
                    });
                    console.log('✅ 应用场景编辑器创建成功');

                    // 监听编辑器内容变化，自动保存图片到媒体库
                    productApplicationEditor.on('text-change', function() {
                        setTimeout(() => {
                            processEditorImages(productApplicationEditor, 'application');
                        }, 1000);
                    });
                } catch (error) {
                    console.error('❌ 创建应用场景编辑器失败:', error);
                    productApplicationEditor = null;
                }
            } else {
                console.log('❌ 无法创建应用场景编辑器 - 容器或Quill不可用');
            }
        }

        // 清理产品编辑器
        function cleanupProductEditors() {
            console.log('🧹 清理产品编辑器...');

            // 清理详细描述编辑器
            try {
                if (productDescriptionEditor) {
                    console.log('🗑️ 销毁详细描述编辑器实例');
                    // 尝试销毁Quill实例
                    if (productDescriptionEditor.destroy) {
                        productDescriptionEditor.destroy();
                    }
                    productDescriptionEditor = null;
                }
                const descContainer = document.getElementById('productDescriptionEditor');
                if (descContainer) {
                    console.log('🧹 清空详细描述编辑器容器');

                    // 查找并移除父容器中的所有工具栏
                    const parentContainer = descContainer.parentNode;
                    if (parentContainer) {
                        const toolbars = parentContainer.querySelectorAll('.ql-toolbar');
                        toolbars.forEach(toolbar => {
                            console.log('🗑️ 移除工具栏:', toolbar);
                            toolbar.remove();
                        });
                    }

                    // 移除所有子元素，包括工具栏
                    while (descContainer.firstChild) {
                        descContainer.removeChild(descContainer.firstChild);
                    }
                    descContainer.innerHTML = '';
                }
                console.log('✅ 详细描述编辑器已清理');
            } catch (e) {
                console.error('清理详细描述编辑器时出错:', e);
            }

            // 清理应用场景编辑器
            try {
                if (productApplicationEditor) {
                    console.log('🗑️ 销毁应用场景编辑器实例');
                    // 尝试销毁Quill实例
                    if (productApplicationEditor.destroy) {
                        productApplicationEditor.destroy();
                    }
                    productApplicationEditor = null;
                }
                const appContainer = document.getElementById('productApplicationEditor');
                if (appContainer) {
                    console.log('🧹 清空应用场景编辑器容器');

                    // 查找并移除父容器中的所有工具栏
                    const parentContainer = appContainer.parentNode;
                    if (parentContainer) {
                        const toolbars = parentContainer.querySelectorAll('.ql-toolbar');
                        toolbars.forEach(toolbar => {
                            console.log('🗑️ 移除工具栏:', toolbar);
                            toolbar.remove();
                        });
                    }

                    // 移除所有子元素，包括工具栏
                    while (appContainer.firstChild) {
                        appContainer.removeChild(appContainer.firstChild);
                    }
                    appContainer.innerHTML = '';
                }
                console.log('✅ 应用场景编辑器已清理');
            } catch (e) {
                console.error('清理应用场景编辑器时出错:', e);
            }
        }

        function updateSecondaryCategories() {
            const primaryCategory = document.getElementById('productPrimaryCategory').value;
            const secondarySelect = document.getElementById('productSecondaryCategory');

            secondarySelect.innerHTML = '<option value="">选择次要分类</option>';

            if (primaryCategory && categoryHierarchy[primaryCategory]) {
                categoryHierarchy[primaryCategory].forEach(subCategory => {
                    const option = document.createElement('option');
                    option.value = subCategory;
                    option.textContent = subCategory;
                    secondarySelect.appendChild(option);
                });
            }
        }

        function updateProductSeries() {
            const supplier = document.getElementById('productSupplier').value;
            const seriesSelect = document.getElementById('productSeries');

            seriesSelect.innerHTML = '<option value="">选择产品系列</option>';

            if (supplier && supplierSeriesMap[supplier]) {
                supplierSeriesMap[supplier].forEach(series => {
                    const option = document.createElement('option');
                    option.value = series;
                    option.textContent = series;
                    seriesSelect.appendChild(option);
                });
            }
        }

        // 参数管理功能
        function loadParameterTemplate() {
            const category = document.getElementById('productPrimaryCategory').value;
            const container = document.getElementById('parametersContainer');

            console.log('🔧 加载参数模板，选择的分类:', category);
            console.log('📋 可用的参数模板:', Object.keys(defaultParameterTemplates));

            if (!category) {
                alert('请先选择产品分类');
                return;
            }

            if (!defaultParameterTemplates[category]) {
                alert(`没有找到分类"${category}"的参数模板`);
                console.log('❌ 没有找到对应的参数模板');
                return;
            }

            console.log('✅ 找到参数模板:', defaultParameterTemplates[category]);
            container.innerHTML = '';
            defaultParameterTemplates[category].forEach(param => {
                addParameter(param.name, param.value);
            });
            console.log('✅ 参数模板加载完成');
        }

        function addParameter(name = '', value = '') {
            const container = document.getElementById('parametersContainer');
            const parameterId = 'param-' + Date.now();

            const parameterDiv = document.createElement('div');
            parameterDiv.className = 'row mb-2 parameter-row';
            parameterDiv.id = `parameter-${parameterId}`;

            parameterDiv.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="参数名称" value="${name}" name="paramName">
                </div>
                <div class="col-md-6">
                    <input type="text" class="form-control" placeholder="参数值" value="${value}" name="paramValue">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeParameter('${parameterId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            container.appendChild(parameterDiv);
        }

        function removeParameter(id) {
            const parameterDiv = document.getElementById(`parameter-${id}`);
            if (parameterDiv) {
                parameterDiv.remove();
            }
        }

        function collectParameters() {
            const parameters = [];
            const parameterRows = document.querySelectorAll('.parameter-row');

            parameterRows.forEach(row => {
                const name = row.querySelector('input[name="paramName"]').value.trim();
                const value = row.querySelector('input[name="paramValue"]').value.trim();

                if (name && value) {
                    parameters.push({ name, value });
                }
            });

            return parameters;
        }

        // 产品列表更新
        function updateProductList() {
            console.log('🔄 更新产品列表...');
            if (!projectData.products || projectData.products.length === 0) {
                console.log('⚠️ 产品数据为空');
                filteredProducts = [];
            } else {
                filteredProducts = [...projectData.products];
                console.log(`✅ 产品数据已复制: ${filteredProducts.length} 个产品`);
            }

            // 初始化筛选器
            initializeProductFilters();

            // 渲染列表
            renderProductList();
        }

        function renderProductList() {
            const tbody = document.getElementById('productList');
            if (!tbody) {
                console.error('❌ 未找到productList元素');
                return;
            }

            console.log(`🔄 渲染产品列表: 总产品${projectData.products.length}个, 过滤后${filteredProducts.length}个`);

            const startIndex = (currentProductPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageProducts = filteredProducts.slice(startIndex, endIndex);

            if (pageProducts.length === 0) {
                console.log('⚠️ 没有产品数据显示');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-box-open fa-2x mb-2"></i>
                            <div>暂无产品数据</div>
                            <small class="text-muted">总产品: ${projectData.products.length}, 过滤后: ${filteredProducts.length}</small>
                        </td>
                    </tr>
                `;
                updateProductPagination();
                return;
            }

            console.log(`✅ 显示产品: ${pageProducts.length} 个`);
            pageProducts.forEach(product => {
                console.log(`  - ${product.title} (${product.model})`);
            });

            tbody.innerHTML = pageProducts.map(product => `
                <tr>
                    <td>
                        <strong>${product.title}</strong>
                        ${product.summary ? `<br><small class="text-muted">${product.summary.substring(0, 50)}${product.summary.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td><code>${product.model}</code></td>
                    <td>
                        <span class="badge bg-primary">${product.primary_category}</span>
                        ${product.secondary_category ? `<br><small class="text-muted">${product.secondary_category}</small>` : ''}
                    </td>
                    <td>${product.supplier}</td>
                    <td>${product.series || '-'}</td>
                    <td>
                        <span class="badge ${product.status === 'published' ? 'bg-success' : 'bg-warning'}">
                            ${product.status === 'published' ? '已发布' : '草稿'}
                        </span>
                    </td>
                    <td>${product.date}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editProduct('${product.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProduct('${product.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updateProductPagination();
        }

        function updateProductPagination() {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const paginationInfo = document.getElementById('productPaginationInfo');
            const pagination = document.getElementById('productPagination');

            // 更新信息
            const startIndex = (currentProductPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentProductPage * itemsPerPage, filteredProducts.length);
            paginationInfo.textContent = `显示 ${startIndex}-${endIndex} 共 ${filteredProducts.length} 个产品`;

            // 生成分页按钮
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            pagination.innerHTML = generatePaginationHTML(currentProductPage, totalPages, 'changeProductPage');
        }

        function changeProductPage(page) {
            const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentProductPage = page;
                renderProductList();
            }
        }

        // 通用分页HTML生成函数
        function generatePaginationHTML(currentPage, totalPages, changeFunction) {
            let paginationHTML = '';

            // 上一页
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="${changeFunction}(${currentPage - 1})">上一页</a>
                </li>
            `;

            // 页码
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="${changeFunction}(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // 下一页
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="${changeFunction}(${currentPage + 1})">下一页</a>
                </li>
            `;

            return paginationHTML;
        }

        // 筛选功能
        function initializeProductFilters() {
            // 初始化供应商筛选
            const supplierFilter = document.getElementById('supplierFilter');
            supplierFilter.innerHTML = '<option value="">所有供应商</option>';
            const suppliers = [...new Set(projectData.products.map(p => p.supplier).filter(s => s))];
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierFilter.appendChild(option);
            });

            // 初始化分类筛选 - 使用层级结构
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">所有分类</option>';

            // 添加主分类和子分类
            categoryHierarchyData.forEach(primary => {
                // 添加主分类
                const primaryOption = document.createElement('option');
                primaryOption.value = primary.title;
                primaryOption.textContent = primary.title;
                categoryFilter.appendChild(primaryOption);

                // 添加子分类
                if (primary.subcategories) {
                    primary.subcategories.forEach(sub => {
                        const subOption = document.createElement('option');
                        subOption.value = sub.title;
                        subOption.textContent = `　└─ ${sub.title}`;
                        categoryFilter.appendChild(subOption);
                    });
                }
            });

            // 添加从产品数据中提取的其他分类
            const existingCategories = new Set();
            categoryHierarchyData.forEach(primary => {
                existingCategories.add(primary.title);
                if (primary.subcategories) {
                    primary.subcategories.forEach(sub => {
                        existingCategories.add(sub.title);
                    });
                }
            });

            const additionalCategories = [...new Set([
                ...projectData.products.map(p => p.primary_category).filter(c => c && !existingCategories.has(c)),
                ...projectData.products.map(p => p.secondary_category).filter(c => c && !existingCategories.has(c))
            ])];

            if (additionalCategories.length > 0) {
                // 添加分隔符
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '─────────────';
                categoryFilter.appendChild(separator);

                // 添加其他分类
                additionalCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const supplierFilter = document.getElementById('supplierFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            // 如果选择了分类，添加到历史记录
            if (categoryFilter && categoryFilter !== '') {
                addToCategoryHistory(categoryFilter);
            }

            filteredProducts = projectData.products.filter(product => {
                const matchesSearch = !searchTerm ||
                    product.title.toLowerCase().includes(searchTerm) ||
                    product.model.toLowerCase().includes(searchTerm) ||
                    (product.summary && product.summary.toLowerCase().includes(searchTerm));

                const matchesSupplier = !supplierFilter || product.supplier === supplierFilter;
                const matchesCategory = !categoryFilter ||
                    product.primary_category === categoryFilter ||
                    product.secondary_category === categoryFilter;
                const matchesStatus = !statusFilter || product.status === statusFilter;

                return matchesSearch && matchesSupplier && matchesCategory && matchesStatus;
            });

            currentProductPage = 1;
            renderProductList();
        }

        function clearProductFilters() {
            document.getElementById('productSearch').value = '';
            document.getElementById('supplierFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('statusFilter').value = '';
            filterProducts();
        }

        // 更新当前显示的列表
        function updateCurrentSectionList() {
            const currentSection = document.querySelector('.content-section.active');
            if (!currentSection) {
                console.log('⚠️ 未找到当前活动的section');
                return;
            }

            const sectionId = currentSection.id;
            console.log(`🔄 更新 ${sectionId} 列表`);

            switch (sectionId) {
                case 'products':
                    updateProductList();
                    initializeProductFilters();
                    break;
                case 'suppliers':
                    updateSupplierList();
                    initializeSupplierFilters();
                    break;
                case 'news':
                    updateNewsList();
                    initializeNewsFilters();
                    break;
                case 'cases':
                    updateCaseList();
                    initializeCaseFilters();
                    break;
                case 'applications':
                    updateApplicationList();
                    break;
                case 'categories':
                    updateCategoryList();
                    break;
                default:
                    console.log(`ℹ️ ${sectionId} 不需要列表更新`);
            }
        }

        // 供应商列表管理
        function updateSupplierList() {
            filteredSuppliers = [...projectData.suppliers];
            applySupplierFilters();
            renderSupplierList();
        }

        function renderSupplierList() {
            const tbody = document.getElementById('supplierList');
            if (!tbody) {
                console.error('❌ 未找到supplierList元素');
                return;
            }

            console.log(`🔄 渲染供应商列表: ${filteredSuppliers.length} 个供应商`);

            const startIndex = (currentSupplierPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageSuppliers = filteredSuppliers.slice(startIndex, endIndex);

            if (pageSuppliers.length === 0) {
                console.log('⚠️ 没有供应商数据显示');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-building fa-2x mb-2"></i>
                            <div>暂无供应商数据</div>
                        </td>
                    </tr>
                `;
                updateSupplierPagination();
                return;
            }

            console.log(`✅ 显示供应商: ${pageSuppliers.length} 个`);
            pageSuppliers.forEach(supplier => {
                console.log(`  - ${supplier.name} (${supplier.products}个产品)`);
            });

            tbody.innerHTML = pageSuppliers.map(supplier => `
                <tr>
                    <td>
                        <strong>${supplier.name}</strong>
                        ${supplier.address ? `<br><small class="text-muted">${supplier.address}</small>` : ''}
                    </td>
                    <td><span class="badge bg-info">${supplier.type}</span></td>
                    <td><span class="badge bg-primary">${supplier.products || 0}</span></td>
                    <td>${supplier.contact_person || '-'}</td>
                    <td>${supplier.phone || supplier.email || '-'}</td>
                    <td>
                        <span class="badge ${supplier.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                            ${supplier.status === 'active' ? '活跃' : '停用'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editSupplier('${supplier.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSupplier('${supplier.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updateSupplierPagination();
        }

        function updateSupplierPagination() {
            const totalPages = Math.ceil(filteredSuppliers.length / itemsPerPage);
            const paginationInfo = document.getElementById('supplierPaginationInfo');
            const pagination = document.getElementById('supplierPagination');

            if (!paginationInfo || !pagination) return;

            const startIndex = (currentSupplierPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentSupplierPage * itemsPerPage, filteredSuppliers.length);
            paginationInfo.textContent = `显示 ${startIndex}-${endIndex} 共 ${filteredSuppliers.length} 个供应商`;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            pagination.innerHTML = generatePaginationHTML(currentSupplierPage, totalPages, 'changeSupplierPage');
        }

        function changeSupplierPage(page) {
            const totalPages = Math.ceil(filteredSuppliers.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentSupplierPage = page;
                renderSupplierList();
            }
        }

        function applySupplierFilters() {
            // 供应商筛选逻辑将在后续实现
            filteredSuppliers = [...projectData.suppliers];
            currentSupplierPage = 1;
        }

        // 资讯列表管理
        function updateNewsList() {
            filteredNews = [...projectData.news];
            applyNewsFilters();
            renderNewsList();
        }

        function renderNewsList() {
            const tbody = document.getElementById('newsList');
            if (!tbody) {
                console.error('❌ 未找到newsList元素');
                return;
            }

            console.log(`🔄 渲染资讯列表: ${filteredNews.length} 个资讯`);

            const startIndex = (currentNewsPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageNews = filteredNews.slice(startIndex, endIndex);

            if (pageNews.length === 0) {
                console.log('⚠️ 没有资讯数据显示');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-newspaper fa-2x mb-2"></i>
                            <div>暂无资讯数据</div>
                        </td>
                    </tr>
                `;
                updateNewsPagination();
                return;
            }

            console.log(`✅ 显示资讯: ${pageNews.length} 个`);

            tbody.innerHTML = pageNews.map(news => `
                <tr>
                    <td>
                        <strong>${news.title}</strong>
                        ${news.summary ? `<br><small class="text-muted">${news.summary.substring(0, 50)}${news.summary.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td>
                        ${news.categories ? news.categories.map(cat => `<span class="badge bg-secondary me-1">${cat}</span>`).join('') : '-'}
                    </td>
                    <td>${news.author || '-'}</td>
                    <td><span class="badge bg-info">${news.views || 0}</span></td>
                    <td>${news.date}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editNews('${news.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteNews('${news.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updateNewsPagination();
        }

        function updateNewsPagination() {
            const totalPages = Math.ceil(filteredNews.length / itemsPerPage);
            const paginationInfo = document.getElementById('newsPaginationInfo');
            const pagination = document.getElementById('newsPagination');

            if (!paginationInfo || !pagination) return;

            const startIndex = (currentNewsPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentNewsPage * itemsPerPage, filteredNews.length);
            paginationInfo.textContent = `显示 ${startIndex}-${endIndex} 共 ${filteredNews.length} 个资讯`;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            pagination.innerHTML = generatePaginationHTML(currentNewsPage, totalPages, 'changeNewsPage');
        }

        function changeNewsPage(page) {
            const totalPages = Math.ceil(filteredNews.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentNewsPage = page;
                renderNewsList();
            }
        }

        function applyNewsFilters() {
            // 资讯筛选逻辑将在后续实现
            filteredNews = [...projectData.news];
            currentNewsPage = 1;
        }

        // 案例列表管理
        function updateCaseList() {
            filteredCases = [...projectData.cases];
            applyCaseFilters();
            renderCaseList();
        }

        function renderCaseList() {
            const tbody = document.getElementById('caseList');
            if (!tbody) return;

            const startIndex = (currentCasePage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageCases = filteredCases.slice(startIndex, endIndex);

            if (pageCases.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-briefcase fa-2x mb-2"></i>
                            <div>暂无案例数据</div>
                        </td>
                    </tr>
                `;
                updateCasePagination();
                return;
            }

            tbody.innerHTML = pageCases.map(caseItem => `
                <tr>
                    <td>
                        <strong>${caseItem.title}</strong>
                        ${caseItem.summary ? `<br><small class="text-muted">${caseItem.summary.substring(0, 50)}${caseItem.summary.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td>${caseItem.client || '-'}</td>
                    <td><span class="badge bg-primary">${caseItem.industry || '-'}</span></td>
                    <td>
                        ${caseItem.application_field ? caseItem.application_field.map(field => `<span class="badge bg-secondary me-1">${field}</span>`).join('') : '-'}
                    </td>
                    <td>${caseItem.date}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editCase('${caseItem.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteCase('${caseItem.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updateCasePagination();
        }

        function updateCasePagination() {
            const totalPages = Math.ceil(filteredCases.length / itemsPerPage);
            const paginationInfo = document.getElementById('casePaginationInfo');
            const pagination = document.getElementById('casePagination');

            if (!paginationInfo || !pagination) return;

            const startIndex = (currentCasePage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentCasePage * itemsPerPage, filteredCases.length);
            paginationInfo.textContent = `显示 ${startIndex}-${endIndex} 共 ${filteredCases.length} 个案例`;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            pagination.innerHTML = generatePaginationHTML(currentCasePage, totalPages, 'changeCasePage');
        }

        function changeCasePage(page) {
            const totalPages = Math.ceil(filteredCases.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentCasePage = page;
                renderCaseList();
            }
        }

        function applyCaseFilters() {
            // 案例筛选逻辑将在后续实现
            filteredCases = [...projectData.cases];
            currentCasePage = 1;
        }

        // 应用领域列表管理
        function updateApplicationList() {
            filteredApplications = [...projectData.applications];
            applyApplicationFilters();
            renderApplicationList();
        }

        function renderApplicationList() {
            const tbody = document.getElementById('applicationList');
            if (!tbody) return;

            const startIndex = (currentApplicationPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageApplications = filteredApplications.slice(startIndex, endIndex);

            if (pageApplications.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-cogs fa-2x mb-2"></i>
                            <div>暂无应用领域数据</div>
                        </td>
                    </tr>
                `;
                updateApplicationPagination();
                return;
            }

            tbody.innerHTML = pageApplications.map(app => `
                <tr>
                    <td>
                        <strong>${app.title}</strong>
                        ${app.summary ? `<br><small class="text-muted">${app.summary.substring(0, 50)}${app.summary.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td><span class="badge bg-info">${app.weight || 1}</span></td>
                    <td>
                        <span class="badge ${app.status === 'published' ? 'bg-success' : 'bg-warning'}">
                            ${app.status === 'published' ? '已发布' : '草稿'}
                        </span>
                    </td>
                    <td>${app.date}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editApplication('${app.id}')" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteApplication('${app.id}')" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            updateApplicationPagination();
        }

        function updateApplicationPagination() {
            const totalPages = Math.ceil(filteredApplications.length / itemsPerPage);
            const paginationInfo = document.getElementById('applicationPaginationInfo');
            const pagination = document.getElementById('applicationPagination');

            if (!paginationInfo || !pagination) return;

            const startIndex = (currentApplicationPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentApplicationPage * itemsPerPage, filteredApplications.length);
            paginationInfo.textContent = `显示 ${startIndex}-${endIndex} 共 ${filteredApplications.length} 个应用领域`;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            pagination.innerHTML = generatePaginationHTML(currentApplicationPage, totalPages, 'changeApplicationPage');
        }

        function changeApplicationPage(page) {
            const totalPages = Math.ceil(filteredApplications.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentApplicationPage = page;
                renderApplicationList();
            }
        }

        function applyApplicationFilters() {
            // 应用领域筛选逻辑将在后续实现
            filteredApplications = [...projectData.applications];
            currentApplicationPage = 1;
        }

        // 分类列表管理
        function updateCategoryList() {
            filteredCategories = [...projectData.categories];
            applyCategoryFilters();
            renderCategoryList();
        }

        function renderCategoryList() {
            const tbody = document.getElementById('categoryList');
            if (!tbody) return;

            const startIndex = (currentCategoryPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageCategories = filteredCategories.slice(startIndex, endIndex);

            if (pageCategories.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-tags fa-2x mb-2"></i>
                            <div>暂无分类数据</div>
                        </td>
                    </tr>
                `;
                updateCategoryPagination();
                return;
            }

            tbody.innerHTML = pageCategories.map(category => {
                const isSubCategory = category.level === '子分类';
                const categoryIcon = category.icon || 'fas fa-tag';
                const indentClass = isSubCategory ? 'ps-4' : '';
                const namePrefix = isSubCategory ? '└─ ' : '';

                return `
                    <tr class="${isSubCategory ? 'table-light' : ''}">
                        <td class="${indentClass}">
                            <div class="d-flex align-items-center">
                                <i class="${categoryIcon} me-2 text-primary"></i>
                                <div>
                                    <strong>${namePrefix}${category.name}</strong>
                                    ${category.description ? `<br><small class="text-muted">${category.description}</small>` : ''}
                                    ${category.parent_name ? `<br><small class="text-info">父分类: ${category.parent_name}</small>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${category.level === '主分类' ? 'bg-primary' : category.level === '子分类' ? 'bg-info' : 'bg-secondary'}">
                                ${category.level}
                            </span>
                        </td>
                        <td><span class="badge bg-primary">${category.product_count || 0}</span></td>
                        <td>
                            <span class="badge ${category.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                ${category.status === 'active' ? '启用' : '禁用'}
                            </span>
                        </td>
                        <td><small class="text-muted">${category.date}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editCategory('${category.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteCategory('${category.id}')" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateCategoryPagination();
        }

        function updateCategoryPagination() {
            const totalPages = Math.ceil(filteredCategories.length / itemsPerPage);
            const paginationInfo = document.getElementById('categoryPaginationInfo');
            const pagination = document.getElementById('categoryPagination');

            if (!paginationInfo || !pagination) return;

            const startIndex = (currentCategoryPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentCategoryPage * itemsPerPage, filteredCategories.length);
            paginationInfo.textContent = `显示 ${startIndex}-${endIndex} 共 ${filteredCategories.length} 个分类`;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            pagination.innerHTML = generatePaginationHTML(currentCategoryPage, totalPages, 'changeCategoryPage');
        }

        function changeCategoryPage(page) {
            const totalPages = Math.ceil(filteredCategories.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentCategoryPage = page;
                renderCategoryList();
            }
        }

        function applyCategoryFilters() {
            const searchTerm = document.getElementById('categorySearch')?.value.toLowerCase() || '';

            filteredCategories = projectData.categories.filter(category => {
                const matchesSearch = !searchTerm ||
                    category.name.toLowerCase().includes(searchTerm) ||
                    (category.description && category.description.toLowerCase().includes(searchTerm)) ||
                    (category.parent_name && category.parent_name.toLowerCase().includes(searchTerm));

                return matchesSearch;
            });

            // 按层级和排序顺序排序
            filteredCategories.sort((a, b) => {
                // 首先按层级排序：主分类 -> 子分类 -> 其他分类
                const levelOrder = { '主分类': 1, '子分类': 2, '其他分类': 3 };
                const levelDiff = levelOrder[a.level] - levelOrder[b.level];
                if (levelDiff !== 0) return levelDiff;

                // 同级别内按排序顺序
                return (a.sort_order || 999) - (b.sort_order || 999);
            });

            currentCategoryPage = 1;
        }

        // 仪表板更新
        function updateDashboard() {
            document.getElementById('productCount').textContent = projectData.products.length;
            document.getElementById('supplierCount').textContent = projectData.suppliers.length;
            document.getElementById('newsCount').textContent = projectData.news.length;
            document.getElementById('caseCount').textContent = projectData.cases.length;
        }

        // 默认数据加载（备用）
        function loadDefaultData() {
            projectData.products = [
                {
                    id: 'ws-k08510-a',
                    title: 'WS-K08510超细工业电子内窥镜',
                    model: 'WS-K08510',
                    summary: '0.85mm超小直径，高清成像，适用于极小空间检测',
                    primary_category: '电子内窥镜',
                    secondary_category: '工业视频内窥镜',
                    supplier: '深圳市微视光电科技有限公司',
                    series: 'K系列',
                    status: 'published',
                    date: '2025-01-01'
                }
            ];

            projectData.suppliers = [
                {
                    id: 'supplier-1',
                    name: '深圳市微视光电科技有限公司',
                    type: '制造商',
                    products: 1,
                    status: 'active',
                    date: '2025-01-01'
                }
            ];

            updateDashboard();
            updateProductList();
            initializeProductFilters();
        }

        // 筛选功能占位符
        function filterSuppliers() {
            applySupplierFilters();
            renderSupplierList();
        }
        function clearSupplierFilters() {
            filteredSuppliers = [...projectData.suppliers];
            currentSupplierPage = 1;
            renderSupplierList();
        }
        function initializeSupplierFilters() {
            console.log('初始化供应商筛选选项');
        }
        function addSupplier() { alert('供应商添加功能开发中...'); }
        function editSupplier(id) { alert('供应商编辑功能开发中...'); }
        function deleteSupplier(id) { alert('供应商删除功能开发中...'); }

        function filterNews() {
            applyNewsFilters();
            renderNewsList();
        }
        function clearNewsFilters() {
            filteredNews = [...projectData.news];
            currentNewsPage = 1;
            renderNewsList();
        }
        function initializeNewsFilters() {
            console.log('初始化资讯筛选选项');
        }
        function addNews() { alert('资讯添加功能开发中...'); }
        function editNews(id) { alert('资讯编辑功能开发中...'); }
        function deleteNews(id) { alert('资讯删除功能开发中...'); }

        function filterCases() {
            applyCaseFilters();
            renderCaseList();
        }
        function clearCaseFilters() {
            filteredCases = [...projectData.cases];
            currentCasePage = 1;
            renderCaseList();
        }
        function initializeCaseFilters() {
            console.log('初始化案例筛选选项');
        }
        function addCase() { alert('案例添加功能开发中...'); }
        function editCase(id) { alert('案例编辑功能开发中...'); }
        function deleteCase(id) { alert('案例删除功能开发中...'); }

        function filterApplications() {
            applyApplicationFilters();
            renderApplicationList();
        }
        function clearApplicationFilters() {
            filteredApplications = [...projectData.applications];
            currentApplicationPage = 1;
            renderApplicationList();
        }
        function addApplication() { alert('应用领域添加功能开发中...'); }
        function editApplication(id) { alert('应用领域编辑功能开发中...'); }
        function deleteApplication(id) { alert('应用领域删除功能开发中...'); }

        function filterCategories() {
            applyCategoryFilters();
            renderCategoryList();
        }
        function clearCategoryFilters() {
            filteredCategories = [...projectData.categories];
            currentCategoryPage = 1;
            renderCategoryList();
        }
        function addCategory() {
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            document.getElementById('categoryModalTitle').textContent = '添加分类';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';

            // 填充父分类选项
            const parentSelect = document.getElementById('categoryParent');
            parentSelect.innerHTML = '<option value="">选择父分类（可选）</option>';

            const mainCategories = projectData.categories.filter(cat => cat.level === '主分类');
            mainCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                parentSelect.appendChild(option);
            });

            modal.show();
        }

        function editCategory(id) {
            const category = projectData.categories.find(cat => cat.id === id);
            if (!category) return;

            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            document.getElementById('categoryModalTitle').textContent = '编辑分类';
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('categoryIcon').value = category.icon || '';
            document.getElementById('categoryStatus').value = category.status;

            // 填充父分类选项
            const parentSelect = document.getElementById('categoryParent');
            parentSelect.innerHTML = '<option value="">选择父分类（可选）</option>';

            const mainCategories = projectData.categories.filter(cat => cat.level === '主分类' && cat.id !== id);
            mainCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                if (cat.id === category.parent_id) option.selected = true;
                parentSelect.appendChild(option);
            });

            modal.show();
        }

        function deleteCategory(id) {
            const category = projectData.categories.find(cat => cat.id === id);
            if (!category) return;

            // 检查是否有子分类
            const hasChildren = projectData.categories.some(cat => cat.parent_id === id);
            if (hasChildren) {
                alert('该分类下还有子分类，请先删除子分类！');
                return;
            }

            // 检查是否有关联产品
            if (category.product_count > 0) {
                if (!confirm(`该分类下有 ${category.product_count} 个产品，删除后这些产品的分类信息将被清空。确定要删除吗？`)) {
                    return;
                }
            }

            if (confirm(`确定要删除分类"${category.name}"吗？`)) {
                projectData.categories = projectData.categories.filter(cat => cat.id !== id);
                updateCategoryList();
                showToast('分类删除成功', 'success');
            }
        }

        // 强制更新所有列表（调试用）
        function forceUpdateAllLists() {
            console.log('🔄 强制更新所有列表...');

            // 确保数据存在
            if (!projectData.products) projectData.products = [];
            if (!projectData.suppliers) projectData.suppliers = [];
            if (!projectData.news) projectData.news = [];
            if (!projectData.cases) projectData.cases = [];
            if (!projectData.applications) projectData.applications = [];
            if (!projectData.categories) projectData.categories = [];

            // 强制更新所有列表
            try {
                updateProductList();
                console.log('✅ 产品列表更新完成');
            } catch (e) { console.error('❌ 产品列表更新失败:', e); }

            try {
                updateSupplierList();
                console.log('✅ 供应商列表更新完成');
            } catch (e) { console.error('❌ 供应商列表更新失败:', e); }

            try {
                updateNewsList();
                console.log('✅ 资讯列表更新完成');
            } catch (e) { console.error('❌ 资讯列表更新失败:', e); }

            try {
                updateCaseList();
                console.log('✅ 案例列表更新完成');
            } catch (e) { console.error('❌ 案例列表更新失败:', e); }

            try {
                updateApplicationList();
                console.log('✅ 应用领域列表更新完成');
            } catch (e) { console.error('❌ 应用领域列表更新失败:', e); }

            try {
                updateCategoryList();
                console.log('✅ 分类列表更新完成');
            } catch (e) { console.error('❌ 分类列表更新失败:', e); }

            console.log('🎉 所有列表强制更新完成');
        }

        // 调试产品数据
        function debugProductData() {
            console.log('🔍 产品数据调试信息:');
            console.log('projectData.products:', projectData.products);
            console.log('filteredProducts:', filteredProducts);
            console.log('currentProductPage:', currentProductPage);
            console.log('itemsPerPage:', itemsPerPage);

            if (projectData.products && projectData.products.length > 0) {
                console.log('✅ 产品数据存在:', projectData.products.length, '个产品');
                projectData.products.slice(0, 3).forEach((product, index) => {
                    console.log(`  ${index + 1}. ${product.title} (${product.model}) - ${product.supplier}`);
                });
            } else {
                console.log('❌ 产品数据为空或未定义');
            }

            // 检查DOM元素
            const tbody = document.getElementById('productList');
            console.log('productList元素:', tbody);
            if (tbody) {
                console.log('当前内容长度:', tbody.innerHTML.length);
                console.log('当前内容预览:', tbody.innerHTML.substring(0, 200));
            }

            // 强制更新产品列表
            console.log('🔄 强制更新产品列表...');
            updateProductList();
        }

        // 分类搜索历史管理
        let categorySearchHistory = JSON.parse(localStorage.getItem('categorySearchHistory') || '[]');

        // 分类层级数据（参考首页分类结构）
        // 实际项目分类层级（根据用户提供的正确结构）
        const categoryHierarchyData = [
            {
                id: "electronic-endoscope",
                title: "电子内窥镜",
                icon: "fas fa-video",
                subcategories: [
                    { title: "工业视频内窥镜", icon: "fas fa-camera" },
                    { title: "工业管道内窥镜", icon: "fas fa-pipe-section" },
                    { title: "爬行机器人", icon: "fas fa-robot" }
                ]
            },
            {
                id: "fiber-endoscope",
                title: "光纤内窥镜",
                icon: "fas fa-fiber-optic",
                subcategories: [
                    { title: "柔性光纤内窥镜", icon: "fas fa-wave-square" },
                    { title: "硬性光纤内窥镜", icon: "fas fa-minus" }
                ]
            },
            {
                id: "optical-endoscope",
                title: "光学内窥镜",
                icon: "fas fa-eye",
                subcategories: [
                    { title: "硬性光学内窥镜", icon: "fas fa-binoculars" },
                    { title: "柔性光学内窥镜", icon: "fas fa-eye-dropper" }
                ]
            }
        ];

        // 切换分类层级面板
        function toggleCategoryPanel() {
            const panel = document.getElementById('categoryHierarchyPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                renderCategoryHierarchy();
                renderCategorySearchHistory();
            } else {
                panel.style.display = 'none';
            }
        }

        // 渲染分类层级树
        function renderCategoryHierarchy() {
            const container = document.getElementById('categoryHierarchyTree');
            let html = '';

            categoryHierarchyData.forEach(primary => {
                const primaryCount = getProductCountByCategory(primary.title);

                html += `
                    <div class="category-tree-item primary" onclick="selectCategory('${primary.title}')">
                        <div class="category-icon">
                            <i class="${primary.icon}"></i>
                        </div>
                        <span>${primary.title}</span>
                        <span class="product-count">${primaryCount}</span>
                    </div>
                `;

                if (primary.subcategories) {
                    primary.subcategories.forEach(sub => {
                        const subCount = getProductCountByCategory(sub.title);
                        html += `
                            <div class="category-tree-item secondary" onclick="selectCategory('${sub.title}')">
                                <div class="category-icon">
                                    <i class="${sub.icon}"></i>
                                </div>
                                <span>${sub.title}</span>
                                <span class="product-count">${subCount}</span>
                            </div>
                        `;
                    });
                }
            });

            container.innerHTML = html;
        }

        // 获取分类下的产品数量
        function getProductCountByCategory(category) {
            if (!projectData.products) return 0;
            return projectData.products.filter(product =>
                product.primary_category === category ||
                product.secondary_category === category
            ).length;
        }

        // 选择分类
        function selectCategory(category) {
            // 添加到搜索历史
            addToCategoryHistory(category);

            // 设置筛选器
            document.getElementById('categoryFilter').value = category;

            // 执行筛选
            filterProducts();

            // 关闭面板
            toggleCategoryPanel();
        }

        // 添加到分类搜索历史
        function addToCategoryHistory(category) {
            // 移除重复项
            categorySearchHistory = categorySearchHistory.filter(item => item !== category);

            // 添加到开头
            categorySearchHistory.unshift(category);

            // 限制历史记录数量
            if (categorySearchHistory.length > 10) {
                categorySearchHistory = categorySearchHistory.slice(0, 10);
            }

            // 保存到localStorage
            localStorage.setItem('categorySearchHistory', JSON.stringify(categorySearchHistory));

            // 重新渲染历史记录
            renderCategorySearchHistory();
        }

        // 渲染分类搜索历史
        function renderCategorySearchHistory() {
            const container = document.getElementById('categorySearchHistory');

            if (categorySearchHistory.length === 0) {
                container.className = 'category-search-history empty';
                container.innerHTML = '';
                return;
            }

            container.className = 'category-search-history';
            let html = '';

            categorySearchHistory.forEach(category => {
                html += `
                    <div class="history-item" onclick="selectCategory('${category}')">
                        ${category}
                        <span class="remove-history" onclick="event.stopPropagation(); removeFromHistory('${category}')">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 从历史记录中移除
        function removeFromHistory(category) {
            categorySearchHistory = categorySearchHistory.filter(item => item !== category);
            localStorage.setItem('categorySearchHistory', JSON.stringify(categorySearchHistory));
            renderCategorySearchHistory();
        }

        // 清除分类搜索历史
        function clearCategoryHistory() {
            categorySearchHistory = [];
            localStorage.removeItem('categorySearchHistory');
            renderCategorySearchHistory();
        }

        // 显示分类层级（当点击分类筛选器时）
        function showCategoryHierarchy() {
            // 可以在这里添加额外的逻辑
        }

        // 显示 Toast 消息
        function showToast(message, type = 'info') {
            // 创建 toast 容器（如果不存在）
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            // 创建 toast 元素
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'exclamation-circle text-danger' : 'info-circle text-info'} me-2"></i>
                        <strong class="me-auto">系统消息</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            // 显示 toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();

            // 自动清理
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // 保存分类表单
        function saveCategoryForm() {
            const form = document.getElementById('categoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const categoryId = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();
            const parentId = document.getElementById('categoryParent').value;
            const icon = document.getElementById('categoryIcon').value.trim() || 'fas fa-tag';
            const status = document.getElementById('categoryStatus').value;

            // 检查名称是否重复
            const existingCategory = projectData.categories.find(cat =>
                cat.name === name && cat.id !== categoryId
            );
            if (existingCategory) {
                alert('分类名称已存在，请使用其他名称！');
                return;
            }

            const now = new Date().toISOString().split('T')[0];

            if (categoryId) {
                // 编辑现有分类
                const categoryIndex = projectData.categories.findIndex(cat => cat.id === categoryId);
                if (categoryIndex !== -1) {
                    const category = projectData.categories[categoryIndex];
                    category.name = name;
                    category.description = description;
                    category.parent_id = parentId || null;
                    category.icon = icon;
                    category.status = status;

                    // 更新层级信息
                    if (parentId) {
                        const parent = projectData.categories.find(cat => cat.id === parentId);
                        category.level = '子分类';
                        category.parent_name = parent ? parent.name : '';
                    } else {
                        category.level = '主分类';
                        category.parent_name = '';
                    }

                    showToast('分类更新成功', 'success');
                }
            } else {
                // 添加新分类
                const newId = `custom-${Date.now()}`;
                const level = parentId ? '子分类' : '主分类';
                const parent = parentId ? projectData.categories.find(cat => cat.id === parentId) : null;

                const newCategory = {
                    id: newId,
                    name: name,
                    description: description,
                    level: level,
                    parent_id: parentId || null,
                    parent_name: parent ? parent.name : '',
                    icon: icon,
                    product_count: 0,
                    status: status,
                    date: now,
                    sort_order: projectData.categories.length + 1
                };

                projectData.categories.push(newCategory);
                showToast('分类添加成功', 'success');
            }

            // 关闭模态框并更新列表
            const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
            modal.hide();
            updateCategoryList();
        }

        // 添加所有函数到全局作用域
        // 基础功能
        window.showSection = showSection;
        window.toggleSidebar = toggleSidebar;
        window.closeSidebar = closeSidebar;
        window.loadProjectData = loadProjectData;
        window.forceUpdateAllLists = forceUpdateAllLists;
        window.debugProductData = debugProductData;

        // 产品管理
        window.addProduct = addProduct;
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.saveProduct = saveProduct;
        window.testProductForm = testProductForm;
        window.testAllFunctions = testAllFunctions;
        window.testCategoryData = testCategoryData;
        window.debugCategoryDisplay = debugCategoryDisplay;
        window.autoAddFiberEndoscope = autoAddFiberEndoscope;
        window.quickTestProduct = quickTestProduct;
        window.debugSaveProduct = debugSaveProduct;
        window.forceReloadProducts = forceReloadProducts;
        window.updateSearchIndex = updateSearchIndex;
        window.debugManualSave = debugManualSave;
        window.testSimpleSave = testSimpleSave;
        window.fixDisplayIssues = fixDisplayIssues;
        window.fixImageIssues = fixImageIssues;
        window.cleanupProductEditors = cleanupProductEditors;
        window.generateCategoryHierarchyFromProducts = generateCategoryHierarchyFromProducts;
        window.createProductEditors = createProductEditors;
        window.uploadBase64Image = uploadBase64Image;
        window.uploadBlobImage = uploadBlobImage;

        // 供应商管理
        window.addSupplier = addSupplier;
        window.editSupplier = editSupplier;
        window.deleteSupplier = deleteSupplier;
        window.saveSupplier = saveSupplier;

        // 新闻管理
        window.addNews = addNews;
        window.editNews = editNews;
        window.deleteNews = deleteNews;
        window.saveNews = saveNews;

        // 案例管理
        window.addCase = addCase;
        window.editCase = editCase;
        window.deleteCase = deleteCase;
        window.saveCase = saveCase;

        // 应用领域管理
        window.addApplication = addApplication;
        window.editApplication = editApplication;
        window.deleteApplication = deleteApplication;
        window.saveApplication = saveApplication;

        // 分类管理
        window.toggleCategoryPanel = toggleCategoryPanel;
        window.selectCategory = selectCategory;
        window.clearCategoryHistory = clearCategoryHistory;
        window.showCategoryHierarchy = showCategoryHierarchy;
        window.saveCategoryForm = saveCategoryForm;

        // 媒体库管理功能实现

        // 媒体库数据
        let mediaLibraryData = [];

        // 上传文件到媒体库
        async function uploadToMediaLibrary(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;

            if (type === 'image') {
                input.accept = 'image/*';
            } else {
                input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z';
            }

            input.onchange = async function(e) {
                const files = Array.from(e.target.files);
                const supplier = document.getElementById('mediaSupplierFilter').value || 'default';

                console.log(`📤 上传 ${files.length} 个${type === 'image' ? '图片' : '文件'}到媒体库...`);
                showSyncStatus(`正在上传 ${files.length} 个文件...`, 1000);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    try {
                        const formData = new FormData();
                        formData.append(type === 'image' ? 'image' : 'file', file);
                        formData.append('uploadType', 'media');
                        formData.append('supplier', supplier);

                        const apiUrl = type === 'image' ?
                            'http://localhost:3002/api/upload/image' :
                            'http://localhost:3002/api/upload/file';

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            console.log(`✅ 文件 ${i + 1} 上传成功: ${result.path}`);
                        } else {
                            console.error(`❌ 文件 ${i + 1} 上传失败:`, result.message);
                        }
                    } catch (error) {
                        console.error(`❌ 文件 ${i + 1} 上传失败:`, error);
                    }
                }

                showSyncStatus(`✅ ${files.length} 个文件上传完成`, 2000);
                refreshMediaLibrary();
            };

            input.click();
        }

        // 刷新媒体库
        async function refreshMediaLibrary() {
            try {
                console.log('🔄 刷新媒体库...');
                const response = await fetch('http://localhost:3002/api/media/list');
                const result = await response.json();

                if (result.success) {
                    mediaLibraryData = result.media;
                    renderMediaLibrary();
                    updateSupplierFilter();
                    console.log(`✅ 媒体库加载完成，共 ${mediaLibraryData.length} 个文件`);
                } else {
                    console.error('❌ 加载媒体库失败:', result.message);
                }
            } catch (error) {
                console.error('❌ 连接媒体库服务器失败:', error);
                // 显示空状态
                document.getElementById('mediaLibraryContainer').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        <p class="mt-2 text-muted">无法连接到媒体库服务器</p>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshMediaLibrary()">
                            <i class="fas fa-retry me-1"></i>重试
                        </button>
                    </div>
                `;
            }
        }

        // 更新供应商筛选器
        function updateSupplierFilter() {
            const supplierFilter = document.getElementById('mediaSupplierFilter');
            const suppliers = [...new Set(mediaLibraryData.map(item => item.supplier))];

            // 保存当前选择
            const currentValue = supplierFilter.value;

            // 清空并重新填充
            supplierFilter.innerHTML = '<option value="">所有供应商</option>';
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier;
                option.textContent = supplier;
                supplierFilter.appendChild(option);
            });

            // 恢复选择
            supplierFilter.value = currentValue;
        }

        // 渲染媒体库
        function renderMediaLibrary() {
            const container = document.getElementById('mediaLibraryContainer');

            if (mediaLibraryData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-folder-open fa-2x text-muted"></i>
                        <p class="mt-2 text-muted">媒体库为空，点击上方按钮上传文件</p>
                    </div>
                `;
                return;
            }

            // 按供应商分组
            const groupedData = {};
            mediaLibraryData.forEach(item => {
                if (!groupedData[item.supplier]) {
                    groupedData[item.supplier] = { images: [], files: [] };
                }
                if (item.type === 'image') {
                    groupedData[item.supplier].images.push(item);
                } else {
                    groupedData[item.supplier].files.push(item);
                }
            });

            let html = '';
            Object.keys(groupedData).forEach(supplier => {
                const data = groupedData[supplier];
                html += `
                    <div class="supplier-group mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-building me-2"></i>${supplier}
                            <span class="badge bg-secondary ms-2">${data.images.length + data.files.length} 个文件</span>
                        </h6>

                        ${data.images.length > 0 ? `
                            <div class="mb-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-images me-1"></i>图片 (${data.images.length})</h6>
                                <div class="row g-2">
                                    ${data.images.map(item => `
                                        <div class="col-md-2 col-sm-3 col-4">
                                            <div class="media-item">
                                                <img src="${item.path}" alt="${item.name}" class="img-thumbnail" style="height: 100px; object-fit: cover;">
                                                <div class="media-overlay">
                                                    <button class="btn btn-sm btn-primary" onclick="selectMediaFile('${item.path}', '${item.name}')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteMediaFile('${item.id}')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                <small class="text-muted d-block mt-1">${item.name}</small>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${data.files.length > 0 ? `
                            <div class="mb-3">
                                <h6 class="text-muted mb-2"><i class="fas fa-file me-1"></i>文件 (${data.files.length})</h6>
                                <div class="list-group">
                                    ${data.files.map(item => `
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file me-2"></i>
                                                <strong>${item.name}</strong>
                                                <small class="text-muted ms-2">${formatFileSize(item.size)}</small>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary" onclick="selectMediaFile('${item.path}', '${item.name}')">
                                                    <i class="fas fa-check me-1"></i>选择
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMediaFile('${item.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 筛选媒体库
        function filterMediaLibrary() {
            const searchTerm = document.getElementById('mediaSearch').value.toLowerCase();
            const supplierFilter = document.getElementById('mediaSupplierFilter').value;
            const typeFilter = document.getElementById('mediaTypeFilter').value;

            // 这里可以实现筛选逻辑
            // 暂时重新渲染所有数据
            renderMediaLibrary();
        }

        // 选择媒体文件
        function selectMediaFile(path, name) {
            console.log(`📁 选择媒体文件: ${name} (${path})`);
            // 这里可以实现选择文件的逻辑
            alert(`已选择文件: ${name}`);
        }

        // 删除媒体文件
        function deleteMediaFile(fileId) {
            if (confirm('确定要删除这个文件吗？')) {
                console.log(`🗑️ 删除媒体文件: ${fileId}`);
                // 这里可以实现删除文件的逻辑
                alert('删除功能开发中...');
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 媒体库管理
        window.uploadToMediaLibrary = uploadToMediaLibrary;
        window.refreshMediaLibrary = refreshMediaLibrary;
        window.filterMediaLibrary = filterMediaLibrary;
        window.selectMediaFile = selectMediaFile;
        window.deleteMediaFile = deleteMediaFile;

        // 产品表单相关
        window.loadParameterTemplate = loadParameterTemplate;
        window.addParameter = addParameter;
        window.removeParameter = removeParameter;
        window.uploadProductImage = uploadProductImage;
        window.uploadProductFile = uploadProductFile;
        window.addRelatedProduct = addRelatedProduct;
        window.removeRelatedProduct = removeRelatedProduct;
        window.setMainImage = setMainImage;
        window.removeGalleryImage = removeGalleryImage;
        window.removeDownloadFile = removeDownloadFile;

        // 筛选和搜索
        window.filterProducts = filterProducts;
        window.clearProductFilters = clearProductFilters;
        window.clearSupplierFilters = clearSupplierFilters;
        window.clearCategoryFilters = clearCategoryFilters;
        window.clearNewsFilters = clearNewsFilters;
        window.clearCaseFilters = clearCaseFilters;
        window.clearApplicationFilters = clearApplicationFilters;

        // 分页功能
        window.changeProductPage = changeProductPage;
        window.changeSupplierPage = changeSupplierPage;
        window.changeNewsPage = changeNewsPage;
        window.changeCasePage = changeCasePage;
        window.changeApplicationPage = changeApplicationPage;

        // 分类管理
        window.addCategory = addCategory;
        window.editCategory = editCategory;
        window.deleteCategory = deleteCategory;
        window.removeFromHistory = removeFromHistory;

        // 同步功能
        window.syncToFrontend = syncToFrontend;

        // 全局图片拦截器
        function setupImageInterceptor() {
            // 拦截所有图片加载错误
            document.addEventListener('error', function(e) {
                if (e.target.tagName === 'IMG') {
                    handleImageError(e.target);
                }
            }, true);

            // 监听DOM变化，为新添加的图片设置拦截器
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            // 检查新添加的图片
                            const images = node.tagName === 'IMG' ? [node] : node.querySelectorAll('img');
                            images.forEach(function(img) {
                                // 如果是产品图片路径，尝试从localStorage加载
                                if (img.src && img.src.includes('/static/images/products/')) {
                                    const displayUrl = getImageDisplayUrl(img.src);
                                    if (displayUrl !== img.src) {
                                        img.src = displayUrl;
                                    }
                                }
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            console.log('🖼️ 图片拦截器已设置');
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 VisNDT 内容管理中心开始初始化...');

            // 设置图片拦截器
            setupImageInterceptor();

            // 初始化媒体库
            if (document.getElementById('media')) {
                console.log('📁 初始化媒体库...');
                refreshMediaLibrary();
            }

            console.log('🔍 JavaScript 基础功能测试:');
            console.log('  - showSection 函数:', typeof showSection);
            console.log('  - addProduct 函数:', typeof addProduct);
            console.log('  - loadProjectData 函数:', typeof loadProjectData);
            console.log('  - refreshMediaLibrary 函数:', typeof refreshMediaLibrary);
            console.log('✅ VisNDT 内容管理中心初始化完成');
            console.log('功能特色：');
            console.log('- 基于MD文件的内容管理');
            console.log('- 完整的CRUD操作支持');
            console.log('- 实时数据同步机制');
            console.log('- 图片自动处理和路径转换');
            console.log('- 富文本编辑器集成');
            console.log('- 媒体库管理');
            console.log('- 所有数据来自项目实际内容');

            // 加载项目数据
            loadProjectData().then((success) => {
                // 数据加载完成后，立即更新当前显示的列表
                setTimeout(() => {
                    console.log('📊 数据加载完成，开始更新列表...');

                    // 确保产品列表正确初始化
                    if (currentSection === 'products') {
                        console.log('🔄 当前在产品页面，强制更新产品列表...');
                        updateProductList();
                    } else {
                        updateCurrentSectionList();
                    }

                    // 如果当前列表更新失败，强制更新所有列表
                    setTimeout(() => {
                        forceUpdateAllLists();
                    }, 500);
                }, 200);
            }).catch((error) => {
                console.error('❌ 数据加载失败:', error);
                // 即使数据加载失败，也尝试更新列表（使用默认数据）
                setTimeout(() => {
                    forceUpdateAllLists();
                }, 1000);
            });

            // 监听窗口大小变化
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    closeSidebar();
                }
            });

            // 监听产品模态框关闭事件
            const productModal = document.getElementById('productModal');
            if (productModal) {
                productModal.addEventListener('hidden.bs.modal', function() {
                    console.log('🔄 产品模态框已关闭，清理编辑器...');
                    cleanupProductEditors();
                });
            }
        });
    </script>

    <!-- 分类编辑模态框 -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">添加分类</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">

                        <div class="mb-3">
                            <label for="categoryName" class="form-label">分类名称 *</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>

                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">分类描述</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="categoryParent" class="form-label">父分类</label>
                            <select class="form-select" id="categoryParent">
                                <option value="">选择父分类（可选）</option>
                            </select>
                            <div class="form-text">选择父分类后，此分类将成为子分类</div>
                        </div>

                        <div class="mb-3">
                            <label for="categoryIcon" class="form-label">图标类名</label>
                            <input type="text" class="form-control" id="categoryIcon" placeholder="例如: fas fa-tag">
                            <div class="form-text">使用 FontAwesome 图标类名</div>
                        </div>

                        <div class="mb-3">
                            <label for="categoryStatus" class="form-label">状态</label>
                            <select class="form-select" id="categoryStatus">
                                <option value="active">启用</option>
                                <option value="inactive">禁用</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategoryForm()">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
