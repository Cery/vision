<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisNDT 编码验证工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .validator-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .code-display {
            background-color: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-check-circle text-primary"></i>
                    VisNDT 编码验证工具
                </h1>
                
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> 工具说明</h5>
                    <p>此工具用于验证项目中所有组件的文字编码一致性，确保中文字符在各个环节正确处理。</p>
                </div>
            </div>
        </div>

        <!-- 系统编码检查 -->
        <div class="validator-section">
            <h3><i class="fas fa-cogs"></i> 系统编码检查</h3>
            <div id="system-encoding-results"></div>
            <button class="btn btn-primary" onclick="checkSystemEncoding()">
                <i class="fas fa-play"></i> 开始检查
            </button>
        </div>

        <!-- 文件编码验证 -->
        <div class="validator-section">
            <h3><i class="fas fa-file-alt"></i> 文件编码验证</h3>
            <div class="mb-3">
                <label for="file-input" class="form-label">选择文件进行编码检查：</label>
                <input type="file" class="form-control" id="file-input" multiple 
                       accept=".html,.js,.css,.md,.json,.txt">
            </div>
            <div id="file-encoding-results"></div>
            <button class="btn btn-success" onclick="validateFileEncoding()">
                <i class="fas fa-search"></i> 验证文件编码
            </button>
        </div>

        <!-- 字符串编码测试 -->
        <div class="validator-section">
            <h3><i class="fas fa-keyboard"></i> 字符串编码测试</h3>
            <div class="mb-3">
                <label for="test-string" class="form-label">输入测试字符串：</label>
                <textarea class="form-control" id="test-string" rows="3" 
                          placeholder="请输入包含中文的测试字符串...">维森视觉检测仪器 - 专业的工业内窥镜解决方案</textarea>
            </div>
            <div id="string-encoding-results"></div>
            <button class="btn btn-info" onclick="testStringEncoding()">
                <i class="fas fa-test-tube"></i> 测试字符串编码
            </button>
        </div>

        <!-- URL编码测试 -->
        <div class="validator-section">
            <h3><i class="fas fa-link"></i> URL编码测试</h3>
            <div class="mb-3">
                <label for="test-url" class="form-label">输入测试URL：</label>
                <input type="text" class="form-control" id="test-url" 
                       placeholder="https://visndt.com/products/工业内窥镜">
            </div>
            <div id="url-encoding-results"></div>
            <button class="btn btn-warning" onclick="testUrlEncoding()">
                <i class="fas fa-globe"></i> 测试URL编码
            </button>
        </div>

        <!-- 浏览器兼容性检查 -->
        <div class="validator-section">
            <h3><i class="fas fa-browser"></i> 浏览器兼容性检查</h3>
            <div id="browser-compatibility-results"></div>
            <button class="btn btn-secondary" onclick="checkBrowserCompatibility()">
                <i class="fas fa-desktop"></i> 检查浏览器兼容性
            </button>
        </div>

        <!-- 综合报告 -->
        <div class="validator-section">
            <h3><i class="fas fa-chart-bar"></i> 综合验证报告</h3>
            <div id="comprehensive-report"></div>
            <button class="btn btn-danger" onclick="generateComprehensiveReport()">
                <i class="fas fa-file-pdf"></i> 生成综合报告
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 编码验证工具类
        class EncodingValidator {
            constructor() {
                this.testResults = [];
            }

            // 检查系统编码环境
            checkSystemEncoding() {
                const results = [];
                
                // 检查文档编码
                const docCharset = document.characterSet || document.charset;
                results.push({
                    test: '文档字符集',
                    result: docCharset,
                    status: docCharset.toLowerCase() === 'utf-8' ? 'pass' : 'fail'
                });

                // 检查语言设置
                const docLang = document.documentElement.lang;
                results.push({
                    test: '文档语言',
                    result: docLang,
                    status: docLang === 'zh-CN' ? 'pass' : 'warning'
                });

                // 检查浏览器语言
                const browserLang = navigator.language;
                results.push({
                    test: '浏览器语言',
                    result: browserLang,
                    status: browserLang.includes('zh') ? 'pass' : 'warning'
                });

                // 检查时区
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                results.push({
                    test: '时区设置',
                    result: timezone,
                    status: timezone.includes('Asia') ? 'pass' : 'warning'
                });

                return results;
            }

            // 验证字符串编码
            validateStringEncoding(str) {
                const results = [];

                try {
                    // 检查字符串长度
                    results.push({
                        test: '字符串长度',
                        result: `${str.length} 字符`,
                        status: 'pass'
                    });

                    // 检查字节长度
                    const byteLength = new Blob([str]).size;
                    results.push({
                        test: '字节长度',
                        result: `${byteLength} 字节`,
                        status: 'pass'
                    });

                    // 检查是否包含中文
                    const hasChinese = /[\u4e00-\u9fff]/.test(str);
                    results.push({
                        test: '包含中文字符',
                        result: hasChinese ? '是' : '否',
                        status: 'pass'
                    });

                    // 检查Unicode标准化
                    const normalized = str.normalize('NFC');
                    results.push({
                        test: 'Unicode标准化',
                        result: str === normalized ? '已标准化' : '需要标准化',
                        status: str === normalized ? 'pass' : 'warning'
                    });

                    // 检查URL编码
                    const encoded = encodeURIComponent(str);
                    const decoded = decodeURIComponent(encoded);
                    results.push({
                        test: 'URL编码往返',
                        result: str === decoded ? '正常' : '异常',
                        status: str === decoded ? 'pass' : 'fail'
                    });

                } catch (error) {
                    results.push({
                        test: '编码验证',
                        result: `错误: ${error.message}`,
                        status: 'fail'
                    });
                }

                return results;
            }

            // 验证文件编码
            async validateFileEncoding(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const results = [];

                        // 检查文件基本信息
                        results.push({
                            test: '文件名',
                            result: file.name,
                            status: 'pass'
                        });

                        results.push({
                            test: '文件大小',
                            result: `${(file.size / 1024).toFixed(2)} KB`,
                            status: 'pass'
                        });

                        // 检查内容编码
                        try {
                            const stringResults = this.validateStringEncoding(content);
                            results.push(...stringResults);
                        } catch (error) {
                            results.push({
                                test: '内容编码检查',
                                result: `错误: ${error.message}`,
                                status: 'fail'
                            });
                        }

                        resolve(results);
                    };
                    reader.onerror = () => {
                        resolve([{
                            test: '文件读取',
                            result: '读取失败',
                            status: 'fail'
                        }]);
                    };
                    reader.readAsText(file, 'UTF-8');
                });
            }

            // 检查浏览器兼容性
            checkBrowserCompatibility() {
                const results = [];

                // 检查TextEncoder支持
                const hasTextEncoder = typeof TextEncoder !== 'undefined';
                results.push({
                    test: 'TextEncoder支持',
                    result: hasTextEncoder ? '支持' : '不支持',
                    status: hasTextEncoder ? 'pass' : 'fail'
                });

                // 检查Intl支持
                const hasIntl = typeof Intl !== 'undefined';
                results.push({
                    test: 'Intl API支持',
                    result: hasIntl ? '支持' : '不支持',
                    status: hasIntl ? 'pass' : 'fail'
                });

                // 检查Normalize支持
                const hasNormalize = typeof String.prototype.normalize === 'function';
                results.push({
                    test: 'String.normalize支持',
                    result: hasNormalize ? '支持' : '不支持',
                    status: hasNormalize ? 'pass' : 'warning'
                });

                // 检查Fetch API支持
                const hasFetch = typeof fetch !== 'undefined';
                results.push({
                    test: 'Fetch API支持',
                    result: hasFetch ? '支持' : '不支持',
                    status: hasFetch ? 'pass' : 'warning'
                });

                return results;
            }

            // 渲染测试结果
            renderResults(results, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                let html = '';
                results.forEach(result => {
                    const statusClass = result.status === 'pass' ? 'test-pass' : 
                                       result.status === 'warning' ? 'test-warning' : 'test-fail';
                    const statusIcon = result.status === 'pass' ? 'fa-check-circle' : 
                                      result.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle';
                    
                    html += `
                        <div class="test-result ${statusClass}">
                            <i class="fas ${statusIcon}"></i>
                            <strong>${result.test}:</strong> ${result.result}
                        </div>
                    `;
                });

                container.innerHTML = html;
            }
        }

        // 创建验证器实例
        const validator = new EncodingValidator();

        // 系统编码检查
        function checkSystemEncoding() {
            const results = validator.checkSystemEncoding();
            validator.renderResults(results, 'system-encoding-results');
        }

        // 文件编码验证
        async function validateFileEncoding() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('请选择要验证的文件');
                return;
            }

            let allResults = [];
            for (let i = 0; i < files.length; i++) {
                const results = await validator.validateFileEncoding(files[i]);
                allResults.push(...results);
                if (i < files.length - 1) {
                    allResults.push({ test: '---', result: '---', status: 'pass' });
                }
            }

            validator.renderResults(allResults, 'file-encoding-results');
        }

        // 字符串编码测试
        function testStringEncoding() {
            const testString = document.getElementById('test-string').value;
            if (!testString.trim()) {
                alert('请输入测试字符串');
                return;
            }

            const results = validator.validateStringEncoding(testString);
            validator.renderResults(results, 'string-encoding-results');
        }

        // URL编码测试
        function testUrlEncoding() {
            const testUrl = document.getElementById('test-url').value;
            if (!testUrl.trim()) {
                alert('请输入测试URL');
                return;
            }

            const results = [];
            try {
                const encoded = encodeURIComponent(testUrl);
                const decoded = decodeURIComponent(encoded);
                
                results.push({
                    test: '原始URL',
                    result: testUrl,
                    status: 'pass'
                });

                results.push({
                    test: '编码后URL',
                    result: encoded,
                    status: 'pass'
                });

                results.push({
                    test: '解码后URL',
                    result: decoded,
                    status: testUrl === decoded ? 'pass' : 'fail'
                });

            } catch (error) {
                results.push({
                    test: 'URL编码测试',
                    result: `错误: ${error.message}`,
                    status: 'fail'
                });
            }

            validator.renderResults(results, 'url-encoding-results');
        }

        // 浏览器兼容性检查
        function checkBrowserCompatibility() {
            const results = validator.checkBrowserCompatibility();
            validator.renderResults(results, 'browser-compatibility-results');
        }

        // 生成综合报告
        function generateComprehensiveReport() {
            const report = {
                timestamp: new Date().toLocaleString('zh-CN'),
                system: validator.checkSystemEncoding(),
                browser: validator.checkBrowserCompatibility(),
                summary: {
                    totalTests: 0,
                    passedTests: 0,
                    warningTests: 0,
                    failedTests: 0
                }
            };

            // 统计测试结果
            [...report.system, ...report.browser].forEach(result => {
                report.summary.totalTests++;
                if (result.status === 'pass') report.summary.passedTests++;
                else if (result.status === 'warning') report.summary.warningTests++;
                else report.summary.failedTests++;
            });

            // 渲染报告
            const reportHtml = `
                <div class="alert alert-primary">
                    <h5>📊 验证报告摘要</h5>
                    <p><strong>生成时间:</strong> ${report.timestamp}</p>
                    <p><strong>总测试项:</strong> ${report.summary.totalTests}</p>
                    <p><strong>通过:</strong> <span class="text-success">${report.summary.passedTests}</span></p>
                    <p><strong>警告:</strong> <span class="text-warning">${report.summary.warningTests}</span></p>
                    <p><strong>失败:</strong> <span class="text-danger">${report.summary.failedTests}</span></p>
                </div>
                <div class="code-display">
                    ${JSON.stringify(report, null, 2)}
                </div>
            `;

            document.getElementById('comprehensive-report').innerHTML = reportHtml;
        }

        // 页面加载时自动运行基础检查
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemEncoding();
            checkBrowserCompatibility();
        });
    </script>
</body>
</html>
