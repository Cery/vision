<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»ç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .category-tree {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .category-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .category-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .category-item.parent {
            border-left-color: #28a745;
            background: #f0f8f0;
        }
        .category-item.child {
            margin-left: 30px;
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .category-header {
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .category-info {
            flex: 1;
        }
        .category-actions {
            display: flex;
            gap: 5px;
        }
        .category-form {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-section {
            margin-bottom: 20px;
        }
        .section-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .icon-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        .icon-option {
            width: 40px;
            height: 40px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .icon-option:hover, .icon-option.selected {
            border-color: #007bff;
            background: #e3f2fd;
            color: #007bff;
        }
        .category-preview {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-sitemap me-2"></i>åˆ†ç±»ç®¡ç†ç³»ç»Ÿ</h1>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="showAddCategoryForm()">
                            <i class="fas fa-plus me-1"></i>æ·»åŠ åˆ†ç±»
                        </button>
                        <button class="btn btn-primary" onclick="syncCategories()">
                            <i class="fas fa-sync me-1"></i>åŒæ­¥åˆ†ç±»
                        </button>
                        <button class="btn btn-info" onclick="exportCategories()">
                            <i class="fas fa-download me-1"></i>å¯¼å‡ºé…ç½®
                        </button>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-card">
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="h4 mb-1" id="totalCategories">0</div>
                            <div class="small">æ€»åˆ†ç±»æ•°</div>
                        </div>
                        <div class="col-3">
                            <div class="h4 mb-1" id="parentCategories">0</div>
                            <div class="small">ä¸»åˆ†ç±»</div>
                        </div>
                        <div class="col-3">
                            <div class="h4 mb-1" id="childCategories">0</div>
                            <div class="small">å­åˆ†ç±»</div>
                        </div>
                        <div class="col-3">
                            <div class="h4 mb-1" id="totalProducts">0</div>
                            <div class="small">å…³è”äº§å“</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- åˆ†ç±»è¡¨å• -->
                    <div class="col-md-5">
                        <div class="category-form" id="categoryForm">
                            <h3 class="section-title">åˆ†ç±»ä¿¡æ¯</h3>
                            
                            <div class="form-section">
                                <label class="form-label">åˆ†ç±»åç§° *</label>
                                <input type="text" class="form-control" id="categoryTitle" placeholder="è¾“å…¥åˆ†ç±»åç§°">
                            </div>

                            <div class="form-section">
                                <label class="form-label">åˆ†ç±»ç±»å‹</label>
                                <select class="form-select" id="categoryType" onchange="updateParentOptions()">
                                    <option value="parent">ä¸»åˆ†ç±»</option>
                                    <option value="child">å­åˆ†ç±»</option>
                                </select>
                            </div>

                            <div class="form-section" id="parentCategorySection" style="display: none;">
                                <label class="form-label">çˆ¶åˆ†ç±»</label>
                                <select class="form-select" id="parentCategory">
                                    <option value="">é€‰æ‹©çˆ¶åˆ†ç±»</option>
                                </select>
                            </div>

                            <div class="form-section">
                                <label class="form-label">åˆ†ç±»æè¿°</label>
                                <textarea class="form-control" id="categoryDescription" rows="3" placeholder="æè¿°åˆ†ç±»çš„ç”¨é€”å’Œç‰¹ç‚¹"></textarea>
                            </div>

                            <div class="form-section">
                                <label class="form-label">åˆ†ç±»å›¾æ ‡</label>
                                <input type="text" class="form-control mb-2" id="categoryIcon" placeholder="å¦‚ï¼šfas fa-video" readonly>
                                <div class="icon-picker" id="iconPicker">
                                    <!-- å›¾æ ‡é€‰æ‹©å™¨ -->
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-section">
                                        <label class="form-label">æ’åºæƒé‡</label>
                                        <input type="number" class="form-control" id="categoryWeight" value="100" min="1" max="999">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-section">
                                        <label class="form-label">çŠ¶æ€</label>
                                        <select class="form-select" id="categoryStatus">
                                            <option value="active">å¯ç”¨</option>
                                            <option value="inactive">ç¦ç”¨</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showInHome" checked>
                                    <label class="form-check-label" for="showInHome">
                                        åœ¨é¦–é¡µæ˜¾ç¤º
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showInMenu" checked>
                                    <label class="form-check-label" for="showInMenu">
                                        åœ¨èœå•æ˜¾ç¤º
                                    </label>
                                </div>
                            </div>

                            <!-- SEOè®¾ç½® -->
                            <div class="form-section">
                                <h6 class="text-muted">SEOè®¾ç½®</h6>
                                <div class="mb-2">
                                    <label class="form-label">SEOæ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="seoTitle" placeholder="æœç´¢å¼•æ“æ˜¾ç¤ºçš„æ ‡é¢˜">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">SEOæè¿°</label>
                                    <textarea class="form-control" id="seoDescription" rows="2" placeholder="æœç´¢å¼•æ“æ˜¾ç¤ºçš„æè¿°"></textarea>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">å…³é”®è¯</label>
                                    <input type="text" class="form-control" id="seoKeywords" placeholder="ç”¨é€—å·åˆ†éš”å…³é”®è¯">
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="saveCategory()">
                                    <i class="fas fa-save me-1"></i>ä¿å­˜åˆ†ç±»
                                </button>
                                <button class="btn btn-secondary" onclick="clearForm()">
                                    <i class="fas fa-times me-1"></i>æ¸…ç©ºè¡¨å•
                                </button>
                                <button class="btn btn-info" onclick="previewCategory()">
                                    <i class="fas fa-eye me-1"></i>é¢„è§ˆ
                                </button>
                            </div>

                            <!-- é¢„è§ˆåŒºåŸŸ -->
                            <div class="category-preview" id="categoryPreview" style="display: none;">
                                <h6>åˆ†ç±»é¢„è§ˆ</h6>
                                <div id="previewContent"></div>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†ç±»æ ‘ -->
                    <div class="col-md-7">
                        <div class="category-tree">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h3 class="section-title mb-0">åˆ†ç±»ç»“æ„</h3>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="expandAll()">
                                        <i class="fas fa-expand-arrows-alt me-1"></i>å±•å¼€å…¨éƒ¨
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="collapseAll()">
                                        <i class="fas fa-compress-arrows-alt me-1"></i>æ”¶èµ·å…¨éƒ¨
                                    </button>
                                </div>
                            </div>
                            
                            <div id="categoryTree">
                                <!-- åˆ†ç±»æ ‘å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let categories = [];
        let currentEditingId = null;
        let iconList = [
            'fas fa-video', 'fas fa-camera', 'fas fa-robot', 'fas fa-cog', 'fas fa-tools',
            'fas fa-microscope', 'fas fa-search', 'fas fa-eye', 'fas fa-lightbulb',
            'fas fa-bolt', 'fas fa-wifi', 'fas fa-bluetooth', 'fas fa-usb', 'fas fa-plug',
            'fas fa-battery-full', 'fas fa-memory', 'fas fa-microchip', 'fas fa-desktop',
            'fas fa-mobile-alt', 'fas fa-tablet-alt', 'fas fa-laptop', 'fas fa-server',
            'fas fa-database', 'fas fa-cloud', 'fas fa-shield-alt', 'fas fa-lock'
        ];

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeCategoryManager();
            loadCategories();
            initializeIconPicker();
        });

        // åˆå§‹åŒ–åˆ†ç±»ç®¡ç†å™¨
        function initializeCategoryManager() {
            console.log('ğŸš€ åˆ†ç±»ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–');
            updateStats();
        }

        // åˆå§‹åŒ–å›¾æ ‡é€‰æ‹©å™¨
        function initializeIconPicker() {
            const iconPicker = document.getElementById('iconPicker');
            iconPicker.innerHTML = iconList.map(icon => `
                <div class="icon-option" onclick="selectIcon('${icon}')" title="${icon}">
                    <i class="${icon}"></i>
                </div>
            `).join('');
        }

        // é€‰æ‹©å›¾æ ‡
        function selectIcon(iconClass) {
            document.getElementById('categoryIcon').value = iconClass;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.icon-option').classList.add('selected');
        }

        // åŠ è½½åˆ†ç±»æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
        function loadCategories() {
            // æ¨¡æ‹Ÿåˆ†ç±»æ•°æ®
            categories = [
                {
                    id: 1,
                    title: 'ç”µå­å†…çª¥é•œ',
                    type: 'parent',
                    description: 'å„ç±»ç”µå­å†…çª¥é•œåŠç›¸å…³è®¾å¤‡',
                    icon: 'fas fa-video',
                    weight: 100,
                    status: 'active',
                    showInHome: true,
                    showInMenu: true,
                    productCount: 25,
                    children: [
                        {
                            id: 2,
                            title: 'å·¥ä¸šè§†é¢‘å†…çª¥é•œ',
                            type: 'child',
                            parentId: 1,
                            description: 'ç”¨äºå·¥ä¸šæ£€æµ‹çš„è§†é¢‘å†…çª¥é•œ',
                            icon: 'fas fa-camera',
                            weight: 110,
                            status: 'active',
                            productCount: 12
                        },
                        {
                            id: 3,
                            title: 'å·¥ä¸šç®¡é“å†…çª¥é•œ',
                            type: 'child',
                            parentId: 1,
                            description: 'ä¸“ç”¨äºç®¡é“æ£€æµ‹çš„å†…çª¥é•œ',
                            icon: 'fas fa-search',
                            weight: 120,
                            status: 'active',
                            productCount: 8
                        }
                    ]
                },
                {
                    id: 4,
                    title: 'å…‰çº¤å†…çª¥é•œ',
                    type: 'parent',
                    description: 'å…‰çº¤ä¼ è¾“çš„å†…çª¥é•œè®¾å¤‡',
                    icon: 'fas fa-lightbulb',
                    weight: 200,
                    status: 'active',
                    showInHome: true,
                    showInMenu: true,
                    productCount: 15,
                    children: [
                        {
                            id: 5,
                            title: 'åŒ»ç–—å…‰çº¤å†…çª¥é•œ',
                            type: 'child',
                            parentId: 4,
                            description: 'åŒ»ç–—çº§å…‰çº¤å†…çª¥é•œ',
                            icon: 'fas fa-microscope',
                            weight: 210,
                            status: 'active',
                            productCount: 10
                        }
                    ]
                }
            ];

            renderCategoryTree();
            updateStats();
            updateParentOptions();
        }

        // æ¸²æŸ“åˆ†ç±»æ ‘
        function renderCategoryTree() {
            const treeContainer = document.getElementById('categoryTree');

            if (categories.length === 0) {
                treeContainer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">æš‚æ— åˆ†ç±»</h5>
                        <p class="text-muted">ç‚¹å‡»"æ·»åŠ åˆ†ç±»"åˆ›å»ºç¬¬ä¸€ä¸ªåˆ†ç±»</p>
                    </div>
                `;
                return;
            }

            const parentCategories = categories.filter(cat => cat.type === 'parent');

            treeContainer.innerHTML = parentCategories.map(parent => {
                const children = categories.filter(cat => cat.type === 'child' && cat.parentId === parent.id);

                return `
                    <div class="category-item parent" data-category-id="${parent.id}">
                        <div class="category-header">
                            <div class="category-info">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${parent.icon} me-2"></i>
                                    <strong>${parent.title}</strong>
                                    <span class="badge bg-primary ms-2">${parent.productCount || 0}</span>
                                    <span class="badge bg-${parent.status === 'active' ? 'success' : 'secondary'} ms-1">
                                        ${parent.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                    </span>
                                </div>
                                <div class="text-muted small">${parent.description}</div>
                            </div>
                            <div class="category-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${parent.id})" title="ç¼–è¾‘">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="addChildCategory(${parent.id})" title="æ·»åŠ å­åˆ†ç±»">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${parent.id})" title="åˆ é™¤">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        ${children.length > 0 ? `
                            <div class="mt-3">
                                ${children.map(child => `
                                    <div class="category-item child" data-category-id="${child.id}">
                                        <div class="category-header">
                                            <div class="category-info">
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="${child.icon} me-2"></i>
                                                    ${child.title}
                                                    <span class="badge bg-info ms-2">${child.productCount || 0}</span>
                                                    <span class="badge bg-${child.status === 'active' ? 'success' : 'secondary'} ms-1">
                                                        ${child.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}
                                                    </span>
                                                </div>
                                                <div class="text-muted small">${child.description}</div>
                                            </div>
                                            <div class="category-actions">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${child.id})" title="ç¼–è¾‘">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${child.id})" title="åˆ é™¤">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalCategories = categories.length;
            const parentCategories = categories.filter(cat => cat.type === 'parent').length;
            const childCategories = categories.filter(cat => cat.type === 'child').length;
            const totalProducts = categories.reduce((sum, cat) => sum + (cat.productCount || 0), 0);

            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('parentCategories').textContent = parentCategories;
            document.getElementById('childCategories').textContent = childCategories;
            document.getElementById('totalProducts').textContent = totalProducts;
        }

        // æ›´æ–°çˆ¶åˆ†ç±»é€‰é¡¹
        function updateParentOptions() {
            const parentSelect = document.getElementById('parentCategory');
            const parentCategories = categories.filter(cat => cat.type === 'parent');

            parentSelect.innerHTML = '<option value="">é€‰æ‹©çˆ¶åˆ†ç±»</option>' +
                parentCategories.map(cat => `<option value="${cat.id}">${cat.title}</option>`).join('');
        }

        // æ›´æ–°åˆ†ç±»ç±»å‹é€‰æ‹©
        function updateParentOptions() {
            const categoryType = document.getElementById('categoryType').value;
            const parentSection = document.getElementById('parentCategorySection');

            if (categoryType === 'child') {
                parentSection.style.display = 'block';
                updateParentCategoryOptions();
            } else {
                parentSection.style.display = 'none';
            }
        }

        // æ›´æ–°çˆ¶åˆ†ç±»é€‰é¡¹
        function updateParentCategoryOptions() {
            const parentSelect = document.getElementById('parentCategory');
            const parentCategories = categories.filter(cat => cat.type === 'parent');

            parentSelect.innerHTML = '<option value="">é€‰æ‹©çˆ¶åˆ†ç±»</option>' +
                parentCategories.map(cat => `<option value="${cat.id}">${cat.title}</option>`).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ åˆ†ç±»è¡¨å•
        function showAddCategoryForm() {
            clearForm();
            currentEditingId = null;
            document.querySelector('.section-title').textContent = 'æ·»åŠ åˆ†ç±»';
        }

        // æ·»åŠ å­åˆ†ç±»
        function addChildCategory(parentId) {
            clearForm();
            currentEditingId = null;
            document.getElementById('categoryType').value = 'child';
            document.getElementById('parentCategory').value = parentId;
            updateParentOptions();
            document.querySelector('.section-title').textContent = 'æ·»åŠ å­åˆ†ç±»';
        }

        // ç¼–è¾‘åˆ†ç±»
        function editCategory(categoryId) {
            const category = findCategoryById(categoryId);
            if (!category) return;

            currentEditingId = categoryId;

            // å¡«å……è¡¨å•
            document.getElementById('categoryTitle').value = category.title;
            document.getElementById('categoryType').value = category.type;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('categoryIcon').value = category.icon || '';
            document.getElementById('categoryWeight').value = category.weight || 100;
            document.getElementById('categoryStatus').value = category.status || 'active';
            document.getElementById('showInHome').checked = category.showInHome !== false;
            document.getElementById('showInMenu').checked = category.showInMenu !== false;

            if (category.type === 'child' && category.parentId) {
                document.getElementById('parentCategory').value = category.parentId;
            }

            // å¡«å……SEOä¿¡æ¯
            document.getElementById('seoTitle').value = category.seoTitle || '';
            document.getElementById('seoDescription').value = category.seoDescription || '';
            document.getElementById('seoKeywords').value = category.seoKeywords || '';

            // æ›´æ–°å›¾æ ‡é€‰æ‹©
            if (category.icon) {
                document.querySelectorAll('.icon-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.querySelector('i').className === category.icon) {
                        option.classList.add('selected');
                    }
                });
            }

            updateParentOptions();
            document.querySelector('.section-title').textContent = 'ç¼–è¾‘åˆ†ç±»';
        }

        // æŸ¥æ‰¾åˆ†ç±»
        function findCategoryById(id) {
            return categories.find(cat => cat.id === id);
        }

        // ä¿å­˜åˆ†ç±»
        function saveCategory() {
            const categoryData = collectFormData();

            if (!validateCategoryData(categoryData)) {
                return;
            }

            if (currentEditingId) {
                // æ›´æ–°ç°æœ‰åˆ†ç±»
                const index = categories.findIndex(cat => cat.id === currentEditingId);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...categoryData, id: currentEditingId };
                }
            } else {
                // æ·»åŠ æ–°åˆ†ç±»
                const newId = Math.max(...categories.map(cat => cat.id), 0) + 1;
                categories.push({ ...categoryData, id: newId, productCount: 0 });
            }

            renderCategoryTree();
            updateStats();
            updateParentOptions();
            clearForm();

            showNotification(currentEditingId ? 'åˆ†ç±»æ›´æ–°æˆåŠŸï¼' : 'åˆ†ç±»æ·»åŠ æˆåŠŸï¼', 'success');
            currentEditingId = null;
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            return {
                title: document.getElementById('categoryTitle').value,
                type: document.getElementById('categoryType').value,
                parentId: document.getElementById('categoryType').value === 'child' ?
                    parseInt(document.getElementById('parentCategory').value) || null : null,
                description: document.getElementById('categoryDescription').value,
                icon: document.getElementById('categoryIcon').value,
                weight: parseInt(document.getElementById('categoryWeight').value) || 100,
                status: document.getElementById('categoryStatus').value,
                showInHome: document.getElementById('showInHome').checked,
                showInMenu: document.getElementById('showInMenu').checked,
                seoTitle: document.getElementById('seoTitle').value,
                seoDescription: document.getElementById('seoDescription').value,
                seoKeywords: document.getElementById('seoKeywords').value
            };
        }

        // éªŒè¯åˆ†ç±»æ•°æ®
        function validateCategoryData(data) {
            const errors = [];

            if (!data.title.trim()) {
                errors.push('åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º');
            }

            if (data.type === 'child' && !data.parentId) {
                errors.push('å­åˆ†ç±»å¿…é¡»é€‰æ‹©çˆ¶åˆ†ç±»');
            }

            // æ£€æŸ¥åç§°é‡å¤
            const existingCategory = categories.find(cat =>
                cat.title === data.title && cat.id !== currentEditingId
            );
            if (existingCategory) {
                errors.push('åˆ†ç±»åç§°å·²å­˜åœ¨');
            }

            if (errors.length > 0) {
                alert('è¯·ä¿®æ­£ä»¥ä¸‹é”™è¯¯ï¼š\n\n' + errors.join('\n'));
                return false;
            }

            return true;
        }

        // åˆ é™¤åˆ†ç±»
        function deleteCategory(categoryId) {
            const category = findCategoryById(categoryId);
            if (!category) return;

            // æ£€æŸ¥æ˜¯å¦æœ‰å­åˆ†ç±»
            const hasChildren = categories.some(cat => cat.parentId === categoryId);
            if (hasChildren) {
                alert('è¯¥åˆ†ç±»ä¸‹è¿˜æœ‰å­åˆ†ç±»ï¼Œè¯·å…ˆåˆ é™¤å­åˆ†ç±»ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”äº§å“
            if (category.productCount > 0) {
                if (!confirm(`è¯¥åˆ†ç±»ä¸‹æœ‰ ${category.productCount} ä¸ªäº§å“ï¼Œåˆ é™¤åè¿™äº›äº§å“å°†å¤±å»åˆ†ç±»å…³è”ã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ`)) {
                    return;
                }
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»"${category.title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                categories = categories.filter(cat => cat.id !== categoryId);
                renderCategoryTree();
                updateStats();
                updateParentOptions();
                showNotification('åˆ†ç±»åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('categoryTitle').value = '';
            document.getElementById('categoryType').value = 'parent';
            document.getElementById('categoryDescription').value = '';
            document.getElementById('categoryIcon').value = '';
            document.getElementById('categoryWeight').value = '100';
            document.getElementById('categoryStatus').value = 'active';
            document.getElementById('showInHome').checked = true;
            document.getElementById('showInMenu').checked = true;
            document.getElementById('seoTitle').value = '';
            document.getElementById('seoDescription').value = '';
            document.getElementById('seoKeywords').value = '';

            // æ¸…é™¤å›¾æ ‡é€‰æ‹©
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
            });

            // éšè—çˆ¶åˆ†ç±»é€‰æ‹©
            document.getElementById('parentCategorySection').style.display = 'none';

            // éšè—é¢„è§ˆ
            document.getElementById('categoryPreview').style.display = 'none';

            currentEditingId = null;
        }

        // é¢„è§ˆåˆ†ç±»
        function previewCategory() {
            const data = collectFormData();
            const previewContainer = document.getElementById('categoryPreview');
            const previewContent = document.getElementById('previewContent');

            if (!data.title.trim()) {
                alert('è¯·å…ˆè¾“å…¥åˆ†ç±»åç§°');
                return;
            }

            let previewHTML = `
                <div class="d-flex align-items-center mb-3">
                    ${data.icon ? `<i class="${data.icon} me-2"></i>` : ''}
                    <strong>${data.title}</strong>
                    <span class="badge bg-${data.status === 'active' ? 'success' : 'secondary'} ms-2">
                        ${data.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}
                    </span>
                </div>

                <div class="mb-2">
                    <strong>ç±»å‹:</strong> ${data.type === 'parent' ? 'ä¸»åˆ†ç±»' : 'å­åˆ†ç±»'}
                </div>

                ${data.description ? `
                    <div class="mb-2">
                        <strong>æè¿°:</strong> ${data.description}
                    </div>
                ` : ''}

                <div class="mb-2">
                    <strong>æƒé‡:</strong> ${data.weight}
                </div>

                <div class="mb-2">
                    <strong>æ˜¾ç¤ºè®¾ç½®:</strong>
                    ${data.showInHome ? '<span class="badge bg-info me-1">é¦–é¡µæ˜¾ç¤º</span>' : ''}
                    ${data.showInMenu ? '<span class="badge bg-info">èœå•æ˜¾ç¤º</span>' : ''}
                </div>

                ${data.seoTitle ? `
                    <div class="mt-3">
                        <h6>SEOä¿¡æ¯</h6>
                        <div><strong>SEOæ ‡é¢˜:</strong> ${data.seoTitle}</div>
                        ${data.seoDescription ? `<div><strong>SEOæè¿°:</strong> ${data.seoDescription}</div>` : ''}
                        ${data.seoKeywords ? `<div><strong>å…³é”®è¯:</strong> ${data.seoKeywords}</div>` : ''}
                    </div>
                ` : ''}
            `;

            previewContent.innerHTML = previewHTML;
            previewContainer.style.display = 'block';
        }

        // å±•å¼€å…¨éƒ¨
        function expandAll() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ å±•å¼€é€»è¾‘
            showNotification('å…¨éƒ¨å±•å¼€', 'info');
        }

        // æ”¶èµ·å…¨éƒ¨
        function collapseAll() {
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ”¶èµ·é€»è¾‘
            showNotification('å…¨éƒ¨æ”¶èµ·', 'info');
        }

        // åŒæ­¥åˆ†ç±»åˆ°å‰å°
        function syncCategories() {
            if (categories.length === 0) {
                alert('æ²¡æœ‰åˆ†ç±»æ•°æ®å¯åŒæ­¥');
                return;
            }

            // ç”Ÿæˆåˆ†ç±»é…ç½®
            const categoryConfig = generateCategoryConfig();

            console.log('åŒæ­¥åˆ†ç±»é…ç½®:', categoryConfig);

            // æ¨¡æ‹ŸåŒæ­¥è¿‡ç¨‹
            showNotification('æ­£åœ¨åŒæ­¥åˆ†ç±»...', 'info');

            setTimeout(() => {
                showNotification('åˆ†ç±»åŒæ­¥æˆåŠŸï¼', 'success');
            }, 2000);
        }

        // ç”Ÿæˆåˆ†ç±»é…ç½®
        function generateCategoryConfig() {
            const parentCategories = categories.filter(cat => cat.type === 'parent');

            return parentCategories.map(parent => {
                const children = categories.filter(cat => cat.type === 'child' && cat.parentId === parent.id);

                return {
                    id: parent.title.toLowerCase().replace(/\s+/g, '-'),
                    title: parent.title,
                    description: parent.description,
                    icon: parent.icon,
                    weight: parent.weight,
                    status: parent.status,
                    showInHome: parent.showInHome,
                    showInMenu: parent.showInMenu,
                    productCount: parent.productCount,
                    subcategories: children.map(child => ({
                        title: child.title,
                        description: child.description,
                        icon: child.icon,
                        weight: child.weight,
                        status: child.status,
                        productCount: child.productCount
                    }))
                };
            });
        }

        // å¯¼å‡ºåˆ†ç±»é…ç½®
        function exportCategories() {
            if (categories.length === 0) {
                alert('æ²¡æœ‰åˆ†ç±»æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const config = generateCategoryConfig();
            const yamlContent = generateYAMLConfig(config);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([yamlContent], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product_categories_${new Date().toISOString().split('T')[0]}.yml`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('åˆ†ç±»é…ç½®å¯¼å‡ºæˆåŠŸï¼', 'success');
        }

        // ç”ŸæˆYAMLé…ç½®
        function generateYAMLConfig(config) {
            let yaml = '# äº§å“åˆ†ç±»é…ç½®\n# è‡ªåŠ¨ç”Ÿæˆäº ' + new Date().toISOString() + '\n\n';

            config.forEach(category => {
                yaml += `- id: "${category.id}"\n`;
                yaml += `  title: "${category.title}"\n`;
                yaml += `  description: "${category.description || ''}"\n`;
                yaml += `  icon: "${category.icon || ''}"\n`;
                yaml += `  weight: ${category.weight}\n`;
                yaml += `  status: "${category.status}"\n`;
                yaml += `  show_in_home: ${category.showInHome}\n`;
                yaml += `  show_in_menu: ${category.showInMenu}\n`;
                yaml += `  product_count: ${category.productCount}\n`;

                if (category.subcategories.length > 0) {
                    yaml += `  subcategories:\n`;
                    category.subcategories.forEach(sub => {
                        yaml += `    - title: "${sub.title}"\n`;
                        yaml += `      description: "${sub.description || ''}"\n`;
                        yaml += `      icon: "${sub.icon || ''}"\n`;
                        yaml += `      weight: ${sub.weight}\n`;
                        yaml += `      status: "${sub.status}"\n`;
                        yaml += `      product_count: ${sub.productCount}\n`;
                    });
                }
                yaml += '\n';
            });

            return yaml;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
