<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ€ç»ˆæµ‹è¯• - äº§å“æ•°æ®ä¸€è‡´æ€§éªŒè¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        .status-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }
        .status-error {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: white;
        }
        .test-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        .log-info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-check-double me-2"></i>äº§å“æ•°æ®ä¸€è‡´æ€§éªŒè¯
                        </h2>
                        <p class="text-muted mb-0">éªŒè¯å‰å°å’Œåå°äº§å“æ•°æ®æ˜¯å¦ä¸€è‡´</p>
                    </div>
                    <div>
                        <button class="btn btn-primary me-2" onclick="runFullTest()">
                            <i class="fas fa-play me-1"></i>è¿è¡Œå®Œæ•´æµ‹è¯•
                        </button>
                        <button class="btn btn-success" onclick="openAdminPanel()">
                            <i class="fas fa-external-link-alt me-1"></i>æ‰“å¼€ç®¡ç†åå°
                        </button>
                    </div>
                </div>

                <!-- çŠ¶æ€å¡ç‰‡ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card status-card" id="dataLoaderCard">
                            <div class="card-body text-center">
                                <i class="fas fa-database fa-2x mb-2"></i>
                                <h5>æ•°æ®åŠ è½½å™¨</h5>
                                <div class="h3" id="dataLoaderCount">-</div>
                                <small id="dataLoaderStatus">æ£€æµ‹ä¸­...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card status-card" id="adminFunctionsCard">
                            <div class="card-body text-center">
                                <i class="fas fa-cogs fa-2x mb-2"></i>
                                <h5>ç®¡ç†åŠŸèƒ½</h5>
                                <div class="h3" id="adminFunctionsCount">-</div>
                                <small id="adminFunctionsStatus">æ£€æµ‹ä¸­...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card status-card" id="consistencyCard">
                            <div class="card-body text-center">
                                <i class="fas fa-balance-scale fa-2x mb-2"></i>
                                <h5>ä¸€è‡´æ€§æ£€æŸ¥</h5>
                                <div class="h3" id="consistencyStatus">-</div>
                                <small id="consistencyText">æ£€æµ‹ä¸­...</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card status-card" id="performanceCard">
                            <div class="card-body text-center">
                                <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                                <h5>åŠ è½½æ€§èƒ½</h5>
                                <div class="h3" id="loadTime">-</div>
                                <small id="performanceText">æ£€æµ‹ä¸­...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æµ‹è¯•æ—¥å¿— -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-alt me-2"></i>æµ‹è¯•æ—¥å¿—
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="test-log" id="testLog">
                                    <div class="log-entry log-info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>ç»Ÿè®¡ä¿¡æ¯
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>é¢„æœŸäº§å“æ•°:</strong>
                                    <span class="badge bg-primary fs-6">33</span>
                                </div>
                                <div class="mb-3">
                                    <strong>å®é™…åŠ è½½æ•°:</strong>
                                    <span class="badge bg-success fs-6" id="actualProductCount">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>åŒ¹é…ç‡:</strong>
                                    <span class="badge bg-info fs-6" id="matchRate">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>å·²å‘å¸ƒäº§å“:</strong>
                                    <span class="badge bg-warning fs-6" id="publishedCount">-</span>
                                </div>
                                <div class="mb-3">
                                    <strong>æ¨èäº§å“:</strong>
                                    <span class="badge bg-secondary fs-6" id="featuredCount">-</span>
                                </div>
                                <hr>
                                <div class="mb-2">
                                    <strong>Kç³»åˆ—:</strong>
                                    <span class="badge bg-outline-primary" id="kSeriesCount">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>Pç³»åˆ—:</strong>
                                    <span class="badge bg-outline-success" id="pSeriesCount">-</span>
                                </div>
                                <div class="mb-2">
                                    <strong>DZç³»åˆ—:</strong>
                                    <span class="badge bg-outline-info" id="dzSeriesCount">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- äº§å“åˆ—è¡¨é¢„è§ˆ -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>äº§å“åˆ—è¡¨é¢„è§ˆ
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="exportProductList()">
                                        <i class="fas fa-download me-1"></i>å¯¼å‡ºåˆ—è¡¨
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>#</th>
                                                <th>äº§å“ID</th>
                                                <th>äº§å“æ ‡é¢˜</th>
                                                <th>å‹å·</th>
                                                <th>ç³»åˆ—</th>
                                                <th>çŠ¶æ€</th>
                                                <th>æ¨è</th>
                                                <th>å‘å¸ƒæ—¶é—´</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productTableBody">
                                            <tr><td colspan="8" class="text-center">ç­‰å¾…æ•°æ®åŠ è½½...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data-loader.js"></script>
    <script>
        let testStartTime;
        let loadedProducts = [];
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            const logContainer = document.getElementById('testLog');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            testResults.push({ timestamp, message, type });
        }

        function updateCard(cardId, count, status, statusClass) {
            const card = document.getElementById(cardId);
            const countElement = card.querySelector('.h3');
            const statusElement = card.querySelector('small');
            
            countElement.textContent = count;
            statusElement.textContent = status;
            
            card.className = `card status-card status-${statusClass}`;
        }

        async function runFullTest() {
            testStartTime = Date.now();
            testResults = [];
            loadedProducts = [];
            
            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('testLog').innerHTML = '';
            
            log('ğŸš€ å¼€å§‹å®Œæ•´çš„äº§å“æ•°æ®ä¸€è‡´æ€§æµ‹è¯•', 'info');
            
            try {
                // æµ‹è¯•æ•°æ®åŠ è½½å™¨
                log('ğŸ“Š æµ‹è¯•æ•°æ®åŠ è½½å™¨...', 'info');
                const dataLoader = new ContentDataLoader();
                await dataLoader.loadProducts();
                
                if (dataLoader.contentData && dataLoader.contentData.products) {
                    const count = dataLoader.contentData.products.length;
                    loadedProducts = dataLoader.contentData.products;
                    
                    log(`âœ… æ•°æ®åŠ è½½å™¨æˆåŠŸåŠ è½½ ${count} ä¸ªäº§å“`, 'success');
                    updateCard('dataLoaderCard', count, 'åŠ è½½æˆåŠŸ', 'success');
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateStatistics();
                    
                    // æ›´æ–°äº§å“è¡¨æ ¼
                    updateProductTable();
                    
                    // æ£€æŸ¥ä¸€è‡´æ€§
                    checkConsistency(count);
                    
                } else {
                    log('âŒ æ•°æ®åŠ è½½å™¨æœªèƒ½è·å–äº§å“æ•°æ®', 'error');
                    updateCard('dataLoaderCard', 0, 'åŠ è½½å¤±è´¥', 'error');
                }
                
                // è®¡ç®—æ€§èƒ½
                const loadTime = Date.now() - testStartTime;
                updateCard('performanceCard', `${loadTime}ms`, 'åŠ è½½å®Œæˆ', 'success');
                log(`â±ï¸ æ€»åŠ è½½æ—¶é—´: ${loadTime}ms`, 'info');
                
                log('ğŸ‰ æµ‹è¯•å®Œæˆï¼', 'success');
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('æµ‹è¯•å¤±è´¥:', error);
            }
        }

        function checkConsistency(actualCount) {
            const expectedCount = 33;
            const matchRate = Math.round((actualCount / expectedCount) * 100);
            
            document.getElementById('matchRate').textContent = `${matchRate}%`;
            
            if (actualCount === expectedCount) {
                log(`ğŸ¯ å®Œç¾åŒ¹é…ï¼å®é™…äº§å“æ•° ${actualCount} ç­‰äºé¢„æœŸæ•° ${expectedCount}`, 'success');
                updateCard('consistencyCard', '100%', 'å®Œç¾åŒ¹é…', 'success');
            } else if (matchRate >= 90) {
                log(`âœ… åŸºæœ¬åŒ¹é…ï¼å®é™…äº§å“æ•° ${actualCount}ï¼ŒåŒ¹é…ç‡ ${matchRate}%`, 'success');
                updateCard('consistencyCard', `${matchRate}%`, 'åŸºæœ¬åŒ¹é…', 'success');
            } else if (matchRate >= 70) {
                log(`âš ï¸ éƒ¨åˆ†åŒ¹é…ï¼å®é™…äº§å“æ•° ${actualCount}ï¼ŒåŒ¹é…ç‡ ${matchRate}%`, 'warning');
                updateCard('consistencyCard', `${matchRate}%`, 'éƒ¨åˆ†åŒ¹é…', 'warning');
            } else {
                log(`âŒ åŒ¹é…åº¦ä½ï¼å®é™…äº§å“æ•° ${actualCount}ï¼ŒåŒ¹é…ç‡ ${matchRate}%`, 'error');
                updateCard('consistencyCard', `${matchRate}%`, 'åŒ¹é…åº¦ä½', 'error');
            }
        }

        function updateStatistics() {
            const total = loadedProducts.length;
            const published = loadedProducts.filter(p => p.status === 'published').length;
            const featured = loadedProducts.filter(p => p.featured === true).length;
            const kSeries = loadedProducts.filter(p => p.series === 'Kç³»åˆ—').length;
            const pSeries = loadedProducts.filter(p => p.series === 'Pç³»åˆ—').length;
            const dzSeries = loadedProducts.filter(p => p.series === 'DZç³»åˆ—').length;
            
            document.getElementById('actualProductCount').textContent = total;
            document.getElementById('publishedCount').textContent = published;
            document.getElementById('featuredCount').textContent = featured;
            document.getElementById('kSeriesCount').textContent = kSeries;
            document.getElementById('pSeriesCount').textContent = pSeries;
            document.getElementById('dzSeriesCount').textContent = dzSeries;
            
            log(`ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯: æ€»æ•°=${total}, å·²å‘å¸ƒ=${published}, æ¨è=${featured}`, 'info');
            log(`ğŸ“Š ç³»åˆ—åˆ†å¸ƒ: Kç³»åˆ—=${kSeries}, Pç³»åˆ—=${pSeries}, DZç³»åˆ—=${dzSeries}`, 'info');
        }

        function updateProductTable() {
            const tbody = document.getElementById('productTableBody');
            
            if (loadedProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ— äº§å“æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = loadedProducts.map((product, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><code class="small">${product.id}</code></td>
                    <td>${product.title}</td>
                    <td><span class="badge bg-secondary">${product.model || '-'}</span></td>
                    <td><span class="badge bg-primary">${product.series || '-'}</span></td>
                    <td><span class="badge ${product.status === 'published' ? 'bg-success' : 'bg-warning'}">${product.statusName || product.status}</span></td>
                    <td>${product.featured ? '<i class="fas fa-star text-warning"></i>' : '-'}</td>
                    <td class="small">${product.published ? new Date(product.published).toLocaleDateString() : '-'}</td>
                </tr>
            `).join('');
        }

        function exportProductList() {
            const data = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalProducts: loadedProducts.length,
                    expectedProducts: 33,
                    matchRate: Math.round((loadedProducts.length / 33) * 100),
                    testDuration: Date.now() - testStartTime
                },
                products: loadedProducts,
                testResults: testResults
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `product-consistency-test-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('ğŸ“ æµ‹è¯•ç»“æœå·²å¯¼å‡º', 'success');
        }

        function openAdminPanel() {
            window.open('admin.html', '_blank');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runFullTest, 1000);
        });
    </script>
</body>
</html>
