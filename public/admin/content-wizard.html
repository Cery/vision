<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisNDT 内容创建向导</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f6fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
        }

        .wizard-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 30px 0;
            overflow: hidden;
        }

        .wizard-steps {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            background: #e9ecef;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .step.active {
            background: #007bff;
            color: white;
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .step-number {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .wizard-content {
            padding: 40px;
            min-height: 500px;
        }

        .content-type-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
        }

        .content-type-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.1);
            transform: translateY(-2px);
        }

        .content-type-card.selected {
            border-color: #007bff;
            background: rgba(0,123,255,0.05);
        }

        .type-icon {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #007bff;
        }

        .type-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .type-description {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .type-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .type-features li {
            color: #28a745;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .image-upload-area:hover {
            border-color: #007bff;
            background: rgba(0,123,255,0.05);
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin: 10px;
        }

        .image-slot {
            display: inline-block;
            position: relative;
            margin: 10px;
        }

        .image-slot img {
            max-width: 150px;
            max-height: 100px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .image-slot .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .wizard-navigation {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar-custom {
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s ease;
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            min-height: 38px;
            cursor: text;
        }

        .tag {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
        }

        .tag-input input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
        }

        @media (max-width: 768px) {
            .wizard-content {
                padding: 20px;
            }

            .step-indicator {
                flex-direction: column;
                gap: 10px;
            }

            .step {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <div class="wizard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-magic me-3"></i>内容创建向导</h1>
                    <p class="lead">轻松创建专业的内容，支持图片管理和自动归档</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="local-cms.html" class="btn btn-light me-2">
                        <i class="fas fa-edit me-2"></i>内容编辑器
                    </a>
                    <a href="index.html" class="btn btn-outline-light">
                        <i class="fas fa-home me-2"></i>管理中心
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 向导容器 -->
        <div class="wizard-container">
            <!-- 步骤指示器 -->
            <div class="wizard-steps">
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="progressFill" style="width: 25%;"></div>
                </div>
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <span>选择类型</span>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <span>基本信息</span>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <span>图片管理</span>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <span>内容编辑</span>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-number">5</div>
                        <span>预览发布</span>
                    </div>
                </div>
            </div>

            <!-- 向导内容 -->
            <div class="wizard-content">
                <!-- 步骤1：选择内容类型 -->
                <div id="stepContent1" class="step-content">
                    <h3 class="text-center mb-4">选择要创建的内容类型</h3>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="content-type-card" onclick="selectContentType('news')">
                                <div class="type-icon">
                                    <i class="fas fa-newspaper"></i>
                                </div>
                                <div class="type-title">新闻资讯</div>
                                <div class="type-description">发布行业动态、技术资讯等新闻内容</div>
                                <ul class="type-features">
                                    <li><i class="fas fa-check me-2"></i>支持缩略图</li>
                                    <li><i class="fas fa-check me-2"></i>分类标签</li>
                                    <li><i class="fas fa-check me-2"></i>发布日期</li>
                                    <li><i class="fas fa-check me-2"></i>SEO优化</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="content-type-card" onclick="selectContentType('product')">
                                <div class="type-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="type-title">产品信息</div>
                                <div class="type-description">添加产品详情、技术参数等产品信息</div>
                                <ul class="type-features">
                                    <li><i class="fas fa-check me-2"></i>产品图库</li>
                                    <li><i class="fas fa-check me-2"></i>技术参数</li>
                                    <li><i class="fas fa-check me-2"></i>应用场景</li>
                                    <li><i class="fas fa-check me-2"></i>供应商信息</li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="content-type-card" onclick="selectContentType('case')">
                                <div class="type-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="type-title">应用案例</div>
                                <div class="type-description">展示成功案例、项目经验等内容</div>
                                <ul class="type-features">
                                    <li><i class="fas fa-check me-2"></i>案例图片</li>
                                    <li><i class="fas fa-check me-2"></i>项目背景</li>
                                    <li><i class="fas fa-check me-2"></i>解决方案</li>
                                    <li><i class="fas fa-check me-2"></i>实施效果</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤2：基本信息 -->
                <div id="stepContent2" class="step-content" style="display: none;">
                    <h3 class="mb-4">填写基本信息</h3>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-info-circle"></i>
                                    基础信息
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">标题 *</label>
                                    <input type="text" class="form-control" id="contentTitle" placeholder="请输入内容标题">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">摘要描述</label>
                                    <textarea class="form-control" id="contentSummary" rows="3" placeholder="请输入内容摘要，用于SEO和列表显示"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">发布日期</label>
                                        <input type="date" class="form-control" id="publishDate">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">状态</label>
                                        <select class="form-select" id="contentStatus">
                                            <option value="draft">草稿</option>
                                            <option value="published">已发布</option>
                                            <option value="scheduled">定时发布</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-tags"></i>
                                    分类和标签
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">分类</label>
                                    <select class="form-select" id="contentCategory">
                                        <option value="">选择分类</option>
                                        <option value="industry">行业资讯</option>
                                        <option value="technology">技术动态</option>
                                        <option value="company">公司新闻</option>
                                        <option value="product">产品发布</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">标签</label>
                                    <div class="tag-input" id="tagInput" onclick="focusTagInput()">
                                        <input type="text" placeholder="输入标签后按回车" onkeydown="handleTagInput(event)">
                                    </div>
                                    <small class="text-muted">输入标签后按回车键添加，点击标签可删除</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-cog"></i>
                                    高级设置
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">URL别名</label>
                                    <input type="text" class="form-control" id="urlSlug" placeholder="自动生成">
                                    <small class="text-muted">留空将根据标题自动生成</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SEO关键词</label>
                                    <input type="text" class="form-control" id="seoKeywords" placeholder="关键词1, 关键词2">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableComments" checked>
                                        <label class="form-check-label" for="enableComments">
                                            允许评论
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="featuredContent">
                                        <label class="form-check-label" for="featuredContent">
                                            推荐内容
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤3：图片管理 -->
                <div id="stepContent3" class="step-content" style="display: none;">
                    <h3 class="mb-4">图片和媒体管理</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-image"></i>
                                    缩略图设置
                                </div>
                                <div class="image-upload-area" onclick="selectThumbnail()">
                                    <div id="thumbnailPreview">
                                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                        <p class="mb-0">点击选择缩略图</p>
                                        <small class="text-muted">推荐尺寸：800x600px</small>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="selectThumbnail()">
                                        <i class="fas fa-images me-1"></i>从媒体库选择
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="uploadThumbnail()">
                                        <i class="fas fa-upload me-1"></i>上传新图片
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-images"></i>
                                    内容图片库
                                </div>
                                <div class="image-upload-area" onclick="selectContentImages()">
                                    <i class="fas fa-plus fa-2x text-muted mb-3"></i>
                                    <p class="mb-0">添加内容图片</p>
                                    <small class="text-muted">可选择多张图片</small>
                                </div>
                                <div id="contentImagesPreview" class="mt-3">
                                    <!-- 内容图片预览将在这里显示 -->
                                </div>
                                <div class="d-flex gap-2 mt-3">
                                    <button class="btn btn-primary btn-sm" onclick="selectContentImages()">
                                        <i class="fas fa-images me-1"></i>从媒体库选择
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="uploadContentImages()">
                                        <i class="fas fa-upload me-1"></i>上传图片
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-folder"></i>
                            图片组织和归档
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">图片存储路径</label>
                                <input type="text" class="form-control" id="imagePath" readonly>
                                <small class="text-muted">图片将自动保存到对应的分类目录</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">图片命名规则</label>
                                <select class="form-select" id="imageNaming">
                                    <option value="auto">自动命名（日期+序号）</option>
                                    <option value="title">基于标题命名</option>
                                    <option value="custom">自定义命名</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 其他步骤内容将在这里添加 -->
                <div id="stepContent4" class="step-content" style="display: none;">
                    <h3 class="mb-4">内容编辑</h3>
                    <p class="text-center text-muted">内容编辑功能开发中...</p>
                </div>

                <div id="stepContent5" class="step-content" style="display: none;">
                    <h3 class="mb-4">预览和发布</h3>
                    <p class="text-center text-muted">预览发布功能开发中...</p>
                </div>
            </div>

            <!-- 导航按钮 -->
            <div class="wizard-navigation">
                <button class="btn btn-outline-secondary" id="prevBtn" onclick="previousStep()" disabled>
                    <i class="fas fa-arrow-left me-2"></i>上一步
                </button>
                <div>
                    <span class="text-muted">步骤 <span id="currentStepNum">1</span> / 5</span>
                </div>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                    下一步<i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="auth.js"></script>

    <script>
        // 全局变量
        let currentStep = 1;
        let totalSteps = 5;
        let contentData = {
            type: '',
            title: '',
            summary: '',
            publishDate: '',
            status: 'draft',
            category: '',
            tags: [],
            thumbnail: null,
            contentImages: [],
            imagePath: '',
            imageNaming: 'auto'
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeWizard();
        });

        function initializeWizard() {
            console.log('初始化内容创建向导...');

            // 设置默认发布日期
            document.getElementById('publishDate').value = new Date().toISOString().split('T')[0];

            // 更新进度
            updateProgress();

            console.log('向导初始化完成');
        }

        // 选择内容类型
        function selectContentType(type) {
            // 清除之前的选择
            document.querySelectorAll('.content-type-card').forEach(card => {
                card.classList.remove('selected');
            });

            // 选择当前类型
            event.currentTarget.classList.add('selected');

            contentData.type = type;

            // 更新图片路径
            updateImagePath();

            // 启用下一步按钮
            document.getElementById('nextBtn').disabled = false;

            console.log('选择内容类型:', type);
        }

        // 更新图片路径
        function updateImagePath() {
            const pathMap = {
                'news': '/images/news/',
                'product': '/images/products/',
                'case': '/images/cases/'
            };

            const basePath = pathMap[contentData.type] || '/images/';
            const date = new Date().toISOString().split('T')[0];
            contentData.imagePath = `${basePath}${date}/`;

            const imagePathInput = document.getElementById('imagePath');
            if (imagePathInput) {
                imagePathInput.value = contentData.imagePath;
            }
        }

        // 步骤导航
        function nextStep() {
            if (currentStep < totalSteps) {
                // 验证当前步骤
                if (validateCurrentStep()) {
                    // 保存当前步骤数据
                    saveCurrentStepData();

                    // 移动到下一步
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                    updateNavigation();
                }
            } else {
                // 最后一步，完成创建
                finishWizard();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgress();
                updateNavigation();
            }
        }

        function showStep(stepNum) {
            // 隐藏所有步骤内容
            document.querySelectorAll('.step-content').forEach(content => {
                content.style.display = 'none';
            });

            // 显示当前步骤
            document.getElementById(`stepContent${stepNum}`).style.display = 'block';

            // 更新步骤指示器
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < stepNum) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNum) {
                    step.classList.add('active');
                }
            });
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentStepNum').textContent = currentStep;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.disabled = currentStep === 1;

            if (currentStep === totalSteps) {
                nextBtn.innerHTML = '<i class="fas fa-check me-2"></i>完成创建';
            } else {
                nextBtn.innerHTML = '下一步<i class="fas fa-arrow-right ms-2"></i>';
            }
        }

        // 验证步骤
        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    if (!contentData.type) {
                        showNotification('请选择内容类型', 'warning');
                        return false;
                    }
                    break;
                case 2:
                    const title = document.getElementById('contentTitle').value.trim();
                    if (!title) {
                        showNotification('请输入内容标题', 'warning');
                        document.getElementById('contentTitle').focus();
                        return false;
                    }
                    break;
                case 3:
                    // 图片步骤可选
                    break;
                case 4:
                    // 内容编辑步骤
                    break;
                case 5:
                    // 预览步骤
                    break;
            }
            return true;
        }

        // 保存当前步骤数据
        function saveCurrentStepData() {
            switch(currentStep) {
                case 2:
                    contentData.title = document.getElementById('contentTitle').value.trim();
                    contentData.summary = document.getElementById('contentSummary').value.trim();
                    contentData.publishDate = document.getElementById('publishDate').value;
                    contentData.status = document.getElementById('contentStatus').value;
                    contentData.category = document.getElementById('contentCategory').value;

                    // 自动生成URL别名
                    if (!document.getElementById('urlSlug').value) {
                        document.getElementById('urlSlug').value = generateSlug(contentData.title);
                    }
                    break;
                case 3:
                    contentData.imageNaming = document.getElementById('imageNaming').value;
                    break;
            }
        }

        // 生成URL别名
        function generateSlug(title) {
            return title.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim('-');
        }

        // 标签管理
        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const tag = input.value.trim();

                if (tag && !contentData.tags.includes(tag)) {
                    contentData.tags.push(tag);
                    addTagToUI(tag);
                    input.value = '';
                }
            }
        }

        function addTagToUI(tag) {
            const tagInput = document.getElementById('tagInput');
            const input = tagInput.querySelector('input');

            const tagElement = document.createElement('div');
            tagElement.className = 'tag';
            tagElement.innerHTML = `
                ${tag}
                <span class="remove-tag" onclick="removeTag('${tag}')">&times;</span>
            `;

            tagInput.insertBefore(tagElement, input);
        }

        function removeTag(tag) {
            contentData.tags = contentData.tags.filter(t => t !== tag);

            // 从UI中移除
            const tagElements = document.querySelectorAll('.tag');
            tagElements.forEach(element => {
                if (element.textContent.includes(tag)) {
                    element.remove();
                }
            });
        }

        function focusTagInput() {
            document.querySelector('#tagInput input').focus();
        }

        // 图片选择功能
        function selectThumbnail() {
            openImagePicker((image) => {
                contentData.thumbnail = image;
                updateThumbnailPreview(image);
            });
        }

        function updateThumbnailPreview(image) {
            const preview = document.getElementById('thumbnailPreview');
            preview.innerHTML = `
                <img src="${image.url}" class="image-preview" alt="${image.name}">
                <p class="mb-0 mt-2">${image.name}</p>
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="removeThumbnail()">
                    <i class="fas fa-trash me-1"></i>移除
                </button>
            `;
        }

        function removeThumbnail() {
            contentData.thumbnail = null;
            document.getElementById('thumbnailPreview').innerHTML = `
                <i class="fas fa-image fa-3x text-muted mb-3"></i>
                <p class="mb-0">点击选择缩略图</p>
                <small class="text-muted">推荐尺寸：800x600px</small>
            `;
        }

        function selectContentImages() {
            openImagePicker((image) => {
                if (!contentData.contentImages.find(img => img.id === image.id)) {
                    contentData.contentImages.push(image);
                    updateContentImagesPreview();
                }
            }, true); // 允许多选
        }

        function updateContentImagesPreview() {
            const preview = document.getElementById('contentImagesPreview');
            preview.innerHTML = '';

            contentData.contentImages.forEach((image, index) => {
                const imageSlot = document.createElement('div');
                imageSlot.className = 'image-slot';
                imageSlot.innerHTML = `
                    <img src="${image.url}" alt="${image.name}">
                    <button class="remove-btn" onclick="removeContentImage(${index})">&times;</button>
                `;
                preview.appendChild(imageSlot);
            });
        }

        function removeContentImage(index) {
            contentData.contentImages.splice(index, 1);
            updateContentImagesPreview();
        }

        function uploadThumbnail() {
            // 打开文件选择器上传缩略图
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 模拟上传并创建图片对象
                    const image = {
                        id: 'upload_' + Date.now(),
                        name: file.name,
                        url: URL.createObjectURL(file),
                        size: file.size
                    };
                    contentData.thumbnail = image;
                    updateThumbnailPreview(image);
                }
            };
            input.click();
        }

        function uploadContentImages() {
            // 打开文件选择器上传内容图片
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const image = {
                        id: 'upload_' + Date.now() + '_' + Math.random(),
                        name: file.name,
                        url: URL.createObjectURL(file),
                        size: file.size
                    };
                    contentData.contentImages.push(image);
                });
                updateContentImagesPreview();
            };
            input.click();
        }

        // 图片选择器
        function openImagePicker(callback, multiple = false) {
            // 打开媒体库窗口
            const mediaWindow = window.open('media-library.html', 'mediaLibrary',
                'width=1200,height=800,scrollbars=yes,resizable=yes');

            // 监听媒体库的消息
            window.addEventListener('message', function(event) {
                if (event.data.type === 'insertMedia') {
                    const image = {
                        id: event.data.id || 'media_' + Date.now(),
                        name: event.data.name,
                        url: event.data.url,
                        size: event.data.size || 0
                    };
                    callback(image);
                }
            });
        }

        // 完成向导
        function finishWizard() {
            // 保存最后步骤的数据
            saveCurrentStepData();

            // 生成最终的内容文件
            const content = generateContentFile();

            // 显示完成信息
            showCompletionDialog(content);
        }

        function generateContentFile() {
            const frontMatter = {
                title: contentData.title,
                date: contentData.publishDate,
                summary: contentData.summary,
                categories: contentData.category ? [contentData.category] : [],
                tags: contentData.tags,
                draft: contentData.status === 'draft'
            };

            if (contentData.thumbnail) {
                frontMatter.thumbnail = contentData.thumbnail.url;
            }

            // 生成YAML前置内容
            let yamlContent = '---\n';
            Object.entries(frontMatter).forEach(([key, value]) => {
                if (Array.isArray(value)) {
                    yamlContent += `${key}: [${value.map(v => `"${v}"`).join(', ')}]\n`;
                } else if (typeof value === 'boolean') {
                    yamlContent += `${key}: ${value}\n`;
                } else {
                    yamlContent += `${key}: "${value}"\n`;
                }
            });
            yamlContent += '---\n\n';

            // 生成内容
            let markdownContent = `# ${contentData.title}\n\n`;

            if (contentData.summary) {
                markdownContent += `${contentData.summary}\n\n`;
            }

            // 添加内容图片
            if (contentData.contentImages.length > 0) {
                markdownContent += '## 相关图片\n\n';
                contentData.contentImages.forEach(image => {
                    markdownContent += `![${image.name}](${image.url})\n\n`;
                });
            }

            markdownContent += '## 详细内容\n\n请在此处添加详细内容...\n';

            return yamlContent + markdownContent;
        }

        function showCompletionDialog(content) {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-check-circle text-success me-2"></i>
                                内容创建完成
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success">
                                <h6>创建成功！</h6>
                                <p class="mb-0">您的${getContentTypeName()}已创建完成，包含以下内容：</p>
                                <ul class="mt-2 mb-0">
                                    <li>标题：${contentData.title}</li>
                                    <li>类型：${getContentTypeName()}</li>
                                    <li>标签：${contentData.tags.join(', ') || '无'}</li>
                                    <li>缩略图：${contentData.thumbnail ? '已设置' : '未设置'}</li>
                                    <li>内容图片：${contentData.contentImages.length} 张</li>
                                </ul>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">生成的文件内容：</label>
                                <textarea class="form-control" rows="10" readonly>${content}</textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" onclick="openInEditor()">
                                <i class="fas fa-edit me-2"></i>在编辑器中打开
                            </button>
                            <button type="button" class="btn btn-success" onclick="downloadFile()">
                                <i class="fas fa-download me-2"></i>下载文件
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            // 模态框关闭后移除元素
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        function getContentTypeName() {
            const typeNames = {
                'news': '新闻资讯',
                'product': '产品信息',
                'case': '应用案例'
            };
            return typeNames[contentData.type] || '内容';
        }

        function openInEditor() {
            // 在内容编辑器中打开
            const content = generateContentFile();
            const editorUrl = `local-cms.html?content=${encodeURIComponent(content)}&title=${encodeURIComponent(contentData.title)}`;
            window.open(editorUrl, '_blank');
        }

        function downloadFile() {
            const content = generateContentFile();
            const filename = `${generateSlug(contentData.title)}.md`;

            const blob = new Blob([content], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 2050; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>
