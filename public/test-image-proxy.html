<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片代理测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-image {
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border: 1px solid #ccc;
            margin: 10px;
        }
        .error-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>🖼️ 图片代理功能测试页面</h1>
    
    <div class="status info">
        <strong>说明：</strong>这个页面用于测试图片代理功能。当图片加载失败时，会尝试通过代理从后台管理系统获取图片数据。
    </div>

    <div class="test-section">
        <h2>测试1：产品图片</h2>
        <p>这些图片路径指向可能不存在的文件，应该触发代理加载：</p>
        <img src="/images/products/test-product-1.jpg" alt="测试产品1" class="test-image">
        <img src="/images/products/test-product-2.png" alt="测试产品2" class="test-image">
        <img src="/images/products/ws-k1010-main.jpg" alt="WS-K1010主图" class="test-image">
    </div>

    <div class="test-section">
        <h2>测试2：内容图片</h2>
        <p>这些图片来自富文本编辑器：</p>
        <img src="/images/content/products/application-1.jpg" alt="应用场景1" class="test-image">
        <img src="/images/content/products/description-1.png" alt="产品描述1" class="test-image">
    </div>

    <div class="test-section">
        <h2>测试3：现有图片</h2>
        <p>这些图片应该正常加载（如果存在）：</p>
        <img src="/images/products/K-series/K-main.jpg" alt="K系列主图" class="test-image">
        <img src="/images/products/P60/P-MAIN.jpg" alt="P60主图" class="test-image">
    </div>

    <div class="test-section">
        <h2>📊 测试状态</h2>
        <div id="testStatus"></div>
        <button onclick="runImageTest()">运行图片测试</button>
        <button onclick="clearLog()">清除日志</button>
    </div>

    <div class="test-section">
        <h2>📝 错误日志</h2>
        <div id="errorLog" class="error-log"></div>
    </div>

    <script>
        // 日志记录
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const logElement = document.getElementById('errorLog');
        
        function addToLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'};">${message}</span>`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLog(args.join(' '), 'info');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        // 测试函数
        function runImageTest() {
            const statusElement = document.getElementById('testStatus');
            statusElement.innerHTML = '<div class="status info">正在运行图片测试...</div>';
            
            const images = document.querySelectorAll('.test-image');
            let loadedCount = 0;
            let errorCount = 0;
            let totalCount = images.length;
            
            images.forEach((img, index) => {
                const originalSrc = img.src;
                
                // 重置图片
                img.src = '';
                
                setTimeout(() => {
                    img.onload = function() {
                        loadedCount++;
                        console.log(`✅ 图片 ${index + 1} 加载成功: ${originalSrc}`);
                        updateTestStatus();
                    };
                    
                    img.onerror = function() {
                        errorCount++;
                        console.error(`❌ 图片 ${index + 1} 加载失败: ${originalSrc}`);
                        updateTestStatus();
                    };
                    
                    // 重新设置src触发加载
                    img.src = originalSrc;
                }, index * 100);
            });
            
            function updateTestStatus() {
                if (loadedCount + errorCount === totalCount) {
                    const successRate = ((loadedCount / totalCount) * 100).toFixed(1);
                    statusElement.innerHTML = `
                        <div class="status ${loadedCount === totalCount ? 'success' : 'error'}">
                            测试完成！成功加载: ${loadedCount}/${totalCount} (${successRate}%)
                        </div>
                    `;
                }
            }
        }
        
        function clearLog() {
            document.getElementById('errorLog').innerHTML = '';
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🖼️ 图片代理测试页面已加载');
            
            // 监听图片加载事件
            document.querySelectorAll('.test-image').forEach((img, index) => {
                img.addEventListener('load', function() {
                    console.log(`图片 ${index + 1} 加载成功: ${this.src}`);
                });
                
                img.addEventListener('error', function() {
                    console.error(`图片 ${index + 1} 加载失败: ${this.src}`);
                });
            });
            
            // 自动运行一次测试
            setTimeout(runImageTest, 1000);
        });
        
        // 监听来自图片代理的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'IMAGE_RESPONSE') {
                console.log(`📡 收到图片代理响应: ${event.data.fileName}`);
            }
        });
    </script>
    
    <!-- 引入图片代理脚本 -->
    <script src="/js/image-proxy.js"></script>
</body>
</html>
