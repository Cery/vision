{{ define "main" }}
<div class="container py-5">
    {{ partial "breadcrumbs.html" . }}
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- 主图容器 - 固定高度 -->
                    <div class="main-image-container">
                        {{ $mainImageSrc := "" }}
                        {{ $mainImageAlt := "产品图片" }}
                        {{ if .Params.gallery }}
                            {{ if reflect.IsSlice .Params.gallery }}
                                {{ $firstImage := index .Params.gallery 0 }}
                                {{ if reflect.IsMap $firstImage }}
                                    {{ $mainImageSrc = $firstImage.image }}
                                    {{ $mainImageAlt = $firstImage.alt | default "产品图片" }}
                                {{ else }}
                                    {{ $mainImageSrc = $firstImage }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                        {{ if $mainImageSrc }}
                        <img src="{{ $mainImageSrc | relURL }}" class="img-fluid rounded mb-3 main-product-image" alt="{{ $mainImageAlt }}" id="main-product-image">
                        {{ else }}
                        <img src="/images/products/default-product.jpg" class="img-fluid rounded mb-3 main-product-image" alt="主图占位图" id="main-product-image">
                        {{ end }}
                    </div>

                    <!-- 缩略图容器 - 固定高度 -->
                    <div class="row g-2 thumbnail-gallery">
                        {{ if .Params.gallery }}
                            {{ if reflect.IsSlice .Params.gallery }}
                                {{ $galleryItems := after 1 .Params.gallery }}
                                {{ range first 4 $galleryItems }}
                                    {{ if reflect.IsMap . }}
                                    <div class="col-3">
                                        <div class="thumbnail-container">
                                            <img src="{{ .image | relURL }}"
                                                 class="img-fluid rounded object-fit-cover thumbnail-image"
                                                 alt="{{ .alt | default "产品图片" | htmlEscape }}"
                                                 data-image-url="{{ .image | relURL | htmlEscape }}"
                                                 data-image-alt="{{ .alt | default "产品图片" | htmlEscape }}"
                                                 data-full-image="{{ .image | relURL | htmlEscape }}"
                                                 onclick="switchMainImageFromData(this)">
                                        </div>
                                    </div>
                                    {{ else }}
                                    <div class="col-3">
                                        <div class="thumbnail-container">
                                            <img src="{{ . | relURL }}"
                                                 class="img-fluid rounded object-fit-cover thumbnail-image"
                                                 alt="产品图片"
                                                 data-image-url="{{ . | relURL | htmlEscape }}"
                                                 data-image-alt="产品图片"
                                                 data-full-image="{{ . | relURL | htmlEscape }}"
                                                 onclick="switchMainImageFromData(this)">
                                        </div>
                                    </div>
                                    {{ end }}
                                {{ end }}
                            {{ end }}
                        {{ else }}
                        {{ range seq 2 5 }}
                        <div class="col-3">
                            <div class="thumbnail-container">
                                <img src="/images/products/default-gallery-{{ . }}.jpg"
                                     class="img-fluid rounded object-fit-cover thumbnail-image"
                                     alt="副图占位图"
                                     data-image-url="/images/products/default-gallery-{{ . }}.jpg"
                                     data-image-alt="副图占位图"
                                     data-full-image="/images/products/default-gallery-{{ . }}.jpg"
                                     onclick="switchMainImageFromData(this)">
                            </div>
                        </div>
                        {{ end }}
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="mb-3">{{ .Title }}</h2>
                    {{ with .Params.summary }}
                    <p class="lead text-muted">{{ . }}</p>
                    {{ end }}

                    <!-- 产品分类标签 -->
                    <div class="product-categories mb-3">
                        {{ with .Params.primary_category }}
                        <span class="badge bg-dark me-2 mb-1" style="font-size: 0.9rem; padding: 0.5rem 0.8rem;">
                            <i class="fas fa-folder me-1"></i>{{ . }}
                        </span>
                        {{ end }}
                        {{ with .Params.secondary_category }}
                        <span class="badge bg-dark me-2 mb-1" style="font-size: 0.9rem; padding: 0.5rem 0.8rem;">
                            <i class="fas fa-tag me-1"></i>{{ . }}
                        </span>
                        {{ end }}
                    </div>

                    <hr>

                    <ul class="list-unstyled product-details-list">
                        {{ with .Params.product_category }}
                        <li><strong>产品分类：</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.product_type }}
                        <li><strong>产品型式：</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.model }}
                        <li><strong>型号：</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.series }}
                        <li><strong>系列：</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.supplier }}
                        <li><strong>供应商：</strong>
                            {{ $supplierTitle := . }}
                            {{ $foundSupplier := "" }}
                            {{ range (where site.Pages "Section" "suppliers") }}
                                {{ if eq .Title $supplierTitle }}
                                    {{ $foundSupplier = . }}
                                {{ end }}
                            {{ end }}

                            {{ if $foundSupplier }}
                            <a href="#" data-bs-toggle="modal" data-bs-target="#supplierModal"
                                class="supplier-link"
                                data-supplier-title="{{ $foundSupplier.Title | htmlEscape }}"
                                data-supplier-address="{{ $foundSupplier.Params.address | default "未提供" | htmlEscape }}"
                                data-supplier-type="{{ $foundSupplier.Params.type | default "未提供" | htmlEscape }}"
                                data-supplier-contact-person="{{ $foundSupplier.Params.contact_person | default "未提供" | htmlEscape }}"
                                data-supplier-position="{{ $foundSupplier.Params.position | default "未提供" | htmlEscape }}"
                                data-supplier-phone="{{ $foundSupplier.Params.phone | default "未提供" | htmlEscape }}"
                                data-supplier-email="{{ $foundSupplier.Params.email | default "未提供" | htmlEscape }}"
                                data-supplier-content="{{ ($foundSupplier.Params.description | default "暂无简介") | htmlEscape }}"
                                data-supplier-series='{{ $foundSupplier.Params.series | jsonify | safeHTMLAttr }}'
                                data-supplier-models='{{ $foundSupplier.Params.models | jsonify | safeHTMLAttr }}'
                                data-supplier-gallery='{{ $foundSupplier.Params.gallery | jsonify | safeHTMLAttr }}'>
                            {{ $foundSupplier.Title }}
                            </a>            
                            {{ else }}
                                {{ $supplierTitle }}
                            {{ end }}
                        </li>
                        {{ end }}
                        
                        {{ with .Params.published }}
                        <li><strong>发布时间：</strong> {{ .Format "2006-01-02" }}</li>
                        {{ end }}
                        <li><strong>浏览次数：</strong>
                            <span id="page-views">加载中...</span>
                            <!-- 不蒜子统计备用方案 -->
                            <span id="busuanzi_container_page_pv" style="display:none;">
                                (<span id="busuanzi_value_page_pv"></span>)
                            </span>
                        </li>
                        </ul>

                    <div class="mt-4 d-flex gap-3">
                        <button class="btn btn-primary flex-grow-1" id="online-consult-btn">
                            <i class="bi bi-chat-dots-fill me-2"></i>在线咨询
                        </button>
                        <button class="btn btn-outline-primary flex-grow-1" id="phone-contact-btn" data-bs-toggle="modal" data-bs-target="#phoneContactModal"
                                {{ with .Params.supplier }}
                                {{ $supplierTitle := . }}
                                {{ $foundSupplier := "" }}
                                {{ range (where site.Pages "Section" "suppliers") }}
                                    {{ if eq .Title $supplierTitle }}
                                        {{ $foundSupplier = . }}
                                    {{ end }}
                                {{ end }}
                                {{ if $foundSupplier }}
                                data-supplier-title="{{ $foundSupplier.Title | htmlEscape }}"
                                data-supplier-contact-person="{{ $foundSupplier.Params.contact_person | default "客服" | htmlEscape }}"
                                data-supplier-position="{{ $foundSupplier.Params.position | default "销售顾问" | htmlEscape }}"
                                data-supplier-phone="{{ $foundSupplier.Params.phone | default "400-000-0000" | htmlEscape }}"
                                {{ end }}
                                {{ end }}>
                            <i class="bi bi-telephone-fill me-2"></i>电话沟通
                        </button>
                    </div>
                </div>
            </div>

            {{ with .Params.parameters }}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h4 class="card-title mb-0">核心参数</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {{ $displayCount := 0 }}
                        {{ range . }}
                            {{ if .group }}
                                {{ range .items }}
                                    {{ if or (eq .name "主机屏幕") (eq .name "待机时长") (eq .name "探头直径") (eq .name "像素") (eq .name "视向") (eq .name "光源") (eq .name "导向") (eq .name "管线材质") }}
                                        {{ if lt $displayCount 8 }}
                                            <div class="col-6 mb-2">
                                                <strong>{{ .name }}：</strong> {{ .value }}
                                            </div>
                                            {{ $displayCount = add $displayCount 1 }}
                                        {{ end }}
                                    {{ end }}
                                {{ end }}
                            {{ else }}
                                {{ if or (eq .name "主机屏幕") (eq .name "待机时长") (eq .name "探头直径") (eq .name "像素") (eq .name "视向") (eq .name "光源") (eq .name "导向") (eq .name "管线材质") }}
                                    {{ if lt $displayCount 8 }}
                                        <div class="col-6 mb-2">
                                            <strong>{{ .name }}：</strong> {{ .value }}
                                        </div>
                                        {{ $displayCount = add $displayCount 1 }}
                                    {{ end }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs" id="productTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="intro-tab" data-bs-toggle="tab" data-bs-target="#intro" type="button" role="tab" aria-controls="intro" aria-selected="true">产品介绍</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="detailed-specs-tab" data-bs-toggle="tab" data-bs-target="#detailed-specs" type="button" role="tab" aria-controls="detailed-specs" aria-selected="false">详细参数</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="application-tab" data-bs-toggle="tab" data-bs-target="#application" type="button" role="tab" aria-controls="application" aria-selected="false">应用场景</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download" type="button" role="tab" aria-controls="download" aria-selected="false">资料下载</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="productTabContent">
                        <div class="tab-pane fade show active" id="intro" role="tabpanel" aria-labelledby="intro-tab">
                            <div class="content">
                                {{ .Content }}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="detailed-specs" role="tabpanel" aria-labelledby="detailed-specs-tab">
                            {{ with .Params.parameters }}
                            <table class="table table-bordered detailed-params-table">
                                <tbody>
                                    {{ range . }}
                                        {{ if .group }}
                                            <tr>
                                                <td colspan="2" class="param-group-header"><h6>{{ .group }}</h6></td>
                                            </tr>
                                            {{ range .items }}
                                            <tr>
                                                <td class="param-name">{{ .name }}</td>
                                                <td class="param-value">{{ .value }}</td>
                                            </tr>
                                            {{ end }}
                                        {{ else }}
                                            <tr>
                                                <td class="param-name">{{ .name }}</td>
                                                <td class="param-value">{{ .value }}</td>
                                            </tr>
                                        {{ end }}
                                    {{ end }}
                                </tbody>
                            </table>
                            {{ else }}
                            <p>暂无详细参数信息。</p>
                            {{ end }}
                        </div>
                        <div class="tab-pane fade" id="application" role="tabpanel" aria-labelledby="application-tab">
                            {{ with .Params.application_scenarios }}
                            <div class="content application-scenarios">
                                {{ . | markdownify }}
                            </div>
                            {{ else }}
                            <p>暂无应用场景信息。</p>
                            {{ end }}
                        </div>
                        <div class="tab-pane fade" id="download" role="tabpanel" aria-labelledby="download-tab">
                            {{ with .Params.data_download }}
                            <ul class="list-unstyled">
                                {{ range . }}
                                <li>
                                    <a href="{{ .file_path | relURL }}"
                                       target="_blank"
                                       class="download-link"
                                       data-file-path="{{ .file_path }}">
                                        <i class="fas fa-download me-2"></i>{{ .file_title }}
                                    </a>
                                </li>
                                {{ end }}
                            </ul>
                            {{ else }}
                            <p>暂无资料可供下载。</p>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{ with .Params.related_products }}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">相关产品</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled row row-cols-1 row-cols-md-3 g-4">
                        {{ range . }}
                        {{ $relatedProduct := site.GetPage (printf "products/%s" .) }}
                        {{ with $relatedProduct }}
                        <li class="col">
                            <a href="{{ .Permalink }}" class="text-decoration-none">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-dark">{{ .Title }}</h6>
                                        <p class="card-text text-muted small">{{ .Summary }}</p>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {{ end }}
                        {{ end }}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {{ end }}
</div>

{{ partial "supplier_modal.html" . }}

<div class="modal fade" id="phoneContactModal" tabindex="-1" aria-labelledby="phoneContactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="phoneContactModalLabel">联系我们</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <h4 class="mb-3">咨询电话</h4>
                <div class="mb-3">
                    <p class="fs-6 mb-1 text-muted" id="supplier-company">公司名称</p>
                    <p class="fs-5 mb-2" id="contact-person">联系人</p>
                    <p class="fs-6 mb-2 text-muted" id="contact-position">职务</p>
                </div>
                <p class="fs-4 mb-4 fw-bold" id="contact-phone">电话号码</p>
                <p class="text-muted">工作时间：周一至周五 08:00-18:00</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="tel:" class="btn btn-primary" id="call-now-btn">立即拨打</a>
            </div>
        </div>
    </div>
</div>

<!-- 页面数据存储 -->
<div id="page-data"
     data-current-path="{{ .RelPermalink | htmlEscape }}"
     data-page-title="{{ .Title | htmlEscape }}"
     style="display: none;"></div>

<!-- 修复浏览次数的JavaScript -->
<script>
// 防止重复初始化的标记
let isInitialized = false;
let pageViewsElement;
// 页面信息变量
let currentPath = '';
let pageTitle = '';

// 获取页面信息的函数
function getPageData() {
    const pageData = document.getElementById('page-data');
    if (pageData) {
        currentPath = pageData.dataset.currentPath;
        pageTitle = pageData.dataset.pageTitle;
        return true;
    }
    return false;
}

// LeanCloud配置
const LC_APP_ID = 'pUEgNUJ66pc7S4FqVpqxkTkx-MdYXbMMI';
const LC_APP_KEY = 'K9OXRf3L6Zp0s6TEzJElWQ5r';

function initPageViews() {
    // 防止重复初始化
    if (isInitialized) {
        console.log('页面访问统计已初始化，跳过重复初始化');
        return;
    }

    // 获取页面数据
    if (!getPageData()) {
        console.error('无法获取页面数据，延迟重试');
        setTimeout(initPageViews, 500);
        return;
    }

    pageViewsElement = document.getElementById('page-views');
    if (!pageViewsElement) {
        console.log('未找到页面访问统计元素');
        return;
    }

    console.log('初始化页面访问统计, 路径:', currentPath);
    isInitialized = true;

    // 只使用LeanCloud直接API方式，避免Valine冲突
    initLeanCloudViews();
}

function initLeanCloudViews() {
    // 检查pageViewsElement是否存在
    if (!pageViewsElement) {
        console.error('pageViewsElement未初始化，无法显示浏览次数');
        return;
    }

    console.log('开始初始化浏览次数统计，路径:', currentPath);

    // 首先尝试LeanCloud，失败后使用本地存储
    tryLeanCloudFirst();
}

function tryLeanCloudFirst() {
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';
    const queryUrl = url + '?where=' + encodeURIComponent(JSON.stringify({url: currentPath}));

    console.log('尝试连接LeanCloud:', queryUrl);

    // 设置超时时间为5秒
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        console.log('LeanCloud响应状态:', response.status, response.statusText);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('LeanCloud连接成功，查询结果:', data);

        if (data.results && data.results.length > 0) {
            const record = data.results[0];
            const currentViews = record.time || 0;
            const newViews = currentViews + 1;

            // 显示当前浏览次数
            pageViewsElement.textContent = newViews.toString();

            // 更新LeanCloud记录
            updateLeanCloudCounter(record.objectId, newViews);
        } else {
            // 创建新记录
            createLeanCloudCounter(1);
            pageViewsElement.textContent = '1';
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('LeanCloud连接失败:', error.message);

        if (error.name === 'AbortError') {
            console.log('LeanCloud连接超时，使用本地存储');
        } else {
            console.log('LeanCloud网络错误，使用本地存储');
        }

        // 回退到本地存储
        initLocalPageViews();
    });
}

function initLocalPageViews() {
    try {
        // 获取当前页面的浏览次数
        const storageKey = 'pageviews_' + currentPath.replace(/[^a-zA-Z0-9]/g, '_');
        let currentViews = parseInt(localStorage.getItem(storageKey) || '0');

        // 增加浏览次数
        currentViews += 1;

        // 保存到本地存储
        localStorage.setItem(storageKey, currentViews.toString());

        // 显示浏览次数
        pageViewsElement.textContent = currentViews.toString();

        console.log('本地浏览次数统计成功，当前次数:', currentViews);

        // 可选：同时尝试同步到LeanCloud（不阻塞显示）
        tryLeanCloudSync(currentViews);

    } catch (error) {
        console.error('本地浏览次数统计失败:', error);
        // 显示默认值
        pageViewsElement.textContent = '1';
    }
}

function tryLeanCloudSync(views) {
    // 异步尝试同步到LeanCloud，不影响本地显示
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';
    const queryUrl = url + '?where=' + encodeURIComponent(JSON.stringify({url: currentPath}));

    fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.results && data.results.length > 0) {
            // 更新现有记录
            const record = data.results[0];
            updateLeanCloudCounter(record.objectId, views);
        } else {
            // 创建新记录
            createLeanCloudCounter(views);
        }
    })
    .catch(error => {
        console.log('LeanCloud同步失败（不影响本地统计）:', error.message);
    });
}

function createLeanCloudCounter(views) {
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';

    const requestBody = {
        url: currentPath,
        title: pageTitle,
        time: views,
        createdAt: new Date().toISOString()
    };

    fetch(url, {
        method: 'POST',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('LeanCloud创建成功:', data);
    })
    .catch(error => {
        console.log('LeanCloud创建失败:', error.message);
    });
}

function fetchCurrentViews() {
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';
    const queryUrl = url + '?where=' + encodeURIComponent(JSON.stringify({url: currentPath}));

    fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.results && data.results.length > 0) {
            const record = data.results[0];
            const currentViews = record.time || 0;
            pageViewsElement.textContent = currentViews.toString();
        } else {
            pageViewsElement.textContent = '0';
        }
    })
    .catch(error => {
        console.error('获取浏览次数失败:', error);
        pageViewsElement.textContent = '0';
    });
}

function updateLeanCloudCounter(objectId, views) {
    const url = `https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter/${objectId}`;

    const requestBody = {
        time: views,
        updatedAt: new Date().toISOString()
    };

    fetch(url, {
        method: 'PUT',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('LeanCloud更新成功:', data);
    })
    .catch(error => {
        console.log('LeanCloud更新失败:', error.message);
    });
}

// 页面加载完成后初始化 - 只初始化一次
document.addEventListener('DOMContentLoaded', function() {
    // 延迟初始化，确保页面完全加载
    setTimeout(initPageViews, 1000);

    // 初始化不蒜子统计备用方案
    setTimeout(initBusuanziBackup, 2000);
});

// 不蒜子统计备用方案
function initBusuanziBackup() {
    // 检查LeanCloud是否工作正常
    const pageViewsElement = document.getElementById('page-views');
    const busuanziContainer = document.getElementById('busuanzi_container_page_pv');

    if (pageViewsElement && (pageViewsElement.textContent === '网络错误' || pageViewsElement.textContent === '加载中...')) {
        console.log('LeanCloud统计失败，启用不蒜子统计备用方案');

        // 显示不蒜子统计
        if (busuanziContainer) {
            busuanziContainer.style.display = 'inline';
        }

        // 加载不蒜子统计脚本
        if (!document.querySelector('script[src*="busuanzi"]')) {
            const script = document.createElement('script');
            script.async = true;
            script.src = '//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
            document.head.appendChild(script);

            // 监听不蒜子加载完成
            script.onload = function() {
                console.log('不蒜子统计加载成功');
                // 隐藏原来的错误提示
                pageViewsElement.style.display = 'none';
            };
        }
    }
}
</script>

<!-- 不蒜子统计脚本（按需加载） -->
<script>
// 如果需要立即启用不蒜子统计，取消下面的注释
// document.write('<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"><\/script>');
</script>

<script>
function switchMainImage(imageUrl, altText) {
    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    
    if (mainImage) {
        mainImage.src = imageUrl;
        mainImage.alt = altText;
    }

    // 高亮当前选中的缩略图
    thumbnails.forEach(thumbnail => {
        if (thumbnail.src === imageUrl) {
            thumbnail.classList.add('active-thumbnail');
        } else {
            thumbnail.classList.remove('active-thumbnail');
        }
    });
}

// 从data属性获取数据并切换主图
function switchMainImageFromData(element) {
    const imageUrl = element.dataset.imageUrl;
    const altText = element.dataset.imageAlt;
    switchMainImage(imageUrl, altText);
}

// 为缩略图添加点击事件监听器
document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const imageUrl = this.getAttribute('data-full-image') || this.src;
            const altText = this.alt;
            switchMainImage(imageUrl, altText);
        });
    });
});
</script>

<style>
/* 产品页面样式 - 统一设计 */
.product-details-list li {
    margin-bottom: 0.75rem;
    font-size: 14px;
    line-height: 1.5;
    color: #212121;
}

.product-details-list strong {
    color: #616161;
    font-weight: 500;
}

.content img {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
}

.content p {
    line-height: 1.6;
    margin-bottom: 1.5rem;
    font-size: 14px;
    color: #212121;
}

.content h2, .content h3, .content h4 {
    color: #1976d2;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.nav-tabs .nav-link {
    font-size: 14px;
    font-weight: 500;
    color: #616161;
    border-radius: 8px 8px 0 0;
    transition: all 0.15s ease-in-out;
}

.nav-tabs .nav-link.active {
    border-color: #e0e0e0 #e0e0e0 #fff;
    background-color: #fff;
    color: #1976d2;
}

.nav-tabs .nav-link:hover {
    color: #1976d2;
    background-color: rgba(25, 118, 210, 0.05);
}

.detailed-params-table {
    font-size: 14px;
}

.detailed-params-table .param-name {
    background-color: #fafafa;
    width: 30%;
    font-weight: 500;
    color: #616161;
    padding: 0.75rem;
}

.detailed-params-table .param-value {
    background-color: #ffffff;
    color: #212121;
    padding: 0.75rem;
}

.detailed-params-table .param-group-header {
    background-color: #f5f5f5;
    font-weight: 600;
    text-align: center;
    color: #1976d2;
    padding: 1rem;
}

.detailed-params-table .param-group-header h6 {
    margin: 0;
    font-size: 16px;
}

/* 主图容器 - 统一设计 */
.main-image-container {
    height: 400px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: #fafafa;
    border-radius: 12px;
    margin-bottom: 1rem;
    border: 1px solid #f5f5f5;
}

.main-product-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    transition: all 0.15s ease-in-out;
}

/* 缩略图容器 - 统一设计 */
.thumbnail-container {
    height: 100px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: #fafafa;
    border-radius: 8px;
    border: 1px solid #f5f5f5;
}

.thumbnail-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    border: 2px solid transparent;
    border-radius: 6px;
}

.thumbnail-image:hover {
    transform: scale(1.02);
    border-color: #1976d2;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
}

.thumbnail-image.active-thumbnail {
    border: 2px solid #1976d2;
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
}

/* 浏览次数样式 */
#page-views {
    color: #1976d2;
    font-weight: 500;
    transition: color 0.15s ease-in-out;
}

/* 产品标题样式 */
.card-body h2 {
    font-size: 24px;
    font-weight: 700;
    color: #212121;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.card-body .lead {
    font-size: 16px;
    color: #616161;
    font-weight: 400;
    line-height: 1.5;
}

/* 按钮样式统一 */
.btn-primary {
    background-color: #1976d2;
    border-color: #1976d2;
    font-size: 14px;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all 0.15s ease-in-out;
}

.btn-primary:hover {
    background-color: #1565c0;
    border-color: #1565c0;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
}

.btn-outline-primary {
    color: #1976d2;
    border-color: #1976d2;
    font-size: 14px;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
}

.btn-outline-primary:hover {
    background-color: #1976d2;
    border-color: #1976d2;
    color: white;
}

/* 移动端响应式调整 */
@media (max-width: 768px) {
    .main-image-container {
        height: 250px;
    }

    .thumbnail-container {
        height: 80px;
    }

    .card-body h2 {
        font-size: 20px;
    }

    .product-details-list li {
        font-size: 13px;
    }

    .btn-primary, .btn-outline-primary {
        font-size: 13px;
        padding: 0.6rem 1.2rem;
    }
}

/* 更大屏幕的调整 */
@media (min-width: 1400px) {
    .main-image-container {
        height: 450px;
    }
}

/* 应用场景样式 - 统一设计 */
.application-scenarios img {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
}

.application-scenarios h2,
.application-scenarios h3 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #1976d2;
    font-weight: 600;
}

.application-scenarios h2 {
    font-size: 20px;
}

.application-scenarios h3 {
    font-size: 18px;
}

.application-scenarios p {
    line-height: 1.6;
    margin-bottom: 1rem;
    font-size: 14px;
    color: #212121;
}

.application-scenarios ul {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.application-scenarios li {
    margin-bottom: 0.5rem;
    font-size: 14px;
    color: #212121;
    line-height: 1.5;
}
</style>

<script>
// 电话沟通弹窗动态内容处理
document.addEventListener('DOMContentLoaded', function() {
    const phoneContactBtn = document.getElementById('phone-contact-btn');
    const phoneContactModal = document.getElementById('phoneContactModal');

    if (phoneContactBtn && phoneContactModal) {
        phoneContactBtn.addEventListener('click', function() {
            // 获取供应商信息
            const supplierTitle = this.getAttribute('data-supplier-title');
            const contactPerson = this.getAttribute('data-supplier-contact-person');
            const contactPosition = this.getAttribute('data-supplier-position');
            const contactPhone = this.getAttribute('data-supplier-phone');

            // 更新弹窗内容
            const supplierCompanyElement = phoneContactModal.querySelector('#supplier-company');
            const contactPersonElement = phoneContactModal.querySelector('#contact-person');
            const contactPositionElement = phoneContactModal.querySelector('#contact-position');
            const contactPhoneElement = phoneContactModal.querySelector('#contact-phone');
            const callNowBtn = phoneContactModal.querySelector('#call-now-btn');

            // 设置默认值
            const defaultCompany = '维森视觉检测仪器';
            const defaultContact = '客服';
            const defaultPosition = '销售顾问';
            const defaultPhone = '400-000-0000';

            // 更新显示内容
            if (supplierCompanyElement) {
                supplierCompanyElement.textContent = supplierTitle || defaultCompany;
            }

            if (contactPersonElement) {
                contactPersonElement.textContent = contactPerson || defaultContact;
            }

            if (contactPositionElement) {
                contactPositionElement.textContent = contactPosition || defaultPosition;
            }

            if (contactPhoneElement) {
                const displayPhone = contactPhone || defaultPhone;
                contactPhoneElement.textContent = displayPhone;
            }

            // 更新拨打电话链接
            if (callNowBtn) {
                const phoneNumber = contactPhone || defaultPhone;
                // 移除电话号码中的空格和特殊字符，只保留数字
                const cleanPhone = phoneNumber.replace(/\s+/g, '').replace(/[^\d]/g, '');
                callNowBtn.href = 'tel:' + cleanPhone;
            }
        });
    }

    // 处理文件下载链接和图片显示
    document.addEventListener('DOMContentLoaded', function() {
        // 处理产品图片显示
        const productImages = document.querySelectorAll('img[src*="/images/products/"]');
        productImages.forEach(img => {
            const originalSrc = img.src;
            const fileName = originalSrc.split('/').pop();
            const imageKey = `product_image_${fileName}`;
            const storedImage = localStorage.getItem(imageKey);

            if (storedImage) {
                console.log(`📷 从本地存储加载产品图片: ${fileName}`);
                img.src = storedImage;
            }
        });

        const downloadLinks = document.querySelectorAll('.download-link');

        downloadLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const filePath = this.getAttribute('data-file-path');

                // 检查是否是本地存储的文件
                if (filePath && filePath.includes('/uploads/products/')) {
                    const fileName = filePath.split('/').pop();
                    const fileKey = `product_file_${fileName}`;
                    const storedFile = localStorage.getItem(fileKey);

                    if (storedFile) {
                        e.preventDefault(); // 阻止默认链接行为

                        try {
                            const fileData = JSON.parse(storedFile);
                            console.log(`📁 从本地存储下载文件: ${fileName}`);

                            // 创建下载链接
                            const blob = dataURLtoBlob(fileData.data);
                            const url = URL.createObjectURL(blob);

                            // 创建临时下载链接
                            const tempLink = document.createElement('a');
                            tempLink.href = url;
                            tempLink.download = fileData.originalName || fileName;
                            document.body.appendChild(tempLink);
                            tempLink.click();
                            document.body.removeChild(tempLink);

                            // 清理URL对象
                            setTimeout(() => URL.revokeObjectURL(url), 100);

                        } catch (error) {
                            console.error('下载文件失败:', error);
                            // 如果解析失败，使用原始链接
                            window.open(filePath, '_blank');
                        }
                    }
                }
            });
        });
    });

    // 将dataURL转换为Blob的辅助函数
    function dataURLtoBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
    }
});
</script>

{{ end }}