{{ define "main" }}
<div class="container py-5">
    {{ partial "breadcrumbs.html" . }}
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- ä¸»å›¾å®¹å™¨ - å›ºå®šé«˜åº¦ -->
                    <div class="main-image-container">
                        {{ $mainImageSrc := "" }}
                        {{ $mainImageAlt := "äº§å“å›¾ç‰‡" }}
                        {{ if .Params.gallery }}
                            {{ if reflect.IsSlice .Params.gallery }}
                                {{ $firstImage := index .Params.gallery 0 }}
                                {{ if reflect.IsMap $firstImage }}
                                    {{ $mainImageSrc = $firstImage.image }}
                                    {{ $mainImageAlt = $firstImage.alt | default "äº§å“å›¾ç‰‡" }}
                                {{ else }}
                                    {{ $mainImageSrc = $firstImage }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                        {{ if $mainImageSrc }}
                        <img src="{{ $mainImageSrc | relURL }}" class="img-fluid rounded mb-3 main-product-image" alt="{{ $mainImageAlt }}" id="main-product-image">
                        {{ else }}
                        <img src="/images/products/default-product.jpg" class="img-fluid rounded mb-3 main-product-image" alt="ä¸»å›¾å ä½å›¾" id="main-product-image">
                        {{ end }}
                    </div>

                    <!-- ç¼©ç•¥å›¾å®¹å™¨ - å›ºå®šé«˜åº¦ -->
                    <div class="row g-2 thumbnail-gallery">
                        {{ if .Params.gallery }}
                            {{ if reflect.IsSlice .Params.gallery }}
                                {{ $galleryItems := after 1 .Params.gallery }}
                                {{ range first 4 $galleryItems }}
                                    {{ if reflect.IsMap . }}
                                    <div class="col-3">
                                        <div class="thumbnail-container">
                                            <img src="{{ .image | relURL }}"
                                                 class="img-fluid rounded object-fit-cover thumbnail-image"
                                                 alt="{{ .alt | default "äº§å“å›¾ç‰‡" | htmlEscape }}"
                                                 data-image-url="{{ .image | relURL | htmlEscape }}"
                                                 data-image-alt="{{ .alt | default "äº§å“å›¾ç‰‡" | htmlEscape }}"
                                                 data-full-image="{{ .image | relURL | htmlEscape }}"
                                                 onclick="switchMainImageFromData(this)">
                                        </div>
                                    </div>
                                    {{ else }}
                                    <div class="col-3">
                                        <div class="thumbnail-container">
                                            <img src="{{ . | relURL }}"
                                                 class="img-fluid rounded object-fit-cover thumbnail-image"
                                                 alt="äº§å“å›¾ç‰‡"
                                                 data-image-url="{{ . | relURL | htmlEscape }}"
                                                 data-image-alt="äº§å“å›¾ç‰‡"
                                                 data-full-image="{{ . | relURL | htmlEscape }}"
                                                 onclick="switchMainImageFromData(this)">
                                        </div>
                                    </div>
                                    {{ end }}
                                {{ end }}
                            {{ end }}
                        {{ else }}
                        {{ range seq 2 5 }}
                        <div class="col-3">
                            <div class="thumbnail-container">
                                <img src="/images/products/default-gallery-{{ . }}.jpg"
                                     class="img-fluid rounded object-fit-cover thumbnail-image"
                                     alt="å‰¯å›¾å ä½å›¾"
                                     data-image-url="/images/products/default-gallery-{{ . }}.jpg"
                                     data-image-alt="å‰¯å›¾å ä½å›¾"
                                     data-full-image="/images/products/default-gallery-{{ . }}.jpg"
                                     onclick="switchMainImageFromData(this)">
                            </div>
                        </div>
                        {{ end }}
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h2 class="mb-3">{{ .Title }}</h2>
                    {{ with .Params.summary }}
                    <p class="lead text-muted">{{ . }}</p>
                    {{ end }}

                    <!-- äº§å“åˆ†ç±»æ ‡ç­¾ -->
                    <div class="product-categories mb-3">
                        {{ with .Params.primary_category }}
                        <span class="badge bg-dark me-2 mb-1" style="font-size: 0.9rem; padding: 0.5rem 0.8rem;">
                            <i class="fas fa-folder me-1"></i>{{ . }}
                        </span>
                        {{ end }}
                        {{ with .Params.secondary_category }}
                        <span class="badge bg-dark me-2 mb-1" style="font-size: 0.9rem; padding: 0.5rem 0.8rem;">
                            <i class="fas fa-tag me-1"></i>{{ . }}
                        </span>
                        {{ end }}
                    </div>

                    <hr>

                    <ul class="list-unstyled product-details-list">
                        {{ with .Params.product_category }}
                        <li><strong>äº§å“åˆ†ç±»ï¼š</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.product_type }}
                        <li><strong>äº§å“å‹å¼ï¼š</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.model }}
                        <li><strong>å‹å·ï¼š</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.series }}
                        <li><strong>ç³»åˆ—ï¼š</strong> {{ . }}</li>
                        {{ end }}
                        {{ with .Params.supplier }}
                        <li><strong>ä¾›åº”å•†ï¼š</strong>
                            {{ $supplierTitle := . }}
                            {{ $foundSupplier := "" }}
                            {{ range (where site.Pages "Section" "suppliers") }}
                                {{ if eq .Title $supplierTitle }}
                                    {{ $foundSupplier = . }}
                                {{ end }}
                            {{ end }}

                            {{ if $foundSupplier }}
                            <a href="#" data-bs-toggle="modal" data-bs-target="#supplierModal"
                                class="supplier-link"
                                data-supplier-title="{{ $foundSupplier.Title | htmlEscape }}"
                                data-supplier-address="{{ $foundSupplier.Params.address | default "æœªæä¾›" | htmlEscape }}"
                                data-supplier-type="{{ $foundSupplier.Params.type | default "æœªæä¾›" | htmlEscape }}"
                                data-supplier-contact-person="{{ $foundSupplier.Params.contact_person | default "æœªæä¾›" | htmlEscape }}"
                                data-supplier-position="{{ $foundSupplier.Params.position | default "æœªæä¾›" | htmlEscape }}"
                                data-supplier-phone="{{ $foundSupplier.Params.phone | default "æœªæä¾›" | htmlEscape }}"
                                data-supplier-email="{{ $foundSupplier.Params.email | default "æœªæä¾›" | htmlEscape }}"
                                data-supplier-content="{{ ($foundSupplier.Params.description | default "æš‚æ— ç®€ä»‹") | htmlEscape }}"
                                data-supplier-series='{{ $foundSupplier.Params.series | jsonify | safeHTMLAttr }}'
                                data-supplier-models='{{ $foundSupplier.Params.models | jsonify | safeHTMLAttr }}'
                                data-supplier-gallery='{{ $foundSupplier.Params.gallery | jsonify | safeHTMLAttr }}'>
                            {{ $foundSupplier.Title }}
                            </a>            
                            {{ else }}
                                {{ $supplierTitle }}
                            {{ end }}
                        </li>
                        {{ end }}
                        
                        {{ with .Params.published }}
                        <li><strong>å‘å¸ƒæ—¶é—´ï¼š</strong> {{ .Format "2006-01-02" }}</li>
                        {{ end }}
                        <li><strong>æµè§ˆæ¬¡æ•°ï¼š</strong>
                            <span id="page-views">åŠ è½½ä¸­...</span>
                            <!-- ä¸è’œå­ç»Ÿè®¡å¤‡ç”¨æ–¹æ¡ˆ -->
                            <span id="busuanzi_container_page_pv" style="display:none;">
                                (<span id="busuanzi_value_page_pv"></span>)
                            </span>
                        </li>
                        </ul>

                    <div class="mt-4 d-flex gap-3">
                        <button class="btn btn-primary flex-grow-1" id="online-consult-btn">
                            <i class="bi bi-chat-dots-fill me-2"></i>åœ¨çº¿å’¨è¯¢
                        </button>
                        <button class="btn btn-outline-primary flex-grow-1" id="phone-contact-btn" data-bs-toggle="modal" data-bs-target="#phoneContactModal"
                                {{ with .Params.supplier }}
                                {{ $supplierTitle := . }}
                                {{ $foundSupplier := "" }}
                                {{ range (where site.Pages "Section" "suppliers") }}
                                    {{ if eq .Title $supplierTitle }}
                                        {{ $foundSupplier = . }}
                                    {{ end }}
                                {{ end }}
                                {{ if $foundSupplier }}
                                data-supplier-title="{{ $foundSupplier.Title | htmlEscape }}"
                                data-supplier-contact-person="{{ $foundSupplier.Params.contact_person | default "å®¢æœ" | htmlEscape }}"
                                data-supplier-position="{{ $foundSupplier.Params.position | default "é”€å”®é¡¾é—®" | htmlEscape }}"
                                data-supplier-phone="{{ $foundSupplier.Params.phone | default "400-000-0000" | htmlEscape }}"
                                {{ end }}
                                {{ end }}>
                            <i class="bi bi-telephone-fill me-2"></i>ç”µè¯æ²Ÿé€š
                        </button>
                    </div>
                </div>
            </div>

            {{ with .Params.parameters }}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h4 class="card-title mb-0">æ ¸å¿ƒå‚æ•°</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {{ $displayCount := 0 }}
                        {{ range . }}
                            {{ if .group }}
                                {{ range .items }}
                                    {{ if or (eq .name "ä¸»æœºå±å¹•") (eq .name "å¾…æœºæ—¶é•¿") (eq .name "æ¢å¤´ç›´å¾„") (eq .name "åƒç´ ") (eq .name "è§†å‘") (eq .name "å…‰æº") (eq .name "å¯¼å‘") (eq .name "ç®¡çº¿æè´¨") }}
                                        {{ if lt $displayCount 8 }}
                                            <div class="col-6 mb-2">
                                                <strong>{{ .name }}ï¼š</strong> {{ .value }}
                                            </div>
                                            {{ $displayCount = add $displayCount 1 }}
                                        {{ end }}
                                    {{ end }}
                                {{ end }}
                            {{ else }}
                                {{ if or (eq .name "ä¸»æœºå±å¹•") (eq .name "å¾…æœºæ—¶é•¿") (eq .name "æ¢å¤´ç›´å¾„") (eq .name "åƒç´ ") (eq .name "è§†å‘") (eq .name "å…‰æº") (eq .name "å¯¼å‘") (eq .name "ç®¡çº¿æè´¨") }}
                                    {{ if lt $displayCount 8 }}
                                        <div class="col-6 mb-2">
                                            <strong>{{ .name }}ï¼š</strong> {{ .value }}
                                        </div>
                                        {{ $displayCount = add $displayCount 1 }}
                                    {{ end }}
                                {{ end }}
                            {{ end }}
                        {{ end }}
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white p-0">
                    <ul class="nav nav-tabs" id="productTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="intro-tab" data-bs-toggle="tab" data-bs-target="#intro" type="button" role="tab" aria-controls="intro" aria-selected="true">äº§å“ä»‹ç»</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="detailed-specs-tab" data-bs-toggle="tab" data-bs-target="#detailed-specs" type="button" role="tab" aria-controls="detailed-specs" aria-selected="false">è¯¦ç»†å‚æ•°</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="application-tab" data-bs-toggle="tab" data-bs-target="#application" type="button" role="tab" aria-controls="application" aria-selected="false">åº”ç”¨åœºæ™¯</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download" type="button" role="tab" aria-controls="download" aria-selected="false">èµ„æ–™ä¸‹è½½</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="productTabContent">
                        <div class="tab-pane fade show active" id="intro" role="tabpanel" aria-labelledby="intro-tab">
                            <div class="content">
                                {{ .Content }}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="detailed-specs" role="tabpanel" aria-labelledby="detailed-specs-tab">
                            {{ with .Params.parameters }}
                            <table class="table table-bordered detailed-params-table">
                                <tbody>
                                    {{ range . }}
                                        {{ if .group }}
                                            <tr>
                                                <td colspan="2" class="param-group-header"><h6>{{ .group }}</h6></td>
                                            </tr>
                                            {{ range .items }}
                                            <tr>
                                                <td class="param-name">{{ .name }}</td>
                                                <td class="param-value">{{ .value }}</td>
                                            </tr>
                                            {{ end }}
                                        {{ else }}
                                            <tr>
                                                <td class="param-name">{{ .name }}</td>
                                                <td class="param-value">{{ .value }}</td>
                                            </tr>
                                        {{ end }}
                                    {{ end }}
                                </tbody>
                            </table>
                            {{ else }}
                            <p>æš‚æ— è¯¦ç»†å‚æ•°ä¿¡æ¯ã€‚</p>
                            {{ end }}
                        </div>
                        <div class="tab-pane fade" id="application" role="tabpanel" aria-labelledby="application-tab">
                            {{ with .Params.application_scenarios }}
                            <div class="content application-scenarios">
                                {{ . | markdownify }}
                            </div>
                            {{ else }}
                            <p>æš‚æ— åº”ç”¨åœºæ™¯ä¿¡æ¯ã€‚</p>
                            {{ end }}
                        </div>
                        <div class="tab-pane fade" id="download" role="tabpanel" aria-labelledby="download-tab">
                            {{ with .Params.data_download }}
                            <ul class="list-unstyled">
                                {{ range . }}
                                <li>
                                    <a href="{{ .file_path | relURL }}"
                                       target="_blank"
                                       class="download-link"
                                       data-file-path="{{ .file_path }}">
                                        <i class="fas fa-download me-2"></i>{{ .file_title }}
                                    </a>
                                </li>
                                {{ end }}
                            </ul>
                            {{ else }}
                            <p>æš‚æ— èµ„æ–™å¯ä¾›ä¸‹è½½ã€‚</p>
                            {{ end }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{ with .Params.related_products }}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">ç›¸å…³äº§å“</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled row row-cols-1 row-cols-md-3 g-4">
                        {{ range . }}
                        {{ $relatedProduct := site.GetPage (printf "products/%s" .) }}
                        {{ with $relatedProduct }}
                        <li class="col">
                            <a href="{{ .Permalink }}" class="text-decoration-none">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title text-dark">{{ .Title }}</h6>
                                        <p class="card-text text-muted small">{{ .Summary }}</p>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {{ end }}
                        {{ end }}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {{ end }}
</div>

{{ partial "supplier_modal.html" . }}

<div class="modal fade" id="phoneContactModal" tabindex="-1" aria-labelledby="phoneContactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="phoneContactModalLabel">è”ç³»æˆ‘ä»¬</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <h4 class="mb-3">å’¨è¯¢ç”µè¯</h4>
                <div class="mb-3">
                    <p class="fs-6 mb-1 text-muted" id="supplier-company">å…¬å¸åç§°</p>
                    <p class="fs-5 mb-2" id="contact-person">è”ç³»äºº</p>
                    <p class="fs-6 mb-2 text-muted" id="contact-position">èŒåŠ¡</p>
                </div>
                <p class="fs-4 mb-4 fw-bold" id="contact-phone">ç”µè¯å·ç </p>
                <p class="text-muted">å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 08:00-18:00</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <a href="tel:" class="btn btn-primary" id="call-now-btn">ç«‹å³æ‹¨æ‰“</a>
            </div>
        </div>
    </div>
</div>

<!-- é¡µé¢æ•°æ®å­˜å‚¨ -->
<div id="page-data"
     data-current-path="{{ .RelPermalink | htmlEscape }}"
     data-page-title="{{ .Title | htmlEscape }}"
     style="display: none;"></div>

<!-- ä¿®å¤æµè§ˆæ¬¡æ•°çš„JavaScript -->
<script>
// é˜²æ­¢é‡å¤åˆå§‹åŒ–çš„æ ‡è®°
let isInitialized = false;
let pageViewsElement;
// é¡µé¢ä¿¡æ¯å˜é‡
let currentPath = '';
let pageTitle = '';

// è·å–é¡µé¢ä¿¡æ¯çš„å‡½æ•°
function getPageData() {
    const pageData = document.getElementById('page-data');
    if (pageData) {
        currentPath = pageData.dataset.currentPath;
        pageTitle = pageData.dataset.pageTitle;
        return true;
    }
    return false;
}

// LeanCloudé…ç½®
const LC_APP_ID = 'pUEgNUJ66pc7S4FqVpqxkTkx-MdYXbMMI';
const LC_APP_KEY = 'K9OXRf3L6Zp0s6TEzJElWQ5r';

function initPageViews() {
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (isInitialized) {
        console.log('é¡µé¢è®¿é—®ç»Ÿè®¡å·²åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
        return;
    }

    // è·å–é¡µé¢æ•°æ®
    if (!getPageData()) {
        console.error('æ— æ³•è·å–é¡µé¢æ•°æ®ï¼Œå»¶è¿Ÿé‡è¯•');
        setTimeout(initPageViews, 500);
        return;
    }

    pageViewsElement = document.getElementById('page-views');
    if (!pageViewsElement) {
        console.log('æœªæ‰¾åˆ°é¡µé¢è®¿é—®ç»Ÿè®¡å…ƒç´ ');
        return;
    }

    console.log('åˆå§‹åŒ–é¡µé¢è®¿é—®ç»Ÿè®¡, è·¯å¾„:', currentPath);
    isInitialized = true;

    // åªä½¿ç”¨LeanCloudç›´æ¥APIæ–¹å¼ï¼Œé¿å…Valineå†²çª
    initLeanCloudViews();
}

function initLeanCloudViews() {
    // æ£€æŸ¥pageViewsElementæ˜¯å¦å­˜åœ¨
    if (!pageViewsElement) {
        console.error('pageViewsElementæœªåˆå§‹åŒ–ï¼Œæ— æ³•æ˜¾ç¤ºæµè§ˆæ¬¡æ•°');
        return;
    }

    console.log('å¼€å§‹åˆå§‹åŒ–æµè§ˆæ¬¡æ•°ç»Ÿè®¡ï¼Œè·¯å¾„:', currentPath);

    // é¦–å…ˆå°è¯•LeanCloudï¼Œå¤±è´¥åä½¿ç”¨æœ¬åœ°å­˜å‚¨
    tryLeanCloudFirst();
}

function tryLeanCloudFirst() {
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';
    const queryUrl = url + '?where=' + encodeURIComponent(JSON.stringify({url: currentPath}));

    console.log('å°è¯•è¿æ¥LeanCloud:', queryUrl);

    // è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º5ç§’
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);

    fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        },
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        console.log('LeanCloudå“åº”çŠ¶æ€:', response.status, response.statusText);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('LeanCloudè¿æ¥æˆåŠŸï¼ŒæŸ¥è¯¢ç»“æœ:', data);

        if (data.results && data.results.length > 0) {
            const record = data.results[0];
            const currentViews = record.time || 0;
            const newViews = currentViews + 1;

            // æ˜¾ç¤ºå½“å‰æµè§ˆæ¬¡æ•°
            pageViewsElement.textContent = newViews.toString();

            // æ›´æ–°LeanCloudè®°å½•
            updateLeanCloudCounter(record.objectId, newViews);
        } else {
            // åˆ›å»ºæ–°è®°å½•
            createLeanCloudCounter(1);
            pageViewsElement.textContent = '1';
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('LeanCloudè¿æ¥å¤±è´¥:', error.message);

        if (error.name === 'AbortError') {
            console.log('LeanCloudè¿æ¥è¶…æ—¶ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
        } else {
            console.log('LeanCloudç½‘ç»œé”™è¯¯ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
        }

        // å›é€€åˆ°æœ¬åœ°å­˜å‚¨
        initLocalPageViews();
    });
}

function initLocalPageViews() {
    try {
        // è·å–å½“å‰é¡µé¢çš„æµè§ˆæ¬¡æ•°
        const storageKey = 'pageviews_' + currentPath.replace(/[^a-zA-Z0-9]/g, '_');
        let currentViews = parseInt(localStorage.getItem(storageKey) || '0');

        // å¢åŠ æµè§ˆæ¬¡æ•°
        currentViews += 1;

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem(storageKey, currentViews.toString());

        // æ˜¾ç¤ºæµè§ˆæ¬¡æ•°
        pageViewsElement.textContent = currentViews.toString();

        console.log('æœ¬åœ°æµè§ˆæ¬¡æ•°ç»Ÿè®¡æˆåŠŸï¼Œå½“å‰æ¬¡æ•°:', currentViews);

        // å¯é€‰ï¼šåŒæ—¶å°è¯•åŒæ­¥åˆ°LeanCloudï¼ˆä¸é˜»å¡æ˜¾ç¤ºï¼‰
        tryLeanCloudSync(currentViews);

    } catch (error) {
        console.error('æœ¬åœ°æµè§ˆæ¬¡æ•°ç»Ÿè®¡å¤±è´¥:', error);
        // æ˜¾ç¤ºé»˜è®¤å€¼
        pageViewsElement.textContent = '1';
    }
}

function tryLeanCloudSync(views) {
    // å¼‚æ­¥å°è¯•åŒæ­¥åˆ°LeanCloudï¼Œä¸å½±å“æœ¬åœ°æ˜¾ç¤º
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';
    const queryUrl = url + '?where=' + encodeURIComponent(JSON.stringify({url: currentPath}));

    fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.results && data.results.length > 0) {
            // æ›´æ–°ç°æœ‰è®°å½•
            const record = data.results[0];
            updateLeanCloudCounter(record.objectId, views);
        } else {
            // åˆ›å»ºæ–°è®°å½•
            createLeanCloudCounter(views);
        }
    })
    .catch(error => {
        console.log('LeanCloudåŒæ­¥å¤±è´¥ï¼ˆä¸å½±å“æœ¬åœ°ç»Ÿè®¡ï¼‰:', error.message);
    });
}

function createLeanCloudCounter(views) {
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';

    const requestBody = {
        url: currentPath,
        title: pageTitle,
        time: views,
        createdAt: new Date().toISOString()
    };

    fetch(url, {
        method: 'POST',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('LeanCloudåˆ›å»ºæˆåŠŸ:', data);
    })
    .catch(error => {
        console.log('LeanCloudåˆ›å»ºå¤±è´¥:', error.message);
    });
}

function fetchCurrentViews() {
    const url = 'https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter';
    const queryUrl = url + '?where=' + encodeURIComponent(JSON.stringify({url: currentPath}));

    fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.results && data.results.length > 0) {
            const record = data.results[0];
            const currentViews = record.time || 0;
            pageViewsElement.textContent = currentViews.toString();
        } else {
            pageViewsElement.textContent = '0';
        }
    })
    .catch(error => {
        console.error('è·å–æµè§ˆæ¬¡æ•°å¤±è´¥:', error);
        pageViewsElement.textContent = '0';
    });
}

function updateLeanCloudCounter(objectId, views) {
    const url = `https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter/${objectId}`;

    const requestBody = {
        time: views,
        updatedAt: new Date().toISOString()
    };

    fetch(url, {
        method: 'PUT',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('LeanCloudæ›´æ–°æˆåŠŸ:', data);
    })
    .catch(error => {
        console.log('LeanCloudæ›´æ–°å¤±è´¥:', error.message);
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– - åªåˆå§‹åŒ–ä¸€æ¬¡
document.addEventListener('DOMContentLoaded', function() {
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    setTimeout(initPageViews, 1000);

    // åˆå§‹åŒ–ä¸è’œå­ç»Ÿè®¡å¤‡ç”¨æ–¹æ¡ˆ
    setTimeout(initBusuanziBackup, 2000);
});

// ä¸è’œå­ç»Ÿè®¡å¤‡ç”¨æ–¹æ¡ˆ
function initBusuanziBackup() {
    // æ£€æŸ¥LeanCloudæ˜¯å¦å·¥ä½œæ­£å¸¸
    const pageViewsElement = document.getElementById('page-views');
    const busuanziContainer = document.getElementById('busuanzi_container_page_pv');

    if (pageViewsElement && (pageViewsElement.textContent === 'ç½‘ç»œé”™è¯¯' || pageViewsElement.textContent === 'åŠ è½½ä¸­...')) {
        console.log('LeanCloudç»Ÿè®¡å¤±è´¥ï¼Œå¯ç”¨ä¸è’œå­ç»Ÿè®¡å¤‡ç”¨æ–¹æ¡ˆ');

        // æ˜¾ç¤ºä¸è’œå­ç»Ÿè®¡
        if (busuanziContainer) {
            busuanziContainer.style.display = 'inline';
        }

        // åŠ è½½ä¸è’œå­ç»Ÿè®¡è„šæœ¬
        if (!document.querySelector('script[src*="busuanzi"]')) {
            const script = document.createElement('script');
            script.async = true;
            script.src = '//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js';
            document.head.appendChild(script);

            // ç›‘å¬ä¸è’œå­åŠ è½½å®Œæˆ
            script.onload = function() {
                console.log('ä¸è’œå­ç»Ÿè®¡åŠ è½½æˆåŠŸ');
                // éšè—åŸæ¥çš„é”™è¯¯æç¤º
                pageViewsElement.style.display = 'none';
            };
        }
    }
}
</script>

<!-- ä¸è’œå­ç»Ÿè®¡è„šæœ¬ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰ -->
<script>
// å¦‚æœéœ€è¦ç«‹å³å¯ç”¨ä¸è’œå­ç»Ÿè®¡ï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Š
// document.write('<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"><\/script>');
</script>

<script>
function switchMainImage(imageUrl, altText) {
    const mainImage = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    
    if (mainImage) {
        mainImage.src = imageUrl;
        mainImage.alt = altText;
    }

    // é«˜äº®å½“å‰é€‰ä¸­çš„ç¼©ç•¥å›¾
    thumbnails.forEach(thumbnail => {
        if (thumbnail.src === imageUrl) {
            thumbnail.classList.add('active-thumbnail');
        } else {
            thumbnail.classList.remove('active-thumbnail');
        }
    });
}

// ä»dataå±æ€§è·å–æ•°æ®å¹¶åˆ‡æ¢ä¸»å›¾
function switchMainImageFromData(element) {
    const imageUrl = element.dataset.imageUrl;
    const altText = element.dataset.imageAlt;
    switchMainImage(imageUrl, altText);
}

// ä¸ºç¼©ç•¥å›¾æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('.thumbnail-image');
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const imageUrl = this.getAttribute('data-full-image') || this.src;
            const altText = this.alt;
            switchMainImage(imageUrl, altText);
        });
    });
});
</script>

<style>
/* äº§å“é¡µé¢æ ·å¼ - ç»Ÿä¸€è®¾è®¡ */
.product-details-list li {
    margin-bottom: 0.75rem;
    font-size: 14px;
    line-height: 1.5;
    color: #212121;
}

.product-details-list strong {
    color: #616161;
    font-weight: 500;
}

.content img {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
}

.content p {
    line-height: 1.6;
    margin-bottom: 1.5rem;
    font-size: 14px;
    color: #212121;
}

.content h2, .content h3, .content h4 {
    color: #1976d2;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

.nav-tabs .nav-link {
    font-size: 14px;
    font-weight: 500;
    color: #616161;
    border-radius: 8px 8px 0 0;
    transition: all 0.15s ease-in-out;
}

.nav-tabs .nav-link.active {
    border-color: #e0e0e0 #e0e0e0 #fff;
    background-color: #fff;
    color: #1976d2;
}

.nav-tabs .nav-link:hover {
    color: #1976d2;
    background-color: rgba(25, 118, 210, 0.05);
}

.detailed-params-table {
    font-size: 14px;
}

.detailed-params-table .param-name {
    background-color: #fafafa;
    width: 30%;
    font-weight: 500;
    color: #616161;
    padding: 0.75rem;
}

.detailed-params-table .param-value {
    background-color: #ffffff;
    color: #212121;
    padding: 0.75rem;
}

.detailed-params-table .param-group-header {
    background-color: #f5f5f5;
    font-weight: 600;
    text-align: center;
    color: #1976d2;
    padding: 1rem;
}

.detailed-params-table .param-group-header h6 {
    margin: 0;
    font-size: 16px;
}

/* ä¸»å›¾å®¹å™¨ - ç»Ÿä¸€è®¾è®¡ */
.main-image-container {
    height: 400px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: #fafafa;
    border-radius: 12px;
    margin-bottom: 1rem;
    border: 1px solid #f5f5f5;
}

.main-product-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    transition: all 0.15s ease-in-out;
}

/* ç¼©ç•¥å›¾å®¹å™¨ - ç»Ÿä¸€è®¾è®¡ */
.thumbnail-container {
    height: 100px;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background-color: #fafafa;
    border-radius: 8px;
    border: 1px solid #f5f5f5;
}

.thumbnail-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    border: 2px solid transparent;
    border-radius: 6px;
}

.thumbnail-image:hover {
    transform: scale(1.02);
    border-color: #1976d2;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
}

.thumbnail-image.active-thumbnail {
    border: 2px solid #1976d2;
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
}

/* æµè§ˆæ¬¡æ•°æ ·å¼ */
#page-views {
    color: #1976d2;
    font-weight: 500;
    transition: color 0.15s ease-in-out;
}

/* äº§å“æ ‡é¢˜æ ·å¼ */
.card-body h2 {
    font-size: 24px;
    font-weight: 700;
    color: #212121;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.card-body .lead {
    font-size: 16px;
    color: #616161;
    font-weight: 400;
    line-height: 1.5;
}

/* æŒ‰é’®æ ·å¼ç»Ÿä¸€ */
.btn-primary {
    background-color: #1976d2;
    border-color: #1976d2;
    font-size: 14px;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    transition: all 0.15s ease-in-out;
}

.btn-primary:hover {
    background-color: #1565c0;
    border-color: #1565c0;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
}

.btn-outline-primary {
    color: #1976d2;
    border-color: #1976d2;
    font-size: 14px;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
}

.btn-outline-primary:hover {
    background-color: #1976d2;
    border-color: #1976d2;
    color: white;
}

/* ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .main-image-container {
        height: 250px;
    }

    .thumbnail-container {
        height: 80px;
    }

    .card-body h2 {
        font-size: 20px;
    }

    .product-details-list li {
        font-size: 13px;
    }

    .btn-primary, .btn-outline-primary {
        font-size: 13px;
        padding: 0.6rem 1.2rem;
    }
}

/* æ›´å¤§å±å¹•çš„è°ƒæ•´ */
@media (min-width: 1400px) {
    .main-image-container {
        height: 450px;
    }
}

/* åº”ç”¨åœºæ™¯æ ·å¼ - ç»Ÿä¸€è®¾è®¡ */
.application-scenarios img {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
}

.application-scenarios h2,
.application-scenarios h3 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #1976d2;
    font-weight: 600;
}

.application-scenarios h2 {
    font-size: 20px;
}

.application-scenarios h3 {
    font-size: 18px;
}

.application-scenarios p {
    line-height: 1.6;
    margin-bottom: 1rem;
    font-size: 14px;
    color: #212121;
}

.application-scenarios ul {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}

.application-scenarios li {
    margin-bottom: 0.5rem;
    font-size: 14px;
    color: #212121;
    line-height: 1.5;
}
</style>

<script>
// ç”µè¯æ²Ÿé€šå¼¹çª—åŠ¨æ€å†…å®¹å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    const phoneContactBtn = document.getElementById('phone-contact-btn');
    const phoneContactModal = document.getElementById('phoneContactModal');

    if (phoneContactBtn && phoneContactModal) {
        phoneContactBtn.addEventListener('click', function() {
            // è·å–ä¾›åº”å•†ä¿¡æ¯
            const supplierTitle = this.getAttribute('data-supplier-title');
            const contactPerson = this.getAttribute('data-supplier-contact-person');
            const contactPosition = this.getAttribute('data-supplier-position');
            const contactPhone = this.getAttribute('data-supplier-phone');

            // æ›´æ–°å¼¹çª—å†…å®¹
            const supplierCompanyElement = phoneContactModal.querySelector('#supplier-company');
            const contactPersonElement = phoneContactModal.querySelector('#contact-person');
            const contactPositionElement = phoneContactModal.querySelector('#contact-position');
            const contactPhoneElement = phoneContactModal.querySelector('#contact-phone');
            const callNowBtn = phoneContactModal.querySelector('#call-now-btn');

            // è®¾ç½®é»˜è®¤å€¼
            const defaultCompany = 'ç»´æ£®è§†è§‰æ£€æµ‹ä»ªå™¨';
            const defaultContact = 'å®¢æœ';
            const defaultPosition = 'é”€å”®é¡¾é—®';
            const defaultPhone = '400-000-0000';

            // æ›´æ–°æ˜¾ç¤ºå†…å®¹
            if (supplierCompanyElement) {
                supplierCompanyElement.textContent = supplierTitle || defaultCompany;
            }

            if (contactPersonElement) {
                contactPersonElement.textContent = contactPerson || defaultContact;
            }

            if (contactPositionElement) {
                contactPositionElement.textContent = contactPosition || defaultPosition;
            }

            if (contactPhoneElement) {
                const displayPhone = contactPhone || defaultPhone;
                contactPhoneElement.textContent = displayPhone;
            }

            // æ›´æ–°æ‹¨æ‰“ç”µè¯é“¾æ¥
            if (callNowBtn) {
                const phoneNumber = contactPhone || defaultPhone;
                // ç§»é™¤ç”µè¯å·ç ä¸­çš„ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼Œåªä¿ç•™æ•°å­—
                const cleanPhone = phoneNumber.replace(/\s+/g, '').replace(/[^\d]/g, '');
                callNowBtn.href = 'tel:' + cleanPhone;
            }
        });
    }

    // å¤„ç†æ–‡ä»¶ä¸‹è½½é“¾æ¥å’Œå›¾ç‰‡æ˜¾ç¤º
    document.addEventListener('DOMContentLoaded', function() {
        // å¤„ç†äº§å“å›¾ç‰‡æ˜¾ç¤º
        const productImages = document.querySelectorAll('img[src*="/images/products/"]');
        productImages.forEach(img => {
            const originalSrc = img.src;
            const fileName = originalSrc.split('/').pop();
            const imageKey = `product_image_${fileName}`;
            const storedImage = localStorage.getItem(imageKey);

            if (storedImage) {
                console.log(`ğŸ“· ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº§å“å›¾ç‰‡: ${fileName}`);
                img.src = storedImage;
            }
        });

        const downloadLinks = document.querySelectorAll('.download-link');

        downloadLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const filePath = this.getAttribute('data-file-path');

                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°å­˜å‚¨çš„æ–‡ä»¶
                if (filePath && filePath.includes('/uploads/products/')) {
                    const fileName = filePath.split('/').pop();
                    const fileKey = `product_file_${fileName}`;
                    const storedFile = localStorage.getItem(fileKey);

                    if (storedFile) {
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤é“¾æ¥è¡Œä¸º

                        try {
                            const fileData = JSON.parse(storedFile);
                            console.log(`ğŸ“ ä»æœ¬åœ°å­˜å‚¨ä¸‹è½½æ–‡ä»¶: ${fileName}`);

                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const blob = dataURLtoBlob(fileData.data);
                            const url = URL.createObjectURL(blob);

                            // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
                            const tempLink = document.createElement('a');
                            tempLink.href = url;
                            tempLink.download = fileData.originalName || fileName;
                            document.body.appendChild(tempLink);
                            tempLink.click();
                            document.body.removeChild(tempLink);

                            // æ¸…ç†URLå¯¹è±¡
                            setTimeout(() => URL.revokeObjectURL(url), 100);

                        } catch (error) {
                            console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                            // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é“¾æ¥
                            window.open(filePath, '_blank');
                        }
                    }
                }
            });
        });
    });

    // å°†dataURLè½¬æ¢ä¸ºBlobçš„è¾…åŠ©å‡½æ•°
    function dataURLtoBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
    }
});
</script>

{{ end }}