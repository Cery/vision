{{ define "main" }}
<div class="container py-5">
    {{ partial "breadcrumbs.html" . }}

    <div class="row">
        <!-- ç­›é€‰ä¾§è¾¹æ  -->
        <div class="col-lg-3 col-md-4 mb-3 mb-md-4">
            <div class="card shadow-sm news-sidebar-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>ç­›é€‰æ¡ä»¶</h5>
                </div>
                <div class="card-body">
                    <!-- èµ„è®¯åˆ†ç±»ç­›é€‰ -->
                    <div class="mb-4">
                        <h6 class="filter-section-title">
                            <i class="fas fa-folder-open me-2"></i>èµ„è®¯åˆ†ç±»
                        </h6>
                        <div class="filter-buttons-container" id="category-filters">
                            <a href="javascript:void(0)" class="filter-btn active" data-filter-type="category" data-filter-value="">
                                å…¨éƒ¨
                            </a>
                            {{ $newsPages := where .Site.RegularPages "Type" "news" }}
                            {{ $newsCategories := dict }}
                            {{ range $newsPages }}
                                {{ range .Params.categories }}
                                    {{ $newsCategories = merge $newsCategories (dict . (add (index $newsCategories . | default 0) 1)) }}
                                {{ end }}
                            {{ end }}
                            {{ range $category, $count := $newsCategories }}
                            <a href="javascript:void(0)" class="filter-btn" data-filter-type="category" data-filter-value="{{ $category }}">
                                {{ $category }} <span class="badge bg-light text-dark">{{ $count }}</span>
                            </a>
                            {{ end }}
                        </div>
                    </div>

                    <!-- æ ‡ç­¾ç­›é€‰ -->
                    <div class="mb-4">
                        <h6 class="filter-section-title">
                            <i class="fas fa-tags me-2"></i>çƒ­é—¨æ ‡ç­¾
                        </h6>
                        <div class="filter-buttons-container" id="tag-filters">
                            {{ $newsTags := dict }}
                            {{ range $newsPages }}
                                {{ range .Params.tags }}
                                    {{ $newsTags = merge $newsTags (dict . (add (index $newsTags . | default 0) 1)) }}
                                {{ end }}
                            {{ end }}
                            {{ $sortedTags := slice }}
                            {{ range $tag, $count := $newsTags }}
                                {{ $sortedTags = $sortedTags | append (dict "tag" $tag "count" $count) }}
                            {{ end }}
                            {{ $sortedTags = sort $sortedTags "count" "desc" }}
                            {{ range first 10 $sortedTags }}
                            <a href="javascript:void(0)" class="filter-btn tag-btn" data-filter-type="tag" data-filter-value="{{ .tag }}">
                                {{ .tag }} <span class="badge bg-light text-dark">{{ .count }}</span>
                            </a>
                            {{ end }}
                        </div>
                    </div>

                    <!-- æ¸…é™¤ç­›é€‰ -->
                    <div class="text-center">
                        <button class="btn btn-outline-secondary btn-sm" id="clearAllFilters">
                            <i class="fas fa-times me-1"></i>æ¸…é™¤å…¨éƒ¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- å·²é€‰ç­›é€‰é¡¹æ˜¾ç¤º -->
            <div class="card shadow-sm mt-3" id="selected-filters-card" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>å·²é€‰æ¡ä»¶</h6>
                </div>
                <div class="card-body">
                    <div id="selected-filters-container" class="d-flex flex-wrap gap-2">
                        <!-- å·²é€‰ç­›é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- èµ„è®¯åˆ—è¡¨ -->
        <div class="col-lg-9 col-md-8">
            <!-- ç­›é€‰ç»“æœä¿¡æ¯å’Œæ’åº -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <small class="text-muted" id="news-count-info">å…± {{ len $newsPages }} ç¯‡èµ„è®¯</small>
                </div>
                <div class="d-flex align-items-center">
                    <label for="sortOrder" class="form-label me-2 mb-0">æ’åºï¼š</label>
                    <select class="form-select form-select-sm" id="sortOrder" style="width: auto;">
                        <option value="date-desc">æœ€æ–°å‘å¸ƒ</option>
                        <option value="date-asc">æœ€æ—©å‘å¸ƒ</option>
                        <option value="views">æœ€å¤šæµè§ˆ</option>
                    </select>
                </div>
            </div>

            <!-- èµ„è®¯å¡ç‰‡å®¹å™¨ -->
            <div class="row" id="newsList">
                {{ $allNews := where .Site.RegularPages "Type" "news" }}
                {{ range $index, $page := $allNews }}
                <div class="col-12 col-sm-6 col-lg-6 col-xl-4 mb-3 mb-md-4 news-item"
                     data-categories="{{ delimit (.Params.categories | default (slice)) "," }}"
                     data-tags="{{ delimit (.Params.tags | default (slice)) "," | safeHTMLAttr }}"
                     data-date="{{ .Date.Format "2006-01-02" }}"
                     data-views="{{ .Params.views | default 0 }}"
                     data-permalink="{{ .RelPermalink }}"
                     data-title="{{ .Title }}">
                    <div class="card h-100 shadow-sm news-card">
                        <div class="card-img-wrapper">
                            {{ with .Params.featured_image }}
                            <img src="{{ . | relURL }}" class="card-img-top object-fit-cover" alt="{{ $page.Title }}" style="height: 200px;">
                            {{ else }}
                            {{ $newsImages := slice "/images/news/news-1.jpeg" "/images/news/news-2.jpeg" "/images/news/news-3.jpeg" "/images/news/news-4.jpeg" "/images/news/news-5.jpeg" "/images/news/news-6.jpeg" }}
                            <img src="{{ index $newsImages (mod $index 6) }}" class="card-img-top object-fit-cover" alt="{{ $page.Title }}" style="height: 200px;">
                            {{ end }}
                            <div class="card-img-overlay d-flex align-items-end">
                                <div class="w-100 text-end mb-3">
                                    <a href="{{ .Permalink }}" class="btn btn-primary btn-sm">é˜…è¯»å…¨æ–‡</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="mb-2">
                                {{ range .Params.categories }}
                                <span class="badge bg-primary me-1">{{ . }}</span>
                                {{ end }}
                                {{ range .Params.tags }}
                                <span class="badge bg-secondary me-1">{{ . }}</span>
                                {{ end }}
                            </div>
                            <h5 class="card-title">
                                <a href="{{ .Permalink }}" class="text-decoration-none text-dark hover-primary">{{ .Title }}</a>
                            </h5>
                            {{ with .Params.summary }}
                            <p class="card-text text-muted flex-grow-1">{{ . }}</p>
                            {{ end }}
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted"><i class="far fa-calendar-alt me-1"></i>{{ .Date.Format "2006-01-02" }}</small>
                                        {{ if .Params.author }}
                                        <small class="text-muted ms-2"><i class="far fa-user me-1"></i>{{ .Params.author }}</small>
                                        {{ end }}
                                    </div>
                                    <div>
                                        <small class="text-muted"><i class="fas fa-eye me-1"></i><span class="view-count-display">{{ .Params.views | default 0 }}</span></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{ end }}
            </div>

            <!-- æ— ç»“æœæç¤º -->
            <div id="no-news-message" class="text-center py-5" style="display: none;">
                <div class="text-muted">
                    <i class="fas fa-search fa-3x mb-3"></i>
                    <h5>æœªæ‰¾åˆ°åŒ¹é…çš„èµ„è®¯</h5>
                    <p>è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                </div>
            </div>

            <!-- å¢å¼ºç‰ˆåˆ†é¡µ -->
            {{ partial "enhanced-pagination.html" (dict "context" . "containerId" "newsList" "itemsPerPage" 6 "itemType" "èµ„è®¯") }}
        </div>
    </div>

</div>

<style>
/* æ–°é—»åˆ—è¡¨é¡µé¢æ ·å¼ - å·¦ä¾§è¾¹æ å¸ƒå±€ */
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
}

/* ä¾§è¾¹æ æ ·å¼ */
.news-sidebar-card {
    border: 1px solid #f5f5f5;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    position: sticky;
    top: 20px;
}

.news-sidebar-card .card-header {
    background: linear-gradient(135deg, #1976d2, #42a5f5) !important;
    border-bottom: none;
    border-radius: 12px 12px 0 0 !important;
}

.news-sidebar-card .card-header h5 {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

/* ç­›é€‰å™¨æ ·å¼ */
.filter-section-title {
    color: #1976d2;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #1976d2;
}

.filter-buttons-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-btn {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #ffffff;
    color: #616161;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.15s ease-in-out;
}

.filter-btn:hover {
    background-color: #f5f5f5;
    border-color: #1976d2;
    color: #1976d2;
    text-decoration: none;
}

.filter-btn.active {
    background-color: #1976d2;
    border-color: #1976d2;
    color: white;
}

.filter-btn .badge {
    font-size: 11px;
    padding: 0.2rem 0.4rem;
}

.filter-btn.active .badge {
    background-color: rgba(255, 255, 255, 0.2) !important;
    color: white !important;
}

.tag-btn {
    font-size: 13px;
    padding: 0.4rem 0.6rem;
}

/* å·²é€‰ç­›é€‰é¡¹å¡ç‰‡ */
#selected-filters-card .card-header {
    background: linear-gradient(135deg, #17a2b8, #20c997) !important;
    border-radius: 12px 12px 0 0 !important;
}

#selected-filters-card .card-header h6 {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
}

.selected-filter-tag {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.selected-filter-tag .remove-filter {
    cursor: pointer;
    font-weight: bold;
    margin-left: 0.25rem;
}

.selected-filter-tag .remove-filter:hover {
    color: #d32f2f;
}

/* æ–°é—»å¡ç‰‡æ ·å¼ */
.news-card {
    transition: all 0.15s ease-in-out;
    border: 1px solid #f5f5f5;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    overflow: hidden;
}

.news-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.06);
}

.card-img-wrapper {
    position: relative;
    overflow: hidden;
}

.card-img-top {
    transition: all 0.15s ease-in-out;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
}

.news-card:hover .card-img-top {
    transform: scale(1.02);
}

.card-img-overlay {
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    opacity: 0;
    transition: opacity 0.15s ease-in-out;
}

.news-card:hover .card-img-overlay {
    opacity: 1;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    line-height: 1.4;
    color: #212121;
    margin-bottom: 0.75rem;
}

.card-title a {
    color: #212121;
    transition: color 0.15s ease-in-out;
}

.card-title a:hover {
    color: #1976d2;
    text-decoration: none;
}

.card-text {
    font-size: 14px;
    color: #757575;
    line-height: 1.5;
}

/* å¾½ç« æ ·å¼ */
.badge {
    font-weight: 500;
    padding: 0.3rem 0.6rem;
    border-radius: 8px;
    font-size: 12px;
}

.badge.bg-primary {
    background-color: #1976d2 !important;
}

.badge.bg-secondary {
    background-color: #616161 !important;
}

/* å…ƒä¿¡æ¯æ ·å¼ */
.text-muted.small,
small.text-muted {
    font-size: 12px;
    color: #9e9e9e;
}

.text-muted.small i,
small.text-muted i {
    margin-right: 0.25rem;
}

/* é€šç”¨æ‚¬åœæ•ˆæœ */
.hover-primary:hover {
    color: #1976d2 !important;
    transition: color 0.15s ease-in-out;
}

/* æŒ‰é’®æ ·å¼ */
.btn-outline-primary {
    color: #1976d2;
    border-color: #1976d2;
    font-size: 14px;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.15s ease-in-out;
}

.btn-outline-primary:hover {
    background-color: #1976d2;
    border-color: #1976d2;
    color: white;
}

.btn-outline-secondary {
    color: #616161;
    border-color: #e0e0e0;
    font-size: 14px;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.15s ease-in-out;
}

.btn-outline-secondary:hover {
    background-color: #616161;
    border-color: #616161;
    color: white;
}

/* æ—§çš„åˆ†é¡µæ ·å¼å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¢å¼ºç‰ˆåˆ†é¡µç»„ä»¶çš„æ ·å¼ */

/* ç­›é€‰æŒ‰é’®æ¿€æ´»çŠ¶æ€ */
.btn-outline-primary.active,
.btn-outline-secondary.active {
    color: white;
    font-weight: 600;
}

.btn-outline-primary.active {
    background-color: #1976d2;
    border-color: #1976d2;
}

.btn-outline-secondary.active {
    background-color: #616161;
    border-color: #616161;
}

/* å•é€‰æŒ‰é’®æ ·å¼ */
.btn-check:checked + .btn-outline-secondary {
    color: white;
    background-color: #616161;
    border-color: #616161;
}

/* ç­›é€‰å¡ç‰‡æ ·å¼ */
.news-filters-card {
    border: 1px solid #f5f5f5;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
}

.selected-filters-card {
    border: 1px solid #e3f2fd;
    border-radius: 12px;
    background-color: rgba(25, 118, 210, 0.05);
}

.selected-filters-label {
    font-size: 14px;
    font-weight: 500;
    color: #1976d2;
}

.selected-filters-label i {
    color: #1976d2;
}

/* ç­›é€‰åŒºåŸŸæ ‡é¢˜ */
.filter-section-title {
    font-size: 16px;
    font-weight: 600;
    color: #212121;
    margin-bottom: 1rem;
}

.filter-section-title i {
    margin-right: 0.5rem;
    color: #1976d2;
    font-size: 14px;
}

.filter-section-divider {
    border-color: #f5f5f5;
    margin: 1.5rem 0;
}

/* æ— ç»“æœæç¤º */
#no-news-message {
    font-size: 16px;
    color: #9e9e9e;
}

#no-news-message i {
    color: #e0e0e0;
}

/* åˆ†é¡µä¿¡æ¯ */
#newsPaginationInfo {
    font-size: 14px;
    color: #757575;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 992px) {
    .news-sidebar {
        margin-top: 2rem;
    }
}

@media (max-width: 768px) {
    .filter-section-title {
        font-size: 14px;
    }

    .card-title {
        font-size: 14px;
    }

    .card-text {
        font-size: 13px;
    }

    .badge {
        font-size: 11px;
        padding: 0.2rem 0.4rem;
    }

    .btn-outline-primary,
    .btn-outline-secondary {
        font-size: 13px;
        padding: 0.4rem 0.8rem;
    }

    .text-muted.small {
        font-size: 11px;
    }

    .pagination .page-link {
        font-size: 13px;
        padding: 0.4rem 0.6rem;
    }

    .selected-filters-label {
        font-size: 13px;
    }

    .news-item {
        margin-bottom: 1rem;
    }

    .news-item .card {
        border-radius: 8px;
    }

    .news-item .card-img-top {
        height: 180px;
    }
}

@media (max-width: 576px) {
    .news-sidebar {
        padding: 1rem;
        margin-top: 1rem;
    }

    .filter-section-title {
        font-size: 13px;
        margin-bottom: 0.75rem;
    }

    .card-title {
        font-size: 13px;
        line-height: 1.3;
    }

    .card-text {
        font-size: 12px;
        line-height: 1.4;
    }

    .news-item .card-img-top {
        height: 160px;
    }

    .news-item .card-body {
        padding: 0.75rem;
    }

    .btn-outline-primary,
    .btn-outline-secondary {
        font-size: 12px;
        padding: 0.3rem 0.6rem;
    }

    .badge {
        font-size: 10px;
        padding: 0.15rem 0.3rem;
    }

    .selected-filters {
        flex-wrap: wrap;
        gap: 0.25rem;
    }

    .selected-filter-item {
        font-size: 11px;
        padding: 0.2rem 0.4rem;
    }
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(2px);
}

.loading-spinner {
    width: 2.5rem;
    height: 2.5rem;
    border: 0.25rem solid #1976d2;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
// æ–°é—»ç­›é€‰åŠŸèƒ½ - å·¦ä¾§è¾¹æ ç‰ˆæœ¬
const LC_APP_ID = 'pUEgNUJ66pc7S4FqVpqxkTkx-MdYXbMMI';
const LC_APP_KEY = 'K9OXRf3L6Zp0s6TEzJElWQ5r';

// åˆ†é¡µé…ç½®
let NEWS_ITEMS_PER_PAGE = 6;
let currentPage = 1;
let filteredNews = [];
let allNews = [];

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ æ–°é—»ç­›é€‰ç³»ç»Ÿåˆå§‹åŒ–');

    // è·å–æ‰€æœ‰æ–°é—»å…ƒç´ 
    allNews = Array.from(document.querySelectorAll('.news-item'));
    filteredNews = [...allNews];

    // åˆå§‹åŒ–å¢å¼ºåˆ†é¡µ
    initEnhancedPagination('newsList', NEWS_ITEMS_PER_PAGE, 'èµ„è®¯');

    // ç›‘å¬åˆ†é¡µå˜åŒ–äº‹ä»¶
    document.addEventListener('enhancedPaginationChange', function(event) {
        if (event.detail.containerId === 'newsList') {
            currentPage = event.detail.currentPage;
            NEWS_ITEMS_PER_PAGE = event.detail.itemsPerPage;
            updateNewsDisplay();
        }
    });

    // åˆå§‹åŒ–ç­›é€‰å™¨äº‹ä»¶
    initializeFilters();

    // åˆå§‹åŒ–æ’åº
    initializeSorting();

    // åº”ç”¨åˆå§‹ç­›é€‰å’Œåˆ†é¡µ
    applyFiltersAndSort();

    console.log(`âœ… æ‰¾åˆ° ${allNews.length} ç¯‡æ–°é—»`);
});

function initializeFilters() {
    // åˆ†ç±»ç­›é€‰
    document.querySelectorAll('#category-filters .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            toggleFilter(this, 'category');
        });
    });

    // æ ‡ç­¾ç­›é€‰
    document.querySelectorAll('#tag-filters .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            toggleFilter(this, 'tag');
        });
    });

    // æ¸…é™¤å…¨éƒ¨ç­›é€‰
    document.getElementById('clearAllFilters').addEventListener('click', clearAllFilters);
}

function initializeSorting() {
    document.getElementById('sortOrder').addEventListener('change', function() {
        applyFiltersAndSort();
    });
}

function showLoading() {
    const loading = document.createElement('div');
    loading.className = 'loading';
    loading.innerHTML = '<div class="loading-spinner"></div>';
    document.body.appendChild(loading);
}

function hideLoading() {
    const loading = document.querySelector('.loading');
    if (loading) {
        loading.remove();
    }
}

function toggleFilter(button, filterType) {
    const value = button.dataset.filterValue;

    // å¦‚æœæ˜¯"å…¨éƒ¨"æŒ‰é’®
    if (value === '') {
        // æ¸…é™¤åŒç±»å‹çš„å…¶ä»–é€‰ä¸­çŠ¶æ€
        button.parentElement.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
    } else {
        // å–æ¶ˆ"å…¨éƒ¨"æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        const allBtn = button.parentElement.querySelector('[data-filter-value=""]');
        if (allBtn) allBtn.classList.remove('active');

        // åˆ‡æ¢å½“å‰æŒ‰é’®çŠ¶æ€
        button.classList.toggle('active');

        // å¦‚æœæ²¡æœ‰ä»»ä½•æŒ‰é’®è¢«é€‰ä¸­ï¼Œåˆ™é€‰ä¸­"å…¨éƒ¨"
        const activeButtons = button.parentElement.querySelectorAll('.filter-btn.active');
        if (activeButtons.length === 0 && allBtn) {
            allBtn.classList.add('active');
        }
    }

    // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    currentPage = 1;

    // åº”ç”¨ç­›é€‰
    applyFiltersAndSort();
}

function clearAllFilters() {
    // æ¸…é™¤æ‰€æœ‰ç­›é€‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // é€‰ä¸­æ‰€æœ‰"å…¨éƒ¨"æŒ‰é’®
    document.querySelectorAll('[data-filter-value=""]').forEach(btn => {
        btn.classList.add('active');
    });

    // é‡ç½®æ’åº
    document.getElementById('sortOrder').value = 'date-desc';

    // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
    currentPage = 1;

    // åº”ç”¨ç­›é€‰
    applyFiltersAndSort();
}

function fetchViewCountsForPermalinks(permalinks) {
    if (permalinks.length === 0) {
        return Promise.resolve({});
    }

    const query = {
        "url": {
            "$in": permalinks
        }
    };
    const queryUrl = `https://pUEgNUJ66pc7S4FqVpqxkTkx.api.lncldglobal.com/1.1/classes/Counter?where=${encodeURIComponent(JSON.stringify(query))}`;

    return fetch(queryUrl, {
        method: 'GET',
        headers: {
            'X-LC-Id': LC_APP_ID,
            'X-LC-Key': LC_APP_KEY,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const viewCountsMap = {};
        if (data.results) {
            data.results.forEach(record => {
                viewCountsMap[record.url] = record.time || 0;
            });
        }
        return viewCountsMap;
    })
    .catch(error => {
        console.error('æ‰¹é‡æŸ¥è¯¢æµè§ˆæ¬¡æ•°å¤±è´¥:', error);
        return {};
    });
}

function applyFiltersAndSort() {
    console.log('ğŸ”„ åº”ç”¨ç­›é€‰å’Œæ’åº');

    // è·å–é€‰ä¸­çš„ç­›é€‰æ¡ä»¶
    const selectedCategories = getSelectedFilters('#category-filters');
    const selectedTags = getSelectedFilters('#tag-filters');
    const sortOrder = document.getElementById('sortOrder').value;

    console.log('ç­›é€‰æ¡ä»¶:', {
        categories: selectedCategories,
        tags: selectedTags,
        sortOrder: sortOrder
    });

    // ç­›é€‰æ–°é—»
    filteredNews = allNews.filter(newsItem => {
        const categories = newsItem.dataset.categories ?
            newsItem.dataset.categories.split(',').map(c => c.trim()) : [];
        const tags = newsItem.dataset.tags ?
            newsItem.dataset.tags.split(',').map(t => t.trim()) : [];

        // æ£€æŸ¥åˆ†ç±»åŒ¹é…
        let categoryMatch = selectedCategories.length === 0 ||
            selectedCategories.some(cat => categories.includes(cat));

        // æ£€æŸ¥æ ‡ç­¾åŒ¹é…
        let tagMatch = selectedTags.length === 0 ||
            selectedTags.some(tag => tags.includes(tag));

        return categoryMatch && tagMatch;
    });

    // æ’åº
    sortNews(filteredNews, sortOrder);

    console.log(`âœ… ç­›é€‰å®Œæˆ: ${filteredNews.length} / ${allNews.length} ç¯‡æ–°é—»ç¬¦åˆæ¡ä»¶`);

    // æ›´æ–°æ˜¾ç¤º
    updateNewsDisplay();
    updateEnhancedPagination('newsList', filteredNews, 1);
    updateNewsCount();
    updateSelectedFilters();
}

function getSelectedFilters(containerSelector) {
    const activeButtons = document.querySelectorAll(`${containerSelector} .filter-btn.active`);
    const selected = [];

    activeButtons.forEach(btn => {
        const value = btn.dataset.filterValue;
        if (value !== '') {
            selected.push(value);
        }
    });

    return selected;
}

function sortNews(news, sortOrder) {
    news.sort((a, b) => {
        switch (sortOrder) {
            case 'date-desc':
                return new Date(b.dataset.date) - new Date(a.dataset.date);
            case 'date-asc':
                return new Date(a.dataset.date) - new Date(b.dataset.date);
            case 'views':
                return parseInt(b.dataset.views) - parseInt(a.dataset.views);
            default:
                return 0;
        }
    });
}

function updateNewsDisplay() {
    // éšè—æ‰€æœ‰æ–°é—»
    allNews.forEach(newsItem => {
        newsItem.style.display = 'none';
    });

    // è®¡ç®—å½“å‰é¡µè¦æ˜¾ç¤ºçš„æ–°é—»
    const startIndex = (currentPage - 1) * NEWS_ITEMS_PER_PAGE;
    const endIndex = startIndex + NEWS_ITEMS_PER_PAGE;
    const currentPageNews = filteredNews.slice(startIndex, endIndex);

    // æ˜¾ç¤ºå½“å‰é¡µçš„æ–°é—»
    currentPageNews.forEach(newsItem => {
        newsItem.style.display = 'block';
    });

    // æ˜¾ç¤º/éšè—æ— ç»“æœæç¤º
    const noResultsMessage = document.getElementById('no-news-message');
    if (filteredNews.length === 0) {
        noResultsMessage.style.display = 'block';
    } else {
        noResultsMessage.style.display = 'none';
    }
}

// æ—§çš„åˆ†é¡µå‡½æ•°å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¢å¼ºç‰ˆåˆ†é¡µç»„ä»¶

function updateNewsCount() {
    const countInfo = document.getElementById('news-count-info');
    if (filteredNews.length === allNews.length) {
        countInfo.textContent = `å…± ${allNews.length} ç¯‡èµ„è®¯`;
    } else {
        countInfo.textContent = `æ‰¾åˆ° ${filteredNews.length} ç¯‡èµ„è®¯ (å…± ${allNews.length} ç¯‡)`;
    }
}

function updateSelectedFilters() {
    const selectedCategories = getSelectedFilters('#category-filters');
    const selectedTags = getSelectedFilters('#tag-filters');
    const selectedFiltersCard = document.getElementById('selected-filters-card');
    const selectedFiltersContainer = document.getElementById('selected-filters-container');

    const hasFilters = selectedCategories.length > 0 || selectedTags.length > 0;

    if (hasFilters) {
        selectedFiltersCard.style.display = 'block';
        let filtersHTML = '';

        selectedCategories.forEach(category => {
            filtersHTML += `<span class="selected-filter-tag">
                åˆ†ç±»: ${category}
                <span class="remove-filter" onclick="removeFilter('category', '${category}')">&times;</span>
            </span>`;
        });

        selectedTags.forEach(tag => {
            filtersHTML += `<span class="selected-filter-tag">
                æ ‡ç­¾: ${tag}
                <span class="remove-filter" onclick="removeFilter('tag', '${tag}')">&times;</span>
            </span>`;
        });

        selectedFiltersContainer.innerHTML = filtersHTML;
    } else {
        selectedFiltersCard.style.display = 'none';
    }
}

function removeFilter(filterType, value) {
    const selector = filterType === 'category' ? '#category-filters' : '#tag-filters';
    const button = document.querySelector(`${selector} [data-filter-value="${value}"]`);
    if (button) {
        button.classList.remove('active');

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¿€æ´»"å…¨éƒ¨"æŒ‰é’®
        const activeButtons = button.parentElement.querySelectorAll('.filter-btn.active');
        if (activeButtons.length === 0) {
            const allBtn = button.parentElement.querySelector('[data-filter-value=""]');
            if (allBtn) allBtn.classList.add('active');
        }
    }

    applyFiltersAndSort();
}

// æ—§çš„goToPageå‡½æ•°å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¢å¼ºç‰ˆåˆ†é¡µç»„ä»¶





</script>
{{ end }}